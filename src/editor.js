// Auto-generated file. Do not edit directly.
export function getEditorHtml() {
  return atob('PCFET0NUWVBFIGh0bWw+CjxodG1sPgogIDxoZWFkPgogICAgPHRpdGxlPlpTU1JpY2hUZXh0RWRpdG9yPC90aXRsZT4KICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wLCBtYXhpbXVtLXNjYWxlPTEuMCwgdXNlci1zY2FsYWJsZT1ubyIgLz4KICAgIDxtZXRhIG5hbWU9ImZvcm1hdC1kZXRlY3Rpb24iIGNvbnRlbnQ9InRlbGVwaG9uZT1ubyIgLz4KCiAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCI+CiAgICAgIC8qISBqUXVlcnkgdjMuMS4wIHwgKGMpIGpRdWVyeSBGb3VuZGF0aW9uIHwganF1ZXJ5Lm9yZy9saWNlbnNlICovCiAgICAgICEoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgIm9iamVjdCIgPT0gdHlwZW9mIG1vZHVsZSAmJiAib2JqZWN0IiA9PSB0eXBlb2YgbW9kdWxlLmV4cG9ydHMKICAgICAgICAgID8gKG1vZHVsZS5leHBvcnRzID0gYS5kb2N1bWVudAogICAgICAgICAgICAgID8gYihhLCAhMCkKICAgICAgICAgICAgICA6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgIGlmICghYS5kb2N1bWVudCkgdGhyb3cgbmV3IEVycm9yKCJqUXVlcnkgcmVxdWlyZXMgYSB3aW5kb3cgd2l0aCBhIGRvY3VtZW50Iik7CiAgICAgICAgICAgICAgICAgIHJldHVybiBiKGEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgIDogYihhKTsKICAgICAgfSkoInVuZGVmaW5lZCIgIT0gdHlwZW9mIHdpbmRvdyA/IHdpbmRvdyA6IHRoaXMsIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBjID0gW10sCiAgICAgICAgICBkID0gYS5kb2N1bWVudCwKICAgICAgICAgIGUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YsCiAgICAgICAgICBmID0gYy5zbGljZSwKICAgICAgICAgIGcgPSBjLmNvbmNhdCwKICAgICAgICAgIGggPSBjLnB1c2gsCiAgICAgICAgICBpID0gYy5pbmRleE9mLAogICAgICAgICAgaiA9IHt9LAogICAgICAgICAgayA9IGoudG9TdHJpbmcsCiAgICAgICAgICBsID0gai5oYXNPd25Qcm9wZXJ0eSwKICAgICAgICAgIG0gPSBsLnRvU3RyaW5nLAogICAgICAgICAgbiA9IG0uY2FsbChPYmplY3QpLAogICAgICAgICAgbyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHAoYSwgYikgewogICAgICAgICAgYiA9IGIgfHwgZDsKICAgICAgICAgIHZhciBjID0gYi5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICAgIChjLnRleHQgPSBhKSwgYi5oZWFkLmFwcGVuZENoaWxkKGMpLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYyk7CiAgICAgICAgfQogICAgICAgIHZhciBxID0gIjMuMS4wIiwKICAgICAgICAgIHIgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICByZXR1cm4gbmV3IHIuZm4uaW5pdChhLCBiKTsKICAgICAgICAgIH0sCiAgICAgICAgICBzID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nLAogICAgICAgICAgdCA9IC9eLW1zLS8sCiAgICAgICAgICB1ID0gLy0oW2Etel0pL2csCiAgICAgICAgICB2ID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGIudG9VcHBlckNhc2UoKTsKICAgICAgICAgIH07CiAgICAgICAgKHIuZm4gPSByLnByb3RvdHlwZSA9CiAgICAgICAgICB7CiAgICAgICAgICAgIGpxdWVyeTogcSwKICAgICAgICAgICAgY29uc3RydWN0b3I6IHIsCiAgICAgICAgICAgIGxlbmd0aDogMCwKICAgICAgICAgICAgdG9BcnJheTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiBmLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbCAhPSBhID8gKGEgPCAwID8gdGhpc1thICsgdGhpcy5sZW5ndGhdIDogdGhpc1thXSkgOiBmLmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHB1c2hTdGFjazogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICB2YXIgYiA9IHIubWVyZ2UodGhpcy5jb25zdHJ1Y3RvcigpLCBhKTsKICAgICAgICAgICAgICByZXR1cm4gKGIucHJldk9iamVjdCA9IHRoaXMpLCBiOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlYWNoOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiByLmVhY2godGhpcywgYSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1hcDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soCiAgICAgICAgICAgICAgICByLm1hcCh0aGlzLCBmdW5jdGlvbiAoYiwgYykgewogICAgICAgICAgICAgICAgICByZXR1cm4gYS5jYWxsKGIsIGMsIGIpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzbGljZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmaXJzdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLmVxKDApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBsYXN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXEoLTEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlcTogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICB2YXIgYiA9IHRoaXMubGVuZ3RoLAogICAgICAgICAgICAgICAgYyA9ICthICsgKGEgPCAwID8gYiA6IDApOwogICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhjID49IDAgJiYgYyA8IGIgPyBbdGhpc1tjXV0gOiBbXSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVuZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBwdXNoOiBoLAogICAgICAgICAgICBzb3J0OiBjLnNvcnQsCiAgICAgICAgICAgIHNwbGljZTogYy5zcGxpY2UsCiAgICAgICAgICB9KSwKICAgICAgICAgIChyLmV4dGVuZCA9IHIuZm4uZXh0ZW5kID0KICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHZhciBhLAogICAgICAgICAgICAgICAgYiwKICAgICAgICAgICAgICAgIGMsCiAgICAgICAgICAgICAgICBkLAogICAgICAgICAgICAgICAgZSwKICAgICAgICAgICAgICAgIGYsCiAgICAgICAgICAgICAgICBnID0gYXJndW1lbnRzWzBdIHx8IHt9LAogICAgICAgICAgICAgICAgaCA9IDEsCiAgICAgICAgICAgICAgICBpID0gYXJndW1lbnRzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGogPSAhMTsKICAgICAgICAgICAgICBmb3IgKAogICAgICAgICAgICAgICAgImJvb2xlYW4iID09IHR5cGVvZiBnICYmICgoaiA9IGcpLCAoZyA9IGFyZ3VtZW50c1toXSB8fCB7fSksIGgrKyksCiAgICAgICAgICAgICAgICAgICJvYmplY3QiID09IHR5cGVvZiBnIHx8IHIuaXNGdW5jdGlvbihnKSB8fCAoZyA9IHt9KSwKICAgICAgICAgICAgICAgICAgaCA9PT0gaSAmJiAoKGcgPSB0aGlzKSwgaC0tKTsKICAgICAgICAgICAgICAgIGggPCBpOwogICAgICAgICAgICAgICAgaCsrCiAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaWYgKG51bGwgIT0gKGEgPSBhcmd1bWVudHNbaF0pKQogICAgICAgICAgICAgICAgICBmb3IgKGIgaW4gYSkKICAgICAgICAgICAgICAgICAgICAoYyA9IGdbYl0pLAogICAgICAgICAgICAgICAgICAgICAgKGQgPSBhW2JdKSwKICAgICAgICAgICAgICAgICAgICAgIGcgIT09IGQgJiYKICAgICAgICAgICAgICAgICAgICAgICAgKGogJiYgZCAmJiAoci5pc1BsYWluT2JqZWN0KGQpIHx8IChlID0gci5pc0FycmF5KGQpKSkKICAgICAgICAgICAgICAgICAgICAgICAgICA/IChlID8gKChlID0gITEpLCAoZiA9IGMgJiYgci5pc0FycmF5KGMpID8gYyA6IFtdKSkgOiAoZiA9IGMgJiYgci5pc1BsYWluT2JqZWN0KGMpID8gYyA6IHt9KSwgKGdbYl0gPSByLmV4dGVuZChqLCBmLCBkKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiB2b2lkIDAgIT09IGQgJiYgKGdbYl0gPSBkKSk7CiAgICAgICAgICAgICAgcmV0dXJuIGc7CiAgICAgICAgICAgIH0pLAogICAgICAgICAgci5leHRlbmQoewogICAgICAgICAgICBleHBhbmRvOiAialF1ZXJ5IiArIChxICsgTWF0aC5yYW5kb20oKSkucmVwbGFjZSgvXEQvZywgIiIpLAogICAgICAgICAgICBpc1JlYWR5OiAhMCwKICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBub29wOiBmdW5jdGlvbiAoKSB7fSwKICAgICAgICAgICAgaXNGdW5jdGlvbjogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIiA9PT0gci50eXBlKGEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0FycmF5OiBBcnJheS5pc0FycmF5LAogICAgICAgICAgICBpc1dpbmRvdzogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbCAhPSBhICYmIGEgPT09IGEud2luZG93OwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc051bWVyaWM6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgdmFyIGIgPSByLnR5cGUoYSk7CiAgICAgICAgICAgICAgcmV0dXJuICgibnVtYmVyIiA9PT0gYiB8fCAic3RyaW5nIiA9PT0gYikgJiYgIWlzTmFOKGEgLSBwYXJzZUZsb2F0KGEpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNQbGFpbk9iamVjdDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICB2YXIgYiwgYzsKICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgISghYSB8fCAiW29iamVjdCBPYmplY3RdIiAhPT0gay5jYWxsKGEpKSAmJgogICAgICAgICAgICAgICAgKCEoYiA9IGUoYSkpIHx8ICgoYyA9IGwuY2FsbChiLCAiY29uc3RydWN0b3IiKSAmJiBiLmNvbnN0cnVjdG9yKSwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgYyAmJiBtLmNhbGwoYykgPT09IG4pKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzRW1wdHlPYmplY3Q6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgdmFyIGI7CiAgICAgICAgICAgICAgZm9yIChiIGluIGEpIHJldHVybiAhMTsKICAgICAgICAgICAgICByZXR1cm4gITA7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHR5cGU6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGwgPT0gYSA/IGEgKyAiIiA6ICJvYmplY3QiID09IHR5cGVvZiBhIHx8ICJmdW5jdGlvbiIgPT0gdHlwZW9mIGEgPyBqW2suY2FsbChhKV0gfHwgIm9iamVjdCIgOiB0eXBlb2YgYTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2xvYmFsRXZhbDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICBwKGEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW1lbENhc2U6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGEucmVwbGFjZSh0LCAibXMtIikucmVwbGFjZSh1LCB2KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbm9kZU5hbWU6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGEubm9kZU5hbWUgJiYgYS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBiLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVhY2g6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgdmFyIGMsCiAgICAgICAgICAgICAgICBkID0gMDsKICAgICAgICAgICAgICBpZiAodyhhKSkgewogICAgICAgICAgICAgICAgZm9yIChjID0gYS5sZW5ndGg7IGQgPCBjOyBkKyspIGlmIChiLmNhbGwoYVtkXSwgZCwgYVtkXSkgPT09ICExKSBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgZm9yIChkIGluIGEpIGlmIChiLmNhbGwoYVtkXSwgZCwgYVtkXSkgPT09ICExKSBicmVhazsKICAgICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdHJpbTogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbCA9PSBhID8gIiIgOiAoYSArICIiKS5yZXBsYWNlKHMsICIiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbWFrZUFycmF5OiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHZhciBjID0gYiB8fCBbXTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbCAhPSBhICYmICh3KE9iamVjdChhKSkgPyByLm1lcmdlKGMsICJzdHJpbmciID09IHR5cGVvZiBhID8gW2FdIDogYSkgOiBoLmNhbGwoYywgYSkpLCBjOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpbkFycmF5OiBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgIHJldHVybiBudWxsID09IGIgPyAtMSA6IGkuY2FsbChiLCBhLCBjKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbWVyZ2U6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgYyA9ICtiLmxlbmd0aCwgZCA9IDAsIGUgPSBhLmxlbmd0aDsgZCA8IGM7IGQrKykgYVtlKytdID0gYltkXTsKICAgICAgICAgICAgICByZXR1cm4gKGEubGVuZ3RoID0gZSksIGE7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdyZXA6IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgZCwgZSA9IFtdLCBmID0gMCwgZyA9IGEubGVuZ3RoLCBoID0gIWM7IGYgPCBnOyBmKyspIChkID0gIWIoYVtmXSwgZikpLCBkICE9PSBoICYmIGUucHVzaChhW2ZdKTsKICAgICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbWFwOiBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgIHZhciBkLAogICAgICAgICAgICAgICAgZSwKICAgICAgICAgICAgICAgIGYgPSAwLAogICAgICAgICAgICAgICAgaCA9IFtdOwogICAgICAgICAgICAgIGlmICh3KGEpKSBmb3IgKGQgPSBhLmxlbmd0aDsgZiA8IGQ7IGYrKykgKGUgPSBiKGFbZl0sIGYsIGMpKSwgbnVsbCAhPSBlICYmIGgucHVzaChlKTsKICAgICAgICAgICAgICBlbHNlIGZvciAoZiBpbiBhKSAoZSA9IGIoYVtmXSwgZiwgYykpLCBudWxsICE9IGUgJiYgaC5wdXNoKGUpOwogICAgICAgICAgICAgIHJldHVybiBnLmFwcGx5KFtdLCBoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ3VpZDogMSwKICAgICAgICAgICAgcHJveHk6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgdmFyIGMsIGQsIGU7CiAgICAgICAgICAgICAgaWYgKCgic3RyaW5nIiA9PSB0eXBlb2YgYiAmJiAoKGMgPSBhW2JdKSwgKGIgPSBhKSwgKGEgPSBjKSksIHIuaXNGdW5jdGlvbihhKSkpCiAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAoZCA9IGYuY2FsbChhcmd1bWVudHMsIDIpKSwKICAgICAgICAgICAgICAgICAgKGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEuYXBwbHkoYiB8fCB0aGlzLCBkLmNvbmNhdChmLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgKGUuZ3VpZCA9IGEuZ3VpZCA9IGEuZ3VpZCB8fCByLmd1aWQrKyksCiAgICAgICAgICAgICAgICAgIGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG5vdzogRGF0ZS5ub3csCiAgICAgICAgICAgIHN1cHBvcnQ6IG8sCiAgICAgICAgICB9KSwKICAgICAgICAgICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiAoci5mbltTeW1ib2wuaXRlcmF0b3JdID0gY1tTeW1ib2wuaXRlcmF0b3JdKSwKICAgICAgICAgIHIuZWFjaCgiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCBFcnJvciBTeW1ib2wiLnNwbGl0KCIgIiksIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIGpbIltvYmplY3QgIiArIGIgKyAiXSJdID0gYi50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgZnVuY3Rpb24gdyhhKSB7CiAgICAgICAgICB2YXIgYiA9ICEhYSAmJiAibGVuZ3RoIiBpbiBhICYmIGEubGVuZ3RoLAogICAgICAgICAgICBjID0gci50eXBlKGEpOwogICAgICAgICAgcmV0dXJuICJmdW5jdGlvbiIgIT09IGMgJiYgIXIuaXNXaW5kb3coYSkgJiYgKCJhcnJheSIgPT09IGMgfHwgMCA9PT0gYiB8fCAoIm51bWJlciIgPT0gdHlwZW9mIGIgJiYgYiA+IDAgJiYgYiAtIDEgaW4gYSkpOwogICAgICAgIH0KICAgICAgICB2YXIgeCA9IChmdW5jdGlvbiAoYSkgewogICAgICAgICAgdmFyIGIsCiAgICAgICAgICAgIGMsCiAgICAgICAgICAgIGQsCiAgICAgICAgICAgIGUsCiAgICAgICAgICAgIGYsCiAgICAgICAgICAgIGcsCiAgICAgICAgICAgIGgsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGosCiAgICAgICAgICAgIGssCiAgICAgICAgICAgIGwsCiAgICAgICAgICAgIG0sCiAgICAgICAgICAgIG4sCiAgICAgICAgICAgIG8sCiAgICAgICAgICAgIHAsCiAgICAgICAgICAgIHEsCiAgICAgICAgICAgIHIsCiAgICAgICAgICAgIHMsCiAgICAgICAgICAgIHQsCiAgICAgICAgICAgIHUgPSAic2l6emxlIiArIDEgKiBuZXcgRGF0ZSgpLAogICAgICAgICAgICB2ID0gYS5kb2N1bWVudCwKICAgICAgICAgICAgdyA9IDAsCiAgICAgICAgICAgIHggPSAwLAogICAgICAgICAgICB5ID0gaGEoKSwKICAgICAgICAgICAgeiA9IGhhKCksCiAgICAgICAgICAgIEEgPSBoYSgpLAogICAgICAgICAgICBCID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYiAmJiAobCA9ICEwKSwgMDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgQyA9IHt9Lmhhc093blByb3BlcnR5LAogICAgICAgICAgICBEID0gW10sCiAgICAgICAgICAgIEUgPSBELnBvcCwKICAgICAgICAgICAgRiA9IEQucHVzaCwKICAgICAgICAgICAgRyA9IEQucHVzaCwKICAgICAgICAgICAgSCA9IEQuc2xpY2UsCiAgICAgICAgICAgIEkgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIGZvciAodmFyIGMgPSAwLCBkID0gYS5sZW5ndGg7IGMgPCBkOyBjKyspIGlmIChhW2NdID09PSBiKSByZXR1cm4gYzsKICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEogPSAiY2hlY2tlZHxzZWxlY3RlZHxhc3luY3xhdXRvZm9jdXN8YXV0b3BsYXl8Y29udHJvbHN8ZGVmZXJ8ZGlzYWJsZWR8aGlkZGVufGlzbWFwfGxvb3B8bXVsdGlwbGV8b3BlbnxyZWFkb25seXxyZXF1aXJlZHxzY29wZWQiLAogICAgICAgICAgICBLID0gIltcXHgyMFxcdFxcclxcblxcZl0iLAogICAgICAgICAgICBMID0gIig/OlxcXFwufFtcXHctXXxbXlwwLVxceGEwXSkrIiwKICAgICAgICAgICAgTSA9CiAgICAgICAgICAgICAgIlxcWyIgKwogICAgICAgICAgICAgIEsgKwogICAgICAgICAgICAgICIqKCIgKwogICAgICAgICAgICAgIEwgKwogICAgICAgICAgICAgICIpKD86IiArCiAgICAgICAgICAgICAgSyArCiAgICAgICAgICAgICAgIiooWypeJHwhfl0/PSkiICsKICAgICAgICAgICAgICBLICsKICAgICAgICAgICAgICAiKig/OicoKD86XFxcXC58W15cXFxcJ10pKiknfFwiKCg/OlxcXFwufFteXFxcXFwiXSkqKVwifCgiICsKICAgICAgICAgICAgICBMICsKICAgICAgICAgICAgICAiKSl8KSIgKwogICAgICAgICAgICAgIEsgKwogICAgICAgICAgICAgICIqXFxdIiwKICAgICAgICAgICAgTiA9ICI6KCIgKyBMICsgIikoPzpcXCgoKCcoKD86XFxcXC58W15cXFxcJ10pKiknfFwiKCg/OlxcXFwufFteXFxcXFwiXSkqKVwiKXwoKD86XFxcXC58W15cXFxcKClbXFxdXXwiICsgTSArICIpKil8LiopXFwpfCkiLAogICAgICAgICAgICBPID0gbmV3IFJlZ0V4cChLICsgIisiLCAiZyIpLAogICAgICAgICAgICBQID0gbmV3IFJlZ0V4cCgiXiIgKyBLICsgIit8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKSIgKyBLICsgIiskIiwgImciKSwKICAgICAgICAgICAgUSA9IG5ldyBSZWdFeHAoIl4iICsgSyArICIqLCIgKyBLICsgIioiKSwKICAgICAgICAgICAgUiA9IG5ldyBSZWdFeHAoIl4iICsgSyArICIqKFs+K35dfCIgKyBLICsgIikiICsgSyArICIqIiksCiAgICAgICAgICAgIFMgPSBuZXcgUmVnRXhwKCI9IiArIEsgKyAiKihbXlxcXSdcIl0qPykiICsgSyArICIqXFxdIiwgImciKSwKICAgICAgICAgICAgVCA9IG5ldyBSZWdFeHAoTiksCiAgICAgICAgICAgIFUgPSBuZXcgUmVnRXhwKCJeIiArIEwgKyAiJCIpLAogICAgICAgICAgICBWID0gewogICAgICAgICAgICAgIElEOiBuZXcgUmVnRXhwKCJeIygiICsgTCArICIpIiksCiAgICAgICAgICAgICAgQ0xBU1M6IG5ldyBSZWdFeHAoIl5cXC4oIiArIEwgKyAiKSIpLAogICAgICAgICAgICAgIFRBRzogbmV3IFJlZ0V4cCgiXigiICsgTCArICJ8WypdKSIpLAogICAgICAgICAgICAgIEFUVFI6IG5ldyBSZWdFeHAoIl4iICsgTSksCiAgICAgICAgICAgICAgUFNFVURPOiBuZXcgUmVnRXhwKCJeIiArIE4pLAogICAgICAgICAgICAgIENISUxEOiBuZXcgUmVnRXhwKAogICAgICAgICAgICAgICAgIl46KG9ubHl8Zmlyc3R8bGFzdHxudGh8bnRoLWxhc3QpLShjaGlsZHxvZi10eXBlKSg/OlxcKCIgKwogICAgICAgICAgICAgICAgICBLICsKICAgICAgICAgICAgICAgICAgIiooZXZlbnxvZGR8KChbKy1dfCkoXFxkKilufCkiICsKICAgICAgICAgICAgICAgICAgSyArCiAgICAgICAgICAgICAgICAgICIqKD86KFsrLV18KSIgKwogICAgICAgICAgICAgICAgICBLICsKICAgICAgICAgICAgICAgICAgIiooXFxkKyl8KSkiICsKICAgICAgICAgICAgICAgICAgSyArCiAgICAgICAgICAgICAgICAgICIqXFwpfCkiLAogICAgICAgICAgICAgICAgImkiCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICBib29sOiBuZXcgUmVnRXhwKCJeKD86IiArIEogKyAiKSQiLCAiaSIpLAogICAgICAgICAgICAgIG5lZWRzQ29udGV4dDogbmV3IFJlZ0V4cCgKICAgICAgICAgICAgICAgICJeIiArIEsgKyAiKls+K35dfDooZXZlbnxvZGR8ZXF8Z3R8bHR8bnRofGZpcnN0fGxhc3QpKD86XFwoIiArIEsgKyAiKigoPzotXFxkKT9cXGQqKSIgKyBLICsgIipcXCl8KSg/PVteLV18JCkiLAogICAgICAgICAgICAgICAgImkiCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgVyA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2ksCiAgICAgICAgICAgIFggPSAvXmhcZCQvaSwKICAgICAgICAgICAgWSA9IC9eW157XStce1xzKlxbbmF0aXZlIFx3LywKICAgICAgICAgICAgWiA9IC9eKD86IyhbXHctXSspfChcdyspfFwuKFtcdy1dKykpJC8sCiAgICAgICAgICAgICQgPSAvWyt+XS8sCiAgICAgICAgICAgIF8gPSBuZXcgUmVnRXhwKCJcXFxcKFtcXGRhLWZdezEsNn0iICsgSyArICI/fCgiICsgSyArICIpfC4pIiwgImlnIiksCiAgICAgICAgICAgIGFhID0gZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgICB2YXIgZCA9ICIweCIgKyBiIC0gNjU1MzY7CiAgICAgICAgICAgICAgcmV0dXJuIGQgIT09IGQgfHwgYyA/IGIgOiBkIDwgMCA/IFN0cmluZy5mcm9tQ2hhckNvZGUoZCArIDY1NTM2KSA6IFN0cmluZy5mcm9tQ2hhckNvZGUoKGQgPj4gMTApIHwgNTUyOTYsICgxMDIzICYgZCkgfCA1NjMyMCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJhID0gLyhbXDAtXHgxZlx4N2ZdfF4tP1xkKXxeLSR8W15ceDgwLVx1RkZGRlx3LV0vZywKICAgICAgICAgICAgY2EgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHJldHVybiBiID8gKCJcMCIgPT09IGEgPyAiXHVmZmZkIiA6IGEuc2xpY2UoMCwgLTEpICsgIlxcIiArIGEuY2hhckNvZGVBdChhLmxlbmd0aCAtIDEpLnRvU3RyaW5nKDE2KSArICIgIikgOiAiXFwiICsgYTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGEgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgbSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlYSA9IHRhKAogICAgICAgICAgICAgIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYS5kaXNhYmxlZCA9PT0gITA7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB7IGRpcjogInBhcmVudE5vZGUiLCBuZXh0OiAibGVnZW5kIiB9CiAgICAgICAgICAgICk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBHLmFwcGx5KChEID0gSC5jYWxsKHYuY2hpbGROb2RlcykpLCB2LmNoaWxkTm9kZXMpLCBEW3YuY2hpbGROb2Rlcy5sZW5ndGhdLm5vZGVUeXBlOwogICAgICAgICAgfSBjYXRjaCAoZmEpIHsKICAgICAgICAgICAgRyA9IHsKICAgICAgICAgICAgICBhcHBseTogRC5sZW5ndGgKICAgICAgICAgICAgICAgID8gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICBGLmFwcGx5KGEsIEguY2FsbChiKSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGEubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgZCA9IDA7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChhW2MrK10gPSBiW2QrK10pKTsKICAgICAgICAgICAgICAgICAgICBhLmxlbmd0aCA9IGMgLSAxOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2EoYSwgYiwgZCwgZSkgewogICAgICAgICAgICB2YXIgZiwKICAgICAgICAgICAgICBoLAogICAgICAgICAgICAgIGosCiAgICAgICAgICAgICAgaywKICAgICAgICAgICAgICBsLAogICAgICAgICAgICAgIG8sCiAgICAgICAgICAgICAgciwKICAgICAgICAgICAgICBzID0gYiAmJiBiLm93bmVyRG9jdW1lbnQsCiAgICAgICAgICAgICAgdyA9IGIgPyBiLm5vZGVUeXBlIDogOTsKICAgICAgICAgICAgaWYgKCgoZCA9IGQgfHwgW10pLCAic3RyaW5nIiAhPSB0eXBlb2YgYSB8fCAhYSB8fCAoMSAhPT0gdyAmJiA5ICE9PSB3ICYmIDExICE9PSB3KSkpIHJldHVybiBkOwogICAgICAgICAgICBpZiAoIWUgJiYgKChiID8gYi5vd25lckRvY3VtZW50IHx8IGIgOiB2KSAhPT0gbiAmJiBtKGIpLCAoYiA9IGIgfHwgbiksIHApKSB7CiAgICAgICAgICAgICAgaWYgKDExICE9PSB3ICYmIChsID0gWi5leGVjKGEpKSkKICAgICAgICAgICAgICAgIGlmICgoZiA9IGxbMV0pKSB7CiAgICAgICAgICAgICAgICAgIGlmICg5ID09PSB3KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEoaiA9IGIuZ2V0RWxlbWVudEJ5SWQoZikpKSByZXR1cm4gZDsKICAgICAgICAgICAgICAgICAgICBpZiAoai5pZCA9PT0gZikgcmV0dXJuIGQucHVzaChqKSwgZDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzICYmIChqID0gcy5nZXRFbGVtZW50QnlJZChmKSkgJiYgdChiLCBqKSAmJiBqLmlkID09PSBmKSByZXR1cm4gZC5wdXNoKGopLCBkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGxbMl0pIHJldHVybiBHLmFwcGx5KGQsIGIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoYSkpLCBkOwogICAgICAgICAgICAgICAgICBpZiAoKGYgPSBsWzNdKSAmJiBjLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgYi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKSByZXR1cm4gRy5hcHBseShkLCBiLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoZikpLCBkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjLnFzYSAmJiAhQVthICsgIiAiXSAmJiAoIXEgfHwgIXEudGVzdChhKSkpIHsKICAgICAgICAgICAgICAgIGlmICgxICE9PSB3KSAocyA9IGIpLCAociA9IGEpOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoIm9iamVjdCIgIT09IGIubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgICAoayA9IGIuZ2V0QXR0cmlidXRlKCJpZCIpKSA/IChrID0gay5yZXBsYWNlKGJhLCBjYSkpIDogYi5zZXRBdHRyaWJ1dGUoImlkIiwgKGsgPSB1KSksIChvID0gZyhhKSksIChoID0gby5sZW5ndGgpOwogICAgICAgICAgICAgICAgICB3aGlsZSAoaC0tKSBvW2hdID0gIiMiICsgayArICIgIiArIHNhKG9baF0pOwogICAgICAgICAgICAgICAgICAociA9IG8uam9pbigiLCIpKSwgKHMgPSAoJC50ZXN0KGEpICYmIHFhKGIucGFyZW50Tm9kZSkpIHx8IGIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHIpCiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEcuYXBwbHkoZCwgcy5xdWVyeVNlbGVjdG9yQWxsKHIpKSwgZDsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIGsgPT09IHUgJiYgYi5yZW1vdmVBdHRyaWJ1dGUoImlkIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGkoYS5yZXBsYWNlKFAsICIkMSIpLCBiLCBkLCBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGhhKCkgewogICAgICAgICAgICB2YXIgYSA9IFtdOwogICAgICAgICAgICBmdW5jdGlvbiBiKGMsIGUpIHsKICAgICAgICAgICAgICByZXR1cm4gYS5wdXNoKGMgKyAiICIpID4gZC5jYWNoZUxlbmd0aCAmJiBkZWxldGUgYlthLnNoaWZ0KCldLCAoYltjICsgIiAiXSA9IGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaWEoYSkgewogICAgICAgICAgICByZXR1cm4gKGFbdV0gPSAhMCksIGE7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBqYShhKSB7CiAgICAgICAgICAgIHZhciBiID0gbi5jcmVhdGVFbGVtZW50KCJmaWVsZHNldCIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiAhIWEoYik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGMpIHsKICAgICAgICAgICAgICByZXR1cm4gITE7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgYi5wYXJlbnROb2RlICYmIGIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChiKSwgKGIgPSBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24ga2EoYSwgYikgewogICAgICAgICAgICB2YXIgYyA9IGEuc3BsaXQoInwiKSwKICAgICAgICAgICAgICBlID0gYy5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChlLS0pIGQuYXR0ckhhbmRsZVtjW2VdXSA9IGI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBsYShhLCBiKSB7CiAgICAgICAgICAgIHZhciBjID0gYiAmJiBhLAogICAgICAgICAgICAgIGQgPSBjICYmIDEgPT09IGEubm9kZVR5cGUgJiYgMSA9PT0gYi5ub2RlVHlwZSAmJiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKICAgICAgICAgICAgaWYgKGQpIHJldHVybiBkOwogICAgICAgICAgICBpZiAoYykgd2hpbGUgKChjID0gYy5uZXh0U2libGluZykpIGlmIChjID09PSBiKSByZXR1cm4gLTE7CiAgICAgICAgICAgIHJldHVybiBhID8gMSA6IC0xOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWEoYSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICB2YXIgYyA9IGIubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICByZXR1cm4gImlucHV0IiA9PT0gYyAmJiBiLnR5cGUgPT09IGE7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBuYShhKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgIHZhciBjID0gYi5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHJldHVybiAoImlucHV0IiA9PT0gYyB8fCAiYnV0dG9uIiA9PT0gYykgJiYgYi50eXBlID09PSBhOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gb2EoYSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgKCJsYWJlbCIgaW4gYiAmJiBiLmRpc2FibGVkID09PSBhKSB8fAogICAgICAgICAgICAgICAgKCJmb3JtIiBpbiBiICYmIGIuZGlzYWJsZWQgPT09IGEpIHx8CiAgICAgICAgICAgICAgICAoImZvcm0iIGluIGIgJiYgYi5kaXNhYmxlZCA9PT0gITEgJiYgKGIuaXNEaXNhYmxlZCA9PT0gYSB8fCAoYi5pc0Rpc2FibGVkICE9PSAhYSAmJiAoImxhYmVsIiBpbiBiIHx8ICFlYShiKSkgIT09IGEpKSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcGEoYSkgewogICAgICAgICAgICByZXR1cm4gaWEoZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgKGIgPSArYiksCiAgICAgICAgICAgICAgICBpYShmdW5jdGlvbiAoYywgZCkgewogICAgICAgICAgICAgICAgICB2YXIgZSwKICAgICAgICAgICAgICAgICAgICBmID0gYShbXSwgYy5sZW5ndGgsIGIpLAogICAgICAgICAgICAgICAgICAgIGcgPSBmLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGctLSkgY1soZSA9IGZbZ10pXSAmJiAoY1tlXSA9ICEoZFtlXSA9IGNbZV0pKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBxYShhKSB7CiAgICAgICAgICAgIHJldHVybiBhICYmICJ1bmRlZmluZWQiICE9IHR5cGVvZiBhLmdldEVsZW1lbnRzQnlUYWdOYW1lICYmIGE7CiAgICAgICAgICB9CiAgICAgICAgICAoYyA9IGdhLnN1cHBvcnQgPSB7fSksCiAgICAgICAgICAgIChmID0gZ2EuaXNYTUwgPQogICAgICAgICAgICAgIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICB2YXIgYiA9IGEgJiYgKGEub3duZXJEb2N1bWVudCB8fCBhKS5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgICAgICByZXR1cm4gISFiICYmICJIVE1MIiAhPT0gYi5ub2RlTmFtZTsKICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgKG0gPSBnYS5zZXREb2N1bWVudCA9CiAgICAgICAgICAgICAgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgIHZhciBiLAogICAgICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgICAgICBnID0gYSA/IGEub3duZXJEb2N1bWVudCB8fCBhIDogdjsKICAgICAgICAgICAgICAgIHJldHVybiBnICE9PSBuICYmIDkgPT09IGcubm9kZVR5cGUgJiYgZy5kb2N1bWVudEVsZW1lbnQKICAgICAgICAgICAgICAgICAgPyAoKG4gPSBnKSwKICAgICAgICAgICAgICAgICAgICAobyA9IG4uZG9jdW1lbnRFbGVtZW50KSwKICAgICAgICAgICAgICAgICAgICAocCA9ICFmKG4pKSwKICAgICAgICAgICAgICAgICAgICB2ICE9PSBuICYmCiAgICAgICAgICAgICAgICAgICAgICAoZSA9IG4uZGVmYXVsdFZpZXcpICYmCiAgICAgICAgICAgICAgICAgICAgICBlLnRvcCAhPT0gZSAmJgogICAgICAgICAgICAgICAgICAgICAgKGUuYWRkRXZlbnRMaXN0ZW5lciA/IGUuYWRkRXZlbnRMaXN0ZW5lcigidW5sb2FkIiwgZGEsICExKSA6IGUuYXR0YWNoRXZlbnQgJiYgZS5hdHRhY2hFdmVudCgib251bmxvYWQiLCBkYSkpLAogICAgICAgICAgICAgICAgICAgIChjLmF0dHJpYnV0ZXMgPSBqYShmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChhLmNsYXNzTmFtZSA9ICJpIiksICFhLmdldEF0dHJpYnV0ZSgiY2xhc3NOYW1lIik7CiAgICAgICAgICAgICAgICAgICAgfSkpLAogICAgICAgICAgICAgICAgICAgIChjLmdldEVsZW1lbnRzQnlUYWdOYW1lID0gamEoZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhLmFwcGVuZENoaWxkKG4uY3JlYXRlQ29tbWVudCgiIikpLCAhYS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB9KSksCiAgICAgICAgICAgICAgICAgICAgKGMuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9IFkudGVzdChuLmdldEVsZW1lbnRzQnlDbGFzc05hbWUpKSwKICAgICAgICAgICAgICAgICAgICAoYy5nZXRCeUlkID0gamEoZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoby5hcHBlbmRDaGlsZChhKS5pZCA9IHUpLCAhbi5nZXRFbGVtZW50c0J5TmFtZSB8fCAhbi5nZXRFbGVtZW50c0J5TmFtZSh1KS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfSkpLAogICAgICAgICAgICAgICAgICAgIGMuZ2V0QnlJZAogICAgICAgICAgICAgICAgICAgICAgPyAoKGQuZmluZC5JRCA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCJ1bmRlZmluZWQiICE9IHR5cGVvZiBiLmdldEVsZW1lbnRCeUlkICYmIHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjID0gYi5nZXRFbGVtZW50QnlJZChhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjID8gW2NdIDogW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgKGQuZmlsdGVyLklEID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IGEucmVwbGFjZShfLCBhYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IGI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkpCiAgICAgICAgICAgICAgICAgICAgICA6IChkZWxldGUgZC5maW5kLklELAogICAgICAgICAgICAgICAgICAgICAgICAoZC5maWx0ZXIuSUQgPSBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiID0gYS5yZXBsYWNlKF8sIGFhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjID0gInVuZGVmaW5lZCIgIT0gdHlwZW9mIGEuZ2V0QXR0cmlidXRlTm9kZSAmJiBhLmdldEF0dHJpYnV0ZU5vZGUoImlkIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYyAmJiBjLnZhbHVlID09PSBiOwogICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0pKSwKICAgICAgICAgICAgICAgICAgICAoZC5maW5kLlRBRyA9IGMuZ2V0RWxlbWVudHNCeVRhZ05hbWUKICAgICAgICAgICAgICAgICAgICAgID8gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gInVuZGVmaW5lZCIgIT0gdHlwZW9mIGIuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPyBiLmdldEVsZW1lbnRzQnlUYWdOYW1lKGEpIDogYy5xc2EgPyBiLnF1ZXJ5U2VsZWN0b3JBbGwoYSkgOiB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGQgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiA9IGIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCIqIiA9PT0gYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChjID0gZltlKytdKSkgMSA9PT0gYy5ub2RlVHlwZSAmJiBkLnB1c2goYyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZDsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGY7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIChkLmZpbmQuQ0xBU1MgPQogICAgICAgICAgICAgICAgICAgICAgYy5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmCiAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoInVuZGVmaW5lZCIgIT0gdHlwZW9mIGIuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBwKSByZXR1cm4gYi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGEpOwogICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgKHIgPSBbXSksCiAgICAgICAgICAgICAgICAgICAgKHEgPSBbXSksCiAgICAgICAgICAgICAgICAgICAgKGMucXNhID0gWS50ZXN0KG4ucXVlcnlTZWxlY3RvckFsbCkpICYmCiAgICAgICAgICAgICAgICAgICAgICAoamEoZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgKG8uYXBwZW5kQ2hpbGQoYSkuaW5uZXJIVE1MID0KICAgICAgICAgICAgICAgICAgICAgICAgICAiPGEgaWQ9JyIgKyB1ICsgIic+PC9hPjxzZWxlY3QgaWQ9JyIgKyB1ICsgIi1cclxcJyBtc2FsbG93Y2FwdHVyZT0nJz48b3B0aW9uIHNlbGVjdGVkPScnPjwvb3B0aW9uPjwvc2VsZWN0PiIpLAogICAgICAgICAgICAgICAgICAgICAgICAgIGEucXVlcnlTZWxlY3RvckFsbCgiW21zYWxsb3djYXB0dXJlXj0nJ10iKS5sZW5ndGggJiYgcS5wdXNoKCJbKl4kXT0iICsgSyArICIqKD86Jyd8XCJcIikiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICBhLnF1ZXJ5U2VsZWN0b3JBbGwoIltzZWxlY3RlZF0iKS5sZW5ndGggfHwgcS5wdXNoKCJcXFsiICsgSyArICIqKD86dmFsdWV8IiArIEogKyAiKSIpLAogICAgICAgICAgICAgICAgICAgICAgICAgIGEucXVlcnlTZWxlY3RvckFsbCgiW2lkfj0iICsgdSArICItXSIpLmxlbmd0aCB8fCBxLnB1c2goIn49IiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgYS5xdWVyeVNlbGVjdG9yQWxsKCI6Y2hlY2tlZCIpLmxlbmd0aCB8fCBxLnB1c2goIjpjaGVja2VkIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgYS5xdWVyeVNlbGVjdG9yQWxsKCJhIyIgKyB1ICsgIisqIikubGVuZ3RoIHx8IHEucHVzaCgiLiMuK1srfl0iKTsKICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgICAgamEoZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYS5pbm5lckhUTUwgPSAiPGEgaHJlZj0nJyBkaXNhYmxlZD0nZGlzYWJsZWQnPjwvYT48c2VsZWN0IGRpc2FibGVkPSdkaXNhYmxlZCc+PG9wdGlvbi8+PC9zZWxlY3Q+IjsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSBuLmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGIuc2V0QXR0cmlidXRlKCJ0eXBlIiwgImhpZGRlbiIpLAogICAgICAgICAgICAgICAgICAgICAgICAgIGEuYXBwZW5kQ2hpbGQoYikuc2V0QXR0cmlidXRlKCJuYW1lIiwgIkQiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICBhLnF1ZXJ5U2VsZWN0b3JBbGwoIltuYW1lPWRdIikubGVuZ3RoICYmIHEucHVzaCgibmFtZSIgKyBLICsgIipbKl4kfCF+XT89IiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgMiAhPT0gYS5xdWVyeVNlbGVjdG9yQWxsKCI6ZW5hYmxlZCIpLmxlbmd0aCAmJiBxLnB1c2goIjplbmFibGVkIiwgIjpkaXNhYmxlZCIpLAogICAgICAgICAgICAgICAgICAgICAgICAgIChvLmFwcGVuZENoaWxkKGEpLmRpc2FibGVkID0gITApLAogICAgICAgICAgICAgICAgICAgICAgICAgIDIgIT09IGEucXVlcnlTZWxlY3RvckFsbCgiOmRpc2FibGVkIikubGVuZ3RoICYmIHEucHVzaCgiOmVuYWJsZWQiLCAiOmRpc2FibGVkIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgYS5xdWVyeVNlbGVjdG9yQWxsKCIqLDp4IiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgcS5wdXNoKCIsLio6Iik7CiAgICAgICAgICAgICAgICAgICAgICB9KSksCiAgICAgICAgICAgICAgICAgICAgKGMubWF0Y2hlc1NlbGVjdG9yID0gWS50ZXN0KAogICAgICAgICAgICAgICAgICAgICAgKHMgPSBvLm1hdGNoZXMgfHwgby53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgby5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgby5vTWF0Y2hlc1NlbGVjdG9yIHx8IG8ubXNNYXRjaGVzU2VsZWN0b3IpCiAgICAgICAgICAgICAgICAgICAgKSkgJiYKICAgICAgICAgICAgICAgICAgICAgIGphKGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIChjLmRpc2Nvbm5lY3RlZE1hdGNoID0gcy5jYWxsKGEsICIqIikpLCBzLmNhbGwoYSwgIltzIT0nJ106eCIpLCByLnB1c2goIiE9IiwgTik7CiAgICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICAocSA9IHEubGVuZ3RoICYmIG5ldyBSZWdFeHAocS5qb2luKCJ8IikpKSwKICAgICAgICAgICAgICAgICAgICAociA9IHIubGVuZ3RoICYmIG5ldyBSZWdFeHAoci5qb2luKCJ8IikpKSwKICAgICAgICAgICAgICAgICAgICAoYiA9IFkudGVzdChvLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSksCiAgICAgICAgICAgICAgICAgICAgKHQgPQogICAgICAgICAgICAgICAgICAgICAgYiB8fCBZLnRlc3Qoby5jb250YWlucykKICAgICAgICAgICAgICAgICAgICAgICAgPyBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGMgPSA5ID09PSBhLm5vZGVUeXBlID8gYS5kb2N1bWVudEVsZW1lbnQgOiBhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkID0gYiAmJiBiLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhID09PSBkIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICEoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIWQgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICE9PSBkLm5vZGVUeXBlIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIShjLmNvbnRhaW5zID8gYy5jb250YWlucyhkKSA6IGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgMTYgJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGIpIHdoaWxlICgoYiA9IGIucGFyZW50Tm9kZSkpIGlmIChiID09PSBhKSByZXR1cm4gITA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gITE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgKEIgPSBiCiAgICAgICAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGEgPT09IGIpIHJldHVybiAobCA9ICEwKSwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZCA9ICFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIC0gIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAoKGQgPSAoYS5vd25lckRvY3VtZW50IHx8IGEpID09PSAoYi5vd25lckRvY3VtZW50IHx8IGIpID8gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSA6IDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICYgZCB8fCAoIWMuc29ydERldGFjaGVkICYmIGIuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYSkgPT09IGQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBhID09PSBuIHx8IChhLm93bmVyRG9jdW1lbnQgPT09IHYgJiYgdCh2LCBhKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gLTEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogYiA9PT0gbiB8fCAoYi5vd25lckRvY3VtZW50ID09PSB2ICYmIHQodiwgYikpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IDEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBJKGssIGEpIC0gSShrLCBiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiA0ICYgZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gLTEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGEgPT09IGIpIHJldHVybiAobCA9ICEwKSwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGQgPSAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZSA9IGEucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYgPSBiLnBhcmVudE5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnID0gW2FdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaCA9IFtiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWUgfHwgIWYpIHJldHVybiBhID09PSBuID8gLTEgOiBiID09PSBuID8gMSA6IGUgPyAtMSA6IGYgPyAxIDogayA/IEkoaywgYSkgLSBJKGssIGIpIDogMDsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSA9PT0gZikgcmV0dXJuIGxhKGEsIGIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGMgPSBhOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgoYyA9IGMucGFyZW50Tm9kZSkpIGcudW5zaGlmdChjKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBjID0gYjsKICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKGMgPSBjLnBhcmVudE5vZGUpKSBoLnVuc2hpZnQoYyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGdbZF0gPT09IGhbZF0pIGQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZCA/IGxhKGdbZF0sIGhbZF0pIDogZ1tkXSA9PT0gdiA/IC0xIDogaFtkXSA9PT0gdiA/IDEgOiAwOwogICAgICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICBuKQogICAgICAgICAgICAgICAgICA6IG47CiAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgIChnYS5tYXRjaGVzID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2EoYSwgbnVsbCwgbnVsbCwgYik7CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICAoZ2EubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAoKGEub3duZXJEb2N1bWVudCB8fCBhKSAhPT0gbiAmJiBtKGEpLAogICAgICAgICAgICAgICAgKGIgPSBiLnJlcGxhY2UoUywgIj0nJDEnXSIpKSwKICAgICAgICAgICAgICAgIGMubWF0Y2hlc1NlbGVjdG9yICYmIHAgJiYgIUFbYiArICIgIl0gJiYgKCFyIHx8ICFyLnRlc3QoYikpICYmICghcSB8fCAhcS50ZXN0KGIpKSkKICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgZCA9IHMuY2FsbChhLCBiKTsKICAgICAgICAgICAgICAgICAgaWYgKGQgfHwgYy5kaXNjb25uZWN0ZWRNYXRjaCB8fCAoYS5kb2N1bWVudCAmJiAxMSAhPT0gYS5kb2N1bWVudC5ub2RlVHlwZSkpIHJldHVybiBkOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICByZXR1cm4gZ2EoYiwgbiwgbnVsbCwgW2FdKS5sZW5ndGggPiAwOwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgKGdhLmNvbnRhaW5zID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICByZXR1cm4gKGEub3duZXJEb2N1bWVudCB8fCBhKSAhPT0gbiAmJiBtKGEpLCB0KGEsIGIpOwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgKGdhLmF0dHIgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIChhLm93bmVyRG9jdW1lbnQgfHwgYSkgIT09IG4gJiYgbShhKTsKICAgICAgICAgICAgICB2YXIgZSA9IGQuYXR0ckhhbmRsZVtiLnRvTG93ZXJDYXNlKCldLAogICAgICAgICAgICAgICAgZiA9IGUgJiYgQy5jYWxsKGQuYXR0ckhhbmRsZSwgYi50b0xvd2VyQ2FzZSgpKSA/IGUoYSwgYiwgIXApIDogdm9pZCAwOwogICAgICAgICAgICAgIHJldHVybiB2b2lkIDAgIT09IGYgPyBmIDogYy5hdHRyaWJ1dGVzIHx8ICFwID8gYS5nZXRBdHRyaWJ1dGUoYikgOiAoZiA9IGEuZ2V0QXR0cmlidXRlTm9kZShiKSkgJiYgZi5zcGVjaWZpZWQgPyBmLnZhbHVlIDogbnVsbDsKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIChnYS5lc2NhcGUgPSBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiAoYSArICIiKS5yZXBsYWNlKGJhLCBjYSk7CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICAoZ2EuZXJyb3IgPSBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogIiArIGEpOwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgKGdhLnVuaXF1ZVNvcnQgPSBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHZhciBiLAogICAgICAgICAgICAgICAgZCA9IFtdLAogICAgICAgICAgICAgICAgZSA9IDAsCiAgICAgICAgICAgICAgICBmID0gMDsKICAgICAgICAgICAgICBpZiAoKChsID0gIWMuZGV0ZWN0RHVwbGljYXRlcyksIChrID0gIWMuc29ydFN0YWJsZSAmJiBhLnNsaWNlKDApKSwgYS5zb3J0KEIpLCBsKSkgewogICAgICAgICAgICAgICAgd2hpbGUgKChiID0gYVtmKytdKSkgYiA9PT0gYVtmXSAmJiAoZSA9IGQucHVzaChmKSk7CiAgICAgICAgICAgICAgICB3aGlsZSAoZS0tKSBhLnNwbGljZShkW2VdLCAxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIChrID0gbnVsbCksIGE7CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICAoZSA9IGdhLmdldFRleHQgPQogICAgICAgICAgICAgIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICB2YXIgYiwKICAgICAgICAgICAgICAgICAgYyA9ICIiLAogICAgICAgICAgICAgICAgICBkID0gMCwKICAgICAgICAgICAgICAgICAgZiA9IGEubm9kZVR5cGU7CiAgICAgICAgICAgICAgICBpZiAoZikgewogICAgICAgICAgICAgICAgICBpZiAoMSA9PT0gZiB8fCA5ID09PSBmIHx8IDExID09PSBmKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCJzdHJpbmciID09IHR5cGVvZiBhLnRleHRDb250ZW50KSByZXR1cm4gYS50ZXh0Q29udGVudDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGEgPSBhLmZpcnN0Q2hpbGQ7IGE7IGEgPSBhLm5leHRTaWJsaW5nKSBjICs9IGUoYSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoMyA9PT0gZiB8fCA0ID09PSBmKSByZXR1cm4gYS5ub2RlVmFsdWU7CiAgICAgICAgICAgICAgICB9IGVsc2Ugd2hpbGUgKChiID0gYVtkKytdKSkgYyArPSBlKGIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgIChkID0gZ2Euc2VsZWN0b3JzID0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjYWNoZUxlbmd0aDogNTAsCiAgICAgICAgICAgICAgICBjcmVhdGVQc2V1ZG86IGlhLAogICAgICAgICAgICAgICAgbWF0Y2g6IFYsCiAgICAgICAgICAgICAgICBhdHRySGFuZGxlOiB7fSwKICAgICAgICAgICAgICAgIGZpbmQ6IHt9LAogICAgICAgICAgICAgICAgcmVsYXRpdmU6IHsKICAgICAgICAgICAgICAgICAgIj4iOiB7IGRpcjogInBhcmVudE5vZGUiLCBmaXJzdDogITAgfSwKICAgICAgICAgICAgICAgICAgIiAiOiB7IGRpcjogInBhcmVudE5vZGUiIH0sCiAgICAgICAgICAgICAgICAgICIrIjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciLCBmaXJzdDogITAgfSwKICAgICAgICAgICAgICAgICAgIn4iOiB7IGRpcjogInByZXZpb3VzU2libGluZyIgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwcmVGaWx0ZXI6IHsKICAgICAgICAgICAgICAgICAgQVRUUjogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgKGFbMV0gPSBhWzFdLnJlcGxhY2UoXywgYWEpKSwKICAgICAgICAgICAgICAgICAgICAgIChhWzNdID0gKGFbM10gfHwgYVs0XSB8fCBhWzVdIHx8ICIiKS5yZXBsYWNlKF8sIGFhKSksCiAgICAgICAgICAgICAgICAgICAgICAifj0iID09PSBhWzJdICYmIChhWzNdID0gIiAiICsgYVszXSArICIgIiksCiAgICAgICAgICAgICAgICAgICAgICBhLnNsaWNlKDAsIDQpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgQ0hJTEQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgIChhWzFdID0gYVsxXS50b0xvd2VyQ2FzZSgpKSwKICAgICAgICAgICAgICAgICAgICAgICJudGgiID09PSBhWzFdLnNsaWNlKDAsIDMpCiAgICAgICAgICAgICAgICAgICAgICAgID8gKGFbM10gfHwgZ2EuZXJyb3IoYVswXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgKGFbNF0gPSArKGFbNF0gPyBhWzVdICsgKGFbNl0gfHwgMSkgOiAyICogKCJldmVuIiA9PT0gYVszXSB8fCAib2RkIiA9PT0gYVszXSkpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAoYVs1XSA9ICsoYVs3XSArIGFbOF0gfHwgIm9kZCIgPT09IGFbM10pKSkKICAgICAgICAgICAgICAgICAgICAgICAgOiBhWzNdICYmIGdhLmVycm9yKGFbMF0pLAogICAgICAgICAgICAgICAgICAgICAgYQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIFBTRVVETzogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYiwKICAgICAgICAgICAgICAgICAgICAgIGMgPSAhYVs2XSAmJiBhWzJdOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBWLkNISUxELnRlc3QoYVswXSkKICAgICAgICAgICAgICAgICAgICAgID8gbnVsbAogICAgICAgICAgICAgICAgICAgICAgOiAoYVszXQogICAgICAgICAgICAgICAgICAgICAgICAgID8gKGFbMl0gPSBhWzRdIHx8IGFbNV0gfHwgIiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiBjICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBULnRlc3QoYykgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChiID0gZyhjLCAhMCkpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYiA9IGMuaW5kZXhPZigiKSIsIGMubGVuZ3RoIC0gYikgLSBjLmxlbmd0aCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICgoYVswXSA9IGFbMF0uc2xpY2UoMCwgYikpLCAoYVsyXSA9IGMuc2xpY2UoMCwgYikpKSwKICAgICAgICAgICAgICAgICAgICAgICAgYS5zbGljZSgwLCAzKSk7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZmlsdGVyOiB7CiAgICAgICAgICAgICAgICAgIFRBRzogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IGEucmVwbGFjZShfLCBhYSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIioiID09PSBhCiAgICAgICAgICAgICAgICAgICAgICA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gITA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5ub2RlTmFtZSAmJiBhLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IGI7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIENMQVNTOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIHZhciBiID0geVthICsgIiAiXTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgYiB8fAogICAgICAgICAgICAgICAgICAgICAgKChiID0gbmV3IFJlZ0V4cCgiKF58IiArIEsgKyAiKSIgKyBhICsgIigiICsgSyArICJ8JCkiKSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgeShhLCBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBiLnRlc3QoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoInN0cmluZyIgPT0gdHlwZW9mIGEuY2xhc3NOYW1lICYmIGEuY2xhc3NOYW1lKSB8fCAoInVuZGVmaW5lZCIgIT0gdHlwZW9mIGEuZ2V0QXR0cmlidXRlICYmIGEuZ2V0QXR0cmlidXRlKCJjbGFzcyIpKSB8fCAiIgogICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIEFUVFI6IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChkKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZSA9IGdhLmF0dHIoZCwgYSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbCA9PSBlCiAgICAgICAgICAgICAgICAgICAgICAgID8gIiE9IiA9PT0gYgogICAgICAgICAgICAgICAgICAgICAgICA6ICFiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKGUgKz0gIiIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIj0iID09PSBiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZSA9PT0gYwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICIhPSIgPT09IGIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBlICE9PSBjCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogIl49IiA9PT0gYgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGMgJiYgMCA9PT0gZS5pbmRleE9mKGMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogIio9IiA9PT0gYgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGMgJiYgZS5pbmRleE9mKGMpID4gLTEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAiJD0iID09PSBiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYyAmJiBlLnNsaWNlKC1jLmxlbmd0aCkgPT09IGMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAifj0iID09PSBiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gKCIgIiArIGUucmVwbGFjZShPLCAiICIpICsgIiAiKS5pbmRleE9mKGMpID4gLTEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAifD0iID09PSBiICYmIChlID09PSBjIHx8IGUuc2xpY2UoMCwgYy5sZW5ndGggKyAxKSA9PT0gYyArICItIikpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIENISUxEOiBmdW5jdGlvbiAoYSwgYiwgYywgZCwgZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBmID0gIm50aCIgIT09IGEuc2xpY2UoMCwgMyksCiAgICAgICAgICAgICAgICAgICAgICBnID0gImxhc3QiICE9PSBhLnNsaWNlKC00KSwKICAgICAgICAgICAgICAgICAgICAgIGggPSAib2YtdHlwZSIgPT09IGI7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEgPT09IGQgJiYgMCA9PT0gZQogICAgICAgICAgICAgICAgICAgICAgPyBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIWEucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgOiBmdW5jdGlvbiAoYiwgYywgaSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwID0gZiAhPT0gZyA/ICJuZXh0U2libGluZyIgOiAicHJldmlvdXNTaWJsaW5nIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHEgPSBiLnBhcmVudE5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByID0gaCAmJiBiLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gIWkgJiYgIWgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ID0gITE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbSA9IGI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChtID0gbVtwXSkpIGlmIChoID8gbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSByIDogMSA9PT0gbS5ub2RlVHlwZSkgcmV0dXJuICExOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8gPSBwID0gIm9ubHkiID09PSBhICYmICFvICYmICJuZXh0U2libGluZyI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCgobyA9IFtnID8gcS5maXJzdENoaWxkIDogcS5sYXN0Q2hpbGRdKSwgZyAmJiBzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAobSA9IHEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChsID0gbVt1XSB8fCAobVt1XSA9IHt9KSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGsgPSBsW20udW5pcXVlSURdIHx8IChsW20udW5pcXVlSURdID0ge30pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoaiA9IGtbYV0gfHwgW10pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChuID0galswXSA9PT0gdyAmJiBqWzFdKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodCA9IG4gJiYgalsyXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG0gPSBuICYmIHEuY2hpbGROb2Rlc1tuXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgobSA9ICgrK24gJiYgbSAmJiBtW3BdKSB8fCAodCA9IG4gPSAwKSB8fCBvLnBvcCgpKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoMSA9PT0gbS5ub2RlVHlwZSAmJiArK3QgJiYgbSA9PT0gYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga1thXSA9IFt3LCBuLCB0XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChzICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKChtID0gYiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGwgPSBtW3VdIHx8IChtW3VdID0ge30pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoayA9IGxbbS51bmlxdWVJRF0gfHwgKGxbbS51bmlxdWVJRF0gPSB7fSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChqID0ga1thXSB8fCBbXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG4gPSBqWzBdID09PSB3ICYmIGpbMV0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0ID0gbikpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ID09PSAhMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChtID0gKCsrbiAmJiBtICYmIG1bcF0pIHx8ICh0ID0gbiA9IDApIHx8IG8ucG9wKCkpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChoID8gbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSByIDogMSA9PT0gbS5ub2RlVHlwZSkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsrdCAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHMgJiYgKChsID0gbVt1XSB8fCAobVt1XSA9IHt9KSksIChrID0gbFttLnVuaXF1ZUlEXSB8fCAobFttLnVuaXF1ZUlEXSA9IHt9KSksIChrW2FdID0gW3csIHRdKSksIG0gPT09IGIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHQgLT0gZSksIHQgPT09IGQgfHwgKHQgJSBkID09PSAwICYmIHQgLyBkID49IDApOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgUFNFVURPOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgIHZhciBjLAogICAgICAgICAgICAgICAgICAgICAgZSA9IGQucHNldWRvc1thXSB8fCBkLnNldEZpbHRlcnNbYS50b0xvd2VyQ2FzZSgpXSB8fCBnYS5lcnJvcigidW5zdXBwb3J0ZWQgcHNldWRvOiAiICsgYSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVbdV0KICAgICAgICAgICAgICAgICAgICAgID8gZShiKQogICAgICAgICAgICAgICAgICAgICAgOiBlLmxlbmd0aCA+IDEKICAgICAgICAgICAgICAgICAgICAgID8gKChjID0gW2EsIGEsICIiLCBiXSksCiAgICAgICAgICAgICAgICAgICAgICAgIGQuc2V0RmlsdGVycy5oYXNPd25Qcm9wZXJ0eShhLnRvTG93ZXJDYXNlKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBpYShmdW5jdGlvbiAoYSwgYykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmID0gZShhLCBiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnID0gZi5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChnLS0pIChkID0gSShhLCBmW2ddKSksIChhW2RdID0gIShjW2RdID0gZltnXSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlKGEsIDAsIGMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgIDogZTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwc2V1ZG9zOiB7CiAgICAgICAgICAgICAgICAgIG5vdDogaWEoZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgYyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgZCA9IGgoYS5yZXBsYWNlKFAsICIkMSIpKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZFt1XQogICAgICAgICAgICAgICAgICAgICAgPyBpYShmdW5jdGlvbiAoYSwgYiwgYywgZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZyA9IGQoYSwgbnVsbCwgZSwgW10pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaCA9IGEubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChoLS0pIChmID0gZ1toXSkgJiYgKGFbaF0gPSAhKGJbaF0gPSBmKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uIChhLCBlLCBmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChiWzBdID0gYSksIGQoYiwgbnVsbCwgZiwgYyksIChiWzBdID0gbnVsbCksICFjLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgaGFzOiBpYShmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdhKGEsIGIpLmxlbmd0aCA+IDA7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgIGNvbnRhaW5zOiBpYShmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAoYSA9IGEucmVwbGFjZShfLCBhYSkpLAogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChiLnRleHRDb250ZW50IHx8IGIuaW5uZXJUZXh0IHx8IGUoYikpLmluZGV4T2YoYSkgPiAtMTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgbGFuZzogaWEoZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgVS50ZXN0KGEgfHwgIiIpIHx8IGdhLmVycm9yKCJ1bnN1cHBvcnRlZCBsYW5nOiAiICsgYSksCiAgICAgICAgICAgICAgICAgICAgICAoYSA9IGEucmVwbGFjZShfLCBhYSkudG9Mb3dlckNhc2UoKSksCiAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYzsKICAgICAgICAgICAgICAgICAgICAgICAgZG8KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGMgPSBwID8gYi5sYW5nIDogYi5nZXRBdHRyaWJ1dGUoInhtbDpsYW5nIikgfHwgYi5nZXRBdHRyaWJ1dGUoImxhbmciKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGMgPSBjLnRvTG93ZXJDYXNlKCkpLCBjID09PSBhIHx8IDAgPT09IGMuaW5kZXhPZihhICsgIi0iKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChiID0gYi5wYXJlbnROb2RlKSAmJiAxID09PSBiLm5vZGVUeXBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICExOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICB0YXJnZXQ6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGMgPSBhLmxvY2F0aW9uICYmIGEubG9jYXRpb24uaGFzaDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYyAmJiBjLnNsaWNlKDEpID09PSBiLmlkOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICByb290OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBvOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBmb2N1czogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gbi5hY3RpdmVFbGVtZW50ICYmICghbi5oYXNGb2N1cyB8fCBuLmhhc0ZvY3VzKCkpICYmICEhKGEudHlwZSB8fCBhLmhyZWYgfHwgfmEudGFiSW5kZXgpOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBlbmFibGVkOiBvYSghMSksCiAgICAgICAgICAgICAgICAgIGRpc2FibGVkOiBvYSghMCksCiAgICAgICAgICAgICAgICAgIGNoZWNrZWQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSBhLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgiaW5wdXQiID09PSBiICYmICEhYS5jaGVja2VkKSB8fCAoIm9wdGlvbiIgPT09IGIgJiYgISFhLnNlbGVjdGVkKTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEucGFyZW50Tm9kZSAmJiBhLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleCwgYS5zZWxlY3RlZCA9PT0gITA7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGVtcHR5OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIGZvciAoYSA9IGEuZmlyc3RDaGlsZDsgYTsgYSA9IGEubmV4dFNpYmxpbmcpIGlmIChhLm5vZGVUeXBlIDwgNikgcmV0dXJuICExOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAhMDsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgcGFyZW50OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhZC5wc2V1ZG9zLmVtcHR5KGEpOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBoZWFkZXI6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFgudGVzdChhLm5vZGVOYW1lKTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgaW5wdXQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFcudGVzdChhLm5vZGVOYW1lKTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgYnV0dG9uOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIHZhciBiID0gYS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAoImlucHV0IiA9PT0gYiAmJiAiYnV0dG9uIiA9PT0gYS50eXBlKSB8fCAiYnV0dG9uIiA9PT0gYjsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgdGV4dDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYjsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgImlucHV0IiA9PT0gYS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICYmCiAgICAgICAgICAgICAgICAgICAgICAidGV4dCIgPT09IGEudHlwZSAmJgogICAgICAgICAgICAgICAgICAgICAgKG51bGwgPT0gKGIgPSBhLmdldEF0dHJpYnV0ZSgidHlwZSIpKSB8fCAidGV4dCIgPT09IGIudG9Mb3dlckNhc2UoKSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBmaXJzdDogcGEoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBbMF07CiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICBsYXN0OiBwYShmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBbYiAtIDFdOwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgZXE6IHBhKGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtjIDwgMCA/IGMgKyBiIDogY107CiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICBldmVuOiBwYShmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGMgPSAwOyBjIDwgYjsgYyArPSAyKSBhLnB1c2goYyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGE7CiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICBvZGQ6IHBhKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYyA9IDE7IGMgPCBiOyBjICs9IDIpIGEucHVzaChjKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgIGx0OiBwYShmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGQgPSBjIDwgMCA/IGMgKyBiIDogYzsgLS1kID49IDA7ICkgYS5wdXNoKGQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgZ3Q6IHBhKGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZCA9IGMgPCAwID8gYyArIGIgOiBjOyArK2QgPCBiOyApIGEucHVzaChkKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAoZC5wc2V1ZG9zLm50aCA9IGQucHNldWRvcy5lcSk7CiAgICAgICAgICBmb3IgKGIgaW4gewogICAgICAgICAgICByYWRpbzogITAsCiAgICAgICAgICAgIGNoZWNrYm94OiAhMCwKICAgICAgICAgICAgZmlsZTogITAsCiAgICAgICAgICAgIHBhc3N3b3JkOiAhMCwKICAgICAgICAgICAgaW1hZ2U6ICEwLAogICAgICAgICAgfSkKICAgICAgICAgICAgZC5wc2V1ZG9zW2JdID0gbWEoYik7CiAgICAgICAgICBmb3IgKGIgaW4geyBzdWJtaXQ6ICEwLCByZXNldDogITAgfSkgZC5wc2V1ZG9zW2JdID0gbmEoYik7CiAgICAgICAgICBmdW5jdGlvbiByYSgpIHt9CiAgICAgICAgICAocmEucHJvdG90eXBlID0gZC5maWx0ZXJzID0gZC5wc2V1ZG9zKSwKICAgICAgICAgICAgKGQuc2V0RmlsdGVycyA9IG5ldyByYSgpKSwKICAgICAgICAgICAgKGcgPSBnYS50b2tlbml6ZSA9CiAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIHZhciBjLAogICAgICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgICAgICBmLAogICAgICAgICAgICAgICAgICBnLAogICAgICAgICAgICAgICAgICBoLAogICAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgICBqLAogICAgICAgICAgICAgICAgICBrID0gelthICsgIiAiXTsKICAgICAgICAgICAgICAgIGlmIChrKSByZXR1cm4gYiA/IDAgOiBrLnNsaWNlKDApOwogICAgICAgICAgICAgICAgKGggPSBhKSwgKGkgPSBbXSksIChqID0gZC5wcmVGaWx0ZXIpOwogICAgICAgICAgICAgICAgd2hpbGUgKGgpIHsKICAgICAgICAgICAgICAgICAgKGMgJiYgIShlID0gUS5leGVjKGgpKSkgfHwgKGUgJiYgKGggPSBoLnNsaWNlKGVbMF0ubGVuZ3RoKSB8fCBoKSwgaS5wdXNoKChmID0gW10pKSksCiAgICAgICAgICAgICAgICAgICAgKGMgPSAhMSksCiAgICAgICAgICAgICAgICAgICAgKGUgPSBSLmV4ZWMoaCkpICYmICgoYyA9IGUuc2hpZnQoKSksIGYucHVzaCh7IHZhbHVlOiBjLCB0eXBlOiBlWzBdLnJlcGxhY2UoUCwgIiAiKSB9KSwgKGggPSBoLnNsaWNlKGMubGVuZ3RoKSkpOwogICAgICAgICAgICAgICAgICBmb3IgKGcgaW4gZC5maWx0ZXIpCiAgICAgICAgICAgICAgICAgICAgIShlID0gVltnXS5leGVjKGgpKSB8fAogICAgICAgICAgICAgICAgICAgICAgKGpbZ10gJiYgIShlID0galtnXShlKSkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAoKGMgPSBlLnNoaWZ0KCkpLCBmLnB1c2goeyB2YWx1ZTogYywgdHlwZTogZywgbWF0Y2hlczogZSB9KSwgKGggPSBoLnNsaWNlKGMubGVuZ3RoKSkpOwogICAgICAgICAgICAgICAgICBpZiAoIWMpIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGIgPyBoLmxlbmd0aCA6IGggPyBnYS5lcnJvcihhKSA6IHooYSwgaSkuc2xpY2UoMCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICBmdW5jdGlvbiBzYShhKSB7CiAgICAgICAgICAgIGZvciAodmFyIGIgPSAwLCBjID0gYS5sZW5ndGgsIGQgPSAiIjsgYiA8IGM7IGIrKykgZCArPSBhW2JdLnZhbHVlOwogICAgICAgICAgICByZXR1cm4gZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHRhKGEsIGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSBiLmRpciwKICAgICAgICAgICAgICBlID0gYi5uZXh0LAogICAgICAgICAgICAgIGYgPSBlIHx8IGQsCiAgICAgICAgICAgICAgZyA9IGMgJiYgInBhcmVudE5vZGUiID09PSBmLAogICAgICAgICAgICAgIGggPSB4Kys7CiAgICAgICAgICAgIHJldHVybiBiLmZpcnN0CiAgICAgICAgICAgICAgPyBmdW5jdGlvbiAoYiwgYywgZSkgewogICAgICAgICAgICAgICAgICB3aGlsZSAoKGIgPSBiW2RdKSkgaWYgKDEgPT09IGIubm9kZVR5cGUgfHwgZykgcmV0dXJuIGEoYiwgYywgZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgOiBmdW5jdGlvbiAoYiwgYywgaSkgewogICAgICAgICAgICAgICAgICB2YXIgaiwKICAgICAgICAgICAgICAgICAgICBrLAogICAgICAgICAgICAgICAgICAgIGwsCiAgICAgICAgICAgICAgICAgICAgbSA9IFt3LCBoXTsKICAgICAgICAgICAgICAgICAgaWYgKGkpIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKGIgPSBiW2RdKSkgaWYgKCgxID09PSBiLm5vZGVUeXBlIHx8IGcpICYmIGEoYiwgYywgaSkpIHJldHVybiAhMDsKICAgICAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChiID0gYltkXSkpCiAgICAgICAgICAgICAgICAgICAgICBpZiAoMSA9PT0gYi5ub2RlVHlwZSB8fCBnKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKChsID0gYlt1XSB8fCAoYlt1XSA9IHt9KSksIChrID0gbFtiLnVuaXF1ZUlEXSB8fCAobFtiLnVuaXF1ZUlEXSA9IHt9KSksIGUgJiYgZSA9PT0gYi5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSkKICAgICAgICAgICAgICAgICAgICAgICAgICBiID0gYltkXSB8fCBiOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGogPSBrW2ZdKSAmJiBqWzBdID09PSB3ICYmIGpbMV0gPT09IGgpIHJldHVybiAobVsyXSA9IGpbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoKGtbZl0gPSBtKSwgKG1bMl0gPSBhKGIsIGMsIGkpKSkpIHJldHVybiAhMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVhKGEpIHsKICAgICAgICAgICAgcmV0dXJuIGEubGVuZ3RoID4gMQogICAgICAgICAgICAgID8gZnVuY3Rpb24gKGIsIGMsIGQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGUgPSBhLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGUtLSkgaWYgKCFhW2VdKGIsIGMsIGQpKSByZXR1cm4gITE7CiAgICAgICAgICAgICAgICAgIHJldHVybiAhMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICA6IGFbMF07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB2YShhLCBiLCBjKSB7CiAgICAgICAgICAgIGZvciAodmFyIGQgPSAwLCBlID0gYi5sZW5ndGg7IGQgPCBlOyBkKyspIGdhKGEsIGJbZF0sIGMpOwogICAgICAgICAgICByZXR1cm4gYzsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhKGEsIGIsIGMsIGQsIGUpIHsKICAgICAgICAgICAgZm9yICh2YXIgZiwgZyA9IFtdLCBoID0gMCwgaSA9IGEubGVuZ3RoLCBqID0gbnVsbCAhPSBiOyBoIDwgaTsgaCsrKSAoZiA9IGFbaF0pICYmICgoYyAmJiAhYyhmLCBkLCBlKSkgfHwgKGcucHVzaChmKSwgaiAmJiBiLnB1c2goaCkpKTsKICAgICAgICAgICAgcmV0dXJuIGc7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB4YShhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgZCAmJiAhZFt1XSAmJiAoZCA9IHhhKGQpKSwKICAgICAgICAgICAgICBlICYmICFlW3VdICYmIChlID0geGEoZSwgZikpLAogICAgICAgICAgICAgIGlhKGZ1bmN0aW9uIChmLCBnLCBoLCBpKSB7CiAgICAgICAgICAgICAgICB2YXIgaiwKICAgICAgICAgICAgICAgICAgaywKICAgICAgICAgICAgICAgICAgbCwKICAgICAgICAgICAgICAgICAgbSA9IFtdLAogICAgICAgICAgICAgICAgICBuID0gW10sCiAgICAgICAgICAgICAgICAgIG8gPSBnLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgcCA9IGYgfHwgdmEoYiB8fCAiKiIsIGgubm9kZVR5cGUgPyBbaF0gOiBoLCBbXSksCiAgICAgICAgICAgICAgICAgIHEgPSAhYSB8fCAoIWYgJiYgYikgPyBwIDogd2EocCwgbSwgYSwgaCwgaSksCiAgICAgICAgICAgICAgICAgIHIgPSBjID8gKGUgfHwgKGYgPyBhIDogbyB8fCBkKSA/IFtdIDogZykgOiBxOwogICAgICAgICAgICAgICAgaWYgKChjICYmIGMocSwgciwgaCwgaSksIGQpKSB7CiAgICAgICAgICAgICAgICAgIChqID0gd2EociwgbikpLCBkKGosIFtdLCBoLCBpKSwgKGsgPSBqLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChrLS0pIChsID0galtrXSkgJiYgKHJbbltrXV0gPSAhKHFbbltrXV0gPSBsKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZikgewogICAgICAgICAgICAgICAgICBpZiAoZSB8fCBhKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGUpIHsKICAgICAgICAgICAgICAgICAgICAgIChqID0gW10pLCAoayA9IHIubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChrLS0pIChsID0gcltrXSkgJiYgai5wdXNoKChxW2tdID0gbCkpOwogICAgICAgICAgICAgICAgICAgICAgZShudWxsLCAociA9IFtdKSwgaiwgaSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGsgPSByLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoay0tKSAobCA9IHJba10pICYmIChqID0gZSA/IEkoZiwgbCkgOiBtW2tdKSA+IC0xICYmIChmW2pdID0gIShnW2pdID0gbCkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgKHIgPSB3YShyID09PSBnID8gci5zcGxpY2Uobywgci5sZW5ndGgpIDogcikpLCBlID8gZShudWxsLCBnLCByLCBpKSA6IEcuYXBwbHkoZywgcik7CiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHlhKGEpIHsKICAgICAgICAgICAgZm9yICgKICAgICAgICAgICAgICB2YXIgYiwKICAgICAgICAgICAgICAgIGMsCiAgICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgICAgZiA9IGEubGVuZ3RoLAogICAgICAgICAgICAgICAgZyA9IGQucmVsYXRpdmVbYVswXS50eXBlXSwKICAgICAgICAgICAgICAgIGggPSBnIHx8IGQucmVsYXRpdmVbIiAiXSwKICAgICAgICAgICAgICAgIGkgPSBnID8gMSA6IDAsCiAgICAgICAgICAgICAgICBrID0gdGEoCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGgsCiAgICAgICAgICAgICAgICAgICEwCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgbCA9IHRhKAogICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBJKGIsIGEpID4gLTE7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGgsCiAgICAgICAgICAgICAgICAgICEwCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgbSA9IFsKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGMsIGQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZSA9ICghZyAmJiAoZCB8fCBjICE9PSBqKSkgfHwgKChiID0gYykubm9kZVR5cGUgPyBrKGEsIGMsIGQpIDogbChhLCBjLCBkKSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChiID0gbnVsbCksIGU7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgIGkgPCBmOwogICAgICAgICAgICAgIGkrKwogICAgICAgICAgICApCiAgICAgICAgICAgICAgaWYgKChjID0gZC5yZWxhdGl2ZVthW2ldLnR5cGVdKSkgbSA9IFt0YSh1YShtKSwgYyldOwogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCgoYyA9IGQuZmlsdGVyW2FbaV0udHlwZV0uYXBwbHkobnVsbCwgYVtpXS5tYXRjaGVzKSksIGNbdV0pKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoZSA9ICsraTsgZSA8IGY7IGUrKykgaWYgKGQucmVsYXRpdmVbYVtlXS50eXBlXSkgYnJlYWs7CiAgICAgICAgICAgICAgICAgIHJldHVybiB4YSgKICAgICAgICAgICAgICAgICAgICBpID4gMSAmJiB1YShtKSwKICAgICAgICAgICAgICAgICAgICBpID4gMSAmJiBzYShhLnNsaWNlKDAsIGkgLSAxKS5jb25jYXQoeyB2YWx1ZTogIiAiID09PSBhW2kgLSAyXS50eXBlID8gIioiIDogIiIgfSkpLnJlcGxhY2UoUCwgIiQxIiksCiAgICAgICAgICAgICAgICAgICAgYywKICAgICAgICAgICAgICAgICAgICBpIDwgZSAmJiB5YShhLnNsaWNlKGksIGUpKSwKICAgICAgICAgICAgICAgICAgICBlIDwgZiAmJiB5YSgoYSA9IGEuc2xpY2UoZSkpKSwKICAgICAgICAgICAgICAgICAgICBlIDwgZiAmJiBzYShhKQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbS5wdXNoKGMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVhKG0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gemEoYSwgYikgewogICAgICAgICAgICB2YXIgYyA9IGIubGVuZ3RoID4gMCwKICAgICAgICAgICAgICBlID0gYS5sZW5ndGggPiAwLAogICAgICAgICAgICAgIGYgPSBmdW5jdGlvbiAoZiwgZywgaCwgaSwgaykgewogICAgICAgICAgICAgICAgdmFyIGwsCiAgICAgICAgICAgICAgICAgIG8sCiAgICAgICAgICAgICAgICAgIHEsCiAgICAgICAgICAgICAgICAgIHIgPSAwLAogICAgICAgICAgICAgICAgICBzID0gIjAiLAogICAgICAgICAgICAgICAgICB0ID0gZiAmJiBbXSwKICAgICAgICAgICAgICAgICAgdSA9IFtdLAogICAgICAgICAgICAgICAgICB2ID0gaiwKICAgICAgICAgICAgICAgICAgeCA9IGYgfHwgKGUgJiYgZC5maW5kLlRBRygiKiIsIGspKSwKICAgICAgICAgICAgICAgICAgeSA9ICh3ICs9IG51bGwgPT0gdiA/IDEgOiBNYXRoLnJhbmRvbSgpIHx8IDAuMSksCiAgICAgICAgICAgICAgICAgIHogPSB4Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvciAoayAmJiAoaiA9IGcgPT09IG4gfHwgZyB8fCBrKTsgcyAhPT0geiAmJiBudWxsICE9IChsID0geFtzXSk7IHMrKykgewogICAgICAgICAgICAgICAgICBpZiAoZSAmJiBsKSB7CiAgICAgICAgICAgICAgICAgICAgKG8gPSAwKSwgZyB8fCBsLm93bmVyRG9jdW1lbnQgPT09IG4gfHwgKG0obCksIChoID0gIXApKTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKHEgPSBhW28rK10pKQogICAgICAgICAgICAgICAgICAgICAgaWYgKHEobCwgZyB8fCBuLCBoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpLnB1c2gobCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGsgJiYgKHcgPSB5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjICYmICgobCA9ICFxICYmIGwpICYmIHItLSwgZiAmJiB0LnB1c2gobCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCgociArPSBzKSwgYyAmJiBzICE9PSByKSkgewogICAgICAgICAgICAgICAgICBvID0gMDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKChxID0gYltvKytdKSkgcSh0LCB1LCBnLCBoKTsKICAgICAgICAgICAgICAgICAgaWYgKGYpIHsKICAgICAgICAgICAgICAgICAgICBpZiAociA+IDApIHdoaWxlIChzLS0pIHRbc10gfHwgdVtzXSB8fCAodVtzXSA9IEUuY2FsbChpKSk7CiAgICAgICAgICAgICAgICAgICAgdSA9IHdhKHUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIEcuYXBwbHkoaSwgdSksIGsgJiYgIWYgJiYgdS5sZW5ndGggPiAwICYmIHIgKyBiLmxlbmd0aCA+IDEgJiYgZ2EudW5pcXVlU29ydChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBrICYmICgodyA9IHkpLCAoaiA9IHYpKSwgdDsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gYyA/IGlhKGYpIDogZjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIChoID0gZ2EuY29tcGlsZSA9CiAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIHZhciBjLAogICAgICAgICAgICAgICAgICBkID0gW10sCiAgICAgICAgICAgICAgICAgIGUgPSBbXSwKICAgICAgICAgICAgICAgICAgZiA9IEFbYSArICIgIl07CiAgICAgICAgICAgICAgICBpZiAoIWYpIHsKICAgICAgICAgICAgICAgICAgYiB8fCAoYiA9IGcoYSkpLCAoYyA9IGIubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGMtLSkgKGYgPSB5YShiW2NdKSksIGZbdV0gPyBkLnB1c2goZikgOiBlLnB1c2goZik7CiAgICAgICAgICAgICAgICAgIChmID0gQShhLCB6YShlLCBkKSkpLCAoZi5zZWxlY3RvciA9IGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGY7CiAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgIChpID0gZ2Euc2VsZWN0ID0KICAgICAgICAgICAgICBmdW5jdGlvbiAoYSwgYiwgZSwgZikgewogICAgICAgICAgICAgICAgdmFyIGksCiAgICAgICAgICAgICAgICAgIGosCiAgICAgICAgICAgICAgICAgIGssCiAgICAgICAgICAgICAgICAgIGwsCiAgICAgICAgICAgICAgICAgIG0sCiAgICAgICAgICAgICAgICAgIG4gPSAiZnVuY3Rpb24iID09IHR5cGVvZiBhICYmIGEsCiAgICAgICAgICAgICAgICAgIG8gPSAhZiAmJiBnKChhID0gbi5zZWxlY3RvciB8fCBhKSk7CiAgICAgICAgICAgICAgICBpZiAoKChlID0gZSB8fCBbXSksIDEgPT09IG8ubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgKChqID0gb1swXSA9IG9bMF0uc2xpY2UoMCkpLAogICAgICAgICAgICAgICAgICAgIGoubGVuZ3RoID4gMiAmJiAiSUQiID09PSAoayA9IGpbMF0pLnR5cGUgJiYgYy5nZXRCeUlkICYmIDkgPT09IGIubm9kZVR5cGUgJiYgcCAmJiBkLnJlbGF0aXZlW2pbMV0udHlwZV0pCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIGlmICgoKGIgPSAoZC5maW5kLklEKGsubWF0Y2hlc1swXS5yZXBsYWNlKF8sIGFhKSwgYikgfHwgW10pWzBdKSwgIWIpKSByZXR1cm4gZTsKICAgICAgICAgICAgICAgICAgICBuICYmIChiID0gYi5wYXJlbnROb2RlKSwgKGEgPSBhLnNsaWNlKGouc2hpZnQoKS52YWx1ZS5sZW5ndGgpKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpID0gVi5uZWVkc0NvbnRleHQudGVzdChhKSA/IDAgOiBqLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgICAgIGlmICgoKGsgPSBqW2ldKSwgZC5yZWxhdGl2ZVsobCA9IGsudHlwZSldKSkgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgaWYgKChtID0gZC5maW5kW2xdKSAmJiAoZiA9IG0oay5tYXRjaGVzWzBdLnJlcGxhY2UoXywgYWEpLCAoJC50ZXN0KGpbMF0udHlwZSkgJiYgcWEoYi5wYXJlbnROb2RlKSkgfHwgYikpKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoKGouc3BsaWNlKGksIDEpLCAoYSA9IGYubGVuZ3RoICYmIHNhKGopKSwgIWEpKSByZXR1cm4gRy5hcHBseShlLCBmKSwgZTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIChuIHx8IGgoYSwgbykpKGYsIGIsICFwLCBlLCAhYiB8fCAoJC50ZXN0KGEpICYmIHFhKGIucGFyZW50Tm9kZSkpIHx8IGIpLCBlOwogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAoYy5zb3J0U3RhYmxlID0gdS5zcGxpdCgiIikuc29ydChCKS5qb2luKCIiKSA9PT0gdSksCiAgICAgICAgICAgIChjLmRldGVjdER1cGxpY2F0ZXMgPSAhIWwpLAogICAgICAgICAgICBtKCksCiAgICAgICAgICAgIChjLnNvcnREZXRhY2hlZCA9IGphKGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDEgJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG4uY3JlYXRlRWxlbWVudCgiZmllbGRzZXQiKSk7CiAgICAgICAgICAgIH0pKSwKICAgICAgICAgICAgamEoZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gKGEuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iKSwgIiMiID09PSBhLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIik7CiAgICAgICAgICAgIH0pIHx8CiAgICAgICAgICAgICAga2EoInR5cGV8aHJlZnxoZWlnaHR8d2lkdGgiLCBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgICAgaWYgKCFjKSByZXR1cm4gYS5nZXRBdHRyaWJ1dGUoYiwgInR5cGUiID09PSBiLnRvTG93ZXJDYXNlKCkgPyAxIDogMik7CiAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgIChjLmF0dHJpYnV0ZXMgJiYKICAgICAgICAgICAgICBqYShmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgcmV0dXJuIChhLmlubmVySFRNTCA9ICI8aW5wdXQvPiIpLCBhLmZpcnN0Q2hpbGQuc2V0QXR0cmlidXRlKCJ2YWx1ZSIsICIiKSwgIiIgPT09IGEuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgICAgfSkpIHx8CiAgICAgICAgICAgICAga2EoInZhbHVlIiwgZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgICAgIGlmICghYyAmJiAiaW5wdXQiID09PSBhLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpIHJldHVybiBhLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgamEoZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbCA9PSBhLmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKTsKICAgICAgICAgICAgfSkgfHwKICAgICAgICAgICAgICBrYShKLCBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgICAgdmFyIGQ7CiAgICAgICAgICAgICAgICBpZiAoIWMpIHJldHVybiBhW2JdID09PSAhMCA/IGIudG9Mb3dlckNhc2UoKSA6IChkID0gYS5nZXRBdHRyaWJ1dGVOb2RlKGIpKSAmJiBkLnNwZWNpZmllZCA/IGQudmFsdWUgOiBudWxsOwogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICBnYQogICAgICAgICAgKTsKICAgICAgICB9KShhKTsKICAgICAgICAoci5maW5kID0geCksCiAgICAgICAgICAoci5leHByID0geC5zZWxlY3RvcnMpLAogICAgICAgICAgKHIuZXhwclsiOiJdID0gci5leHByLnBzZXVkb3MpLAogICAgICAgICAgKHIudW5pcXVlU29ydCA9IHIudW5pcXVlID0geC51bmlxdWVTb3J0KSwKICAgICAgICAgIChyLnRleHQgPSB4LmdldFRleHQpLAogICAgICAgICAgKHIuaXNYTUxEb2MgPSB4LmlzWE1MKSwKICAgICAgICAgIChyLmNvbnRhaW5zID0geC5jb250YWlucyksCiAgICAgICAgICAoci5lc2NhcGVTZWxlY3RvciA9IHguZXNjYXBlKTsKICAgICAgICB2YXIgeSA9IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gW10sCiAgICAgICAgICAgICAgZSA9IHZvaWQgMCAhPT0gYzsKICAgICAgICAgICAgd2hpbGUgKChhID0gYVtiXSkgJiYgOSAhPT0gYS5ub2RlVHlwZSkKICAgICAgICAgICAgICBpZiAoMSA9PT0gYS5ub2RlVHlwZSkgewogICAgICAgICAgICAgICAgaWYgKGUgJiYgcihhKS5pcyhjKSkgYnJlYWs7CiAgICAgICAgICAgICAgICBkLnB1c2goYSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZDsKICAgICAgICAgIH0sCiAgICAgICAgICB6ID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgZm9yICh2YXIgYyA9IFtdOyBhOyBhID0gYS5uZXh0U2libGluZykgMSA9PT0gYS5ub2RlVHlwZSAmJiBhICE9PSBiICYmIGMucHVzaChhKTsKICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICB9LAogICAgICAgICAgQSA9IHIuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQsCiAgICAgICAgICBCID0gL148KFthLXpdW15cL1wwPjpceDIwXHRcclxuXGZdKilbXHgyMFx0XHJcblxmXSpcLz8+KD86PFwvXDE+fCkkL2ksCiAgICAgICAgICBDID0gL14uW146I1xbXC4sXSokLzsKICAgICAgICBmdW5jdGlvbiBEKGEsIGIsIGMpIHsKICAgICAgICAgIGlmIChyLmlzRnVuY3Rpb24oYikpCiAgICAgICAgICAgIHJldHVybiByLmdyZXAoYSwgZnVuY3Rpb24gKGEsIGQpIHsKICAgICAgICAgICAgICByZXR1cm4gISFiLmNhbGwoYSwgZCwgYSkgIT09IGM7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKGIubm9kZVR5cGUpCiAgICAgICAgICAgIHJldHVybiByLmdyZXAoYSwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gKGEgPT09IGIpICE9PSBjOwogICAgICAgICAgICB9KTsKICAgICAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgYikgewogICAgICAgICAgICBpZiAoQy50ZXN0KGIpKSByZXR1cm4gci5maWx0ZXIoYiwgYSwgYyk7CiAgICAgICAgICAgIGIgPSByLmZpbHRlcihiLCBhKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByLmdyZXAoYSwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgcmV0dXJuIGkuY2FsbChiLCBhKSA+IC0xICE9PSBjICYmIDEgPT09IGEubm9kZVR5cGU7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgKHIuZmlsdGVyID0gZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgIHZhciBkID0gYlswXTsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIGMgJiYgKGEgPSAiOm5vdCgiICsgYSArICIpIiksCiAgICAgICAgICAgIDEgPT09IGIubGVuZ3RoICYmIDEgPT09IGQubm9kZVR5cGUKICAgICAgICAgICAgICA/IHIuZmluZC5tYXRjaGVzU2VsZWN0b3IoZCwgYSkKICAgICAgICAgICAgICAgID8gW2RdCiAgICAgICAgICAgICAgICA6IFtdCiAgICAgICAgICAgICAgOiByLmZpbmQubWF0Y2hlcygKICAgICAgICAgICAgICAgICAgYSwKICAgICAgICAgICAgICAgICAgci5ncmVwKGIsIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEgPT09IGEubm9kZVR5cGU7CiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICApCiAgICAgICAgICApOwogICAgICAgIH0pLAogICAgICAgICAgci5mbi5leHRlbmQoewogICAgICAgICAgICBmaW5kOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHZhciBiLAogICAgICAgICAgICAgICAgYywKICAgICAgICAgICAgICAgIGQgPSB0aGlzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGUgPSB0aGlzOwogICAgICAgICAgICAgIGlmICgic3RyaW5nIiAhPSB0eXBlb2YgYSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjaygKICAgICAgICAgICAgICAgICAgcihhKS5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoYiA9IDA7IGIgPCBkOyBiKyspIGlmIChyLmNvbnRhaW5zKGVbYl0sIHRoaXMpKSByZXR1cm4gITA7CiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGZvciAoYyA9IHRoaXMucHVzaFN0YWNrKFtdKSwgYiA9IDA7IGIgPCBkOyBiKyspIHIuZmluZChhLCBlW2JdLCBjKTsKICAgICAgICAgICAgICByZXR1cm4gZCA+IDEgPyByLnVuaXF1ZVNvcnQoYykgOiBjOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmaWx0ZXI6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKEQodGhpcywgYSB8fCBbXSwgITEpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbm90OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhEKHRoaXMsIGEgfHwgW10sICEwKSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiAhIUQodGhpcywgInN0cmluZyIgPT0gdHlwZW9mIGEgJiYgQS50ZXN0KGEpID8gcihhKSA6IGEgfHwgW10sICExKS5sZW5ndGg7CiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KTsKICAgICAgICB2YXIgRSwKICAgICAgICAgIEYgPSAvXig/OlxzKig8W1x3XFddKz4pW14+XSp8IyhbXHctXSspKSQvLAogICAgICAgICAgRyA9IChyLmZuLmluaXQgPSBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICB2YXIgZSwgZjsKICAgICAgICAgICAgaWYgKCFhKSByZXR1cm4gdGhpczsKICAgICAgICAgICAgaWYgKCgoYyA9IGMgfHwgRSksICJzdHJpbmciID09IHR5cGVvZiBhKSkgewogICAgICAgICAgICAgIGlmICgoKGUgPSAiPCIgPT09IGFbMF0gJiYgIj4iID09PSBhW2EubGVuZ3RoIC0gMV0gJiYgYS5sZW5ndGggPj0gMyA/IFtudWxsLCBhLCBudWxsXSA6IEYuZXhlYyhhKSksICFlIHx8ICghZVsxXSAmJiBiKSkpCiAgICAgICAgICAgICAgICByZXR1cm4gIWIgfHwgYi5qcXVlcnkgPyAoYiB8fCBjKS5maW5kKGEpIDogdGhpcy5jb25zdHJ1Y3RvcihiKS5maW5kKGEpOwogICAgICAgICAgICAgIGlmIChlWzFdKSB7CiAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICgoYiA9IGIgaW5zdGFuY2VvZiByID8gYlswXSA6IGIpLAogICAgICAgICAgICAgICAgICByLm1lcmdlKHRoaXMsIHIucGFyc2VIVE1MKGVbMV0sIGIgJiYgYi5ub2RlVHlwZSA/IGIub3duZXJEb2N1bWVudCB8fCBiIDogZCwgITApKSwKICAgICAgICAgICAgICAgICAgQi50ZXN0KGVbMV0pICYmIHIuaXNQbGFpbk9iamVjdChiKSkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgZm9yIChlIGluIGIpIHIuaXNGdW5jdGlvbih0aGlzW2VdKSA/IHRoaXNbZV0oYltlXSkgOiB0aGlzLmF0dHIoZSwgYltlXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIChmID0gZC5nZXRFbGVtZW50QnlJZChlWzJdKSksIGYgJiYgKCh0aGlzWzBdID0gZiksICh0aGlzLmxlbmd0aCA9IDEpKSwgdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYS5ub2RlVHlwZQogICAgICAgICAgICAgID8gKCh0aGlzWzBdID0gYSksICh0aGlzLmxlbmd0aCA9IDEpLCB0aGlzKQogICAgICAgICAgICAgIDogci5pc0Z1bmN0aW9uKGEpCiAgICAgICAgICAgICAgPyB2b2lkIDAgIT09IGMucmVhZHkKICAgICAgICAgICAgICAgID8gYy5yZWFkeShhKQogICAgICAgICAgICAgICAgOiBhKHIpCiAgICAgICAgICAgICAgOiByLm1ha2VBcnJheShhLCB0aGlzKTsKICAgICAgICAgIH0pOwogICAgICAgIChHLnByb3RvdHlwZSA9IHIuZm4pLCAoRSA9IHIoZCkpOwogICAgICAgIHZhciBIID0gL14oPzpwYXJlbnRzfHByZXYoPzpVbnRpbHxBbGwpKS8sCiAgICAgICAgICBJID0geyBjaGlsZHJlbjogITAsIGNvbnRlbnRzOiAhMCwgbmV4dDogITAsIHByZXY6ICEwIH07CiAgICAgICAgci5mbi5leHRlbmQoewogICAgICAgICAgaGFzOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICB2YXIgYiA9IHIoYSwgdGhpcyksCiAgICAgICAgICAgICAgYyA9IGIubGVuZ3RoOwogICAgICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGZvciAodmFyIGEgPSAwOyBhIDwgYzsgYSsrKSBpZiAoci5jb250YWlucyh0aGlzLCBiW2FdKSkgcmV0dXJuICEwOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBjbG9zZXN0OiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICB2YXIgYywKICAgICAgICAgICAgICBkID0gMCwKICAgICAgICAgICAgICBlID0gdGhpcy5sZW5ndGgsCiAgICAgICAgICAgICAgZiA9IFtdLAogICAgICAgICAgICAgIGcgPSAic3RyaW5nIiAhPSB0eXBlb2YgYSAmJiByKGEpOwogICAgICAgICAgICBpZiAoIUEudGVzdChhKSkKICAgICAgICAgICAgICBmb3IgKDsgZCA8IGU7IGQrKykKICAgICAgICAgICAgICAgIGZvciAoYyA9IHRoaXNbZF07IGMgJiYgYyAhPT0gYjsgYyA9IGMucGFyZW50Tm9kZSkKICAgICAgICAgICAgICAgICAgaWYgKGMubm9kZVR5cGUgPCAxMSAmJiAoZyA/IGcuaW5kZXgoYykgPiAtMSA6IDEgPT09IGMubm9kZVR5cGUgJiYgci5maW5kLm1hdGNoZXNTZWxlY3RvcihjLCBhKSkpIHsKICAgICAgICAgICAgICAgICAgICBmLnB1c2goYyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGYubGVuZ3RoID4gMSA/IHIudW5pcXVlU29ydChmKSA6IGYpOwogICAgICAgICAgfSwKICAgICAgICAgIGluZGV4OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICByZXR1cm4gYQogICAgICAgICAgICAgID8gInN0cmluZyIgPT0gdHlwZW9mIGEKICAgICAgICAgICAgICAgID8gaS5jYWxsKHIoYSksIHRoaXNbMF0pCiAgICAgICAgICAgICAgICA6IGkuY2FsbCh0aGlzLCBhLmpxdWVyeSA/IGFbMF0gOiBhKQogICAgICAgICAgICAgIDogdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUKICAgICAgICAgICAgICA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoCiAgICAgICAgICAgICAgOiAtMTsKICAgICAgICAgIH0sCiAgICAgICAgICBhZGQ6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhyLnVuaXF1ZVNvcnQoci5tZXJnZSh0aGlzLmdldCgpLCByKGEsIGIpKSkpOwogICAgICAgICAgfSwKICAgICAgICAgIGFkZEJhY2s6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZChudWxsID09IGEgPyB0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKGEpKTsKICAgICAgICAgIH0sCiAgICAgICAgfSk7CiAgICAgICAgZnVuY3Rpb24gSihhLCBiKSB7CiAgICAgICAgICB3aGlsZSAoKGEgPSBhW2JdKSAmJiAxICE9PSBhLm5vZGVUeXBlKTsKICAgICAgICAgIHJldHVybiBhOwogICAgICAgIH0KICAgICAgICByLmVhY2goCiAgICAgICAgICB7CiAgICAgICAgICAgIHBhcmVudDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICB2YXIgYiA9IGEucGFyZW50Tm9kZTsKICAgICAgICAgICAgICByZXR1cm4gYiAmJiAxMSAhPT0gYi5ub2RlVHlwZSA/IGIgOiBudWxsOwogICAgICAgICAgICB9LAogICAgICAgICAgICBwYXJlbnRzOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiB5KGEsICJwYXJlbnROb2RlIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBhcmVudHNVbnRpbDogZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgICByZXR1cm4geShhLCAicGFyZW50Tm9kZSIsIGMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBuZXh0OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiBKKGEsICJuZXh0U2libGluZyIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBwcmV2OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiBKKGEsICJwcmV2aW91c1NpYmxpbmciKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbmV4dEFsbDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4geShhLCAibmV4dFNpYmxpbmciKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHJldkFsbDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4geShhLCAicHJldmlvdXNTaWJsaW5nIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG5leHRVbnRpbDogZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgICByZXR1cm4geShhLCAibmV4dFNpYmxpbmciLCBjKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHJldlVudGlsOiBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgIHJldHVybiB5KGEsICJwcmV2aW91c1NpYmxpbmciLCBjKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2libGluZ3M6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHooKGEucGFyZW50Tm9kZSB8fCB7fSkuZmlyc3RDaGlsZCwgYSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiB6KGEuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNvbnRlbnRzOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiBhLmNvbnRlbnREb2N1bWVudCB8fCByLm1lcmdlKFtdLCBhLmNoaWxkTm9kZXMpOwogICAgICAgICAgICB9LAogICAgICAgICAgfSwKICAgICAgICAgIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHIuZm5bYV0gPSBmdW5jdGlvbiAoYywgZCkgewogICAgICAgICAgICAgIHZhciBlID0gci5tYXAodGhpcywgYiwgYyk7CiAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICJVbnRpbCIgIT09IGEuc2xpY2UoLTUpICYmIChkID0gYyksCiAgICAgICAgICAgICAgICBkICYmICJzdHJpbmciID09IHR5cGVvZiBkICYmIChlID0gci5maWx0ZXIoZCwgZSkpLAogICAgICAgICAgICAgICAgdGhpcy5sZW5ndGggPiAxICYmIChJW2FdIHx8IHIudW5pcXVlU29ydChlKSwgSC50ZXN0KGEpICYmIGUucmV2ZXJzZSgpKSwKICAgICAgICAgICAgICAgIHRoaXMucHVzaFN0YWNrKGUpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICApOwogICAgICAgIHZhciBLID0gL1xTKy9nOwogICAgICAgIGZ1bmN0aW9uIEwoYSkgewogICAgICAgICAgdmFyIGIgPSB7fTsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIHIuZWFjaChhLm1hdGNoKEspIHx8IFtdLCBmdW5jdGlvbiAoYSwgYykgewogICAgICAgICAgICAgIGJbY10gPSAhMDsKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHIuQ2FsbGJhY2tzID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgIGEgPSAic3RyaW5nIiA9PSB0eXBlb2YgYSA/IEwoYSkgOiByLmV4dGVuZCh7fSwgYSk7CiAgICAgICAgICB2YXIgYiwKICAgICAgICAgICAgYywKICAgICAgICAgICAgZCwKICAgICAgICAgICAgZSwKICAgICAgICAgICAgZiA9IFtdLAogICAgICAgICAgICBnID0gW10sCiAgICAgICAgICAgIGggPSAtMSwKICAgICAgICAgICAgaSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBmb3IgKGUgPSBhLm9uY2UsIGQgPSBiID0gITA7IGcubGVuZ3RoOyBoID0gLTEpIHsKICAgICAgICAgICAgICAgIGMgPSBnLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICB3aGlsZSAoKytoIDwgZi5sZW5ndGgpIGZbaF0uYXBwbHkoY1swXSwgY1sxXSkgPT09ICExICYmIGEuc3RvcE9uRmFsc2UgJiYgKChoID0gZi5sZW5ndGgpLCAoYyA9ICExKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGEubWVtb3J5IHx8IChjID0gITEpLCAoYiA9ICExKSwgZSAmJiAoZiA9IGMgPyBbXSA6ICIiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaiA9IHsKICAgICAgICAgICAgICBhZGQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgIGYgJiYKICAgICAgICAgICAgICAgICAgICAoYyAmJiAhYiAmJiAoKGggPSBmLmxlbmd0aCAtIDEpLCBnLnB1c2goYykpLAogICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiBkKGIpIHsKICAgICAgICAgICAgICAgICAgICAgIHIuZWFjaChiLCBmdW5jdGlvbiAoYiwgYykgewogICAgICAgICAgICAgICAgICAgICAgICByLmlzRnVuY3Rpb24oYykgPyAoYS51bmlxdWUgJiYgai5oYXMoYykpIHx8IGYucHVzaChjKSA6IGMgJiYgYy5sZW5ndGggJiYgInN0cmluZyIgIT09IHIudHlwZShjKSAmJiBkKGMpOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkoYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgICAgICBjICYmICFiICYmIGkoKSksCiAgICAgICAgICAgICAgICAgIHRoaXMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgIHIuZWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGM7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChjID0gci5pbkFycmF5KGIsIGYsIGMpKSA+IC0xKSBmLnNwbGljZShjLCAxKSwgYyA8PSBoICYmIGgtLTsKICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgIHRoaXMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBoYXM6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYSA/IHIuaW5BcnJheShhLCBmKSA+IC0xIDogZi5sZW5ndGggPiAwOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmICYmIChmID0gW10pLCB0aGlzOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIChlID0gZyA9IFtdKSwgKGYgPSBjID0gIiIpLCB0aGlzOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGlzYWJsZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhZjsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGxvY2s6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoZSA9IGcgPSBbXSksIGMgfHwgYiB8fCAoZiA9IGMgPSAiIiksIHRoaXM7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBsb2NrZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhIWU7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmaXJlV2l0aDogZnVuY3Rpb24gKGEsIGMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlIHx8ICgoYyA9IGMgfHwgW10pLCAoYyA9IFthLCBjLnNsaWNlID8gYy5zbGljZSgpIDogY10pLCBnLnB1c2goYyksIGIgfHwgaSgpKSwgdGhpczsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZpcmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBqLmZpcmVXaXRoKHRoaXMsIGFyZ3VtZW50cyksIHRoaXM7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmaXJlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICEhZDsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGo7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBNKGEpIHsKICAgICAgICAgIHJldHVybiBhOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBOKGEpIHsKICAgICAgICAgIHRocm93IGE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIE8oYSwgYiwgYykgewogICAgICAgICAgdmFyIGQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhICYmIHIuaXNGdW5jdGlvbigoZCA9IGEucHJvbWlzZSkpID8gZC5jYWxsKGEpLmRvbmUoYikuZmFpbChjKSA6IGEgJiYgci5pc0Z1bmN0aW9uKChkID0gYS50aGVuKSkgPyBkLmNhbGwoYSwgYiwgYykgOiBiLmNhbGwodm9pZCAwLCBhKTsKICAgICAgICAgIH0gY2F0Y2ggKGEpIHsKICAgICAgICAgICAgYy5jYWxsKHZvaWQgMCwgYSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHIuZXh0ZW5kKHsKICAgICAgICAgIERlZmVycmVkOiBmdW5jdGlvbiAoYikgewogICAgICAgICAgICB2YXIgYyA9IFsKICAgICAgICAgICAgICAgIFsibm90aWZ5IiwgInByb2dyZXNzIiwgci5DYWxsYmFja3MoIm1lbW9yeSIpLCByLkNhbGxiYWNrcygibWVtb3J5IiksIDJdLAogICAgICAgICAgICAgICAgWyJyZXNvbHZlIiwgImRvbmUiLCByLkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgci5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksIDAsICJyZXNvbHZlZCJdLAogICAgICAgICAgICAgICAgWyJyZWplY3QiLCAiZmFpbCIsIHIuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCByLkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgMSwgInJlamVjdGVkIl0sCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICBkID0gInBlbmRpbmciLAogICAgICAgICAgICAgIGUgPSB7CiAgICAgICAgICAgICAgICBzdGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZDsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhbHdheXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGYuZG9uZShhcmd1bWVudHMpLmZhaWwoYXJndW1lbnRzKSwgdGhpczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjYXRjaDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGUudGhlbihudWxsLCBhKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwaXBlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBhID0gYXJndW1lbnRzOwogICAgICAgICAgICAgICAgICByZXR1cm4gcgogICAgICAgICAgICAgICAgICAgIC5EZWZlcnJlZChmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgICAgICAgci5lYWNoKGMsIGZ1bmN0aW9uIChjLCBkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlID0gci5pc0Z1bmN0aW9uKGFbZFs0XV0pICYmIGFbZFs0XV07CiAgICAgICAgICAgICAgICAgICAgICAgIGZbZFsxXV0oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhID0gZSAmJiBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYSAmJiByLmlzRnVuY3Rpb24oYS5wcm9taXNlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBhLnByb21pc2UoKS5wcm9ncmVzcyhiLm5vdGlmeSkuZG9uZShiLnJlc29sdmUpLmZhaWwoYi5yZWplY3QpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGJbZFswXSArICJXaXRoIl0odGhpcywgZSA/IFthXSA6IGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgICAgIChhID0gbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAucHJvbWlzZSgpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uIChiLCBkLCBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmID0gMDsKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZyhiLCBjLCBkLCBlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBoID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IGFyZ3VtZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgaiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYSwgajsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShiIDwgZikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoKGEgPSBkLmFwcGx5KGgsIGkpKSwgYSA9PT0gYy5wcm9taXNlKCkpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGVuYWJsZSBzZWxmLXJlc29sdXRpb24iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChqID0gYSAmJiAoIm9iamVjdCIgPT0gdHlwZW9mIGEgfHwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgYSkgJiYgYS50aGVuKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgci5pc0Z1bmN0aW9uKGopCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGouY2FsbChhLCBnKGYsIGMsIE0sIGUpLCBnKGYsIGMsIE4sIGUpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAoZisrLCBqLmNhbGwoYSwgZyhmLCBjLCBNLCBlKSwgZyhmLCBjLCBOLCBlKSwgZyhmLCBjLCBNLCBjLm5vdGlmeVdpdGgpKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IChkICE9PSBNICYmICgoaCA9IHZvaWQgMCksIChpID0gW2FdKSksIChlIHx8IGMucmVzb2x2ZVdpdGgpKGgsIGkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGsgPSBlCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBqCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgci5EZWZlcnJlZC5leGNlcHRpb25Ib29rICYmIHIuRGVmZXJyZWQuZXhjZXB0aW9uSG9vayhhLCBrLnN0YWNrVHJhY2UpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYiArIDEgPj0gZiAmJiAoZCAhPT0gTiAmJiAoKGggPSB2b2lkIDApLCAoaSA9IFthXSkpLCBjLnJlamVjdFdpdGgoaCwgaSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgYiA/IGsoKSA6IChyLkRlZmVycmVkLmdldFN0YWNrSG9vayAmJiAoay5zdGFja1RyYWNlID0gci5EZWZlcnJlZC5nZXRTdGFja0hvb2soKSksIGEuc2V0VGltZW91dChrKSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gcgogICAgICAgICAgICAgICAgICAgIC5EZWZlcnJlZChmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgICAgY1swXVszXS5hZGQoZygwLCBhLCByLmlzRnVuY3Rpb24oZSkgPyBlIDogTSwgYS5ub3RpZnlXaXRoKSksCiAgICAgICAgICAgICAgICAgICAgICAgIGNbMV1bM10uYWRkKGcoMCwgYSwgci5pc0Z1bmN0aW9uKGIpID8gYiA6IE0pKSwKICAgICAgICAgICAgICAgICAgICAgICAgY1syXVszXS5hZGQoZygwLCBhLCByLmlzRnVuY3Rpb24oZCkgPyBkIDogTikpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLnByb21pc2UoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBwcm9taXNlOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbCAhPSBhID8gci5leHRlbmQoYSwgZSkgOiBlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGYgPSB7fTsKICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICByLmVhY2goYywgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIHZhciBnID0gYlsyXSwKICAgICAgICAgICAgICAgICAgaCA9IGJbNV07CiAgICAgICAgICAgICAgICAoZVtiWzFdXSA9IGcuYWRkKSwKICAgICAgICAgICAgICAgICAgaCAmJgogICAgICAgICAgICAgICAgICAgIGcuYWRkKAogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBkID0gaDsKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICBjWzMgLSBhXVsyXS5kaXNhYmxlLAogICAgICAgICAgICAgICAgICAgICAgY1swXVsyXS5sb2NrCiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgZy5hZGQoYlszXS5maXJlKSwKICAgICAgICAgICAgICAgICAgKGZbYlswXV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZbYlswXSArICJXaXRoIl0odGhpcyA9PT0gZiA/IHZvaWQgMCA6IHRoaXMsIGFyZ3VtZW50cyksIHRoaXM7CiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAoZltiWzBdICsgIldpdGgiXSA9IGcuZmlyZVdpdGgpOwogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgIGUucHJvbWlzZShmKSwKICAgICAgICAgICAgICBiICYmIGIuY2FsbChmLCBmKSwKICAgICAgICAgICAgICBmCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgd2hlbjogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgdmFyIGIgPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgICAgICAgIGMgPSBiLAogICAgICAgICAgICAgIGQgPSBBcnJheShjKSwKICAgICAgICAgICAgICBlID0gZi5jYWxsKGFyZ3VtZW50cyksCiAgICAgICAgICAgICAgZyA9IHIuRGVmZXJyZWQoKSwKICAgICAgICAgICAgICBoID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoYykgewogICAgICAgICAgICAgICAgICAoZFthXSA9IHRoaXMpLCAoZVthXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gZi5jYWxsKGFyZ3VtZW50cykgOiBjKSwgLS1iIHx8IGcucmVzb2x2ZVdpdGgoZCwgZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChiIDw9IDEgJiYgKE8oYSwgZy5kb25lKGgoYykpLnJlc29sdmUsIGcucmVqZWN0KSwgInBlbmRpbmciID09PSBnLnN0YXRlKCkgfHwgci5pc0Z1bmN0aW9uKGVbY10gJiYgZVtjXS50aGVuKSkpIHJldHVybiBnLnRoZW4oKTsKICAgICAgICAgICAgd2hpbGUgKGMtLSkgTyhlW2NdLCBoKGMpLCBnLnJlamVjdCk7CiAgICAgICAgICAgIHJldHVybiBnLnByb21pc2UoKTsKICAgICAgICAgIH0sCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFAgPSAvXihFdmFsfEludGVybmFsfFJhbmdlfFJlZmVyZW5jZXxTeW50YXh8VHlwZXxVUkkpRXJyb3IkLzsKICAgICAgICAoci5EZWZlcnJlZC5leGNlcHRpb25Ib29rID0gZnVuY3Rpb24gKGIsIGMpIHsKICAgICAgICAgIGEuY29uc29sZSAmJiBhLmNvbnNvbGUud2FybiAmJiBiICYmIFAudGVzdChiLm5hbWUpICYmIGEuY29uc29sZS53YXJuKCJqUXVlcnkuRGVmZXJyZWQgZXhjZXB0aW9uOiAiICsgYi5tZXNzYWdlLCBiLnN0YWNrLCBjKTsKICAgICAgICB9KSwKICAgICAgICAgIChyLnJlYWR5RXhjZXB0aW9uID0gZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgYS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aHJvdyBiOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIHZhciBRID0gci5EZWZlcnJlZCgpOwogICAgICAgIChyLmZuLnJlYWR5ID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIFEudGhlbihhKVsiY2F0Y2giXShmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHIucmVhZHlFeGNlcHRpb24oYSk7CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICB0aGlzCiAgICAgICAgICApOwogICAgICAgIH0pLAogICAgICAgICAgci5leHRlbmQoewogICAgICAgICAgICBpc1JlYWR5OiAhMSwKICAgICAgICAgICAgcmVhZHlXYWl0OiAxLAogICAgICAgICAgICBob2xkUmVhZHk6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgYSA/IHIucmVhZHlXYWl0KysgOiByLnJlYWR5KCEwKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgKGEgPT09ICEwID8gLS1yLnJlYWR5V2FpdCA6IHIuaXNSZWFkeSkgfHwgKChyLmlzUmVhZHkgPSAhMCksIChhICE9PSAhMCAmJiAtLXIucmVhZHlXYWl0ID4gMCkgfHwgUS5yZXNvbHZlV2l0aChkLCBbcl0pKTsKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgICAgKHIucmVhZHkudGhlbiA9IFEudGhlbik7CiAgICAgICAgZnVuY3Rpb24gUigpIHsKICAgICAgICAgIGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIFIpLCBhLnJlbW92ZUV2ZW50TGlzdGVuZXIoImxvYWQiLCBSKSwgci5yZWFkeSgpOwogICAgICAgIH0KICAgICAgICAiY29tcGxldGUiID09PSBkLnJlYWR5U3RhdGUgfHwgKCJsb2FkaW5nIiAhPT0gZC5yZWFkeVN0YXRlICYmICFkLmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCkKICAgICAgICAgID8gYS5zZXRUaW1lb3V0KHIucmVhZHkpCiAgICAgICAgICA6IChkLmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBSKSwgYS5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgUikpOwogICAgICAgIHZhciBTID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQsIGUsIGYsIGcpIHsKICAgICAgICAgICAgdmFyIGggPSAwLAogICAgICAgICAgICAgIGkgPSBhLmxlbmd0aCwKICAgICAgICAgICAgICBqID0gbnVsbCA9PSBjOwogICAgICAgICAgICBpZiAoIm9iamVjdCIgPT09IHIudHlwZShjKSkgewogICAgICAgICAgICAgIGUgPSAhMDsKICAgICAgICAgICAgICBmb3IgKGggaW4gYykgUyhhLCBiLCBoLCBjW2hdLCAhMCwgZiwgZyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgdm9pZCAwICE9PSBkICYmCiAgICAgICAgICAgICAgKChlID0gITApLAogICAgICAgICAgICAgIHIuaXNGdW5jdGlvbihkKSB8fCAoZyA9ICEwKSwKICAgICAgICAgICAgICBqICYmCiAgICAgICAgICAgICAgICAoZwogICAgICAgICAgICAgICAgICA/IChiLmNhbGwoYSwgZCksIChiID0gbnVsbCkpCiAgICAgICAgICAgICAgICAgIDogKChqID0gYiksCiAgICAgICAgICAgICAgICAgICAgKGIgPSBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGouY2FsbChyKGEpLCBjKTsKICAgICAgICAgICAgICAgICAgICB9KSkpLAogICAgICAgICAgICAgIGIpCiAgICAgICAgICAgICkKICAgICAgICAgICAgICBmb3IgKDsgaCA8IGk7IGgrKykgYihhW2hdLCBjLCBnID8gZCA6IGQuY2FsbChhW2hdLCBoLCBiKGFbaF0sIGMpKSk7CiAgICAgICAgICAgIHJldHVybiBlID8gYSA6IGogPyBiLmNhbGwoYSkgOiBpID8gYihhWzBdLCBjKSA6IGY7CiAgICAgICAgICB9LAogICAgICAgICAgVCA9IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiAxID09PSBhLm5vZGVUeXBlIHx8IDkgPT09IGEubm9kZVR5cGUgfHwgISthLm5vZGVUeXBlOwogICAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBVKCkgewogICAgICAgICAgdGhpcy5leHBhbmRvID0gci5leHBhbmRvICsgVS51aWQrKzsKICAgICAgICB9CiAgICAgICAgKFUudWlkID0gMSksCiAgICAgICAgICAoVS5wcm90b3R5cGUgPSB7CiAgICAgICAgICAgIGNhY2hlOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHZhciBiID0gYVt0aGlzLmV4cGFuZG9dOwogICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICBiIHx8CiAgICAgICAgICAgICAgICAgICgoYiA9IHt9KSwKICAgICAgICAgICAgICAgICAgVChhKSAmJgogICAgICAgICAgICAgICAgICAgIChhLm5vZGVUeXBlCiAgICAgICAgICAgICAgICAgICAgICA/IChhW3RoaXMuZXhwYW5kb10gPSBiKQogICAgICAgICAgICAgICAgICAgICAgOiBPYmplY3QuZGVmaW5lUHJvcGVydHkoYSwgdGhpcy5leHBhbmRvLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiAhMCwKICAgICAgICAgICAgICAgICAgICAgICAgfSkpKSwKICAgICAgICAgICAgICAgIGIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgICAgdmFyIGQsCiAgICAgICAgICAgICAgICBlID0gdGhpcy5jYWNoZShhKTsKICAgICAgICAgICAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIGIpIGVbci5jYW1lbENhc2UoYildID0gYzsKICAgICAgICAgICAgICBlbHNlIGZvciAoZCBpbiBiKSBlW3IuY2FtZWxDYXNlKGQpXSA9IGJbZF07CiAgICAgICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwID09PSBiID8gdGhpcy5jYWNoZShhKSA6IGFbdGhpcy5leHBhbmRvXSAmJiBhW3RoaXMuZXhwYW5kb11bci5jYW1lbENhc2UoYildOwogICAgICAgICAgICB9LAogICAgICAgICAgICBhY2Nlc3M6IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMCA9PT0gYiB8fCAoYiAmJiAic3RyaW5nIiA9PSB0eXBlb2YgYiAmJiB2b2lkIDAgPT09IGMpID8gdGhpcy5nZXQoYSwgYikgOiAodGhpcy5zZXQoYSwgYiwgYyksIHZvaWQgMCAhPT0gYyA/IGMgOiBiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHZhciBjLAogICAgICAgICAgICAgICAgZCA9IGFbdGhpcy5leHBhbmRvXTsKICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBkKSB7CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBiKSB7CiAgICAgICAgICAgICAgICAgIHIuaXNBcnJheShiKSA/IChiID0gYi5tYXAoci5jYW1lbENhc2UpKSA6ICgoYiA9IHIuY2FtZWxDYXNlKGIpKSwgKGIgPSBiIGluIGQgPyBbYl0gOiBiLm1hdGNoKEspIHx8IFtdKSksIChjID0gYi5sZW5ndGgpOwogICAgICAgICAgICAgICAgICB3aGlsZSAoYy0tKSBkZWxldGUgZFtiW2NdXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICh2b2lkIDAgPT09IGIgfHwgci5pc0VtcHR5T2JqZWN0KGQpKSAmJiAoYS5ub2RlVHlwZSA/IChhW3RoaXMuZXhwYW5kb10gPSB2b2lkIDApIDogZGVsZXRlIGFbdGhpcy5leHBhbmRvXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBoYXNEYXRhOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHZhciBiID0gYVt0aGlzLmV4cGFuZG9dOwogICAgICAgICAgICAgIHJldHVybiB2b2lkIDAgIT09IGIgJiYgIXIuaXNFbXB0eU9iamVjdChiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pOwogICAgICAgIHZhciBWID0gbmV3IFUoKSwKICAgICAgICAgIFcgPSBuZXcgVSgpLAogICAgICAgICAgWCA9IC9eKD86XHtbXHdcV10qXH18XFtbXHdcV10qXF0pJC8sCiAgICAgICAgICBZID0gL1tBLVpdL2c7CiAgICAgICAgZnVuY3Rpb24gWihhLCBiLCBjKSB7CiAgICAgICAgICB2YXIgZDsKICAgICAgICAgIGlmICh2b2lkIDAgPT09IGMgJiYgMSA9PT0gYS5ub2RlVHlwZSkKICAgICAgICAgICAgaWYgKCgoZCA9ICJkYXRhLSIgKyBiLnJlcGxhY2UoWSwgIi0kJiIpLnRvTG93ZXJDYXNlKCkpLCAoYyA9IGEuZ2V0QXR0cmlidXRlKGQpKSwgInN0cmluZyIgPT0gdHlwZW9mIGMpKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGMgPSAidHJ1ZSIgPT09IGMgfHwgKCJmYWxzZSIgIT09IGMgJiYgKCJudWxsIiA9PT0gYyA/IG51bGwgOiArYyArICIiID09PSBjID8gK2MgOiBYLnRlc3QoYykgPyBKU09OLnBhcnNlKGMpIDogYykpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgICAgVy5zZXQoYSwgYiwgYyk7CiAgICAgICAgICAgIH0gZWxzZSBjID0gdm9pZCAwOwogICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgfQogICAgICAgIHIuZXh0ZW5kKHsKICAgICAgICAgIGhhc0RhdGE6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiBXLmhhc0RhdGEoYSkgfHwgVi5oYXNEYXRhKGEpOwogICAgICAgICAgfSwKICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgIHJldHVybiBXLmFjY2VzcyhhLCBiLCBjKTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmVEYXRhOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICBXLnJlbW92ZShhLCBiKTsKICAgICAgICAgIH0sCiAgICAgICAgICBfZGF0YTogZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgcmV0dXJuIFYuYWNjZXNzKGEsIGIsIGMpOwogICAgICAgICAgfSwKICAgICAgICAgIF9yZW1vdmVEYXRhOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICBWLnJlbW92ZShhLCBiKTsKICAgICAgICAgIH0sCiAgICAgICAgfSksCiAgICAgICAgICByLmZuLmV4dGVuZCh7CiAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgdmFyIGMsCiAgICAgICAgICAgICAgICBkLAogICAgICAgICAgICAgICAgZSwKICAgICAgICAgICAgICAgIGYgPSB0aGlzWzBdLAogICAgICAgICAgICAgICAgZyA9IGYgJiYgZi5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IGEpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCAmJiAoKGUgPSBXLmdldChmKSksIDEgPT09IGYubm9kZVR5cGUgJiYgIVYuZ2V0KGYsICJoYXNEYXRhQXR0cnMiKSkpIHsKICAgICAgICAgICAgICAgICAgYyA9IGcubGVuZ3RoOwogICAgICAgICAgICAgICAgICB3aGlsZSAoYy0tKSBnW2NdICYmICgoZCA9IGdbY10ubmFtZSksIDAgPT09IGQuaW5kZXhPZigiZGF0YS0iKSAmJiAoKGQgPSByLmNhbWVsQ2FzZShkLnNsaWNlKDUpKSksIFooZiwgZCwgZVtkXSkpKTsKICAgICAgICAgICAgICAgICAgVi5zZXQoZiwgImhhc0RhdGFBdHRycyIsICEwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCIgPT0gdHlwZW9mIGEKICAgICAgICAgICAgICAgID8gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBXLnNldCh0aGlzLCBhKTsKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIDogUygKICAgICAgICAgICAgICAgICAgICB0aGlzLAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChmICYmIHZvaWQgMCA9PT0gYikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKChjID0gVy5nZXQoZiwgYSkpLCB2b2lkIDAgIT09IGMpKSByZXR1cm4gYzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCgoYyA9IFooZiwgYSkpLCB2b2lkIDAgIT09IGMpKSByZXR1cm4gYzsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIFcuc2V0KHRoaXMsIGEsIGIpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgICAgYiwKICAgICAgICAgICAgICAgICAgICBhcmd1bWVudHMubGVuZ3RoID4gMSwKICAgICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAgICEwCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlbW92ZURhdGE6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBXLnJlbW92ZSh0aGlzLCBhKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgICAgci5leHRlbmQoewogICAgICAgICAgICBxdWV1ZTogZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgICB2YXIgZDsKICAgICAgICAgICAgICBpZiAoYSkKICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgIChiID0gKGIgfHwgImZ4IikgKyAicXVldWUiKSwKICAgICAgICAgICAgICAgICAgKGQgPSBWLmdldChhLCBiKSksCiAgICAgICAgICAgICAgICAgIGMgJiYgKCFkIHx8IHIuaXNBcnJheShjKSA/IChkID0gVi5hY2Nlc3MoYSwgYiwgci5tYWtlQXJyYXkoYykpKSA6IGQucHVzaChjKSksCiAgICAgICAgICAgICAgICAgIGQgfHwgW10KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlcXVldWU6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgYiA9IGIgfHwgImZ4IjsKICAgICAgICAgICAgICB2YXIgYyA9IHIucXVldWUoYSwgYiksCiAgICAgICAgICAgICAgICBkID0gYy5sZW5ndGgsCiAgICAgICAgICAgICAgICBlID0gYy5zaGlmdCgpLAogICAgICAgICAgICAgICAgZiA9IHIuX3F1ZXVlSG9va3MoYSwgYiksCiAgICAgICAgICAgICAgICBnID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICByLmRlcXVldWUoYSwgYik7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICJpbnByb2dyZXNzIiA9PT0gZSAmJiAoKGUgPSBjLnNoaWZ0KCkpLCBkLS0pLAogICAgICAgICAgICAgICAgZSAmJiAoImZ4IiA9PT0gYiAmJiBjLnVuc2hpZnQoImlucHJvZ3Jlc3MiKSwgZGVsZXRlIGYuc3RvcCwgZS5jYWxsKGEsIGcsIGYpKSwKICAgICAgICAgICAgICAgICFkICYmIGYgJiYgZi5lbXB0eS5maXJlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9xdWV1ZUhvb2tzOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHZhciBjID0gYiArICJxdWV1ZUhvb2tzIjsKICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgVi5nZXQoYSwgYykgfHwKICAgICAgICAgICAgICAgIFYuYWNjZXNzKGEsIGMsIHsKICAgICAgICAgICAgICAgICAgZW1wdHk6IHIuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLmFkZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgVi5yZW1vdmUoYSwgW2IgKyAicXVldWUiLCBjXSk7CiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgfSksCiAgICAgICAgICByLmZuLmV4dGVuZCh7CiAgICAgICAgICAgIHF1ZXVlOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHZhciBjID0gMjsKICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgInN0cmluZyIgIT0gdHlwZW9mIGEgJiYgKChiID0gYSksIChhID0gImZ4IiksIGMtLSksCiAgICAgICAgICAgICAgICBhcmd1bWVudHMubGVuZ3RoIDwgYwogICAgICAgICAgICAgICAgICA/IHIucXVldWUodGhpc1swXSwgYSkKICAgICAgICAgICAgICAgICAgOiB2b2lkIDAgPT09IGIKICAgICAgICAgICAgICAgICAgPyB0aGlzCiAgICAgICAgICAgICAgICAgIDogdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBjID0gci5xdWV1ZSh0aGlzLCBhLCBiKTsKICAgICAgICAgICAgICAgICAgICAgIHIuX3F1ZXVlSG9va3ModGhpcywgYSksICJmeCIgPT09IGEgJiYgImlucHJvZ3Jlc3MiICE9PSBjWzBdICYmIHIuZGVxdWV1ZSh0aGlzLCBhKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlcXVldWU6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByLmRlcXVldWUodGhpcywgYSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsZWFyUXVldWU6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVldWUoYSB8fCAiZngiLCBbXSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHByb21pc2U6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgdmFyIGMsCiAgICAgICAgICAgICAgICBkID0gMSwKICAgICAgICAgICAgICAgIGUgPSByLkRlZmVycmVkKCksCiAgICAgICAgICAgICAgICBmID0gdGhpcywKICAgICAgICAgICAgICAgIGcgPSB0aGlzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIC0tZCB8fCBlLnJlc29sdmVXaXRoKGYsIFtmXSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICJzdHJpbmciICE9IHR5cGVvZiBhICYmICgoYiA9IGEpLCAoYSA9IHZvaWQgMCkpLCAoYSA9IGEgfHwgImZ4Iik7CiAgICAgICAgICAgICAgd2hpbGUgKGctLSkgKGMgPSBWLmdldChmW2ddLCBhICsgInF1ZXVlSG9va3MiKSksIGMgJiYgYy5lbXB0eSAmJiAoZCsrLCBjLmVtcHR5LmFkZChoKSk7CiAgICAgICAgICAgICAgcmV0dXJuIGgoKSwgZS5wcm9taXNlKGIpOwogICAgICAgICAgICB9LAogICAgICAgICAgfSk7CiAgICAgICAgdmFyICQgPSAvWystXT8oPzpcZCpcLnwpXGQrKD86W2VFXVsrLV0/XGQrfCkvLnNvdXJjZSwKICAgICAgICAgIF8gPSBuZXcgUmVnRXhwKCJeKD86KFsrLV0pPXwpKCIgKyAkICsgIikoW2EteiVdKikkIiwgImkiKSwKICAgICAgICAgIGFhID0gWyJUb3AiLCAiUmlnaHQiLCAiQm90dG9tIiwgIkxlZnQiXSwKICAgICAgICAgIGJhID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAoYSA9IGIgfHwgYSksICJub25lIiA9PT0gYS5zdHlsZS5kaXNwbGF5IHx8ICgiIiA9PT0gYS5zdHlsZS5kaXNwbGF5ICYmIHIuY29udGFpbnMoYS5vd25lckRvY3VtZW50LCBhKSAmJiAibm9uZSIgPT09IHIuY3NzKGEsICJkaXNwbGF5IikpCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgY2EgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZSwKICAgICAgICAgICAgICBmLAogICAgICAgICAgICAgIGcgPSB7fTsKICAgICAgICAgICAgZm9yIChmIGluIGIpIChnW2ZdID0gYS5zdHlsZVtmXSksIChhLnN0eWxlW2ZdID0gYltmXSk7CiAgICAgICAgICAgIGUgPSBjLmFwcGx5KGEsIGQgfHwgW10pOwogICAgICAgICAgICBmb3IgKGYgaW4gYikgYS5zdHlsZVtmXSA9IGdbZl07CiAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBkYShhLCBiLCBjLCBkKSB7CiAgICAgICAgICB2YXIgZSwKICAgICAgICAgICAgZiA9IDEsCiAgICAgICAgICAgIGcgPSAyMCwKICAgICAgICAgICAgaCA9IGQKICAgICAgICAgICAgICA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGQuY3VyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiByLmNzcyhhLCBiLCAiIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICBpID0gaCgpLAogICAgICAgICAgICBqID0gKGMgJiYgY1szXSkgfHwgKHIuY3NzTnVtYmVyW2JdID8gIiIgOiAicHgiKSwKICAgICAgICAgICAgayA9IChyLmNzc051bWJlcltiXSB8fCAoInB4IiAhPT0gaiAmJiAraSkpICYmIF8uZXhlYyhyLmNzcyhhLCBiKSk7CiAgICAgICAgICBpZiAoayAmJiBrWzNdICE9PSBqKSB7CiAgICAgICAgICAgIChqID0gaiB8fCBrWzNdKSwgKGMgPSBjIHx8IFtdKSwgKGsgPSAraSB8fCAxKTsKICAgICAgICAgICAgZG8gKGYgPSBmIHx8ICIuNSIpLCAoayAvPSBmKSwgci5zdHlsZShhLCBiLCBrICsgaik7CiAgICAgICAgICAgIHdoaWxlIChmICE9PSAoZiA9IGgoKSAvIGkpICYmIDEgIT09IGYgJiYgLS1nKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjICYmICgoayA9ICtrIHx8ICtpIHx8IDApLCAoZSA9IGNbMV0gPyBrICsgKGNbMV0gKyAxKSAqIGNbMl0gOiArY1syXSksIGQgJiYgKChkLnVuaXQgPSBqKSwgKGQuc3RhcnQgPSBrKSwgKGQuZW5kID0gZSkpKSwgZTsKICAgICAgICB9CiAgICAgICAgdmFyIGVhID0ge307CiAgICAgICAgZnVuY3Rpb24gZmEoYSkgewogICAgICAgICAgdmFyIGIsCiAgICAgICAgICAgIGMgPSBhLm93bmVyRG9jdW1lbnQsCiAgICAgICAgICAgIGQgPSBhLm5vZGVOYW1lLAogICAgICAgICAgICBlID0gZWFbZF07CiAgICAgICAgICByZXR1cm4gZQogICAgICAgICAgICA/IGUKICAgICAgICAgICAgOiAoKGIgPSBjLmJvZHkuYXBwZW5kQ2hpbGQoYy5jcmVhdGVFbGVtZW50KGQpKSksCiAgICAgICAgICAgICAgKGUgPSByLmNzcyhiLCAiZGlzcGxheSIpKSwKICAgICAgICAgICAgICBiLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYiksCiAgICAgICAgICAgICAgIm5vbmUiID09PSBlICYmIChlID0gImJsb2NrIiksCiAgICAgICAgICAgICAgKGVhW2RdID0gZSksCiAgICAgICAgICAgICAgZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdhKGEsIGIpIHsKICAgICAgICAgIGZvciAodmFyIGMsIGQsIGUgPSBbXSwgZiA9IDAsIGcgPSBhLmxlbmd0aDsgZiA8IGc7IGYrKykKICAgICAgICAgICAgKGQgPSBhW2ZdKSwKICAgICAgICAgICAgICBkLnN0eWxlICYmCiAgICAgICAgICAgICAgICAoKGMgPSBkLnN0eWxlLmRpc3BsYXkpLAogICAgICAgICAgICAgICAgYgogICAgICAgICAgICAgICAgICA/ICgibm9uZSIgPT09IGMgJiYgKChlW2ZdID0gVi5nZXQoZCwgImRpc3BsYXkiKSB8fCBudWxsKSwgZVtmXSB8fCAoZC5zdHlsZS5kaXNwbGF5ID0gIiIpKSwKICAgICAgICAgICAgICAgICAgICAiIiA9PT0gZC5zdHlsZS5kaXNwbGF5ICYmIGJhKGQpICYmIChlW2ZdID0gZmEoZCkpKQogICAgICAgICAgICAgICAgICA6ICJub25lIiAhPT0gYyAmJiAoKGVbZl0gPSAibm9uZSIpLCBWLnNldChkLCAiZGlzcGxheSIsIGMpKSk7CiAgICAgICAgICBmb3IgKGYgPSAwOyBmIDwgZzsgZisrKSBudWxsICE9IGVbZl0gJiYgKGFbZl0uc3R5bGUuZGlzcGxheSA9IGVbZl0pOwogICAgICAgICAgcmV0dXJuIGE7CiAgICAgICAgfQogICAgICAgIHIuZm4uZXh0ZW5kKHsKICAgICAgICAgIHNob3c6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGdhKHRoaXMsICEwKTsKICAgICAgICAgIH0sCiAgICAgICAgICBoaWRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBnYSh0aGlzKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0b2dnbGU6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiAiYm9vbGVhbiIgPT0gdHlwZW9mIGEKICAgICAgICAgICAgICA/IGEKICAgICAgICAgICAgICAgID8gdGhpcy5zaG93KCkKICAgICAgICAgICAgICAgIDogdGhpcy5oaWRlKCkKICAgICAgICAgICAgICA6IHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIGJhKHRoaXMpID8gcih0aGlzKS5zaG93KCkgOiByKHRoaXMpLmhpZGUoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICB9KTsKICAgICAgICB2YXIgaGEgPSAvXig/OmNoZWNrYm94fHJhZGlvKSQvaSwKICAgICAgICAgIGlhID0gLzwoW2Etel1bXlwvXDA+XHgyMFx0XHJcblxmXSspL2ksCiAgICAgICAgICBqYSA9IC9eJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSwKICAgICAgICAgIGthID0gewogICAgICAgICAgICBvcHRpb246IFsxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iXSwKICAgICAgICAgICAgdGhlYWQ6IFsxLCAiPHRhYmxlPiIsICI8L3RhYmxlPiJdLAogICAgICAgICAgICBjb2w6IFsyLCAiPHRhYmxlPjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiJdLAogICAgICAgICAgICB0cjogWzIsICI8dGFibGU+PHRib2R5PiIsICI8L3Rib2R5PjwvdGFibGU+Il0sCiAgICAgICAgICAgIHRkOiBbMywgIjx0YWJsZT48dGJvZHk+PHRyPiIsICI8L3RyPjwvdGJvZHk+PC90YWJsZT4iXSwKICAgICAgICAgICAgX2RlZmF1bHQ6IFswLCAiIiwgIiJdLAogICAgICAgICAgfTsKICAgICAgICAoa2Eub3B0Z3JvdXAgPSBrYS5vcHRpb24pLCAoa2EudGJvZHkgPSBrYS50Zm9vdCA9IGthLmNvbGdyb3VwID0ga2EuY2FwdGlvbiA9IGthLnRoZWFkKSwgKGthLnRoID0ga2EudGQpOwogICAgICAgIGZ1bmN0aW9uIGxhKGEsIGIpIHsKICAgICAgICAgIHZhciBjID0KICAgICAgICAgICAgInVuZGVmaW5lZCIgIT0gdHlwZW9mIGEuZ2V0RWxlbWVudHNCeVRhZ05hbWUKICAgICAgICAgICAgICA/IGEuZ2V0RWxlbWVudHNCeVRhZ05hbWUoYiB8fCAiKiIpCiAgICAgICAgICAgICAgOiAidW5kZWZpbmVkIiAhPSB0eXBlb2YgYS5xdWVyeVNlbGVjdG9yQWxsCiAgICAgICAgICAgICAgPyBhLnF1ZXJ5U2VsZWN0b3JBbGwoYiB8fCAiKiIpCiAgICAgICAgICAgICAgOiBbXTsKICAgICAgICAgIHJldHVybiB2b2lkIDAgPT09IGIgfHwgKGIgJiYgci5ub2RlTmFtZShhLCBiKSkgPyByLm1lcmdlKFthXSwgYykgOiBjOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYShhLCBiKSB7CiAgICAgICAgICBmb3IgKHZhciBjID0gMCwgZCA9IGEubGVuZ3RoOyBjIDwgZDsgYysrKSBWLnNldChhW2NdLCAiZ2xvYmFsRXZhbCIsICFiIHx8IFYuZ2V0KGJbY10sICJnbG9iYWxFdmFsIikpOwogICAgICAgIH0KICAgICAgICB2YXIgbmEgPSAvPHwmIz9cdys7LzsKICAgICAgICBmdW5jdGlvbiBvYShhLCBiLCBjLCBkLCBlKSB7CiAgICAgICAgICBmb3IgKHZhciBmLCBnLCBoLCBpLCBqLCBrLCBsID0gYi5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksIG0gPSBbXSwgbiA9IDAsIG8gPSBhLmxlbmd0aDsgbiA8IG87IG4rKykKICAgICAgICAgICAgaWYgKCgoZiA9IGFbbl0pLCBmIHx8IDAgPT09IGYpKQogICAgICAgICAgICAgIGlmICgib2JqZWN0IiA9PT0gci50eXBlKGYpKSByLm1lcmdlKG0sIGYubm9kZVR5cGUgPyBbZl0gOiBmKTsKICAgICAgICAgICAgICBlbHNlIGlmIChuYS50ZXN0KGYpKSB7CiAgICAgICAgICAgICAgICAoZyA9IGcgfHwgbC5hcHBlbmRDaGlsZChiLmNyZWF0ZUVsZW1lbnQoImRpdiIpKSksCiAgICAgICAgICAgICAgICAgIChoID0gKGlhLmV4ZWMoZikgfHwgWyIiLCAiIl0pWzFdLnRvTG93ZXJDYXNlKCkpLAogICAgICAgICAgICAgICAgICAoaSA9IGthW2hdIHx8IGthLl9kZWZhdWx0KSwKICAgICAgICAgICAgICAgICAgKGcuaW5uZXJIVE1MID0gaVsxXSArIHIuaHRtbFByZWZpbHRlcihmKSArIGlbMl0pLAogICAgICAgICAgICAgICAgICAoayA9IGlbMF0pOwogICAgICAgICAgICAgICAgd2hpbGUgKGstLSkgZyA9IGcubGFzdENoaWxkOwogICAgICAgICAgICAgICAgci5tZXJnZShtLCBnLmNoaWxkTm9kZXMpLCAoZyA9IGwuZmlyc3RDaGlsZCksIChnLnRleHRDb250ZW50ID0gIiIpOwogICAgICAgICAgICAgIH0gZWxzZSBtLnB1c2goYi5jcmVhdGVUZXh0Tm9kZShmKSk7CiAgICAgICAgICAobC50ZXh0Q29udGVudCA9ICIiKSwgKG4gPSAwKTsKICAgICAgICAgIHdoaWxlICgoZiA9IG1bbisrXSkpCiAgICAgICAgICAgIGlmIChkICYmIHIuaW5BcnJheShmLCBkKSA+IC0xKSBlICYmIGUucHVzaChmKTsKICAgICAgICAgICAgZWxzZSBpZiAoKChqID0gci5jb250YWlucyhmLm93bmVyRG9jdW1lbnQsIGYpKSwgKGcgPSBsYShsLmFwcGVuZENoaWxkKGYpLCAic2NyaXB0IikpLCBqICYmIG1hKGcpLCBjKSkgewogICAgICAgICAgICAgIGsgPSAwOwogICAgICAgICAgICAgIHdoaWxlICgoZiA9IGdbaysrXSkpIGphLnRlc3QoZi50eXBlIHx8ICIiKSAmJiBjLnB1c2goZik7CiAgICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsOwogICAgICAgIH0KICAgICAgICAhKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBhID0gZC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgICAgIGIgPSBhLmFwcGVuZENoaWxkKGQuY3JlYXRlRWxlbWVudCgiZGl2IikpLAogICAgICAgICAgICBjID0gZC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgYy5zZXRBdHRyaWJ1dGUoInR5cGUiLCAicmFkaW8iKSwKICAgICAgICAgICAgYy5zZXRBdHRyaWJ1dGUoImNoZWNrZWQiLCAiY2hlY2tlZCIpLAogICAgICAgICAgICBjLnNldEF0dHJpYnV0ZSgibmFtZSIsICJ0IiksCiAgICAgICAgICAgIGIuYXBwZW5kQ2hpbGQoYyksCiAgICAgICAgICAgIChvLmNoZWNrQ2xvbmUgPSBiLmNsb25lTm9kZSghMCkuY2xvbmVOb2RlKCEwKS5sYXN0Q2hpbGQuY2hlY2tlZCksCiAgICAgICAgICAgIChiLmlubmVySFRNTCA9ICI8dGV4dGFyZWE+eDwvdGV4dGFyZWE+IiksCiAgICAgICAgICAgIChvLm5vQ2xvbmVDaGVja2VkID0gISFiLmNsb25lTm9kZSghMCkubGFzdENoaWxkLmRlZmF1bHRWYWx1ZSk7CiAgICAgICAgfSkoKTsKICAgICAgICB2YXIgcGEgPSBkLmRvY3VtZW50RWxlbWVudCwKICAgICAgICAgIHFhID0gL15rZXkvLAogICAgICAgICAgcmEgPSAvXig/Om1vdXNlfHBvaW50ZXJ8Y29udGV4dG1lbnV8ZHJhZ3xkcm9wKXxjbGljay8sCiAgICAgICAgICBzYSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpLzsKICAgICAgICBmdW5jdGlvbiB0YSgpIHsKICAgICAgICAgIHJldHVybiAhMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdWEoKSB7CiAgICAgICAgICByZXR1cm4gITE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGQuYWN0aXZlRWxlbWVudDsKICAgICAgICAgIH0gY2F0Y2ggKGEpIHt9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhKGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIHZhciBnLCBoOwogICAgICAgICAgaWYgKCJvYmplY3QiID09IHR5cGVvZiBiKSB7CiAgICAgICAgICAgICJzdHJpbmciICE9IHR5cGVvZiBjICYmICgoZCA9IGQgfHwgYyksIChjID0gdm9pZCAwKSk7CiAgICAgICAgICAgIGZvciAoaCBpbiBiKSB3YShhLCBoLCBjLCBkLCBiW2hdLCBmKTsKICAgICAgICAgICAgcmV0dXJuIGE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIChudWxsID09IGQgJiYgbnVsbCA9PSBlCiAgICAgICAgICAgICAgPyAoKGUgPSBjKSwgKGQgPSBjID0gdm9pZCAwKSkKICAgICAgICAgICAgICA6IG51bGwgPT0gZSAmJiAoInN0cmluZyIgPT0gdHlwZW9mIGMgPyAoKGUgPSBkKSwgKGQgPSB2b2lkIDApKSA6ICgoZSA9IGQpLCAoZCA9IGMpLCAoYyA9IHZvaWQgMCkpKSwKICAgICAgICAgICAgZSA9PT0gITEpCiAgICAgICAgICApCiAgICAgICAgICAgIGUgPSB1YTsKICAgICAgICAgIGVsc2UgaWYgKCFlKSByZXR1cm4gYTsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIDEgPT09IGYgJiYKICAgICAgICAgICAgICAoKGcgPSBlKSwKICAgICAgICAgICAgICAoZSA9IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcigpLm9mZihhKSwgZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgIChlLmd1aWQgPSBnLmd1aWQgfHwgKGcuZ3VpZCA9IHIuZ3VpZCsrKSkpLAogICAgICAgICAgICBhLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHIuZXZlbnQuYWRkKHRoaXMsIGIsIGUsIGQsIGMpOwogICAgICAgICAgICB9KQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgKHIuZXZlbnQgPSB7CiAgICAgICAgICBnbG9iYWw6IHt9LAogICAgICAgICAgYWRkOiBmdW5jdGlvbiAoYSwgYiwgYywgZCwgZSkgewogICAgICAgICAgICB2YXIgZiwKICAgICAgICAgICAgICBnLAogICAgICAgICAgICAgIGgsCiAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICBqLAogICAgICAgICAgICAgIGssCiAgICAgICAgICAgICAgbCwKICAgICAgICAgICAgICBtLAogICAgICAgICAgICAgIG4sCiAgICAgICAgICAgICAgbywKICAgICAgICAgICAgICBwLAogICAgICAgICAgICAgIHEgPSBWLmdldChhKTsKICAgICAgICAgICAgaWYgKHEpIHsKICAgICAgICAgICAgICBjLmhhbmRsZXIgJiYgKChmID0gYyksIChjID0gZi5oYW5kbGVyKSwgKGUgPSBmLnNlbGVjdG9yKSksCiAgICAgICAgICAgICAgICBlICYmIHIuZmluZC5tYXRjaGVzU2VsZWN0b3IocGEsIGUpLAogICAgICAgICAgICAgICAgYy5ndWlkIHx8IChjLmd1aWQgPSByLmd1aWQrKyksCiAgICAgICAgICAgICAgICAoaSA9IHEuZXZlbnRzKSB8fCAoaSA9IHEuZXZlbnRzID0ge30pLAogICAgICAgICAgICAgICAgKGcgPSBxLmhhbmRsZSkgfHwKICAgICAgICAgICAgICAgICAgKGcgPSBxLmhhbmRsZSA9CiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAidW5kZWZpbmVkIiAhPSB0eXBlb2YgciAmJiByLmV2ZW50LnRyaWdnZXJlZCAhPT0gYi50eXBlID8gci5ldmVudC5kaXNwYXRjaC5hcHBseShhLCBhcmd1bWVudHMpIDogdm9pZCAwOwogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgKGIgPSAoYiB8fCAiIikubWF0Y2goSykgfHwgWyIiXSksCiAgICAgICAgICAgICAgICAoaiA9IGIubGVuZ3RoKTsKICAgICAgICAgICAgICB3aGlsZSAoai0tKQogICAgICAgICAgICAgICAgKGggPSBzYS5leGVjKGJbal0pIHx8IFtdKSwKICAgICAgICAgICAgICAgICAgKG4gPSBwID0gaFsxXSksCiAgICAgICAgICAgICAgICAgIChvID0gKGhbMl0gfHwgIiIpLnNwbGl0KCIuIikuc29ydCgpKSwKICAgICAgICAgICAgICAgICAgbiAmJgogICAgICAgICAgICAgICAgICAgICgobCA9IHIuZXZlbnQuc3BlY2lhbFtuXSB8fCB7fSksCiAgICAgICAgICAgICAgICAgICAgKG4gPSAoZSA/IGwuZGVsZWdhdGVUeXBlIDogbC5iaW5kVHlwZSkgfHwgbiksCiAgICAgICAgICAgICAgICAgICAgKGwgPSByLmV2ZW50LnNwZWNpYWxbbl0gfHwge30pLAogICAgICAgICAgICAgICAgICAgIChrID0gci5leHRlbmQoCiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG4sCiAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdUeXBlOiBwLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkLAogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyOiBjLAogICAgICAgICAgICAgICAgICAgICAgICBndWlkOiBjLmd1aWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yOiBlLAogICAgICAgICAgICAgICAgICAgICAgICBuZWVkc0NvbnRleHQ6IGUgJiYgci5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KGUpLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IG8uam9pbigiLiIpLAogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgIGYKICAgICAgICAgICAgICAgICAgICApKSwKICAgICAgICAgICAgICAgICAgICAobSA9IGlbbl0pIHx8CiAgICAgICAgICAgICAgICAgICAgICAoKG0gPSBpW25dID0gW10pLAogICAgICAgICAgICAgICAgICAgICAgKG0uZGVsZWdhdGVDb3VudCA9IDApLAogICAgICAgICAgICAgICAgICAgICAgKGwuc2V0dXAgJiYgbC5zZXR1cC5jYWxsKGEsIGQsIG8sIGcpICE9PSAhMSkgfHwgKGEuYWRkRXZlbnRMaXN0ZW5lciAmJiBhLmFkZEV2ZW50TGlzdGVuZXIobiwgZykpKSwKICAgICAgICAgICAgICAgICAgICBsLmFkZCAmJiAobC5hZGQuY2FsbChhLCBrKSwgay5oYW5kbGVyLmd1aWQgfHwgKGsuaGFuZGxlci5ndWlkID0gYy5ndWlkKSksCiAgICAgICAgICAgICAgICAgICAgZSA/IG0uc3BsaWNlKG0uZGVsZWdhdGVDb3VudCsrLCAwLCBrKSA6IG0ucHVzaChrKSwKICAgICAgICAgICAgICAgICAgICAoci5ldmVudC5nbG9iYWxbbl0gPSAhMCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoYSwgYiwgYywgZCwgZSkgewogICAgICAgICAgICB2YXIgZiwKICAgICAgICAgICAgICBnLAogICAgICAgICAgICAgIGgsCiAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICBqLAogICAgICAgICAgICAgIGssCiAgICAgICAgICAgICAgbCwKICAgICAgICAgICAgICBtLAogICAgICAgICAgICAgIG4sCiAgICAgICAgICAgICAgbywKICAgICAgICAgICAgICBwLAogICAgICAgICAgICAgIHEgPSBWLmhhc0RhdGEoYSkgJiYgVi5nZXQoYSk7CiAgICAgICAgICAgIGlmIChxICYmIChpID0gcS5ldmVudHMpKSB7CiAgICAgICAgICAgICAgKGIgPSAoYiB8fCAiIikubWF0Y2goSykgfHwgWyIiXSksIChqID0gYi5sZW5ndGgpOwogICAgICAgICAgICAgIHdoaWxlIChqLS0pCiAgICAgICAgICAgICAgICBpZiAoKChoID0gc2EuZXhlYyhiW2pdKSB8fCBbXSksIChuID0gcCA9IGhbMV0pLCAobyA9IChoWzJdIHx8ICIiKS5zcGxpdCgiLiIpLnNvcnQoKSksIG4pKSB7CiAgICAgICAgICAgICAgICAgIChsID0gci5ldmVudC5zcGVjaWFsW25dIHx8IHt9KSwKICAgICAgICAgICAgICAgICAgICAobiA9IChkID8gbC5kZWxlZ2F0ZVR5cGUgOiBsLmJpbmRUeXBlKSB8fCBuKSwKICAgICAgICAgICAgICAgICAgICAobSA9IGlbbl0gfHwgW10pLAogICAgICAgICAgICAgICAgICAgIChoID0gaFsyXSAmJiBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIG8uam9pbigiXFwuKD86LipcXC58KSIpICsgIihcXC58JCkiKSksCiAgICAgICAgICAgICAgICAgICAgKGcgPSBmID0gbS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICB3aGlsZSAoZi0tKQogICAgICAgICAgICAgICAgICAgIChrID0gbVtmXSksCiAgICAgICAgICAgICAgICAgICAgICAoIWUgJiYgcCAhPT0gay5vcmlnVHlwZSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKGMgJiYgYy5ndWlkICE9PSBrLmd1aWQpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIChoICYmICFoLnRlc3Qoay5uYW1lc3BhY2UpKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAoZCAmJiBkICE9PSBrLnNlbGVjdG9yICYmICgiKioiICE9PSBkIHx8ICFrLnNlbGVjdG9yKSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKG0uc3BsaWNlKGYsIDEpLCBrLnNlbGVjdG9yICYmIG0uZGVsZWdhdGVDb3VudC0tLCBsLnJlbW92ZSAmJiBsLnJlbW92ZS5jYWxsKGEsIGspKTsKICAgICAgICAgICAgICAgICAgZyAmJiAhbS5sZW5ndGggJiYgKChsLnRlYXJkb3duICYmIGwudGVhcmRvd24uY2FsbChhLCBvLCBxLmhhbmRsZSkgIT09ICExKSB8fCByLnJlbW92ZUV2ZW50KGEsIG4sIHEuaGFuZGxlKSwgZGVsZXRlIGlbbl0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGZvciAobiBpbiBpKSByLmV2ZW50LnJlbW92ZShhLCBuICsgYltqXSwgYywgZCwgITApOwogICAgICAgICAgICAgIHIuaXNFbXB0eU9iamVjdChpKSAmJiBWLnJlbW92ZShhLCAiaGFuZGxlIGV2ZW50cyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZGlzcGF0Y2g6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHZhciBiID0gci5ldmVudC5maXgoYSksCiAgICAgICAgICAgICAgYywKICAgICAgICAgICAgICBkLAogICAgICAgICAgICAgIGUsCiAgICAgICAgICAgICAgZiwKICAgICAgICAgICAgICBnLAogICAgICAgICAgICAgIGgsCiAgICAgICAgICAgICAgaSA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoKSwKICAgICAgICAgICAgICBqID0gKFYuZ2V0KHRoaXMsICJldmVudHMiKSB8fCB7fSlbYi50eXBlXSB8fCBbXSwKICAgICAgICAgICAgICBrID0gci5ldmVudC5zcGVjaWFsW2IudHlwZV0gfHwge307CiAgICAgICAgICAgIGZvciAoaVswXSA9IGIsIGMgPSAxOyBjIDwgYXJndW1lbnRzLmxlbmd0aDsgYysrKSBpW2NdID0gYXJndW1lbnRzW2NdOwogICAgICAgICAgICBpZiAoKChiLmRlbGVnYXRlVGFyZ2V0ID0gdGhpcyksICFrLnByZURpc3BhdGNoIHx8IGsucHJlRGlzcGF0Y2guY2FsbCh0aGlzLCBiKSAhPT0gITEpKSB7CiAgICAgICAgICAgICAgKGggPSByLmV2ZW50LmhhbmRsZXJzLmNhbGwodGhpcywgYiwgaikpLCAoYyA9IDApOwogICAgICAgICAgICAgIHdoaWxlICgoZiA9IGhbYysrXSkgJiYgIWIuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgICAgKGIuY3VycmVudFRhcmdldCA9IGYuZWxlbSksIChkID0gMCk7CiAgICAgICAgICAgICAgICB3aGlsZSAoKGcgPSBmLmhhbmRsZXJzW2QrK10pICYmICFiLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkpCiAgICAgICAgICAgICAgICAgIChiLnJuYW1lc3BhY2UgJiYgIWIucm5hbWVzcGFjZS50ZXN0KGcubmFtZXNwYWNlKSkgfHwKICAgICAgICAgICAgICAgICAgICAoKGIuaGFuZGxlT2JqID0gZyksCiAgICAgICAgICAgICAgICAgICAgKGIuZGF0YSA9IGcuZGF0YSksCiAgICAgICAgICAgICAgICAgICAgKGUgPSAoKHIuZXZlbnQuc3BlY2lhbFtnLm9yaWdUeXBlXSB8fCB7fSkuaGFuZGxlIHx8IGcuaGFuZGxlcikuYXBwbHkoZi5lbGVtLCBpKSksCiAgICAgICAgICAgICAgICAgICAgdm9pZCAwICE9PSBlICYmIChiLnJlc3VsdCA9IGUpID09PSAhMSAmJiAoYi5wcmV2ZW50RGVmYXVsdCgpLCBiLnN0b3BQcm9wYWdhdGlvbigpKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBrLnBvc3REaXNwYXRjaCAmJiBrLnBvc3REaXNwYXRjaC5jYWxsKHRoaXMsIGIpLCBiLnJlc3VsdDsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGhhbmRsZXJzOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICB2YXIgYywKICAgICAgICAgICAgICBkLAogICAgICAgICAgICAgIGUsCiAgICAgICAgICAgICAgZiwKICAgICAgICAgICAgICBnID0gW10sCiAgICAgICAgICAgICAgaCA9IGIuZGVsZWdhdGVDb3VudCwKICAgICAgICAgICAgICBpID0gYS50YXJnZXQ7CiAgICAgICAgICAgIGlmIChoICYmIGkubm9kZVR5cGUgJiYgKCJjbGljayIgIT09IGEudHlwZSB8fCBpc05hTihhLmJ1dHRvbikgfHwgYS5idXR0b24gPCAxKSkKICAgICAgICAgICAgICBmb3IgKDsgaSAhPT0gdGhpczsgaSA9IGkucGFyZW50Tm9kZSB8fCB0aGlzKQogICAgICAgICAgICAgICAgaWYgKDEgPT09IGkubm9kZVR5cGUgJiYgKGkuZGlzYWJsZWQgIT09ICEwIHx8ICJjbGljayIgIT09IGEudHlwZSkpIHsKICAgICAgICAgICAgICAgICAgZm9yIChkID0gW10sIGMgPSAwOyBjIDwgaDsgYysrKQogICAgICAgICAgICAgICAgICAgIChmID0gYltjXSksCiAgICAgICAgICAgICAgICAgICAgICAoZSA9IGYuc2VsZWN0b3IgKyAiICIpLAogICAgICAgICAgICAgICAgICAgICAgdm9pZCAwID09PSBkW2VdICYmIChkW2VdID0gZi5uZWVkc0NvbnRleHQgPyByKGUsIHRoaXMpLmluZGV4KGkpID4gLTEgOiByLmZpbmQoZSwgdGhpcywgbnVsbCwgW2ldKS5sZW5ndGgpLAogICAgICAgICAgICAgICAgICAgICAgZFtlXSAmJiBkLnB1c2goZik7CiAgICAgICAgICAgICAgICAgIGQubGVuZ3RoICYmIGcucHVzaCh7IGVsZW06IGksIGhhbmRsZXJzOiBkIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaCA8IGIubGVuZ3RoICYmIGcucHVzaCh7IGVsZW06IHRoaXMsIGhhbmRsZXJzOiBiLnNsaWNlKGgpIH0pLCBnOwogICAgICAgICAgfSwKICAgICAgICAgIGFkZFByb3A6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShyLkV2ZW50LnByb3RvdHlwZSwgYSwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6ICEwLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgICAgICAgZ2V0OiByLmlzRnVuY3Rpb24oYikKICAgICAgICAgICAgICAgID8gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9yaWdpbmFsRXZlbnQpIHJldHVybiBiKHRoaXMub3JpZ2luYWxFdmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9yaWdpbmFsRXZlbnQpIHJldHVybiB0aGlzLm9yaWdpbmFsRXZlbnRbYV07CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIGEsIHsKICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgICAgICAgICAgIHdyaXRhYmxlOiAhMCwKICAgICAgICAgICAgICAgICAgdmFsdWU6IGIsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBmaXg6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiBhW3IuZXhwYW5kb10gPyBhIDogbmV3IHIuRXZlbnQoYSk7CiAgICAgICAgICB9LAogICAgICAgICAgc3BlY2lhbDogewogICAgICAgICAgICBsb2FkOiB7IG5vQnViYmxlOiAhMCB9LAogICAgICAgICAgICBmb2N1czogewogICAgICAgICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzICE9PSB2YSgpICYmIHRoaXMuZm9jdXMpIHJldHVybiB0aGlzLmZvY3VzKCksICExOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZGVsZWdhdGVUeXBlOiAiZm9jdXNpbiIsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJsdXI6IHsKICAgICAgICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcyA9PT0gdmEoKSAmJiB0aGlzLmJsdXIpIHJldHVybiB0aGlzLmJsdXIoKSwgITE7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkZWxlZ2F0ZVR5cGU6ICJmb2N1c291dCIsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsaWNrOiB7CiAgICAgICAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCJjaGVja2JveCIgPT09IHRoaXMudHlwZSAmJiB0aGlzLmNsaWNrICYmIHIubm9kZU5hbWUodGhpcywgImlucHV0IikpIHJldHVybiB0aGlzLmNsaWNrKCksICExOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2RlZmF1bHQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gci5ub2RlTmFtZShhLnRhcmdldCwgImEiKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9LAogICAgICAgICAgICBiZWZvcmV1bmxvYWQ6IHsKICAgICAgICAgICAgICBwb3N0RGlzcGF0Y2g6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICB2b2lkIDAgIT09IGEucmVzdWx0ICYmIGEub3JpZ2luYWxFdmVudCAmJiAoYS5vcmlnaW5hbEV2ZW50LnJldHVyblZhbHVlID0gYS5yZXN1bHQpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9LAogICAgICAgIH0pLAogICAgICAgICAgKHIucmVtb3ZlRXZlbnQgPSBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICBhLnJlbW92ZUV2ZW50TGlzdGVuZXIgJiYgYS5yZW1vdmVFdmVudExpc3RlbmVyKGIsIGMpOwogICAgICAgICAgfSksCiAgICAgICAgICAoci5FdmVudCA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzIGluc3RhbmNlb2Ygci5FdmVudAogICAgICAgICAgICAgID8gKGEgJiYgYS50eXBlCiAgICAgICAgICAgICAgICAgID8gKCh0aGlzLm9yaWdpbmFsRXZlbnQgPSBhKSwKICAgICAgICAgICAgICAgICAgICAodGhpcy50eXBlID0gYS50eXBlKSwKICAgICAgICAgICAgICAgICAgICAodGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBhLmRlZmF1bHRQcmV2ZW50ZWQgfHwgKHZvaWQgMCA9PT0gYS5kZWZhdWx0UHJldmVudGVkICYmIGEucmV0dXJuVmFsdWUgPT09ICExKSA/IHRhIDogdWEpLAogICAgICAgICAgICAgICAgICAgICh0aGlzLnRhcmdldCA9IGEudGFyZ2V0ICYmIDMgPT09IGEudGFyZ2V0Lm5vZGVUeXBlID8gYS50YXJnZXQucGFyZW50Tm9kZSA6IGEudGFyZ2V0KSwKICAgICAgICAgICAgICAgICAgICAodGhpcy5jdXJyZW50VGFyZ2V0ID0gYS5jdXJyZW50VGFyZ2V0KSwKICAgICAgICAgICAgICAgICAgICAodGhpcy5yZWxhdGVkVGFyZ2V0ID0gYS5yZWxhdGVkVGFyZ2V0KSkKICAgICAgICAgICAgICAgICAgOiAodGhpcy50eXBlID0gYSksCiAgICAgICAgICAgICAgICBiICYmIHIuZXh0ZW5kKHRoaXMsIGIpLAogICAgICAgICAgICAgICAgKHRoaXMudGltZVN0YW1wID0gKGEgJiYgYS50aW1lU3RhbXApIHx8IHIubm93KCkpLAogICAgICAgICAgICAgICAgdm9pZCAodGhpc1tyLmV4cGFuZG9dID0gITApKQogICAgICAgICAgICAgIDogbmV3IHIuRXZlbnQoYSwgYik7CiAgICAgICAgICB9KSwKICAgICAgICAgIChyLkV2ZW50LnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgY29uc3RydWN0b3I6IHIuRXZlbnQsCiAgICAgICAgICAgIGlzRGVmYXVsdFByZXZlbnRlZDogdWEsCiAgICAgICAgICAgIGlzUHJvcGFnYXRpb25TdG9wcGVkOiB1YSwKICAgICAgICAgICAgaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQ6IHVhLAogICAgICAgICAgICBpc1NpbXVsYXRlZDogITEsCiAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdmFyIGEgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgICAgICAgICAgKHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gdGEpLCBhICYmICF0aGlzLmlzU2ltdWxhdGVkICYmIGEucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdmFyIGEgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgICAgICAgICAgKHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSB0YSksIGEgJiYgIXRoaXMuaXNTaW11bGF0ZWQgJiYgYS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdmFyIGEgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CiAgICAgICAgICAgICAgKHRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSB0YSksIGEgJiYgIXRoaXMuaXNTaW11bGF0ZWQgJiYgYS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKSwgdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgICAgci5lYWNoKAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgYWx0S2V5OiAhMCwKICAgICAgICAgICAgICBidWJibGVzOiAhMCwKICAgICAgICAgICAgICBjYW5jZWxhYmxlOiAhMCwKICAgICAgICAgICAgICBjaGFuZ2VkVG91Y2hlczogITAsCiAgICAgICAgICAgICAgY3RybEtleTogITAsCiAgICAgICAgICAgICAgZGV0YWlsOiAhMCwKICAgICAgICAgICAgICBldmVudFBoYXNlOiAhMCwKICAgICAgICAgICAgICBtZXRhS2V5OiAhMCwKICAgICAgICAgICAgICBwYWdlWDogITAsCiAgICAgICAgICAgICAgcGFnZVk6ICEwLAogICAgICAgICAgICAgIHNoaWZ0S2V5OiAhMCwKICAgICAgICAgICAgICB2aWV3OiAhMCwKICAgICAgICAgICAgICBjaGFyOiAhMCwKICAgICAgICAgICAgICBjaGFyQ29kZTogITAsCiAgICAgICAgICAgICAga2V5OiAhMCwKICAgICAgICAgICAgICBrZXlDb2RlOiAhMCwKICAgICAgICAgICAgICBidXR0b246ICEwLAogICAgICAgICAgICAgIGJ1dHRvbnM6ICEwLAogICAgICAgICAgICAgIGNsaWVudFg6ICEwLAogICAgICAgICAgICAgIGNsaWVudFk6ICEwLAogICAgICAgICAgICAgIG9mZnNldFg6ICEwLAogICAgICAgICAgICAgIG9mZnNldFk6ICEwLAogICAgICAgICAgICAgIHBvaW50ZXJJZDogITAsCiAgICAgICAgICAgICAgcG9pbnRlclR5cGU6ICEwLAogICAgICAgICAgICAgIHNjcmVlblg6ICEwLAogICAgICAgICAgICAgIHNjcmVlblk6ICEwLAogICAgICAgICAgICAgIHRhcmdldFRvdWNoZXM6ICEwLAogICAgICAgICAgICAgIHRvRWxlbWVudDogITAsCiAgICAgICAgICAgICAgdG91Y2hlczogITAsCiAgICAgICAgICAgICAgd2hpY2g6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICB2YXIgYiA9IGEuYnV0dG9uOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGwgPT0gYS53aGljaCAmJiBxYS50ZXN0KGEudHlwZSkKICAgICAgICAgICAgICAgICAgPyBudWxsICE9IGEuY2hhckNvZGUKICAgICAgICAgICAgICAgICAgICA/IGEuY2hhckNvZGUKICAgICAgICAgICAgICAgICAgICA6IGEua2V5Q29kZQogICAgICAgICAgICAgICAgICA6ICFhLndoaWNoICYmIHZvaWQgMCAhPT0gYiAmJiByYS50ZXN0KGEudHlwZSkKICAgICAgICAgICAgICAgICAgPyAxICYgYgogICAgICAgICAgICAgICAgICAgID8gMQogICAgICAgICAgICAgICAgICAgIDogMiAmIGIKICAgICAgICAgICAgICAgICAgICA/IDMKICAgICAgICAgICAgICAgICAgICA6IDQgJiBiCiAgICAgICAgICAgICAgICAgICAgPyAyCiAgICAgICAgICAgICAgICAgICAgOiAwCiAgICAgICAgICAgICAgICAgIDogYS53aGljaDsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9LAogICAgICAgICAgICByLmV2ZW50LmFkZFByb3AKICAgICAgICAgICksCiAgICAgICAgICByLmVhY2goCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtb3VzZWVudGVyOiAibW91c2VvdmVyIiwKICAgICAgICAgICAgICBtb3VzZWxlYXZlOiAibW91c2VvdXQiLAogICAgICAgICAgICAgIHBvaW50ZXJlbnRlcjogInBvaW50ZXJvdmVyIiwKICAgICAgICAgICAgICBwb2ludGVybGVhdmU6ICJwb2ludGVyb3V0IiwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICByLmV2ZW50LnNwZWNpYWxbYV0gPSB7CiAgICAgICAgICAgICAgICBkZWxlZ2F0ZVR5cGU6IGIsCiAgICAgICAgICAgICAgICBiaW5kVHlwZTogYiwKICAgICAgICAgICAgICAgIGhhbmRsZTogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgdmFyIGMsCiAgICAgICAgICAgICAgICAgICAgZCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgZSA9IGEucmVsYXRlZFRhcmdldCwKICAgICAgICAgICAgICAgICAgICBmID0gYS5oYW5kbGVPYmo7CiAgICAgICAgICAgICAgICAgIHJldHVybiAoZSAmJiAoZSA9PT0gZCB8fCByLmNvbnRhaW5zKGQsIGUpKSkgfHwgKChhLnR5cGUgPSBmLm9yaWdUeXBlKSwgKGMgPSBmLmhhbmRsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSksIChhLnR5cGUgPSBiKSksIGM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICByLmZuLmV4dGVuZCh7CiAgICAgICAgICAgIG9uOiBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgICAgICAgICAgIHJldHVybiB3YSh0aGlzLCBhLCBiLCBjLCBkKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25lOiBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgICAgICAgICAgIHJldHVybiB3YSh0aGlzLCBhLCBiLCBjLCBkLCAxKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb2ZmOiBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgIHZhciBkLCBlOwogICAgICAgICAgICAgIGlmIChhICYmIGEucHJldmVudERlZmF1bHQgJiYgYS5oYW5kbGVPYmopCiAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAoZCA9IGEuaGFuZGxlT2JqKSwgcihhLmRlbGVnYXRlVGFyZ2V0KS5vZmYoZC5uYW1lc3BhY2UgPyBkLm9yaWdUeXBlICsgIi4iICsgZC5uYW1lc3BhY2UgOiBkLm9yaWdUeXBlLCBkLnNlbGVjdG9yLCBkLmhhbmRsZXIpLCB0aGlzCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICgib2JqZWN0IiA9PSB0eXBlb2YgYSkgewogICAgICAgICAgICAgICAgZm9yIChlIGluIGEpIHRoaXMub2ZmKGUsIGIsIGFbZV0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAoYiAhPT0gITEgJiYgImZ1bmN0aW9uIiAhPSB0eXBlb2YgYikgfHwgKChjID0gYiksIChiID0gdm9pZCAwKSksCiAgICAgICAgICAgICAgICBjID09PSAhMSAmJiAoYyA9IHVhKSwKICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHIuZXZlbnQucmVtb3ZlKHRoaXMsIGEsIGMsIGIpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgfSk7CiAgICAgICAgdmFyIHhhID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW2Etel1bXlwvXDA+XHgyMFx0XHJcblxmXSopW14+XSopXC8+L2dpLAogICAgICAgICAgeWEgPSAvPHNjcmlwdHw8c3R5bGV8PGxpbmsvaSwKICAgICAgICAgIHphID0gL2NoZWNrZWRccyooPzpbXj1dfD1ccyouY2hlY2tlZC4pL2ksCiAgICAgICAgICBBYSA9IC9edHJ1ZVwvKC4qKS8sCiAgICAgICAgICBCYSA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8LS0pfCg/OlxdXF18LS0pPlxzKiQvZzsKICAgICAgICBmdW5jdGlvbiBDYShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gci5ub2RlTmFtZShhLCAidGFibGUiKSAmJiByLm5vZGVOYW1lKDExICE9PSBiLm5vZGVUeXBlID8gYiA6IGIuZmlyc3RDaGlsZCwgInRyIikgPyBhLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpWzBdIHx8IGEgOiBhOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBEYShhKSB7CiAgICAgICAgICByZXR1cm4gKGEudHlwZSA9IChudWxsICE9PSBhLmdldEF0dHJpYnV0ZSgidHlwZSIpKSArICIvIiArIGEudHlwZSksIGE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIEVhKGEpIHsKICAgICAgICAgIHZhciBiID0gQWEuZXhlYyhhLnR5cGUpOwogICAgICAgICAgcmV0dXJuIGIgPyAoYS50eXBlID0gYlsxXSkgOiBhLnJlbW92ZUF0dHJpYnV0ZSgidHlwZSIpLCBhOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGYShhLCBiKSB7CiAgICAgICAgICB2YXIgYywgZCwgZSwgZiwgZywgaCwgaSwgajsKICAgICAgICAgIGlmICgxID09PSBiLm5vZGVUeXBlKSB7CiAgICAgICAgICAgIGlmIChWLmhhc0RhdGEoYSkgJiYgKChmID0gVi5hY2Nlc3MoYSkpLCAoZyA9IFYuc2V0KGIsIGYpKSwgKGogPSBmLmV2ZW50cykpKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGcuaGFuZGxlLCAoZy5ldmVudHMgPSB7fSk7CiAgICAgICAgICAgICAgZm9yIChlIGluIGopIGZvciAoYyA9IDAsIGQgPSBqW2VdLmxlbmd0aDsgYyA8IGQ7IGMrKykgci5ldmVudC5hZGQoYiwgZSwgaltlXVtjXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgVy5oYXNEYXRhKGEpICYmICgoaCA9IFcuYWNjZXNzKGEpKSwgKGkgPSByLmV4dGVuZCh7fSwgaCkpLCBXLnNldChiLCBpKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIEdhKGEsIGIpIHsKICAgICAgICAgIHZhciBjID0gYi5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgImlucHV0IiA9PT0gYyAmJiBoYS50ZXN0KGEudHlwZSkgPyAoYi5jaGVja2VkID0gYS5jaGVja2VkKSA6ICgiaW5wdXQiICE9PSBjICYmICJ0ZXh0YXJlYSIgIT09IGMpIHx8IChiLmRlZmF1bHRWYWx1ZSA9IGEuZGVmYXVsdFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gSGEoYSwgYiwgYywgZCkgewogICAgICAgICAgYiA9IGcuYXBwbHkoW10sIGIpOwogICAgICAgICAgdmFyIGUsCiAgICAgICAgICAgIGYsCiAgICAgICAgICAgIGgsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGosCiAgICAgICAgICAgIGssCiAgICAgICAgICAgIGwgPSAwLAogICAgICAgICAgICBtID0gYS5sZW5ndGgsCiAgICAgICAgICAgIG4gPSBtIC0gMSwKICAgICAgICAgICAgcSA9IGJbMF0sCiAgICAgICAgICAgIHMgPSByLmlzRnVuY3Rpb24ocSk7CiAgICAgICAgICBpZiAocyB8fCAobSA+IDEgJiYgInN0cmluZyIgPT0gdHlwZW9mIHEgJiYgIW8uY2hlY2tDbG9uZSAmJiB6YS50ZXN0KHEpKSkKICAgICAgICAgICAgcmV0dXJuIGEuZWFjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgIHZhciBmID0gYS5lcShlKTsKICAgICAgICAgICAgICBzICYmIChiWzBdID0gcS5jYWxsKHRoaXMsIGUsIGYuaHRtbCgpKSksIEhhKGYsIGIsIGMsIGQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChtICYmICgoZSA9IG9hKGIsIGFbMF0ub3duZXJEb2N1bWVudCwgITEsIGEsIGQpKSwgKGYgPSBlLmZpcnN0Q2hpbGQpLCAxID09PSBlLmNoaWxkTm9kZXMubGVuZ3RoICYmIChlID0gZiksIGYgfHwgZCkpIHsKICAgICAgICAgICAgZm9yIChoID0gci5tYXAobGEoZSwgInNjcmlwdCIpLCBEYSksIGkgPSBoLmxlbmd0aDsgbCA8IG07IGwrKykKICAgICAgICAgICAgICAoaiA9IGUpLCBsICE9PSBuICYmICgoaiA9IHIuY2xvbmUoaiwgITAsICEwKSksIGkgJiYgci5tZXJnZShoLCBsYShqLCAic2NyaXB0IikpKSwgYy5jYWxsKGFbbF0sIGosIGwpOwogICAgICAgICAgICBpZiAoaSkKICAgICAgICAgICAgICBmb3IgKGsgPSBoW2gubGVuZ3RoIC0gMV0ub3duZXJEb2N1bWVudCwgci5tYXAoaCwgRWEpLCBsID0gMDsgbCA8IGk7IGwrKykKICAgICAgICAgICAgICAgIChqID0gaFtsXSksCiAgICAgICAgICAgICAgICAgIGphLnRlc3Qoai50eXBlIHx8ICIiKSAmJgogICAgICAgICAgICAgICAgICAgICFWLmFjY2VzcyhqLCAiZ2xvYmFsRXZhbCIpICYmCiAgICAgICAgICAgICAgICAgICAgci5jb250YWlucyhrLCBqKSAmJgogICAgICAgICAgICAgICAgICAgIChqLnNyYyA/IHIuX2V2YWxVcmwgJiYgci5fZXZhbFVybChqLnNyYykgOiBwKGoudGV4dENvbnRlbnQucmVwbGFjZShCYSwgIiIpLCBrKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gSWEoYSwgYiwgYykgewogICAgICAgICAgZm9yICh2YXIgZCwgZSA9IGIgPyByLmZpbHRlcihiLCBhKSA6IGEsIGYgPSAwOyBudWxsICE9IChkID0gZVtmXSk7IGYrKykKICAgICAgICAgICAgYyB8fCAxICE9PSBkLm5vZGVUeXBlIHx8IHIuY2xlYW5EYXRhKGxhKGQpKSwKICAgICAgICAgICAgICBkLnBhcmVudE5vZGUgJiYgKGMgJiYgci5jb250YWlucyhkLm93bmVyRG9jdW1lbnQsIGQpICYmIG1hKGxhKGQsICJzY3JpcHQiKSksIGQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkKSk7CiAgICAgICAgICByZXR1cm4gYTsKICAgICAgICB9CiAgICAgICAgci5leHRlbmQoewogICAgICAgICAgaHRtbFByZWZpbHRlcjogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgcmV0dXJuIGEucmVwbGFjZSh4YSwgIjwkMT48LyQyPiIpOwogICAgICAgICAgfSwKICAgICAgICAgIGNsb25lOiBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICB2YXIgZCwKICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgIGYsCiAgICAgICAgICAgICAgZywKICAgICAgICAgICAgICBoID0gYS5jbG9uZU5vZGUoITApLAogICAgICAgICAgICAgIGkgPSByLmNvbnRhaW5zKGEub3duZXJEb2N1bWVudCwgYSk7CiAgICAgICAgICAgIGlmICghKG8ubm9DbG9uZUNoZWNrZWQgfHwgKDEgIT09IGEubm9kZVR5cGUgJiYgMTEgIT09IGEubm9kZVR5cGUpIHx8IHIuaXNYTUxEb2MoYSkpKQogICAgICAgICAgICAgIGZvciAoZyA9IGxhKGgpLCBmID0gbGEoYSksIGQgPSAwLCBlID0gZi5sZW5ndGg7IGQgPCBlOyBkKyspIEdhKGZbZF0sIGdbZF0pOwogICAgICAgICAgICBpZiAoYikKICAgICAgICAgICAgICBpZiAoYykgZm9yIChmID0gZiB8fCBsYShhKSwgZyA9IGcgfHwgbGEoaCksIGQgPSAwLCBlID0gZi5sZW5ndGg7IGQgPCBlOyBkKyspIEZhKGZbZF0sIGdbZF0pOwogICAgICAgICAgICAgIGVsc2UgRmEoYSwgaCk7CiAgICAgICAgICAgIHJldHVybiAoZyA9IGxhKGgsICJzY3JpcHQiKSksIGcubGVuZ3RoID4gMCAmJiBtYShnLCAhaSAmJiBsYShhLCAic2NyaXB0IikpLCBoOwogICAgICAgICAgfSwKICAgICAgICAgIGNsZWFuRGF0YTogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgZm9yICh2YXIgYiwgYywgZCwgZSA9IHIuZXZlbnQuc3BlY2lhbCwgZiA9IDA7IHZvaWQgMCAhPT0gKGMgPSBhW2ZdKTsgZisrKQogICAgICAgICAgICAgIGlmIChUKGMpKSB7CiAgICAgICAgICAgICAgICBpZiAoKGIgPSBjW1YuZXhwYW5kb10pKSB7CiAgICAgICAgICAgICAgICAgIGlmIChiLmV2ZW50cykgZm9yIChkIGluIGIuZXZlbnRzKSBlW2RdID8gci5ldmVudC5yZW1vdmUoYywgZCkgOiByLnJlbW92ZUV2ZW50KGMsIGQsIGIuaGFuZGxlKTsKICAgICAgICAgICAgICAgICAgY1tWLmV4cGFuZG9dID0gdm9pZCAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY1tXLmV4cGFuZG9dICYmIChjW1cuZXhwYW5kb10gPSB2b2lkIDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgfSksCiAgICAgICAgICByLmZuLmV4dGVuZCh7CiAgICAgICAgICAgIGRldGFjaDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gSWEodGhpcywgYSwgITApOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIElhKHRoaXMsIGEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB0ZXh0OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiBTKAogICAgICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDAgPT09IGEKICAgICAgICAgICAgICAgICAgICA/IHIudGV4dCh0aGlzKQogICAgICAgICAgICAgICAgICAgIDogdGhpcy5lbXB0eSgpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAoMSAhPT0gdGhpcy5ub2RlVHlwZSAmJiAxMSAhPT0gdGhpcy5ub2RlVHlwZSAmJiA5ICE9PSB0aGlzLm5vZGVUeXBlKSB8fCAodGhpcy50ZXh0Q29udGVudCA9IGEpOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIGEsCiAgICAgICAgICAgICAgICBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYXBwZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIEhhKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgIGlmICgxID09PSB0aGlzLm5vZGVUeXBlIHx8IDExID09PSB0aGlzLm5vZGVUeXBlIHx8IDkgPT09IHRoaXMubm9kZVR5cGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGIgPSBDYSh0aGlzLCBhKTsKICAgICAgICAgICAgICAgICAgYi5hcHBlbmRDaGlsZChhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiBIYSh0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICBpZiAoMSA9PT0gdGhpcy5ub2RlVHlwZSB8fCAxMSA9PT0gdGhpcy5ub2RlVHlwZSB8fCA5ID09PSB0aGlzLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBiID0gQ2EodGhpcywgYSk7CiAgICAgICAgICAgICAgICAgIGIuaW5zZXJ0QmVmb3JlKGEsIGIuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJlZm9yZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiBIYSh0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudE5vZGUgJiYgdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhLCB0aGlzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYWZ0ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gSGEodGhpcywgYXJndW1lbnRzLCBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgdGhpcy5wYXJlbnROb2RlICYmIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSwgdGhpcy5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVtcHR5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgYSwgYiA9IDA7IG51bGwgIT0gKGEgPSB0aGlzW2JdKTsgYisrKSAxID09PSBhLm5vZGVUeXBlICYmIChyLmNsZWFuRGF0YShsYShhLCAhMSkpLCAoYS50ZXh0Q29udGVudCA9ICIiKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsb25lOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAoYSA9IG51bGwgIT0gYSAmJiBhKSwKICAgICAgICAgICAgICAgIChiID0gbnVsbCA9PSBiID8gYSA6IGIpLAogICAgICAgICAgICAgICAgdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gci5jbG9uZSh0aGlzLCBhLCBiKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaHRtbDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gUygKICAgICAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICB2YXIgYiA9IHRoaXNbMF0gfHwge30sCiAgICAgICAgICAgICAgICAgICAgYyA9IDAsCiAgICAgICAgICAgICAgICAgICAgZCA9IHRoaXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBhICYmIDEgPT09IGIubm9kZVR5cGUpIHJldHVybiBiLmlubmVySFRNTDsKICAgICAgICAgICAgICAgICAgaWYgKCJzdHJpbmciID09IHR5cGVvZiBhICYmICF5YS50ZXN0KGEpICYmICFrYVsoaWEuZXhlYyhhKSB8fCBbIiIsICIiXSlbMV0udG9Mb3dlckNhc2UoKV0pIHsKICAgICAgICAgICAgICAgICAgICBhID0gci5odG1sUHJlZmlsdGVyKGEpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBmb3IgKDsgYyA8IGQ7IGMrKykgKGIgPSB0aGlzW2NdIHx8IHt9KSwgMSA9PT0gYi5ub2RlVHlwZSAmJiAoci5jbGVhbkRhdGEobGEoYiwgITEpKSwgKGIuaW5uZXJIVE1MID0gYSkpOwogICAgICAgICAgICAgICAgICAgICAgYiA9IDA7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBiICYmIHRoaXMuZW1wdHkoKS5hcHBlbmQoYSk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIGEsCiAgICAgICAgICAgICAgICBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB2YXIgYSA9IFtdOwogICAgICAgICAgICAgIHJldHVybiBIYSgKICAgICAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgICAgICBhcmd1bWVudHMsCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgICB2YXIgYyA9IHRoaXMucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgci5pbkFycmF5KHRoaXMsIGEpIDwgMCAmJiAoci5jbGVhbkRhdGEobGEodGhpcykpLCBjICYmIGMucmVwbGFjZUNoaWxkKGIsIHRoaXMpKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgICAgci5lYWNoKAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgYXBwZW5kVG86ICJhcHBlbmQiLAogICAgICAgICAgICAgIHByZXBlbmRUbzogInByZXBlbmQiLAogICAgICAgICAgICAgIGluc2VydEJlZm9yZTogImJlZm9yZSIsCiAgICAgICAgICAgICAgaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCiAgICAgICAgICAgICAgcmVwbGFjZUFsbDogInJlcGxhY2VXaXRoIiwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICByLmZuW2FdID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGMsIGQgPSBbXSwgZSA9IHIoYSksIGYgPSBlLmxlbmd0aCAtIDEsIGcgPSAwOyBnIDw9IGY7IGcrKykKICAgICAgICAgICAgICAgICAgKGMgPSBnID09PSBmID8gdGhpcyA6IHRoaXMuY2xvbmUoITApKSwgcihlW2ddKVtiXShjKSwgaC5hcHBseShkLCBjLmdldCgpKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhkKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICApOwogICAgICAgIHZhciBKYSA9IC9ebWFyZ2luLywKICAgICAgICAgIEthID0gbmV3IFJlZ0V4cCgiXigiICsgJCArICIpKD8hcHgpW2EteiVdKyQiLCAiaSIpLAogICAgICAgICAgTGEgPSBmdW5jdGlvbiAoYikgewogICAgICAgICAgICB2YXIgYyA9IGIub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldzsKICAgICAgICAgICAgcmV0dXJuIChjICYmIGMub3BlbmVyKSB8fCAoYyA9IGEpLCBjLmdldENvbXB1dGVkU3R5bGUoYik7CiAgICAgICAgICB9OwogICAgICAgICEoZnVuY3Rpb24gKCkgewogICAgICAgICAgZnVuY3Rpb24gYigpIHsKICAgICAgICAgICAgaWYgKGkpIHsKICAgICAgICAgICAgICAoaS5zdHlsZS5jc3NUZXh0ID0gImJveC1zaXppbmc6Ym9yZGVyLWJveDtwb3NpdGlvbjpyZWxhdGl2ZTtkaXNwbGF5OmJsb2NrO21hcmdpbjphdXRvO2JvcmRlcjoxcHg7cGFkZGluZzoxcHg7dG9wOjElO3dpZHRoOjUwJSIpLAogICAgICAgICAgICAgICAgKGkuaW5uZXJIVE1MID0gIiIpLAogICAgICAgICAgICAgICAgcGEuYXBwZW5kQ2hpbGQoaCk7CiAgICAgICAgICAgICAgdmFyIGIgPSBhLmdldENvbXB1dGVkU3R5bGUoaSk7CiAgICAgICAgICAgICAgKGMgPSAiMSUiICE9PSBiLnRvcCksCiAgICAgICAgICAgICAgICAoZyA9ICIycHgiID09PSBiLm1hcmdpbkxlZnQpLAogICAgICAgICAgICAgICAgKGUgPSAiNHB4IiA9PT0gYi53aWR0aCksCiAgICAgICAgICAgICAgICAoaS5zdHlsZS5tYXJnaW5SaWdodCA9ICI1MCUiKSwKICAgICAgICAgICAgICAgIChmID0gIjRweCIgPT09IGIubWFyZ2luUmlnaHQpLAogICAgICAgICAgICAgICAgcGEucmVtb3ZlQ2hpbGQoaCksCiAgICAgICAgICAgICAgICAoaSA9IG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYywKICAgICAgICAgICAgZSwKICAgICAgICAgICAgZiwKICAgICAgICAgICAgZywKICAgICAgICAgICAgaCA9IGQuY3JlYXRlRWxlbWVudCgiZGl2IiksCiAgICAgICAgICAgIGkgPSBkLmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgaS5zdHlsZSAmJgogICAgICAgICAgICAoKGkuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiY29udGVudC1ib3giKSwKICAgICAgICAgICAgKGkuY2xvbmVOb2RlKCEwKS5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICIiKSwKICAgICAgICAgICAgKG8uY2xlYXJDbG9uZVN0eWxlID0gImNvbnRlbnQtYm94IiA9PT0gaS5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCksCiAgICAgICAgICAgIChoLnN0eWxlLmNzc1RleHQgPSAiYm9yZGVyOjA7d2lkdGg6OHB4O2hlaWdodDowO3RvcDowO2xlZnQ6LTk5OTlweDtwYWRkaW5nOjA7bWFyZ2luLXRvcDoxcHg7cG9zaXRpb246YWJzb2x1dGUiKSwKICAgICAgICAgICAgaC5hcHBlbmRDaGlsZChpKSwKICAgICAgICAgICAgci5leHRlbmQobywgewogICAgICAgICAgICAgIHBpeGVsUG9zaXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBiKCksIGM7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBib3hTaXppbmdSZWxpYWJsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGIoKSwgZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHBpeGVsTWFyZ2luUmlnaHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBiKCksIGY7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICByZWxpYWJsZU1hcmdpbkxlZnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBiKCksIGc7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSkpOwogICAgICAgIH0pKCk7CiAgICAgICAgZnVuY3Rpb24gTWEoYSwgYiwgYykgewogICAgICAgICAgdmFyIGQsCiAgICAgICAgICAgIGUsCiAgICAgICAgICAgIGYsCiAgICAgICAgICAgIGcsCiAgICAgICAgICAgIGggPSBhLnN0eWxlOwogICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgKGMgPSBjIHx8IExhKGEpKSwKICAgICAgICAgICAgYyAmJgogICAgICAgICAgICAgICgoZyA9IGMuZ2V0UHJvcGVydHlWYWx1ZShiKSB8fCBjW2JdKSwKICAgICAgICAgICAgICAiIiAhPT0gZyB8fCByLmNvbnRhaW5zKGEub3duZXJEb2N1bWVudCwgYSkgfHwgKGcgPSByLnN0eWxlKGEsIGIpKSwKICAgICAgICAgICAgICAhby5waXhlbE1hcmdpblJpZ2h0KCkgJiYKICAgICAgICAgICAgICAgIEthLnRlc3QoZykgJiYKICAgICAgICAgICAgICAgIEphLnRlc3QoYikgJiYKICAgICAgICAgICAgICAgICgoZCA9IGgud2lkdGgpLAogICAgICAgICAgICAgICAgKGUgPSBoLm1pbldpZHRoKSwKICAgICAgICAgICAgICAgIChmID0gaC5tYXhXaWR0aCksCiAgICAgICAgICAgICAgICAoaC5taW5XaWR0aCA9IGgubWF4V2lkdGggPSBoLndpZHRoID0gZyksCiAgICAgICAgICAgICAgICAoZyA9IGMud2lkdGgpLAogICAgICAgICAgICAgICAgKGgud2lkdGggPSBkKSwKICAgICAgICAgICAgICAgIChoLm1pbldpZHRoID0gZSksCiAgICAgICAgICAgICAgICAoaC5tYXhXaWR0aCA9IGYpKSksCiAgICAgICAgICAgIHZvaWQgMCAhPT0gZyA/IGcgKyAiIiA6IGcKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIE5hKGEsIGIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiBhKCkgPyB2b2lkIGRlbGV0ZSB0aGlzLmdldCA6ICh0aGlzLmdldCA9IGIpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgT2EgPSAvXihub25lfHRhYmxlKD8hLWNbZWFdKS4rKS8sCiAgICAgICAgICBQYSA9IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHZpc2liaWxpdHk6ICJoaWRkZW4iLCBkaXNwbGF5OiAiYmxvY2siIH0sCiAgICAgICAgICBRYSA9IHsgbGV0dGVyU3BhY2luZzogIjAiLCBmb250V2VpZ2h0OiAiNDAwIiB9LAogICAgICAgICAgUmEgPSBbIldlYmtpdCIsICJNb3oiLCAibXMiXSwKICAgICAgICAgIFNhID0gZC5jcmVhdGVFbGVtZW50KCJkaXYiKS5zdHlsZTsKICAgICAgICBmdW5jdGlvbiBUYShhKSB7CiAgICAgICAgICBpZiAoYSBpbiBTYSkgcmV0dXJuIGE7CiAgICAgICAgICB2YXIgYiA9IGFbMF0udG9VcHBlckNhc2UoKSArIGEuc2xpY2UoMSksCiAgICAgICAgICAgIGMgPSBSYS5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoYy0tKSBpZiAoKChhID0gUmFbY10gKyBiKSwgYSBpbiBTYSkpIHJldHVybiBhOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBVYShhLCBiLCBjKSB7CiAgICAgICAgICB2YXIgZCA9IF8uZXhlYyhiKTsKICAgICAgICAgIHJldHVybiBkID8gTWF0aC5tYXgoMCwgZFsyXSAtIChjIHx8IDApKSArIChkWzNdIHx8ICJweCIpIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gVmEoYSwgYiwgYywgZCwgZSkgewogICAgICAgICAgZm9yICh2YXIgZiA9IGMgPT09IChkID8gImJvcmRlciIgOiAiY29udGVudCIpID8gNCA6ICJ3aWR0aCIgPT09IGIgPyAxIDogMCwgZyA9IDA7IGYgPCA0OyBmICs9IDIpCiAgICAgICAgICAgICJtYXJnaW4iID09PSBjICYmIChnICs9IHIuY3NzKGEsIGMgKyBhYVtmXSwgITAsIGUpKSwKICAgICAgICAgICAgICBkCiAgICAgICAgICAgICAgICA/ICgiY29udGVudCIgPT09IGMgJiYgKGcgLT0gci5jc3MoYSwgInBhZGRpbmciICsgYWFbZl0sICEwLCBlKSksICJtYXJnaW4iICE9PSBjICYmIChnIC09IHIuY3NzKGEsICJib3JkZXIiICsgYWFbZl0gKyAiV2lkdGgiLCAhMCwgZSkpKQogICAgICAgICAgICAgICAgOiAoKGcgKz0gci5jc3MoYSwgInBhZGRpbmciICsgYWFbZl0sICEwLCBlKSksICJwYWRkaW5nIiAhPT0gYyAmJiAoZyArPSByLmNzcyhhLCAiYm9yZGVyIiArIGFhW2ZdICsgIldpZHRoIiwgITAsIGUpKSk7CiAgICAgICAgICByZXR1cm4gZzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gV2EoYSwgYiwgYykgewogICAgICAgICAgdmFyIGQsCiAgICAgICAgICAgIGUgPSAhMCwKICAgICAgICAgICAgZiA9IExhKGEpLAogICAgICAgICAgICBnID0gImJvcmRlci1ib3giID09PSByLmNzcyhhLCAiYm94U2l6aW5nIiwgITEsIGYpOwogICAgICAgICAgaWYgKChhLmdldENsaWVudFJlY3RzKCkubGVuZ3RoICYmIChkID0gYS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVtiXSksIGQgPD0gMCB8fCBudWxsID09IGQpKSB7CiAgICAgICAgICAgIGlmICgoKGQgPSBNYShhLCBiLCBmKSksIChkIDwgMCB8fCBudWxsID09IGQpICYmIChkID0gYS5zdHlsZVtiXSksIEthLnRlc3QoZCkpKSByZXR1cm4gZDsKICAgICAgICAgICAgKGUgPSBnICYmIChvLmJveFNpemluZ1JlbGlhYmxlKCkgfHwgZCA9PT0gYS5zdHlsZVtiXSkpLCAoZCA9IHBhcnNlRmxvYXQoZCkgfHwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZCArIFZhKGEsIGIsIGMgfHwgKGcgPyAiYm9yZGVyIiA6ICJjb250ZW50IiksIGUsIGYpICsgInB4IjsKICAgICAgICB9CiAgICAgICAgci5leHRlbmQoewogICAgICAgICAgY3NzSG9va3M6IHsKICAgICAgICAgICAgb3BhY2l0eTogewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIGlmIChiKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjID0gTWEoYSwgIm9wYWNpdHkiKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuICIiID09PSBjID8gIjEiIDogYzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9LAogICAgICAgICAgfSwKICAgICAgICAgIGNzc051bWJlcjogewogICAgICAgICAgICBhbmltYXRpb25JdGVyYXRpb25Db3VudDogITAsCiAgICAgICAgICAgIGNvbHVtbkNvdW50OiAhMCwKICAgICAgICAgICAgZmlsbE9wYWNpdHk6ICEwLAogICAgICAgICAgICBmbGV4R3JvdzogITAsCiAgICAgICAgICAgIGZsZXhTaHJpbms6ICEwLAogICAgICAgICAgICBmb250V2VpZ2h0OiAhMCwKICAgICAgICAgICAgbGluZUhlaWdodDogITAsCiAgICAgICAgICAgIG9wYWNpdHk6ICEwLAogICAgICAgICAgICBvcmRlcjogITAsCiAgICAgICAgICAgIG9ycGhhbnM6ICEwLAogICAgICAgICAgICB3aWRvd3M6ICEwLAogICAgICAgICAgICB6SW5kZXg6ICEwLAogICAgICAgICAgICB6b29tOiAhMCwKICAgICAgICAgIH0sCiAgICAgICAgICBjc3NQcm9wczogeyBmbG9hdDogImNzc0Zsb2F0IiB9LAogICAgICAgICAgc3R5bGU6IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgICAgICAgIGlmIChhICYmIDMgIT09IGEubm9kZVR5cGUgJiYgOCAhPT0gYS5ub2RlVHlwZSAmJiBhLnN0eWxlKSB7CiAgICAgICAgICAgICAgdmFyIGUsCiAgICAgICAgICAgICAgICBmLAogICAgICAgICAgICAgICAgZywKICAgICAgICAgICAgICAgIGggPSByLmNhbWVsQ2FzZShiKSwKICAgICAgICAgICAgICAgIGkgPSBhLnN0eWxlOwogICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAoYiA9IHIuY3NzUHJvcHNbaF0gfHwgKHIuY3NzUHJvcHNbaF0gPSBUYShoKSB8fCBoKSksCiAgICAgICAgICAgICAgICAoZyA9IHIuY3NzSG9va3NbYl0gfHwgci5jc3NIb29rc1toXSksCiAgICAgICAgICAgICAgICB2b2lkIDAgPT09IGMKICAgICAgICAgICAgICAgICAgPyBnICYmICJnZXQiIGluIGcgJiYgdm9pZCAwICE9PSAoZSA9IGcuZ2V0KGEsICExLCBkKSkKICAgICAgICAgICAgICAgICAgICA/IGUKICAgICAgICAgICAgICAgICAgICA6IGlbYl0KICAgICAgICAgICAgICAgICAgOiAoKGYgPSB0eXBlb2YgYyksCiAgICAgICAgICAgICAgICAgICAgInN0cmluZyIgPT09IGYgJiYgKGUgPSBfLmV4ZWMoYykpICYmIGVbMV0gJiYgKChjID0gZGEoYSwgYiwgZSkpLCAoZiA9ICJudW1iZXIiKSksCiAgICAgICAgICAgICAgICAgICAgbnVsbCAhPSBjICYmCiAgICAgICAgICAgICAgICAgICAgICBjID09PSBjICYmCiAgICAgICAgICAgICAgICAgICAgICAoIm51bWJlciIgPT09IGYgJiYgKGMgKz0gKGUgJiYgZVszXSkgfHwgKHIuY3NzTnVtYmVyW2hdID8gIiIgOiAicHgiKSksCiAgICAgICAgICAgICAgICAgICAgICBvLmNsZWFyQ2xvbmVTdHlsZSB8fCAiIiAhPT0gYyB8fCAwICE9PSBiLmluZGV4T2YoImJhY2tncm91bmQiKSB8fCAoaVtiXSA9ICJpbmhlcml0IiksCiAgICAgICAgICAgICAgICAgICAgICAoZyAmJiAic2V0IiBpbiBnICYmIHZvaWQgMCA9PT0gKGMgPSBnLnNldChhLCBjLCBkKSkpIHx8IChpW2JdID0gYykpLAogICAgICAgICAgICAgICAgICAgIHZvaWQgMCkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgY3NzOiBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZSwKICAgICAgICAgICAgICBmLAogICAgICAgICAgICAgIGcsCiAgICAgICAgICAgICAgaCA9IHIuY2FtZWxDYXNlKGIpOwogICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgIChiID0gci5jc3NQcm9wc1toXSB8fCAoci5jc3NQcm9wc1toXSA9IFRhKGgpIHx8IGgpKSwKICAgICAgICAgICAgICAoZyA9IHIuY3NzSG9va3NbYl0gfHwgci5jc3NIb29rc1toXSksCiAgICAgICAgICAgICAgZyAmJiAiZ2V0IiBpbiBnICYmIChlID0gZy5nZXQoYSwgITAsIGMpKSwKICAgICAgICAgICAgICB2b2lkIDAgPT09IGUgJiYgKGUgPSBNYShhLCBiLCBkKSksCiAgICAgICAgICAgICAgIm5vcm1hbCIgPT09IGUgJiYgYiBpbiBRYSAmJiAoZSA9IFFhW2JdKSwKICAgICAgICAgICAgICAiIiA9PT0gYyB8fCBjID8gKChmID0gcGFyc2VGbG9hdChlKSksIGMgPT09ICEwIHx8IGlzRmluaXRlKGYpID8gZiB8fCAwIDogZSkgOiBlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgIH0pLAogICAgICAgICAgci5lYWNoKFsiaGVpZ2h0IiwgIndpZHRoIl0sIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHIuY3NzSG9va3NbYl0gPSB7CiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoYSwgYywgZCkgewogICAgICAgICAgICAgICAgaWYgKGMpCiAgICAgICAgICAgICAgICAgIHJldHVybiAhT2EudGVzdChyLmNzcyhhLCAiZGlzcGxheSIpKSB8fCAoYS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aCAmJiBhLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoKQogICAgICAgICAgICAgICAgICAgID8gV2EoYSwgYiwgZCkKICAgICAgICAgICAgICAgICAgICA6IGNhKGEsIFBhLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBXYShhLCBiLCBkKTsKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoYSwgYywgZCkgewogICAgICAgICAgICAgICAgdmFyIGUsCiAgICAgICAgICAgICAgICAgIGYgPSBkICYmIExhKGEpLAogICAgICAgICAgICAgICAgICBnID0gZCAmJiBWYShhLCBiLCBkLCAiYm9yZGVyLWJveCIgPT09IHIuY3NzKGEsICJib3hTaXppbmciLCAhMSwgZiksIGYpOwogICAgICAgICAgICAgICAgcmV0dXJuIGcgJiYgKGUgPSBfLmV4ZWMoYykpICYmICJweCIgIT09IChlWzNdIHx8ICJweCIpICYmICgoYS5zdHlsZVtiXSA9IGMpLCAoYyA9IHIuY3NzKGEsIGIpKSksIFVhKGEsIGMsIGcpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH07CiAgICAgICAgICB9KSwKICAgICAgICAgIChyLmNzc0hvb2tzLm1hcmdpbkxlZnQgPSBOYShvLnJlbGlhYmxlTWFyZ2luTGVmdCwgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgaWYgKGIpCiAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgIChwYXJzZUZsb2F0KE1hKGEsICJtYXJnaW5MZWZ0IikpIHx8CiAgICAgICAgICAgICAgICAgIGEuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCAtCiAgICAgICAgICAgICAgICAgICAgY2EoYSwgeyBtYXJnaW5MZWZ0OiAwIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQ7CiAgICAgICAgICAgICAgICAgICAgfSkpICsgInB4IgogICAgICAgICAgICAgICk7CiAgICAgICAgICB9KSksCiAgICAgICAgICByLmVhY2goeyBtYXJnaW46ICIiLCBwYWRkaW5nOiAiIiwgYm9yZGVyOiAiV2lkdGgiIH0sIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIChyLmNzc0hvb2tzW2EgKyBiXSA9IHsKICAgICAgICAgICAgICBleHBhbmQ6IGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBkID0gMCwgZSA9IHt9LCBmID0gInN0cmluZyIgPT0gdHlwZW9mIGMgPyBjLnNwbGl0KCIgIikgOiBbY107IGQgPCA0OyBkKyspIGVbYSArIGFhW2RdICsgYl0gPSBmW2RdIHx8IGZbZCAtIDJdIHx8IGZbMF07CiAgICAgICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9KSwKICAgICAgICAgICAgICBKYS50ZXN0KGEpIHx8IChyLmNzc0hvb2tzW2EgKyBiXS5zZXQgPSBVYSk7CiAgICAgICAgICB9KSwKICAgICAgICAgIHIuZm4uZXh0ZW5kKHsKICAgICAgICAgICAgY3NzOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHJldHVybiBTKAogICAgICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgICAgICAgIHZhciBkLAogICAgICAgICAgICAgICAgICAgIGUsCiAgICAgICAgICAgICAgICAgICAgZiA9IHt9LAogICAgICAgICAgICAgICAgICAgIGcgPSAwOwogICAgICAgICAgICAgICAgICBpZiAoci5pc0FycmF5KGIpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChkID0gTGEoYSksIGUgPSBiLmxlbmd0aDsgZyA8IGU7IGcrKykgZltiW2ddXSA9IHIuY3NzKGEsIGJbZ10sICExLCBkKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwICE9PSBjID8gci5zdHlsZShhLCBiLCBjKSA6IHIuY3NzKGEsIGIpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGEsCiAgICAgICAgICAgICAgICBiLAogICAgICAgICAgICAgICAgYXJndW1lbnRzLmxlbmd0aCA+IDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgfSk7CiAgICAgICAgZnVuY3Rpb24gWGEoYSwgYiwgYywgZCwgZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBYYS5wcm90b3R5cGUuaW5pdChhLCBiLCBjLCBkLCBlKTsKICAgICAgICB9CiAgICAgICAgKHIuVHdlZW4gPSBYYSksCiAgICAgICAgICAoWGEucHJvdG90eXBlID0gewogICAgICAgICAgICBjb25zdHJ1Y3RvcjogWGEsCiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uIChhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICAgICAgKHRoaXMuZWxlbSA9IGEpLAogICAgICAgICAgICAgICAgKHRoaXMucHJvcCA9IGMpLAogICAgICAgICAgICAgICAgKHRoaXMuZWFzaW5nID0gZSB8fCByLmVhc2luZy5fZGVmYXVsdCksCiAgICAgICAgICAgICAgICAodGhpcy5vcHRpb25zID0gYiksCiAgICAgICAgICAgICAgICAodGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKSksCiAgICAgICAgICAgICAgICAodGhpcy5lbmQgPSBkKSwKICAgICAgICAgICAgICAgICh0aGlzLnVuaXQgPSBmIHx8IChyLmNzc051bWJlcltjXSA/ICIiIDogInB4IikpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjdXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB2YXIgYSA9IFhhLnByb3BIb29rc1t0aGlzLnByb3BdOwogICAgICAgICAgICAgIHJldHVybiBhICYmIGEuZ2V0ID8gYS5nZXQodGhpcykgOiBYYS5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KHRoaXMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBydW46IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgdmFyIGIsCiAgICAgICAgICAgICAgICBjID0gWGEucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5kdXJhdGlvbgogICAgICAgICAgICAgICAgICA/ICh0aGlzLnBvcyA9IGIgPSByLmVhc2luZ1t0aGlzLmVhc2luZ10oYSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogYSwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uKSkKICAgICAgICAgICAgICAgICAgOiAodGhpcy5wb3MgPSBiID0gYSksCiAgICAgICAgICAgICAgICAodGhpcy5ub3cgPSAodGhpcy5lbmQgLSB0aGlzLnN0YXJ0KSAqIGIgKyB0aGlzLnN0YXJ0KSwKICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5zdGVwICYmIHRoaXMub3B0aW9ucy5zdGVwLmNhbGwodGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyksCiAgICAgICAgICAgICAgICBjICYmIGMuc2V0ID8gYy5zZXQodGhpcykgOiBYYS5wcm9wSG9va3MuX2RlZmF1bHQuc2V0KHRoaXMpLAogICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KSwKICAgICAgICAgIChYYS5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBYYS5wcm90b3R5cGUpLAogICAgICAgICAgKFhhLnByb3BIb29rcyA9IHsKICAgICAgICAgICAgX2RlZmF1bHQ6IHsKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICB2YXIgYjsKICAgICAgICAgICAgICAgIHJldHVybiAxICE9PSBhLmVsZW0ubm9kZVR5cGUgfHwgKG51bGwgIT0gYS5lbGVtW2EucHJvcF0gJiYgbnVsbCA9PSBhLmVsZW0uc3R5bGVbYS5wcm9wXSkKICAgICAgICAgICAgICAgICAgPyBhLmVsZW1bYS5wcm9wXQogICAgICAgICAgICAgICAgICA6ICgoYiA9IHIuY3NzKGEuZWxlbSwgYS5wcm9wLCAiIikpLCBiICYmICJhdXRvIiAhPT0gYiA/IGIgOiAwKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgIHIuZnguc3RlcFthLnByb3BdCiAgICAgICAgICAgICAgICAgID8gci5meC5zdGVwW2EucHJvcF0oYSkKICAgICAgICAgICAgICAgICAgOiAxICE9PSBhLmVsZW0ubm9kZVR5cGUgfHwgKG51bGwgPT0gYS5lbGVtLnN0eWxlW3IuY3NzUHJvcHNbYS5wcm9wXV0gJiYgIXIuY3NzSG9va3NbYS5wcm9wXSkKICAgICAgICAgICAgICAgICAgPyAoYS5lbGVtW2EucHJvcF0gPSBhLm5vdykKICAgICAgICAgICAgICAgICAgOiByLnN0eWxlKGEuZWxlbSwgYS5wcm9wLCBhLm5vdyArIGEudW5pdCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgICAgKFhhLnByb3BIb29rcy5zY3JvbGxUb3AgPSBYYS5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICBhLmVsZW0ubm9kZVR5cGUgJiYgYS5lbGVtLnBhcmVudE5vZGUgJiYgKGEuZWxlbVthLnByb3BdID0gYS5ub3cpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0pLAogICAgICAgICAgKHIuZWFzaW5nID0gewogICAgICAgICAgICBsaW5lYXI6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGE7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN3aW5nOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiAwLjUgLSBNYXRoLmNvcyhhICogTWF0aC5QSSkgLyAyOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfZGVmYXVsdDogInN3aW5nIiwKICAgICAgICAgIH0pLAogICAgICAgICAgKHIuZnggPSBYYS5wcm90b3R5cGUuaW5pdCksCiAgICAgICAgICAoci5meC5zdGVwID0ge30pOwogICAgICAgIHZhciBZYSwKICAgICAgICAgIFphLAogICAgICAgICAgJGEgPSAvXig/OnRvZ2dsZXxzaG93fGhpZGUpJC8sCiAgICAgICAgICBfYSA9IC9xdWV1ZUhvb2tzJC87CiAgICAgICAgZnVuY3Rpb24gYWIoKSB7CiAgICAgICAgICBaYSAmJiAoYS5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYWIpLCByLmZ4LnRpY2soKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJiKCkgewogICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgYS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBZYSA9IHZvaWQgMDsKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIChZYSA9IHIubm93KCkpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYihhLCBiKSB7CiAgICAgICAgICB2YXIgYywKICAgICAgICAgICAgZCA9IDAsCiAgICAgICAgICAgIGUgPSB7IGhlaWdodDogYSB9OwogICAgICAgICAgZm9yIChiID0gYiA/IDEgOiAwOyBkIDwgNDsgZCArPSAyIC0gYikgKGMgPSBhYVtkXSksIChlWyJtYXJnaW4iICsgY10gPSBlWyJwYWRkaW5nIiArIGNdID0gYSk7CiAgICAgICAgICByZXR1cm4gYiAmJiAoZS5vcGFjaXR5ID0gZS53aWR0aCA9IGEpLCBlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkYihhLCBiLCBjKSB7CiAgICAgICAgICBmb3IgKHZhciBkLCBlID0gKGdiLnR3ZWVuZXJzW2JdIHx8IFtdKS5jb25jYXQoZ2IudHdlZW5lcnNbIioiXSksIGYgPSAwLCBnID0gZS5sZW5ndGg7IGYgPCBnOyBmKyspIGlmICgoZCA9IGVbZl0uY2FsbChjLCBiLCBhKSkpIHJldHVybiBkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlYihhLCBiLCBjKSB7CiAgICAgICAgICB2YXIgZCwKICAgICAgICAgICAgZSwKICAgICAgICAgICAgZiwKICAgICAgICAgICAgZywKICAgICAgICAgICAgaCwKICAgICAgICAgICAgaSwKICAgICAgICAgICAgaiwKICAgICAgICAgICAgaywKICAgICAgICAgICAgbCA9ICJ3aWR0aCIgaW4gYiB8fCAiaGVpZ2h0IiBpbiBiLAogICAgICAgICAgICBtID0gdGhpcywKICAgICAgICAgICAgbiA9IHt9LAogICAgICAgICAgICBvID0gYS5zdHlsZSwKICAgICAgICAgICAgcCA9IGEubm9kZVR5cGUgJiYgYmEoYSksCiAgICAgICAgICAgIHEgPSBWLmdldChhLCAiZnhzaG93Iik7CiAgICAgICAgICBjLnF1ZXVlIHx8CiAgICAgICAgICAgICgoZyA9IHIuX3F1ZXVlSG9va3MoYSwgImZ4IikpLAogICAgICAgICAgICBudWxsID09IGcudW5xdWV1ZWQgJiYKICAgICAgICAgICAgICAoKGcudW5xdWV1ZWQgPSAwKSwKICAgICAgICAgICAgICAoaCA9IGcuZW1wdHkuZmlyZSksCiAgICAgICAgICAgICAgKGcuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGcudW5xdWV1ZWQgfHwgaCgpOwogICAgICAgICAgICAgIH0pKSwKICAgICAgICAgICAgZy51bnF1ZXVlZCsrLAogICAgICAgICAgICBtLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgbS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZy51bnF1ZXVlZC0tLCByLnF1ZXVlKGEsICJmeCIpLmxlbmd0aCB8fCBnLmVtcHR5LmZpcmUoKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkpOwogICAgICAgICAgZm9yIChkIGluIGIpCiAgICAgICAgICAgIGlmICgoKGUgPSBiW2RdKSwgJGEudGVzdChlKSkpIHsKICAgICAgICAgICAgICBpZiAoKGRlbGV0ZSBiW2RdLCAoZiA9IGYgfHwgInRvZ2dsZSIgPT09IGUpLCBlID09PSAocCA/ICJoaWRlIiA6ICJzaG93IikpKSB7CiAgICAgICAgICAgICAgICBpZiAoInNob3ciICE9PSBlIHx8ICFxIHx8IHZvaWQgMCA9PT0gcVtkXSkgY29udGludWU7CiAgICAgICAgICAgICAgICBwID0gITA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5bZF0gPSAocSAmJiBxW2RdKSB8fCByLnN0eWxlKGEsIGQpOwogICAgICAgICAgICB9CiAgICAgICAgICBpZiAoKChpID0gIXIuaXNFbXB0eU9iamVjdChiKSksIGkgfHwgIXIuaXNFbXB0eU9iamVjdChuKSkpIHsKICAgICAgICAgICAgbCAmJgogICAgICAgICAgICAgIDEgPT09IGEubm9kZVR5cGUgJiYKICAgICAgICAgICAgICAoKGMub3ZlcmZsb3cgPSBbby5vdmVyZmxvdywgby5vdmVyZmxvd1gsIG8ub3ZlcmZsb3dZXSksCiAgICAgICAgICAgICAgKGogPSBxICYmIHEuZGlzcGxheSksCiAgICAgICAgICAgICAgbnVsbCA9PSBqICYmIChqID0gVi5nZXQoYSwgImRpc3BsYXkiKSksCiAgICAgICAgICAgICAgKGsgPSByLmNzcyhhLCAiZGlzcGxheSIpKSwKICAgICAgICAgICAgICAibm9uZSIgPT09IGsgJiYgKGogPyAoayA9IGopIDogKGdhKFthXSwgITApLCAoaiA9IGEuc3R5bGUuZGlzcGxheSB8fCBqKSwgKGsgPSByLmNzcyhhLCAiZGlzcGxheSIpKSwgZ2EoW2FdKSkpLAogICAgICAgICAgICAgICgiaW5saW5lIiA9PT0gayB8fCAoImlubGluZS1ibG9jayIgPT09IGsgJiYgbnVsbCAhPSBqKSkgJiYKICAgICAgICAgICAgICAgICJub25lIiA9PT0gci5jc3MoYSwgImZsb2F0IikgJiYKICAgICAgICAgICAgICAgIChpIHx8CiAgICAgICAgICAgICAgICAgIChtLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG8uZGlzcGxheSA9IGo7CiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICBudWxsID09IGogJiYgKChrID0gby5kaXNwbGF5KSwgKGogPSAibm9uZSIgPT09IGsgPyAiIiA6IGspKSksCiAgICAgICAgICAgICAgICAoby5kaXNwbGF5ID0gImlubGluZS1ibG9jayIpKSksCiAgICAgICAgICAgICAgYy5vdmVyZmxvdyAmJgogICAgICAgICAgICAgICAgKChvLm92ZXJmbG93ID0gImhpZGRlbiIpLAogICAgICAgICAgICAgICAgbS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAoby5vdmVyZmxvdyA9IGMub3ZlcmZsb3dbMF0pLCAoby5vdmVyZmxvd1ggPSBjLm92ZXJmbG93WzFdKSwgKG8ub3ZlcmZsb3dZID0gYy5vdmVyZmxvd1syXSk7CiAgICAgICAgICAgICAgICB9KSksCiAgICAgICAgICAgICAgKGkgPSAhMSk7CiAgICAgICAgICAgIGZvciAoZCBpbiBuKQogICAgICAgICAgICAgIGkgfHwKICAgICAgICAgICAgICAgIChxID8gImhpZGRlbiIgaW4gcSAmJiAocCA9IHEuaGlkZGVuKSA6IChxID0gVi5hY2Nlc3MoYSwgImZ4c2hvdyIsIHsgZGlzcGxheTogaiB9KSksCiAgICAgICAgICAgICAgICBmICYmIChxLmhpZGRlbiA9ICFwKSwKICAgICAgICAgICAgICAgIHAgJiYgZ2EoW2FdLCAhMCksCiAgICAgICAgICAgICAgICBtLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICBwIHx8IGdhKFthXSksIFYucmVtb3ZlKGEsICJmeHNob3ciKTsKICAgICAgICAgICAgICAgICAgZm9yIChkIGluIG4pIHIuc3R5bGUoYSwgZCwgbltkXSk7CiAgICAgICAgICAgICAgICB9KSksCiAgICAgICAgICAgICAgICAoaSA9IGRiKHAgPyBxW2RdIDogMCwgZCwgbSkpLAogICAgICAgICAgICAgICAgZCBpbiBxIHx8ICgocVtkXSA9IGkuc3RhcnQpLCBwICYmICgoaS5lbmQgPSBpLnN0YXJ0KSwgKGkuc3RhcnQgPSAwKSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmYihhLCBiKSB7CiAgICAgICAgICB2YXIgYywgZCwgZSwgZiwgZzsKICAgICAgICAgIGZvciAoYyBpbiBhKQogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgKChkID0gci5jYW1lbENhc2UoYykpLAogICAgICAgICAgICAgIChlID0gYltkXSksCiAgICAgICAgICAgICAgKGYgPSBhW2NdKSwKICAgICAgICAgICAgICByLmlzQXJyYXkoZikgJiYgKChlID0gZlsxXSksIChmID0gYVtjXSA9IGZbMF0pKSwKICAgICAgICAgICAgICBjICE9PSBkICYmICgoYVtkXSA9IGYpLCBkZWxldGUgYVtjXSksCiAgICAgICAgICAgICAgKGcgPSByLmNzc0hvb2tzW2RdKSwKICAgICAgICAgICAgICBnICYmICJleHBhbmQiIGluIGcpCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIChmID0gZy5leHBhbmQoZikpLCBkZWxldGUgYVtkXTsKICAgICAgICAgICAgICBmb3IgKGMgaW4gZikgYyBpbiBhIHx8ICgoYVtjXSA9IGZbY10pLCAoYltjXSA9IGUpKTsKICAgICAgICAgICAgfSBlbHNlIGJbZF0gPSBlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnYihhLCBiLCBjKSB7CiAgICAgICAgICB2YXIgZCwKICAgICAgICAgICAgZSwKICAgICAgICAgICAgZiA9IDAsCiAgICAgICAgICAgIGcgPSBnYi5wcmVmaWx0ZXJzLmxlbmd0aCwKICAgICAgICAgICAgaCA9IHIuRGVmZXJyZWQoKS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGRlbGV0ZSBpLmVsZW07CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBpID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGlmIChlKSByZXR1cm4gITE7CiAgICAgICAgICAgICAgZm9yICgKICAgICAgICAgICAgICAgIHZhciBiID0gWWEgfHwgYmIoKSwgYyA9IE1hdGgubWF4KDAsIGouc3RhcnRUaW1lICsgai5kdXJhdGlvbiAtIGIpLCBkID0gYyAvIGouZHVyYXRpb24gfHwgMCwgZiA9IDEgLSBkLCBnID0gMCwgaSA9IGoudHdlZW5zLmxlbmd0aDsKICAgICAgICAgICAgICAgIGcgPCBpOwogICAgICAgICAgICAgICAgZysrCiAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgai50d2VlbnNbZ10ucnVuKGYpOwogICAgICAgICAgICAgIHJldHVybiBoLm5vdGlmeVdpdGgoYSwgW2osIGYsIGNdKSwgZiA8IDEgJiYgaSA/IGMgOiAoaC5yZXNvbHZlV2l0aChhLCBbal0pLCAhMSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGogPSBoLnByb21pc2UoewogICAgICAgICAgICAgIGVsZW06IGEsCiAgICAgICAgICAgICAgcHJvcHM6IHIuZXh0ZW5kKHt9LCBiKSwKICAgICAgICAgICAgICBvcHRzOiByLmV4dGVuZCghMCwgeyBzcGVjaWFsRWFzaW5nOiB7fSwgZWFzaW5nOiByLmVhc2luZy5fZGVmYXVsdCB9LCBjKSwKICAgICAgICAgICAgICBvcmlnaW5hbFByb3BlcnRpZXM6IGIsCiAgICAgICAgICAgICAgb3JpZ2luYWxPcHRpb25zOiBjLAogICAgICAgICAgICAgIHN0YXJ0VGltZTogWWEgfHwgYmIoKSwKICAgICAgICAgICAgICBkdXJhdGlvbjogYy5kdXJhdGlvbiwKICAgICAgICAgICAgICB0d2VlbnM6IFtdLAogICAgICAgICAgICAgIGNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiAoYiwgYykgewogICAgICAgICAgICAgICAgdmFyIGQgPSByLlR3ZWVuKGEsIGoub3B0cywgYiwgYywgai5vcHRzLnNwZWNpYWxFYXNpbmdbYl0gfHwgai5vcHRzLmVhc2luZyk7CiAgICAgICAgICAgICAgICByZXR1cm4gai50d2VlbnMucHVzaChkKSwgZDsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHN0b3A6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IDAsCiAgICAgICAgICAgICAgICAgIGQgPSBiID8gai50d2VlbnMubGVuZ3RoIDogMDsKICAgICAgICAgICAgICAgIGlmIChlKSByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIGZvciAoZSA9ICEwOyBjIDwgZDsgYysrKSBqLnR3ZWVuc1tjXS5ydW4oMSk7CiAgICAgICAgICAgICAgICByZXR1cm4gYiA/IChoLm5vdGlmeVdpdGgoYSwgW2osIDEsIDBdKSwgaC5yZXNvbHZlV2l0aChhLCBbaiwgYl0pKSA6IGgucmVqZWN0V2l0aChhLCBbaiwgYl0pLCB0aGlzOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBrID0gai5wcm9wczsKICAgICAgICAgIGZvciAoZmIoaywgai5vcHRzLnNwZWNpYWxFYXNpbmcpOyBmIDwgZzsgZisrKQogICAgICAgICAgICBpZiAoKGQgPSBnYi5wcmVmaWx0ZXJzW2ZdLmNhbGwoaiwgYSwgaywgai5vcHRzKSkpCiAgICAgICAgICAgICAgcmV0dXJuIHIuaXNGdW5jdGlvbihkLnN0b3ApICYmIChyLl9xdWV1ZUhvb2tzKGouZWxlbSwgai5vcHRzLnF1ZXVlKS5zdG9wID0gci5wcm94eShkLnN0b3AsIGQpKSwgZDsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIHIubWFwKGssIGRiLCBqKSwKICAgICAgICAgICAgci5pc0Z1bmN0aW9uKGoub3B0cy5zdGFydCkgJiYgai5vcHRzLnN0YXJ0LmNhbGwoYSwgaiksCiAgICAgICAgICAgIHIuZngudGltZXIoci5leHRlbmQoaSwgeyBlbGVtOiBhLCBhbmltOiBqLCBxdWV1ZTogai5vcHRzLnF1ZXVlIH0pKSwKICAgICAgICAgICAgai5wcm9ncmVzcyhqLm9wdHMucHJvZ3Jlc3MpLmRvbmUoai5vcHRzLmRvbmUsIGoub3B0cy5jb21wbGV0ZSkuZmFpbChqLm9wdHMuZmFpbCkuYWx3YXlzKGoub3B0cy5hbHdheXMpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICAoci5BbmltYXRpb24gPSByLmV4dGVuZChnYiwgewogICAgICAgICAgdHdlZW5lcnM6IHsKICAgICAgICAgICAgIioiOiBbCiAgICAgICAgICAgICAgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIHZhciBjID0gdGhpcy5jcmVhdGVUd2VlbihhLCBiKTsKICAgICAgICAgICAgICAgIHJldHVybiBkYShjLmVsZW0sIGEsIF8uZXhlYyhiKSwgYyksIGM7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgXSwKICAgICAgICAgIH0sCiAgICAgICAgICB0d2VlbmVyOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICByLmlzRnVuY3Rpb24oYSkgPyAoKGIgPSBhKSwgKGEgPSBbIioiXSkpIDogKGEgPSBhLm1hdGNoKEspKTsKICAgICAgICAgICAgZm9yICh2YXIgYywgZCA9IDAsIGUgPSBhLmxlbmd0aDsgZCA8IGU7IGQrKykgKGMgPSBhW2RdKSwgKGdiLnR3ZWVuZXJzW2NdID0gZ2IudHdlZW5lcnNbY10gfHwgW10pLCBnYi50d2VlbmVyc1tjXS51bnNoaWZ0KGIpOwogICAgICAgICAgfSwKICAgICAgICAgIHByZWZpbHRlcnM6IFtlYl0sCiAgICAgICAgICBwcmVmaWx0ZXI6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIGIgPyBnYi5wcmVmaWx0ZXJzLnVuc2hpZnQoYSkgOiBnYi5wcmVmaWx0ZXJzLnB1c2goYSk7CiAgICAgICAgICB9LAogICAgICAgIH0pKSwKICAgICAgICAgIChyLnNwZWVkID0gZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgdmFyIGUgPQogICAgICAgICAgICAgIGEgJiYgIm9iamVjdCIgPT0gdHlwZW9mIGEKICAgICAgICAgICAgICAgID8gci5leHRlbmQoe30sIGEpCiAgICAgICAgICAgICAgICA6IHsKICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZTogYyB8fCAoIWMgJiYgYikgfHwgKHIuaXNGdW5jdGlvbihhKSAmJiBhKSwKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogYSwKICAgICAgICAgICAgICAgICAgICBlYXNpbmc6IChjICYmIGIpIHx8IChiICYmICFyLmlzRnVuY3Rpb24oYikgJiYgYiksCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgci5meC5vZmYgfHwgZC5oaWRkZW4KICAgICAgICAgICAgICAgID8gKGUuZHVyYXRpb24gPSAwKQogICAgICAgICAgICAgICAgOiAoZS5kdXJhdGlvbiA9CiAgICAgICAgICAgICAgICAgICAgIm51bWJlciIgPT0gdHlwZW9mIGUuZHVyYXRpb24gPyBlLmR1cmF0aW9uIDogZS5kdXJhdGlvbiBpbiByLmZ4LnNwZWVkcyA/IHIuZnguc3BlZWRzW2UuZHVyYXRpb25dIDogci5meC5zcGVlZHMuX2RlZmF1bHQpLAogICAgICAgICAgICAgIChudWxsICE9IGUucXVldWUgJiYgZS5xdWV1ZSAhPT0gITApIHx8IChlLnF1ZXVlID0gImZ4IiksCiAgICAgICAgICAgICAgKGUub2xkID0gZS5jb21wbGV0ZSksCiAgICAgICAgICAgICAgKGUuY29tcGxldGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByLmlzRnVuY3Rpb24oZS5vbGQpICYmIGUub2xkLmNhbGwodGhpcyksIGUucXVldWUgJiYgci5kZXF1ZXVlKHRoaXMsIGUucXVldWUpOwogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgIGUKICAgICAgICAgICAgKTsKICAgICAgICAgIH0pLAogICAgICAgICAgci5mbi5leHRlbmQoewogICAgICAgICAgICBmYWRlVG86IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGJhKS5jc3MoIm9wYWNpdHkiLCAwKS5zaG93KCkuZW5kKCkuYW5pbWF0ZSh7IG9wYWNpdHk6IGIgfSwgYSwgYywgZCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGFuaW1hdGU6IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgICAgICAgICAgdmFyIGUgPSByLmlzRW1wdHlPYmplY3QoYSksCiAgICAgICAgICAgICAgICBmID0gci5zcGVlZChiLCBjLCBkKSwKICAgICAgICAgICAgICAgIGcgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBiID0gZ2IodGhpcywgci5leHRlbmQoe30sIGEpLCBmKTsKICAgICAgICAgICAgICAgICAgKGUgfHwgVi5nZXQodGhpcywgImZpbmlzaCIpKSAmJiBiLnN0b3AoITApOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByZXR1cm4gKGcuZmluaXNoID0gZyksIGUgfHwgZi5xdWV1ZSA9PT0gITEgPyB0aGlzLmVhY2goZykgOiB0aGlzLnF1ZXVlKGYucXVldWUsIGcpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wOiBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgIHZhciBkID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgIHZhciBiID0gYS5zdG9wOwogICAgICAgICAgICAgICAgZGVsZXRlIGEuc3RvcCwgYihjKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAic3RyaW5nIiAhPSB0eXBlb2YgYSAmJiAoKGMgPSBiKSwgKGIgPSBhKSwgKGEgPSB2b2lkIDApKSwKICAgICAgICAgICAgICAgIGIgJiYgYSAhPT0gITEgJiYgdGhpcy5xdWV1ZShhIHx8ICJmeCIsIFtdKSwKICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBiID0gITAsCiAgICAgICAgICAgICAgICAgICAgZSA9IG51bGwgIT0gYSAmJiBhICsgInF1ZXVlSG9va3MiLAogICAgICAgICAgICAgICAgICAgIGYgPSByLnRpbWVycywKICAgICAgICAgICAgICAgICAgICBnID0gVi5nZXQodGhpcyk7CiAgICAgICAgICAgICAgICAgIGlmIChlKSBnW2VdICYmIGdbZV0uc3RvcCAmJiBkKGdbZV0pOwogICAgICAgICAgICAgICAgICBlbHNlIGZvciAoZSBpbiBnKSBnW2VdICYmIGdbZV0uc3RvcCAmJiBfYS50ZXN0KGUpICYmIGQoZ1tlXSk7CiAgICAgICAgICAgICAgICAgIGZvciAoZSA9IGYubGVuZ3RoOyBlLS07ICkgZltlXS5lbGVtICE9PSB0aGlzIHx8IChudWxsICE9IGEgJiYgZltlXS5xdWV1ZSAhPT0gYSkgfHwgKGZbZV0uYW5pbS5zdG9wKGMpLCAoYiA9ICExKSwgZi5zcGxpY2UoZSwgMSkpOwogICAgICAgICAgICAgICAgICAoIWIgJiYgYykgfHwgci5kZXF1ZXVlKHRoaXMsIGEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmaW5pc2g6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgIGEgIT09ICExICYmIChhID0gYSB8fCAiZngiKSwKICAgICAgICAgICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBiLAogICAgICAgICAgICAgICAgICAgIGMgPSBWLmdldCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICBkID0gY1thICsgInF1ZXVlIl0sCiAgICAgICAgICAgICAgICAgICAgZSA9IGNbYSArICJxdWV1ZUhvb2tzIl0sCiAgICAgICAgICAgICAgICAgICAgZiA9IHIudGltZXJzLAogICAgICAgICAgICAgICAgICAgIGcgPSBkID8gZC5sZW5ndGggOiAwOwogICAgICAgICAgICAgICAgICBmb3IgKGMuZmluaXNoID0gITAsIHIucXVldWUodGhpcywgYSwgW10pLCBlICYmIGUuc3RvcCAmJiBlLnN0b3AuY2FsbCh0aGlzLCAhMCksIGIgPSBmLmxlbmd0aDsgYi0tOyApCiAgICAgICAgICAgICAgICAgICAgZltiXS5lbGVtID09PSB0aGlzICYmIGZbYl0ucXVldWUgPT09IGEgJiYgKGZbYl0uYW5pbS5zdG9wKCEwKSwgZi5zcGxpY2UoYiwgMSkpOwogICAgICAgICAgICAgICAgICBmb3IgKGIgPSAwOyBiIDwgZzsgYisrKSBkW2JdICYmIGRbYl0uZmluaXNoICYmIGRbYl0uZmluaXNoLmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjLmZpbmlzaDsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgICAgci5lYWNoKFsidG9nZ2xlIiwgInNob3ciLCAiaGlkZSJdLCBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICB2YXIgYyA9IHIuZm5bYl07CiAgICAgICAgICAgIHIuZm5bYl0gPSBmdW5jdGlvbiAoYSwgZCwgZSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsID09IGEgfHwgImJvb2xlYW4iID09IHR5cGVvZiBhID8gYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogdGhpcy5hbmltYXRlKGNiKGIsICEwKSwgYSwgZCwgZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9KSwKICAgICAgICAgIHIuZWFjaCgKICAgICAgICAgICAgewogICAgICAgICAgICAgIHNsaWRlRG93bjogY2IoInNob3ciKSwKICAgICAgICAgICAgICBzbGlkZVVwOiBjYigiaGlkZSIpLAogICAgICAgICAgICAgIHNsaWRlVG9nZ2xlOiBjYigidG9nZ2xlIiksCiAgICAgICAgICAgICAgZmFkZUluOiB7IG9wYWNpdHk6ICJzaG93IiB9LAogICAgICAgICAgICAgIGZhZGVPdXQ6IHsgb3BhY2l0eTogImhpZGUiIH0sCiAgICAgICAgICAgICAgZmFkZVRvZ2dsZTogeyBvcGFjaXR5OiAidG9nZ2xlIiB9LAogICAgICAgICAgICB9LAogICAgICAgICAgICBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHIuZm5bYV0gPSBmdW5jdGlvbiAoYSwgYywgZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0ZShiLCBhLCBjLCBkKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICApLAogICAgICAgICAgKHIudGltZXJzID0gW10pLAogICAgICAgICAgKHIuZngudGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGEsCiAgICAgICAgICAgICAgYiA9IDAsCiAgICAgICAgICAgICAgYyA9IHIudGltZXJzOwogICAgICAgICAgICBmb3IgKFlhID0gci5ub3coKTsgYiA8IGMubGVuZ3RoOyBiKyspIChhID0gY1tiXSksIGEoKSB8fCBjW2JdICE9PSBhIHx8IGMuc3BsaWNlKGItLSwgMSk7CiAgICAgICAgICAgIGMubGVuZ3RoIHx8IHIuZnguc3RvcCgpLCAoWWEgPSB2b2lkIDApOwogICAgICAgICAgfSksCiAgICAgICAgICAoci5meC50aW1lciA9IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHIudGltZXJzLnB1c2goYSksIGEoKSA/IHIuZnguc3RhcnQoKSA6IHIudGltZXJzLnBvcCgpOwogICAgICAgICAgfSksCiAgICAgICAgICAoci5meC5pbnRlcnZhbCA9IDEzKSwKICAgICAgICAgIChyLmZ4LnN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBaYSB8fCAoWmEgPSBhLnJlcXVlc3RBbmltYXRpb25GcmFtZSA/IGEucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFiKSA6IGEuc2V0SW50ZXJ2YWwoci5meC50aWNrLCByLmZ4LmludGVydmFsKSk7CiAgICAgICAgICB9KSwKICAgICAgICAgIChyLmZ4LnN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGEuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPyBhLmNhbmNlbEFuaW1hdGlvbkZyYW1lKFphKSA6IGEuY2xlYXJJbnRlcnZhbChaYSksIChaYSA9IG51bGwpOwogICAgICAgICAgfSksCiAgICAgICAgICAoci5meC5zcGVlZHMgPSB7IHNsb3c6IDYwMCwgZmFzdDogMjAwLCBfZGVmYXVsdDogNDAwIH0pLAogICAgICAgICAgKHIuZm4uZGVsYXkgPSBmdW5jdGlvbiAoYiwgYykgewogICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgIChiID0gci5meCA/IHIuZnguc3BlZWRzW2JdIHx8IGIgOiBiKSwKICAgICAgICAgICAgICAoYyA9IGMgfHwgImZ4IiksCiAgICAgICAgICAgICAgdGhpcy5xdWV1ZShjLCBmdW5jdGlvbiAoYywgZCkgewogICAgICAgICAgICAgICAgdmFyIGUgPSBhLnNldFRpbWVvdXQoYywgYik7CiAgICAgICAgICAgICAgICBkLnN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIGEuY2xlYXJUaW1lb3V0KGUpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9KQogICAgICAgICAgICApOwogICAgICAgICAgfSksCiAgICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYSA9IGQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKSwKICAgICAgICAgICAgICBiID0gZC5jcmVhdGVFbGVtZW50KCJzZWxlY3QiKSwKICAgICAgICAgICAgICBjID0gYi5hcHBlbmRDaGlsZChkLmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpKTsKICAgICAgICAgICAgKGEudHlwZSA9ICJjaGVja2JveCIpLAogICAgICAgICAgICAgIChvLmNoZWNrT24gPSAiIiAhPT0gYS52YWx1ZSksCiAgICAgICAgICAgICAgKG8ub3B0U2VsZWN0ZWQgPSBjLnNlbGVjdGVkKSwKICAgICAgICAgICAgICAoYSA9IGQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKSksCiAgICAgICAgICAgICAgKGEudmFsdWUgPSAidCIpLAogICAgICAgICAgICAgIChhLnR5cGUgPSAicmFkaW8iKSwKICAgICAgICAgICAgICAoby5yYWRpb1ZhbHVlID0gInQiID09PSBhLnZhbHVlKTsKICAgICAgICAgIH0pKCk7CiAgICAgICAgdmFyIGhiLAogICAgICAgICAgaWIgPSByLmV4cHIuYXR0ckhhbmRsZTsKICAgICAgICByLmZuLmV4dGVuZCh7CiAgICAgICAgICBhdHRyOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICByZXR1cm4gUyh0aGlzLCByLmF0dHIsIGEsIGIsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByLnJlbW92ZUF0dHIodGhpcywgYSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICB9KSwKICAgICAgICAgIHIuZXh0ZW5kKHsKICAgICAgICAgICAgYXR0cjogZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgICB2YXIgZCwKICAgICAgICAgICAgICAgIGUsCiAgICAgICAgICAgICAgICBmID0gYS5ub2RlVHlwZTsKICAgICAgICAgICAgICBpZiAoMyAhPT0gZiAmJiA4ICE9PSBmICYmIDIgIT09IGYpCiAgICAgICAgICAgICAgICByZXR1cm4gInVuZGVmaW5lZCIgPT0gdHlwZW9mIGEuZ2V0QXR0cmlidXRlCiAgICAgICAgICAgICAgICAgID8gci5wcm9wKGEsIGIsIGMpCiAgICAgICAgICAgICAgICAgIDogKCgxID09PSBmICYmIHIuaXNYTUxEb2MoYSkpIHx8IChlID0gci5hdHRySG9va3NbYi50b0xvd2VyQ2FzZSgpXSB8fCAoci5leHByLm1hdGNoLmJvb2wudGVzdChiKSA/IGhiIDogdm9pZCAwKSksCiAgICAgICAgICAgICAgICAgICAgdm9pZCAwICE9PSBjCiAgICAgICAgICAgICAgICAgICAgICA/IG51bGwgPT09IGMKICAgICAgICAgICAgICAgICAgICAgICAgPyB2b2lkIHIucmVtb3ZlQXR0cihhLCBiKQogICAgICAgICAgICAgICAgICAgICAgICA6IGUgJiYgInNldCIgaW4gZSAmJiB2b2lkIDAgIT09IChkID0gZS5zZXQoYSwgYywgYikpCiAgICAgICAgICAgICAgICAgICAgICAgID8gZAogICAgICAgICAgICAgICAgICAgICAgICA6IChhLnNldEF0dHJpYnV0ZShiLCBjICsgIiIpLCBjKQogICAgICAgICAgICAgICAgICAgICAgOiBlICYmICJnZXQiIGluIGUgJiYgbnVsbCAhPT0gKGQgPSBlLmdldChhLCBiKSkKICAgICAgICAgICAgICAgICAgICAgID8gZAogICAgICAgICAgICAgICAgICAgICAgOiAoKGQgPSByLmZpbmQuYXR0cihhLCBiKSksIG51bGwgPT0gZCA/IHZvaWQgMCA6IGQpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYXR0ckhvb2tzOiB7CiAgICAgICAgICAgICAgdHlwZTogewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgICBpZiAoIW8ucmFkaW9WYWx1ZSAmJiAicmFkaW8iID09PSBiICYmIHIubm9kZU5hbWUoYSwgImlucHV0IikpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGEudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEuc2V0QXR0cmlidXRlKCJ0eXBlIiwgYiksIGMgJiYgKGEudmFsdWUgPSBjKSwgYjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9LAogICAgICAgICAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHZhciBjLAogICAgICAgICAgICAgICAgZCA9IDAsCiAgICAgICAgICAgICAgICBlID0gYiAmJiBiLm1hdGNoKEspOwogICAgICAgICAgICAgIGlmIChlICYmIDEgPT09IGEubm9kZVR5cGUpIHdoaWxlICgoYyA9IGVbZCsrXSkpIGEucmVtb3ZlQXR0cmlidXRlKGMpOwogICAgICAgICAgICB9LAogICAgICAgICAgfSksCiAgICAgICAgICAoaGIgPSB7CiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgICByZXR1cm4gYiA9PT0gITEgPyByLnJlbW92ZUF0dHIoYSwgYykgOiBhLnNldEF0dHJpYnV0ZShjLCBjKSwgYzsKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgICAgci5lYWNoKHIuZXhwci5tYXRjaC5ib29sLnNvdXJjZS5tYXRjaCgvXHcrL2cpLCBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICB2YXIgYyA9IGliW2JdIHx8IHIuZmluZC5hdHRyOwogICAgICAgICAgICBpYltiXSA9IGZ1bmN0aW9uIChhLCBiLCBkKSB7CiAgICAgICAgICAgICAgdmFyIGUsCiAgICAgICAgICAgICAgICBmLAogICAgICAgICAgICAgICAgZyA9IGIudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICByZXR1cm4gZCB8fCAoKGYgPSBpYltnXSksIChpYltnXSA9IGUpLCAoZSA9IG51bGwgIT0gYyhhLCBiLCBkKSA/IGcgOiBudWxsKSwgKGliW2ddID0gZikpLCBlOwogICAgICAgICAgICB9OwogICAgICAgICAgfSk7CiAgICAgICAgdmFyIGpiID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwKICAgICAgICAgIGtiID0gL14oPzphfGFyZWEpJC9pOwogICAgICAgIHIuZm4uZXh0ZW5kKHsKICAgICAgICAgIHByb3A6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBTKHRoaXMsIHIucHJvcCwgYSwgYiwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgICAgICAgfSwKICAgICAgICAgIHJlbW92ZVByb3A6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzW3IucHJvcEZpeFthXSB8fCBhXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgIH0pLAogICAgICAgICAgci5leHRlbmQoewogICAgICAgICAgICBwcm9wOiBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgIHZhciBkLAogICAgICAgICAgICAgICAgZSwKICAgICAgICAgICAgICAgIGYgPSBhLm5vZGVUeXBlOwogICAgICAgICAgICAgIGlmICgzICE9PSBmICYmIDggIT09IGYgJiYgMiAhPT0gZikKICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICgxID09PSBmICYmIHIuaXNYTUxEb2MoYSkpIHx8ICgoYiA9IHIucHJvcEZpeFtiXSB8fCBiKSwgKGUgPSByLnByb3BIb29rc1tiXSkpLAogICAgICAgICAgICAgICAgICB2b2lkIDAgIT09IGMKICAgICAgICAgICAgICAgICAgICA/IGUgJiYgInNldCIgaW4gZSAmJiB2b2lkIDAgIT09IChkID0gZS5zZXQoYSwgYywgYikpCiAgICAgICAgICAgICAgICAgICAgICA/IGQKICAgICAgICAgICAgICAgICAgICAgIDogKGFbYl0gPSBjKQogICAgICAgICAgICAgICAgICAgIDogZSAmJiAiZ2V0IiBpbiBlICYmIG51bGwgIT09IChkID0gZS5nZXQoYSwgYikpCiAgICAgICAgICAgICAgICAgICAgPyBkCiAgICAgICAgICAgICAgICAgICAgOiBhW2JdCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBwcm9wSG9va3M6IHsKICAgICAgICAgICAgICB0YWJJbmRleDogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICB2YXIgYiA9IHIuZmluZC5hdHRyKGEsICJ0YWJpbmRleCIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gYiA/IHBhcnNlSW50KGIsIDEwKSA6IGpiLnRlc3QoYS5ub2RlTmFtZSkgfHwgKGtiLnRlc3QoYS5ub2RlTmFtZSkgJiYgYS5ocmVmKSA/IDAgOiAtMTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcHJvcEZpeDogeyBmb3I6ICJodG1sRm9yIiwgY2xhc3M6ICJjbGFzc05hbWUiIH0sCiAgICAgICAgICB9KSwKICAgICAgICAgIG8ub3B0U2VsZWN0ZWQgfHwKICAgICAgICAgICAgKHIucHJvcEhvb2tzLnNlbGVjdGVkID0gewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgIHZhciBiID0gYS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgcmV0dXJuIGIgJiYgYi5wYXJlbnROb2RlICYmIGIucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4LCBudWxsOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgdmFyIGIgPSBhLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICBiICYmIChiLnNlbGVjdGVkSW5kZXgsIGIucGFyZW50Tm9kZSAmJiBiLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfSksCiAgICAgICAgICByLmVhY2goCiAgICAgICAgICAgIFsidGFiSW5kZXgiLCAicmVhZE9ubHkiLCAibWF4TGVuZ3RoIiwgImNlbGxTcGFjaW5nIiwgImNlbGxQYWRkaW5nIiwgInJvd1NwYW4iLCAiY29sU3BhbiIsICJ1c2VNYXAiLCAiZnJhbWVCb3JkZXIiLCAiY29udGVudEVkaXRhYmxlIl0sCiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByLnByb3BGaXhbdGhpcy50b0xvd2VyQ2FzZSgpXSA9IHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICk7CiAgICAgICAgdmFyIGxiID0gL1tcdFxyXG5cZl0vZzsKICAgICAgICBmdW5jdGlvbiBtYihhKSB7CiAgICAgICAgICByZXR1cm4gKGEuZ2V0QXR0cmlidXRlICYmIGEuZ2V0QXR0cmlidXRlKCJjbGFzcyIpKSB8fCAiIjsKICAgICAgICB9CiAgICAgICAgci5mbi5leHRlbmQoewogICAgICAgICAgYWRkQ2xhc3M6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHZhciBiLAogICAgICAgICAgICAgIGMsCiAgICAgICAgICAgICAgZCwKICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgIGYsCiAgICAgICAgICAgICAgZywKICAgICAgICAgICAgICBoLAogICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICBpZiAoci5pc0Z1bmN0aW9uKGEpKQogICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgIHIodGhpcykuYWRkQ2xhc3MoYS5jYWxsKHRoaXMsIGIsIG1iKHRoaXMpKSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgYSAmJiBhKSB7CiAgICAgICAgICAgICAgYiA9IGEubWF0Y2goSykgfHwgW107CiAgICAgICAgICAgICAgd2hpbGUgKChjID0gdGhpc1tpKytdKSkKICAgICAgICAgICAgICAgIGlmICgoKGUgPSBtYihjKSksIChkID0gMSA9PT0gYy5ub2RlVHlwZSAmJiAoIiAiICsgZSArICIgIikucmVwbGFjZShsYiwgIiAiKSkpKSB7CiAgICAgICAgICAgICAgICAgIGcgPSAwOwogICAgICAgICAgICAgICAgICB3aGlsZSAoKGYgPSBiW2crK10pKSBkLmluZGV4T2YoIiAiICsgZiArICIgIikgPCAwICYmIChkICs9IGYgKyAiICIpOwogICAgICAgICAgICAgICAgICAoaCA9IHIudHJpbShkKSksIGUgIT09IGggJiYgYy5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgaCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHZhciBiLAogICAgICAgICAgICAgIGMsCiAgICAgICAgICAgICAgZCwKICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgIGYsCiAgICAgICAgICAgICAgZywKICAgICAgICAgICAgICBoLAogICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICBpZiAoci5pc0Z1bmN0aW9uKGEpKQogICAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgIHIodGhpcykucmVtb3ZlQ2xhc3MoYS5jYWxsKHRoaXMsIGIsIG1iKHRoaXMpKSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIHRoaXMuYXR0cigiY2xhc3MiLCAiIik7CiAgICAgICAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgYSAmJiBhKSB7CiAgICAgICAgICAgICAgYiA9IGEubWF0Y2goSykgfHwgW107CiAgICAgICAgICAgICAgd2hpbGUgKChjID0gdGhpc1tpKytdKSkKICAgICAgICAgICAgICAgIGlmICgoKGUgPSBtYihjKSksIChkID0gMSA9PT0gYy5ub2RlVHlwZSAmJiAoIiAiICsgZSArICIgIikucmVwbGFjZShsYiwgIiAiKSkpKSB7CiAgICAgICAgICAgICAgICAgIGcgPSAwOwogICAgICAgICAgICAgICAgICB3aGlsZSAoKGYgPSBiW2crK10pKSB3aGlsZSAoZC5pbmRleE9mKCIgIiArIGYgKyAiICIpID4gLTEpIGQgPSBkLnJlcGxhY2UoIiAiICsgZiArICIgIiwgIiAiKTsKICAgICAgICAgICAgICAgICAgKGggPSByLnRyaW0oZCkpLCBlICE9PSBoICYmIGMuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICB2YXIgYyA9IHR5cGVvZiBhOwogICAgICAgICAgICByZXR1cm4gImJvb2xlYW4iID09IHR5cGVvZiBiICYmICJzdHJpbmciID09PSBjCiAgICAgICAgICAgICAgPyBiCiAgICAgICAgICAgICAgICA/IHRoaXMuYWRkQ2xhc3MoYSkKICAgICAgICAgICAgICAgIDogdGhpcy5yZW1vdmVDbGFzcyhhKQogICAgICAgICAgICAgIDogci5pc0Z1bmN0aW9uKGEpCiAgICAgICAgICAgICAgPyB0aGlzLmVhY2goZnVuY3Rpb24gKGMpIHsKICAgICAgICAgICAgICAgICAgcih0aGlzKS50b2dnbGVDbGFzcyhhLmNhbGwodGhpcywgYywgbWIodGhpcyksIGIpLCBiKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgOiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgYiwgZCwgZSwgZjsKICAgICAgICAgICAgICAgICAgaWYgKCJzdHJpbmciID09PSBjKSB7CiAgICAgICAgICAgICAgICAgICAgKGQgPSAwKSwgKGUgPSByKHRoaXMpKSwgKGYgPSBhLm1hdGNoKEspIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKGIgPSBmW2QrK10pKSBlLmhhc0NsYXNzKGIpID8gZS5yZW1vdmVDbGFzcyhiKSA6IGUuYWRkQ2xhc3MoYik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSAodm9pZCAwICE9PSBhICYmICJib29sZWFuIiAhPT0gYykgfHwgKChiID0gbWIodGhpcykpLCBiICYmIFYuc2V0KHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgYiksIHRoaXMuc2V0QXR0cmlidXRlICYmIHRoaXMuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGIgfHwgYSA9PT0gITEgPyAiIiA6IFYuZ2V0KHRoaXMsICJfX2NsYXNzTmFtZV9fIikgfHwgIiIpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICB2YXIgYiwKICAgICAgICAgICAgICBjLAogICAgICAgICAgICAgIGQgPSAwOwogICAgICAgICAgICBiID0gIiAiICsgYSArICIgIjsKICAgICAgICAgICAgd2hpbGUgKChjID0gdGhpc1tkKytdKSkgaWYgKDEgPT09IGMubm9kZVR5cGUgJiYgKCIgIiArIG1iKGMpICsgIiAiKS5yZXBsYWNlKGxiLCAiICIpLmluZGV4T2YoYikgPiAtMSkgcmV0dXJuICEwOwogICAgICAgICAgICByZXR1cm4gITE7CiAgICAgICAgICB9LAogICAgICAgIH0pOwogICAgICAgIHZhciBuYiA9IC9cci9nLAogICAgICAgICAgb2IgPSAvW1x4MjBcdFxyXG5cZl0rL2c7CiAgICAgICAgci5mbi5leHRlbmQoewogICAgICAgICAgdmFsOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICB2YXIgYiwKICAgICAgICAgICAgICBjLAogICAgICAgICAgICAgIGQsCiAgICAgICAgICAgICAgZSA9IHRoaXNbMF07CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkKICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgIChkID0gci5pc0Z1bmN0aW9uKGEpKSwKICAgICAgICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGU7CiAgICAgICAgICAgICAgICAgICAgMSA9PT0gdGhpcy5ub2RlVHlwZSAmJgogICAgICAgICAgICAgICAgICAgICAgKChlID0gZCA/IGEuY2FsbCh0aGlzLCBjLCByKHRoaXMpLnZhbCgpKSA6IGEpLAogICAgICAgICAgICAgICAgICAgICAgbnVsbCA9PSBlCiAgICAgICAgICAgICAgICAgICAgICAgID8gKGUgPSAiIikKICAgICAgICAgICAgICAgICAgICAgICAgOiAibnVtYmVyIiA9PSB0eXBlb2YgZQogICAgICAgICAgICAgICAgICAgICAgICA/IChlICs9ICIiKQogICAgICAgICAgICAgICAgICAgICAgICA6IHIuaXNBcnJheShlKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgIChlID0gci5tYXAoZSwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsID09IGEgPyAiIiA6IGEgKyAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgICB9KSksCiAgICAgICAgICAgICAgICAgICAgICAoYiA9IHIudmFsSG9va3NbdGhpcy50eXBlXSB8fCByLnZhbEhvb2tzW3RoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKV0pLAogICAgICAgICAgICAgICAgICAgICAgKGIgJiYgInNldCIgaW4gYiAmJiB2b2lkIDAgIT09IGIuc2V0KHRoaXMsIGUsICJ2YWx1ZSIpKSB8fCAodGhpcy52YWx1ZSA9IGUpKTsKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGUpCiAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAoYiA9IHIudmFsSG9va3NbZS50eXBlXSB8fCByLnZhbEhvb2tzW2Uubm9kZU5hbWUudG9Mb3dlckNhc2UoKV0pLAogICAgICAgICAgICAgICAgICBiICYmICJnZXQiIGluIGIgJiYgdm9pZCAwICE9PSAoYyA9IGIuZ2V0KGUsICJ2YWx1ZSIpKQogICAgICAgICAgICAgICAgICAgID8gYwogICAgICAgICAgICAgICAgICAgIDogKChjID0gZS52YWx1ZSksICJzdHJpbmciID09IHR5cGVvZiBjID8gYy5yZXBsYWNlKG5iLCAiIikgOiBudWxsID09IGMgPyAiIiA6IGMpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgIH0pLAogICAgICAgICAgci5leHRlbmQoewogICAgICAgICAgICB2YWxIb29rczogewogICAgICAgICAgICAgIG9wdGlvbjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICB2YXIgYiA9IHIuZmluZC5hdHRyKGEsICJ2YWx1ZSIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbCAhPSBiID8gYiA6IHIudHJpbShyLnRleHQoYSkpLnJlcGxhY2Uob2IsICIgIik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2VsZWN0OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoCiAgICAgICAgICAgICAgICAgICAgdmFyIGIsCiAgICAgICAgICAgICAgICAgICAgICBjLAogICAgICAgICAgICAgICAgICAgICAgZCA9IGEub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgIGUgPSBhLnNlbGVjdGVkSW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICBmID0gInNlbGVjdC1vbmUiID09PSBhLnR5cGUsCiAgICAgICAgICAgICAgICAgICAgICBnID0gZiA/IG51bGwgOiBbXSwKICAgICAgICAgICAgICAgICAgICAgIGggPSBmID8gZSArIDEgOiBkLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgIGkgPSBlIDwgMCA/IGggOiBmID8gZSA6IDA7CiAgICAgICAgICAgICAgICAgICAgaSA8IGg7CiAgICAgICAgICAgICAgICAgICAgaSsrCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBpZiAoKChjID0gZFtpXSksIChjLnNlbGVjdGVkIHx8IGkgPT09IGUpICYmICFjLmRpc2FibGVkICYmICghYy5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFyLm5vZGVOYW1lKGMucGFyZW50Tm9kZSwgIm9wdGdyb3VwIikpKSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCgoYiA9IHIoYykudmFsKCkpLCBmKSkgcmV0dXJuIGI7CiAgICAgICAgICAgICAgICAgICAgICBnLnB1c2goYik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gZzsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjLAogICAgICAgICAgICAgICAgICAgIGQsCiAgICAgICAgICAgICAgICAgICAgZSA9IGEub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICBmID0gci5tYWtlQXJyYXkoYiksCiAgICAgICAgICAgICAgICAgICAgZyA9IGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICB3aGlsZSAoZy0tKSAoZCA9IGVbZ10pLCAoZC5zZWxlY3RlZCA9IHIuaW5BcnJheShyLnZhbEhvb2tzLm9wdGlvbi5nZXQoZCksIGYpID4gLTEpICYmIChjID0gITApOwogICAgICAgICAgICAgICAgICByZXR1cm4gYyB8fCAoYS5zZWxlY3RlZEluZGV4ID0gLTEpLCBmOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9LAogICAgICAgICAgfSksCiAgICAgICAgICByLmVhY2goWyJyYWRpbyIsICJjaGVja2JveCJdLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIChyLnZhbEhvb2tzW3RoaXNdID0gewogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgIGlmIChyLmlzQXJyYXkoYikpIHJldHVybiAoYS5jaGVja2VkID0gci5pbkFycmF5KHIoYSkudmFsKCksIGIpID4gLTEpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgIG8uY2hlY2tPbiB8fAogICAgICAgICAgICAgICAgKHIudmFsSG9va3NbdGhpc10uZ2V0ID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGwgPT09IGEuZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpID8gIm9uIiA6IGEudmFsdWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIHZhciBwYiA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLzsKICAgICAgICByLmV4dGVuZChyLmV2ZW50LCB7CiAgICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoYiwgYywgZSwgZikgewogICAgICAgICAgICB2YXIgZywKICAgICAgICAgICAgICBoLAogICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgaiwKICAgICAgICAgICAgICBrLAogICAgICAgICAgICAgIG0sCiAgICAgICAgICAgICAgbiwKICAgICAgICAgICAgICBvID0gW2UgfHwgZF0sCiAgICAgICAgICAgICAgcCA9IGwuY2FsbChiLCAidHlwZSIpID8gYi50eXBlIDogYiwKICAgICAgICAgICAgICBxID0gbC5jYWxsKGIsICJuYW1lc3BhY2UiKSA/IGIubmFtZXNwYWNlLnNwbGl0KCIuIikgOiBbXTsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICgoaCA9IGkgPSBlID0gZSB8fCBkKSwKICAgICAgICAgICAgICAzICE9PSBlLm5vZGVUeXBlICYmCiAgICAgICAgICAgICAgICA4ICE9PSBlLm5vZGVUeXBlICYmCiAgICAgICAgICAgICAgICAhcGIudGVzdChwICsgci5ldmVudC50cmlnZ2VyZWQpICYmCiAgICAgICAgICAgICAgICAocC5pbmRleE9mKCIuIikgPiAtMSAmJiAoKHEgPSBwLnNwbGl0KCIuIikpLCAocCA9IHEuc2hpZnQoKSksIHEuc29ydCgpKSwKICAgICAgICAgICAgICAgIChrID0gcC5pbmRleE9mKCI6IikgPCAwICYmICJvbiIgKyBwKSwKICAgICAgICAgICAgICAgIChiID0gYltyLmV4cGFuZG9dID8gYiA6IG5ldyByLkV2ZW50KHAsICJvYmplY3QiID09IHR5cGVvZiBiICYmIGIpKSwKICAgICAgICAgICAgICAgIChiLmlzVHJpZ2dlciA9IGYgPyAyIDogMyksCiAgICAgICAgICAgICAgICAoYi5uYW1lc3BhY2UgPSBxLmpvaW4oIi4iKSksCiAgICAgICAgICAgICAgICAoYi5ybmFtZXNwYWNlID0gYi5uYW1lc3BhY2UgPyBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIHEuam9pbigiXFwuKD86LipcXC58KSIpICsgIihcXC58JCkiKSA6IG51bGwpLAogICAgICAgICAgICAgICAgKGIucmVzdWx0ID0gdm9pZCAwKSwKICAgICAgICAgICAgICAgIGIudGFyZ2V0IHx8IChiLnRhcmdldCA9IGUpLAogICAgICAgICAgICAgICAgKGMgPSBudWxsID09IGMgPyBbYl0gOiByLm1ha2VBcnJheShjLCBbYl0pKSwKICAgICAgICAgICAgICAgIChuID0gci5ldmVudC5zcGVjaWFsW3BdIHx8IHt9KSwKICAgICAgICAgICAgICAgIGYgfHwgIW4udHJpZ2dlciB8fCBuLnRyaWdnZXIuYXBwbHkoZSwgYykgIT09ICExKSkKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgaWYgKCFmICYmICFuLm5vQnViYmxlICYmICFyLmlzV2luZG93KGUpKSB7CiAgICAgICAgICAgICAgICBmb3IgKGogPSBuLmRlbGVnYXRlVHlwZSB8fCBwLCBwYi50ZXN0KGogKyBwKSB8fCAoaCA9IGgucGFyZW50Tm9kZSk7IGg7IGggPSBoLnBhcmVudE5vZGUpIG8ucHVzaChoKSwgKGkgPSBoKTsKICAgICAgICAgICAgICAgIGkgPT09IChlLm93bmVyRG9jdW1lbnQgfHwgZCkgJiYgby5wdXNoKGkuZGVmYXVsdFZpZXcgfHwgaS5wYXJlbnRXaW5kb3cgfHwgYSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGcgPSAwOwogICAgICAgICAgICAgIHdoaWxlICgoaCA9IG9bZysrXSkgJiYgIWIuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkKICAgICAgICAgICAgICAgIChiLnR5cGUgPSBnID4gMSA/IGogOiBuLmJpbmRUeXBlIHx8IHApLAogICAgICAgICAgICAgICAgICAobSA9IChWLmdldChoLCAiZXZlbnRzIikgfHwge30pW2IudHlwZV0gJiYgVi5nZXQoaCwgImhhbmRsZSIpKSwKICAgICAgICAgICAgICAgICAgbSAmJiBtLmFwcGx5KGgsIGMpLAogICAgICAgICAgICAgICAgICAobSA9IGsgJiYgaFtrXSksCiAgICAgICAgICAgICAgICAgIG0gJiYgbS5hcHBseSAmJiBUKGgpICYmICgoYi5yZXN1bHQgPSBtLmFwcGx5KGgsIGMpKSwgYi5yZXN1bHQgPT09ICExICYmIGIucHJldmVudERlZmF1bHQoKSk7CiAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgIChiLnR5cGUgPSBwKSwKICAgICAgICAgICAgICAgIGYgfHwKICAgICAgICAgICAgICAgICAgYi5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAogICAgICAgICAgICAgICAgICAobi5fZGVmYXVsdCAmJiBuLl9kZWZhdWx0LmFwcGx5KG8ucG9wKCksIGMpICE9PSAhMSkgfHwKICAgICAgICAgICAgICAgICAgIVQoZSkgfHwKICAgICAgICAgICAgICAgICAgKGsgJiYKICAgICAgICAgICAgICAgICAgICByLmlzRnVuY3Rpb24oZVtwXSkgJiYKICAgICAgICAgICAgICAgICAgICAhci5pc1dpbmRvdyhlKSAmJgogICAgICAgICAgICAgICAgICAgICgoaSA9IGVba10pLCBpICYmIChlW2tdID0gbnVsbCksIChyLmV2ZW50LnRyaWdnZXJlZCA9IHApLCBlW3BdKCksIChyLmV2ZW50LnRyaWdnZXJlZCA9IHZvaWQgMCksIGkgJiYgKGVba10gPSBpKSkpLAogICAgICAgICAgICAgICAgYi5yZXN1bHQKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgc2ltdWxhdGU6IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gci5leHRlbmQobmV3IHIuRXZlbnQoKSwgYywgeyB0eXBlOiBhLCBpc1NpbXVsYXRlZDogITAgfSk7CiAgICAgICAgICAgIHIuZXZlbnQudHJpZ2dlcihkLCBudWxsLCBiKTsKICAgICAgICAgIH0sCiAgICAgICAgfSksCiAgICAgICAgICByLmZuLmV4dGVuZCh7CiAgICAgICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByLmV2ZW50LnRyaWdnZXIoYSwgYiwgdGhpcyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHZhciBjID0gdGhpc1swXTsKICAgICAgICAgICAgICBpZiAoYykgcmV0dXJuIHIuZXZlbnQudHJpZ2dlcihhLCBiLCBjLCAhMCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KSwKICAgICAgICAgIHIuZWFjaCgKICAgICAgICAgICAgImJsdXIgZm9jdXMgZm9jdXNpbiBmb2N1c291dCByZXNpemUgc2Nyb2xsIGNsaWNrIGRibGNsaWNrIG1vdXNlZG93biBtb3VzZXVwIG1vdXNlbW92ZSBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2VlbnRlciBtb3VzZWxlYXZlIGNoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgY29udGV4dG1lbnUiLnNwbGl0KAogICAgICAgICAgICAgICIgIgogICAgICAgICAgICApLAogICAgICAgICAgICBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHIuZm5bYl0gPSBmdW5jdGlvbiAoYSwgYykgewogICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8gdGhpcy5vbihiLCBudWxsLCBhLCBjKSA6IHRoaXMudHJpZ2dlcihiKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICApLAogICAgICAgICAgci5mbi5leHRlbmQoewogICAgICAgICAgICBob3ZlcjogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tb3VzZWVudGVyKGEpLm1vdXNlbGVhdmUoYiB8fCBhKTsKICAgICAgICAgICAgfSwKICAgICAgICAgIH0pLAogICAgICAgICAgKG8uZm9jdXNpbiA9ICJvbmZvY3VzaW4iIGluIGEpLAogICAgICAgICAgby5mb2N1c2luIHx8CiAgICAgICAgICAgIHIuZWFjaCh7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICB2YXIgYyA9IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICByLmV2ZW50LnNpbXVsYXRlKGIsIGEudGFyZ2V0LCByLmV2ZW50LmZpeChhKSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByLmV2ZW50LnNwZWNpYWxbYl0gPSB7CiAgICAgICAgICAgICAgICBzZXR1cDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgZCA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLAogICAgICAgICAgICAgICAgICAgIGUgPSBWLmFjY2VzcyhkLCBiKTsKICAgICAgICAgICAgICAgICAgZSB8fCBkLmFkZEV2ZW50TGlzdGVuZXIoYSwgYywgITApLCBWLmFjY2VzcyhkLCBiLCAoZSB8fCAwKSArIDEpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHRlYXJkb3duOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBkID0gdGhpcy5vd25lckRvY3VtZW50IHx8IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgZSA9IFYuYWNjZXNzKGQsIGIpIC0gMTsKICAgICAgICAgICAgICAgICAgZSA/IFYuYWNjZXNzKGQsIGIsIGUpIDogKGQucmVtb3ZlRXZlbnRMaXN0ZW5lcihhLCBjLCAhMCksIFYucmVtb3ZlKGQsIGIpKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgdmFyIHFiID0gYS5sb2NhdGlvbiwKICAgICAgICAgIHJiID0gci5ub3coKSwKICAgICAgICAgIHNiID0gL1w/LzsKICAgICAgICByLnBhcnNlWE1MID0gZnVuY3Rpb24gKGIpIHsKICAgICAgICAgIHZhciBjOwogICAgICAgICAgaWYgKCFiIHx8ICJzdHJpbmciICE9IHR5cGVvZiBiKSByZXR1cm4gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGMgPSBuZXcgYS5ET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoYiwgInRleHQveG1sIik7CiAgICAgICAgICB9IGNhdGNoIChkKSB7CiAgICAgICAgICAgIGMgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKGMgJiYgIWMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIikubGVuZ3RoKSB8fCByLmVycm9yKCJJbnZhbGlkIFhNTDogIiArIGIpLCBjOwogICAgICAgIH07CiAgICAgICAgdmFyIHRiID0gL1xbXF0kLywKICAgICAgICAgIHViID0gL1xyP1xuL2csCiAgICAgICAgICB2YiA9IC9eKD86c3VibWl0fGJ1dHRvbnxpbWFnZXxyZXNldHxmaWxlKSQvaSwKICAgICAgICAgIHdiID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8a2V5Z2VuKS9pOwogICAgICAgIGZ1bmN0aW9uIHhiKGEsIGIsIGMsIGQpIHsKICAgICAgICAgIHZhciBlOwogICAgICAgICAgaWYgKHIuaXNBcnJheShiKSkKICAgICAgICAgICAgci5lYWNoKGIsIGZ1bmN0aW9uIChiLCBlKSB7CiAgICAgICAgICAgICAgYyB8fCB0Yi50ZXN0KGEpID8gZChhLCBlKSA6IHhiKGEgKyAiWyIgKyAoIm9iamVjdCIgPT0gdHlwZW9mIGUgJiYgbnVsbCAhPSBlID8gYiA6ICIiKSArICJdIiwgZSwgYywgZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgZWxzZSBpZiAoYyB8fCAib2JqZWN0IiAhPT0gci50eXBlKGIpKSBkKGEsIGIpOwogICAgICAgICAgZWxzZSBmb3IgKGUgaW4gYikgeGIoYSArICJbIiArIGUgKyAiXSIsIGJbZV0sIGMsIGQpOwogICAgICAgIH0KICAgICAgICAoci5wYXJhbSA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICB2YXIgYywKICAgICAgICAgICAgZCA9IFtdLAogICAgICAgICAgICBlID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICB2YXIgYyA9IHIuaXNGdW5jdGlvbihiKSA/IGIoKSA6IGI7CiAgICAgICAgICAgICAgZFtkLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoYSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQobnVsbCA9PSBjID8gIiIgOiBjKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIGlmIChyLmlzQXJyYXkoYSkgfHwgKGEuanF1ZXJ5ICYmICFyLmlzUGxhaW5PYmplY3QoYSkpKQogICAgICAgICAgICByLmVhY2goYSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGUodGhpcy5uYW1lLCB0aGlzLnZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICBlbHNlIGZvciAoYyBpbiBhKSB4YihjLCBhW2NdLCBiLCBlKTsKICAgICAgICAgIHJldHVybiBkLmpvaW4oIiYiKTsKICAgICAgICB9KSwKICAgICAgICAgIHIuZm4uZXh0ZW5kKHsKICAgICAgICAgICAgc2VyaWFsaXplOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHIucGFyYW0odGhpcy5zZXJpYWxpemVBcnJheSgpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGEgPSByLnByb3AodGhpcywgImVsZW1lbnRzIik7CiAgICAgICAgICAgICAgICByZXR1cm4gYSA/IHIubWFrZUFycmF5KGEpIDogdGhpczsKICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBhID0gdGhpcy50eXBlOwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uYW1lICYmICFyKHRoaXMpLmlzKCI6ZGlzYWJsZWQiKSAmJiB3Yi50ZXN0KHRoaXMubm9kZU5hbWUpICYmICF2Yi50ZXN0KGEpICYmICh0aGlzLmNoZWNrZWQgfHwgIWhhLnRlc3QoYSkpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGMgPSByKHRoaXMpLnZhbCgpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbCA9PSBjCiAgICAgICAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgICAgICAgOiByLmlzQXJyYXkoYykKICAgICAgICAgICAgICAgICAgICA/IHIubWFwKGMsIGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IGIubmFtZSwgdmFsdWU6IGEucmVwbGFjZSh1YiwgIlxyXG4iKSB9OwogICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICA6IHsgbmFtZTogYi5uYW1lLCB2YWx1ZTogYy5yZXBsYWNlKHViLCAiXHJcbiIpIH07CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLmdldCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgfSk7CiAgICAgICAgdmFyIHliID0gLyUyMC9nLAogICAgICAgICAgemIgPSAvIy4qJC8sCiAgICAgICAgICBBYiA9IC8oWz8mXSlfPVteJl0qLywKICAgICAgICAgIEJiID0gL14oLio/KTpbIFx0XSooW15cclxuXSopJC9nbSwKICAgICAgICAgIENiID0gL14oPzphYm91dHxhcHB8YXBwLXN0b3JhZ2V8ListZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sCiAgICAgICAgICBEYiA9IC9eKD86R0VUfEhFQUQpJC8sCiAgICAgICAgICBFYiA9IC9eXC9cLy8sCiAgICAgICAgICBGYiA9IHt9LAogICAgICAgICAgR2IgPSB7fSwKICAgICAgICAgIEhiID0gIiovIi5jb25jYXQoIioiKSwKICAgICAgICAgIEliID0gZC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgICAgSWIuaHJlZiA9IHFiLmhyZWY7CiAgICAgICAgZnVuY3Rpb24gSmIoYSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChiLCBjKSB7CiAgICAgICAgICAgICJzdHJpbmciICE9IHR5cGVvZiBiICYmICgoYyA9IGIpLCAoYiA9ICIqIikpOwogICAgICAgICAgICB2YXIgZCwKICAgICAgICAgICAgICBlID0gMCwKICAgICAgICAgICAgICBmID0gYi50b0xvd2VyQ2FzZSgpLm1hdGNoKEspIHx8IFtdOwogICAgICAgICAgICBpZiAoci5pc0Z1bmN0aW9uKGMpKQogICAgICAgICAgICAgIHdoaWxlICgoZCA9IGZbZSsrXSkpICIrIiA9PT0gZFswXSA/ICgoZCA9IGQuc2xpY2UoMSkgfHwgIioiKSwgKGFbZF0gPSBhW2RdIHx8IFtdKS51bnNoaWZ0KGMpKSA6IChhW2RdID0gYVtkXSB8fCBbXSkucHVzaChjKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIEtiKGEsIGIsIGMsIGQpIHsKICAgICAgICAgIHZhciBlID0ge30sCiAgICAgICAgICAgIGYgPSBhID09PSBHYjsKICAgICAgICAgIGZ1bmN0aW9uIGcoaCkgewogICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAoZVtoXSA9ICEwKSwKICAgICAgICAgICAgICByLmVhY2goYVtoXSB8fCBbXSwgZnVuY3Rpb24gKGEsIGgpIHsKICAgICAgICAgICAgICAgIHZhciBqID0gaChiLCBjLCBkKTsKICAgICAgICAgICAgICAgIHJldHVybiAic3RyaW5nIiAhPSB0eXBlb2YgaiB8fCBmIHx8IGVbal0gPyAoZiA/ICEoaSA9IGopIDogdm9pZCAwKSA6IChiLmRhdGFUeXBlcy51bnNoaWZ0KGopLCBnKGopLCAhMSk7CiAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgaQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGcoYi5kYXRhVHlwZXNbMF0pIHx8ICghZVsiKiJdICYmIGcoIioiKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIExiKGEsIGIpIHsKICAgICAgICAgIHZhciBjLAogICAgICAgICAgICBkLAogICAgICAgICAgICBlID0gci5hamF4U2V0dGluZ3MuZmxhdE9wdGlvbnMgfHwge307CiAgICAgICAgICBmb3IgKGMgaW4gYikgdm9pZCAwICE9PSBiW2NdICYmICgoZVtjXSA/IGEgOiBkIHx8IChkID0ge30pKVtjXSA9IGJbY10pOwogICAgICAgICAgcmV0dXJuIGQgJiYgci5leHRlbmQoITAsIGEsIGQpLCBhOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBNYihhLCBiLCBjKSB7CiAgICAgICAgICB2YXIgZCwKICAgICAgICAgICAgZSwKICAgICAgICAgICAgZiwKICAgICAgICAgICAgZywKICAgICAgICAgICAgaCA9IGEuY29udGVudHMsCiAgICAgICAgICAgIGkgPSBhLmRhdGFUeXBlczsKICAgICAgICAgIHdoaWxlICgiKiIgPT09IGlbMF0pIGkuc2hpZnQoKSwgdm9pZCAwID09PSBkICYmIChkID0gYS5taW1lVHlwZSB8fCBiLmdldFJlc3BvbnNlSGVhZGVyKCJDb250ZW50LVR5cGUiKSk7CiAgICAgICAgICBpZiAoZCkKICAgICAgICAgICAgZm9yIChlIGluIGgpCiAgICAgICAgICAgICAgaWYgKGhbZV0gJiYgaFtlXS50ZXN0KGQpKSB7CiAgICAgICAgICAgICAgICBpLnVuc2hpZnQoZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICBpZiAoaVswXSBpbiBjKSBmID0gaVswXTsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBmb3IgKGUgaW4gYykgewogICAgICAgICAgICAgIGlmICghaVswXSB8fCBhLmNvbnZlcnRlcnNbZSArICIgIiArIGlbMF1dKSB7CiAgICAgICAgICAgICAgICBmID0gZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBnIHx8IChnID0gZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZiA9IGYgfHwgZzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmKSByZXR1cm4gZiAhPT0gaVswXSAmJiBpLnVuc2hpZnQoZiksIGNbZl07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIE5iKGEsIGIsIGMsIGQpIHsKICAgICAgICAgIHZhciBlLAogICAgICAgICAgICBmLAogICAgICAgICAgICBnLAogICAgICAgICAgICBoLAogICAgICAgICAgICBpLAogICAgICAgICAgICBqID0ge30sCiAgICAgICAgICAgIGsgPSBhLmRhdGFUeXBlcy5zbGljZSgpOwogICAgICAgICAgaWYgKGtbMV0pIGZvciAoZyBpbiBhLmNvbnZlcnRlcnMpIGpbZy50b0xvd2VyQ2FzZSgpXSA9IGEuY29udmVydGVyc1tnXTsKICAgICAgICAgIGYgPSBrLnNoaWZ0KCk7CiAgICAgICAgICB3aGlsZSAoZikKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIChhLnJlc3BvbnNlRmllbGRzW2ZdICYmIChjW2EucmVzcG9uc2VGaWVsZHNbZl1dID0gYiksCiAgICAgICAgICAgICAgIWkgJiYgZCAmJiBhLmRhdGFGaWx0ZXIgJiYgKGIgPSBhLmRhdGFGaWx0ZXIoYiwgYS5kYXRhVHlwZSkpLAogICAgICAgICAgICAgIChpID0gZiksCiAgICAgICAgICAgICAgKGYgPSBrLnNoaWZ0KCkpKQogICAgICAgICAgICApCiAgICAgICAgICAgICAgaWYgKCIqIiA9PT0gZikgZiA9IGk7CiAgICAgICAgICAgICAgZWxzZSBpZiAoIioiICE9PSBpICYmIGkgIT09IGYpIHsKICAgICAgICAgICAgICAgIGlmICgoKGcgPSBqW2kgKyAiICIgKyBmXSB8fCBqWyIqICIgKyBmXSksICFnKSkKICAgICAgICAgICAgICAgICAgZm9yIChlIGluIGopCiAgICAgICAgICAgICAgICAgICAgaWYgKCgoaCA9IGUuc3BsaXQoIiAiKSksIGhbMV0gPT09IGYgJiYgKGcgPSBqW2kgKyAiICIgKyBoWzBdXSB8fCBqWyIqICIgKyBoWzBdXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICBnID09PSAhMCA/IChnID0galtlXSkgOiBqW2VdICE9PSAhMCAmJiAoKGYgPSBoWzBdKSwgay51bnNoaWZ0KGhbMV0pKTsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChnICE9PSAhMCkKICAgICAgICAgICAgICAgICAgaWYgKGcgJiYgYVsidGhyb3dzIl0pIGIgPSBnKGIpOwogICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGIgPSBnKGIpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlOiAicGFyc2VyZXJyb3IiLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZyA/IGwgOiAiTm8gY29udmVyc2lvbiBmcm9tICIgKyBpICsgIiB0byAiICsgZiwKICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7IHN0YXRlOiAic3VjY2VzcyIsIGRhdGE6IGIgfTsKICAgICAgICB9CiAgICAgICAgci5leHRlbmQoewogICAgICAgICAgYWN0aXZlOiAwLAogICAgICAgICAgbGFzdE1vZGlmaWVkOiB7fSwKICAgICAgICAgIGV0YWc6IHt9LAogICAgICAgICAgYWpheFNldHRpbmdzOiB7CiAgICAgICAgICAgIHVybDogcWIuaHJlZiwKICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgIGlzTG9jYWw6IENiLnRlc3QocWIucHJvdG9jb2wpLAogICAgICAgICAgICBnbG9iYWw6ICEwLAogICAgICAgICAgICBwcm9jZXNzRGF0YTogITAsCiAgICAgICAgICAgIGFzeW5jOiAhMCwKICAgICAgICAgICAgY29udGVudFR5cGU6ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgiLAogICAgICAgICAgICBhY2NlcHRzOiB7CiAgICAgICAgICAgICAgIioiOiBIYiwKICAgICAgICAgICAgICB0ZXh0OiAidGV4dC9wbGFpbiIsCiAgICAgICAgICAgICAgaHRtbDogInRleHQvaHRtbCIsCiAgICAgICAgICAgICAgeG1sOiAiYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCIsCiAgICAgICAgICAgICAganNvbjogImFwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCIsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNvbnRlbnRzOiB7IHhtbDogL1xieG1sXGIvLCBodG1sOiAvXGJodG1sLywganNvbjogL1xianNvblxiLyB9LAogICAgICAgICAgICByZXNwb25zZUZpZWxkczogewogICAgICAgICAgICAgIHhtbDogInJlc3BvbnNlWE1MIiwKICAgICAgICAgICAgICB0ZXh0OiAicmVzcG9uc2VUZXh0IiwKICAgICAgICAgICAgICBqc29uOiAicmVzcG9uc2VKU09OIiwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29udmVydGVyczogewogICAgICAgICAgICAgICIqIHRleHQiOiBTdHJpbmcsCiAgICAgICAgICAgICAgInRleHQgaHRtbCI6ICEwLAogICAgICAgICAgICAgICJ0ZXh0IGpzb24iOiBKU09OLnBhcnNlLAogICAgICAgICAgICAgICJ0ZXh0IHhtbCI6IHIucGFyc2VYTUwsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZsYXRPcHRpb25zOiB7IHVybDogITAsIGNvbnRleHQ6ICEwIH0sCiAgICAgICAgICB9LAogICAgICAgICAgYWpheFNldHVwOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICByZXR1cm4gYiA/IExiKExiKGEsIHIuYWpheFNldHRpbmdzKSwgYikgOiBMYihyLmFqYXhTZXR0aW5ncywgYSk7CiAgICAgICAgICB9LAogICAgICAgICAgYWpheFByZWZpbHRlcjogSmIoRmIpLAogICAgICAgICAgYWpheFRyYW5zcG9ydDogSmIoR2IpLAogICAgICAgICAgYWpheDogZnVuY3Rpb24gKGIsIGMpIHsKICAgICAgICAgICAgIm9iamVjdCIgPT0gdHlwZW9mIGIgJiYgKChjID0gYiksIChiID0gdm9pZCAwKSksIChjID0gYyB8fCB7fSk7CiAgICAgICAgICAgIHZhciBlLAogICAgICAgICAgICAgIGYsCiAgICAgICAgICAgICAgZywKICAgICAgICAgICAgICBoLAogICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgaiwKICAgICAgICAgICAgICBrLAogICAgICAgICAgICAgIGwsCiAgICAgICAgICAgICAgbSwKICAgICAgICAgICAgICBuLAogICAgICAgICAgICAgIG8gPSByLmFqYXhTZXR1cCh7fSwgYyksCiAgICAgICAgICAgICAgcCA9IG8uY29udGV4dCB8fCBvLAogICAgICAgICAgICAgIHEgPSBvLmNvbnRleHQgJiYgKHAubm9kZVR5cGUgfHwgcC5qcXVlcnkpID8gcihwKSA6IHIuZXZlbnQsCiAgICAgICAgICAgICAgcyA9IHIuRGVmZXJyZWQoKSwKICAgICAgICAgICAgICB0ID0gci5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksCiAgICAgICAgICAgICAgdSA9IG8uc3RhdHVzQ29kZSB8fCB7fSwKICAgICAgICAgICAgICB2ID0ge30sCiAgICAgICAgICAgICAgdyA9IHt9LAogICAgICAgICAgICAgIHggPSAiY2FuY2VsZWQiLAogICAgICAgICAgICAgIHkgPSB7CiAgICAgICAgICAgICAgICByZWFkeVN0YXRlOiAwLAogICAgICAgICAgICAgICAgZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgIHZhciBiOwogICAgICAgICAgICAgICAgICBpZiAoaykgewogICAgICAgICAgICAgICAgICAgIGlmICghaCkgewogICAgICAgICAgICAgICAgICAgICAgaCA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChiID0gQmIuZXhlYyhnKSkpIGhbYlsxXS50b0xvd2VyQ2FzZSgpXSA9IGJbMl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGIgPSBoW2EudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGwgPT0gYiA/IG51bGwgOiBiOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gayA/IGcgOiBudWxsOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldFJlcXVlc3RIZWFkZXI6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsID09IGsgJiYgKChhID0gd1thLnRvTG93ZXJDYXNlKCldID0gd1thLnRvTG93ZXJDYXNlKCldIHx8IGEpLCAodlthXSA9IGIpKSwgdGhpczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbCA9PSBrICYmIChvLm1pbWVUeXBlID0gYSksIHRoaXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgdmFyIGI7CiAgICAgICAgICAgICAgICAgIGlmIChhKQogICAgICAgICAgICAgICAgICAgIGlmIChrKSB5LmFsd2F5cyhhW3kuc3RhdHVzXSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBmb3IgKGIgaW4gYSkgdVtiXSA9IFt1W2JdLCBhW2JdXTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgIHZhciBiID0gYSB8fCB4OwogICAgICAgICAgICAgICAgICByZXR1cm4gZSAmJiBlLmFib3J0KGIpLCBBKDAsIGIpLCB0aGlzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgKHMucHJvbWlzZSh5KSwKICAgICAgICAgICAgICAoby51cmwgPSAoKGIgfHwgby51cmwgfHwgcWIuaHJlZikgKyAiIikucmVwbGFjZShFYiwgcWIucHJvdG9jb2wgKyAiLy8iKSksCiAgICAgICAgICAgICAgKG8udHlwZSA9IGMubWV0aG9kIHx8IGMudHlwZSB8fCBvLm1ldGhvZCB8fCBvLnR5cGUpLAogICAgICAgICAgICAgIChvLmRhdGFUeXBlcyA9IChvLmRhdGFUeXBlIHx8ICIqIikudG9Mb3dlckNhc2UoKS5tYXRjaChLKSB8fCBbIiJdKSwKICAgICAgICAgICAgICBudWxsID09IG8uY3Jvc3NEb21haW4pCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGogPSBkLmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgKGouaHJlZiA9IG8udXJsKSwgKGouaHJlZiA9IGouaHJlZiksIChvLmNyb3NzRG9tYWluID0gSWIucHJvdG9jb2wgKyAiLy8iICsgSWIuaG9zdCAhPSBqLnByb3RvY29sICsgIi8vIiArIGouaG9zdCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeikgewogICAgICAgICAgICAgICAgby5jcm9zc0RvbWFpbiA9ICEwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKG8uZGF0YSAmJiBvLnByb2Nlc3NEYXRhICYmICJzdHJpbmciICE9IHR5cGVvZiBvLmRhdGEgJiYgKG8uZGF0YSA9IHIucGFyYW0oby5kYXRhLCBvLnRyYWRpdGlvbmFsKSksIEtiKEZiLCBvLCBjLCB5KSwgaykpIHJldHVybiB5OwogICAgICAgICAgICAobCA9IHIuZXZlbnQgJiYgby5nbG9iYWwpLAogICAgICAgICAgICAgIGwgJiYgMCA9PT0gci5hY3RpdmUrKyAmJiByLmV2ZW50LnRyaWdnZXIoImFqYXhTdGFydCIpLAogICAgICAgICAgICAgIChvLnR5cGUgPSBvLnR5cGUudG9VcHBlckNhc2UoKSksCiAgICAgICAgICAgICAgKG8uaGFzQ29udGVudCA9ICFEYi50ZXN0KG8udHlwZSkpLAogICAgICAgICAgICAgIChmID0gby51cmwucmVwbGFjZSh6YiwgIiIpKSwKICAgICAgICAgICAgICBvLmhhc0NvbnRlbnQKICAgICAgICAgICAgICAgID8gby5kYXRhICYmCiAgICAgICAgICAgICAgICAgIG8ucHJvY2Vzc0RhdGEgJiYKICAgICAgICAgICAgICAgICAgMCA9PT0gKG8uY29udGVudFR5cGUgfHwgIiIpLmluZGV4T2YoImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpICYmCiAgICAgICAgICAgICAgICAgIChvLmRhdGEgPSBvLmRhdGEucmVwbGFjZSh5YiwgIisiKSkKICAgICAgICAgICAgICAgIDogKChuID0gby51cmwuc2xpY2UoZi5sZW5ndGgpKSwKICAgICAgICAgICAgICAgICAgby5kYXRhICYmICgoZiArPSAoc2IudGVzdChmKSA/ICImIiA6ICI/IikgKyBvLmRhdGEpLCBkZWxldGUgby5kYXRhKSwKICAgICAgICAgICAgICAgICAgby5jYWNoZSA9PT0gITEgJiYgKChmID0gZi5yZXBsYWNlKEFiLCAiIikpLCAobiA9IChzYi50ZXN0KGYpID8gIiYiIDogIj8iKSArICJfPSIgKyByYisrICsgbikpLAogICAgICAgICAgICAgICAgICAoby51cmwgPSBmICsgbikpLAogICAgICAgICAgICAgIG8uaWZNb2RpZmllZCAmJgogICAgICAgICAgICAgICAgKHIubGFzdE1vZGlmaWVkW2ZdICYmIHkuc2V0UmVxdWVzdEhlYWRlcigiSWYtTW9kaWZpZWQtU2luY2UiLCByLmxhc3RNb2RpZmllZFtmXSksCiAgICAgICAgICAgICAgICByLmV0YWdbZl0gJiYgeS5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Ob25lLU1hdGNoIiwgci5ldGFnW2ZdKSksCiAgICAgICAgICAgICAgKChvLmRhdGEgJiYgby5oYXNDb250ZW50ICYmIG8uY29udGVudFR5cGUgIT09ICExKSB8fCBjLmNvbnRlbnRUeXBlKSAmJiB5LnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtVHlwZSIsIG8uY29udGVudFR5cGUpLAogICAgICAgICAgICAgIHkuc2V0UmVxdWVzdEhlYWRlcigKICAgICAgICAgICAgICAgICJBY2NlcHQiLAogICAgICAgICAgICAgICAgby5kYXRhVHlwZXNbMF0gJiYgby5hY2NlcHRzW28uZGF0YVR5cGVzWzBdXQogICAgICAgICAgICAgICAgICA/IG8uYWNjZXB0c1tvLmRhdGFUeXBlc1swXV0gKyAoIioiICE9PSBvLmRhdGFUeXBlc1swXSA/ICIsICIgKyBIYiArICI7IHE9MC4wMSIgOiAiIikKICAgICAgICAgICAgICAgICAgOiBvLmFjY2VwdHNbIioiXQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIGZvciAobSBpbiBvLmhlYWRlcnMpIHkuc2V0UmVxdWVzdEhlYWRlcihtLCBvLmhlYWRlcnNbbV0pOwogICAgICAgICAgICBpZiAoby5iZWZvcmVTZW5kICYmIChvLmJlZm9yZVNlbmQuY2FsbChwLCB5LCBvKSA9PT0gITEgfHwgaykpIHJldHVybiB5LmFib3J0KCk7CiAgICAgICAgICAgIGlmICgoKHggPSAiYWJvcnQiKSwgdC5hZGQoby5jb21wbGV0ZSksIHkuZG9uZShvLnN1Y2Nlc3MpLCB5LmZhaWwoby5lcnJvciksIChlID0gS2IoR2IsIG8sIGMsIHkpKSkpIHsKICAgICAgICAgICAgICBpZiAoKCh5LnJlYWR5U3RhdGUgPSAxKSwgbCAmJiBxLnRyaWdnZXIoImFqYXhTZW5kIiwgW3ksIG9dKSwgaykpIHJldHVybiB5OwogICAgICAgICAgICAgIG8uYXN5bmMgJiYKICAgICAgICAgICAgICAgIG8udGltZW91dCA+IDAgJiYKICAgICAgICAgICAgICAgIChpID0gYS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgeS5hYm9ydCgidGltZW91dCIpOwogICAgICAgICAgICAgICAgfSwgby50aW1lb3V0KSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIChrID0gITEpLCBlLnNlbmQodiwgQSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeikgewogICAgICAgICAgICAgICAgaWYgKGspIHRocm93IHo7CiAgICAgICAgICAgICAgICBBKC0xLCB6KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBBKC0xLCAiTm8gVHJhbnNwb3J0Iik7CiAgICAgICAgICAgIGZ1bmN0aW9uIEEoYiwgYywgZCwgaCkgewogICAgICAgICAgICAgIHZhciBqLAogICAgICAgICAgICAgICAgbSwKICAgICAgICAgICAgICAgIG4sCiAgICAgICAgICAgICAgICB2LAogICAgICAgICAgICAgICAgdywKICAgICAgICAgICAgICAgIHggPSBjOwogICAgICAgICAgICAgIGsgfHwKICAgICAgICAgICAgICAgICgoayA9ICEwKSwKICAgICAgICAgICAgICAgIGkgJiYgYS5jbGVhclRpbWVvdXQoaSksCiAgICAgICAgICAgICAgICAoZSA9IHZvaWQgMCksCiAgICAgICAgICAgICAgICAoZyA9IGggfHwgIiIpLAogICAgICAgICAgICAgICAgKHkucmVhZHlTdGF0ZSA9IGIgPiAwID8gNCA6IDApLAogICAgICAgICAgICAgICAgKGogPSAoYiA+PSAyMDAgJiYgYiA8IDMwMCkgfHwgMzA0ID09PSBiKSwKICAgICAgICAgICAgICAgIGQgJiYgKHYgPSBNYihvLCB5LCBkKSksCiAgICAgICAgICAgICAgICAodiA9IE5iKG8sIHYsIHksIGopKSwKICAgICAgICAgICAgICAgIGoKICAgICAgICAgICAgICAgICAgPyAoby5pZk1vZGlmaWVkICYmCiAgICAgICAgICAgICAgICAgICAgICAoKHcgPSB5LmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIikpLAogICAgICAgICAgICAgICAgICAgICAgdyAmJiAoci5sYXN0TW9kaWZpZWRbZl0gPSB3KSwKICAgICAgICAgICAgICAgICAgICAgICh3ID0geS5nZXRSZXNwb25zZUhlYWRlcigiZXRhZyIpKSwKICAgICAgICAgICAgICAgICAgICAgIHcgJiYgKHIuZXRhZ1tmXSA9IHcpKSwKICAgICAgICAgICAgICAgICAgICAyMDQgPT09IGIgfHwgIkhFQUQiID09PSBvLnR5cGUKICAgICAgICAgICAgICAgICAgICAgID8gKHggPSAibm9jb250ZW50IikKICAgICAgICAgICAgICAgICAgICAgIDogMzA0ID09PSBiCiAgICAgICAgICAgICAgICAgICAgICA/ICh4ID0gIm5vdG1vZGlmaWVkIikKICAgICAgICAgICAgICAgICAgICAgIDogKCh4ID0gdi5zdGF0ZSksIChtID0gdi5kYXRhKSwgKG4gPSB2LmVycm9yKSwgKGogPSAhbikpKQogICAgICAgICAgICAgICAgICA6ICgobiA9IHgpLCAoIWIgJiYgeCkgfHwgKCh4ID0gImVycm9yIiksIGIgPCAwICYmIChiID0gMCkpKSwKICAgICAgICAgICAgICAgICh5LnN0YXR1cyA9IGIpLAogICAgICAgICAgICAgICAgKHkuc3RhdHVzVGV4dCA9IChjIHx8IHgpICsgIiIpLAogICAgICAgICAgICAgICAgaiA/IHMucmVzb2x2ZVdpdGgocCwgW20sIHgsIHldKSA6IHMucmVqZWN0V2l0aChwLCBbeSwgeCwgbl0pLAogICAgICAgICAgICAgICAgeS5zdGF0dXNDb2RlKHUpLAogICAgICAgICAgICAgICAgKHUgPSB2b2lkIDApLAogICAgICAgICAgICAgICAgbCAmJiBxLnRyaWdnZXIoaiA/ICJhamF4U3VjY2VzcyIgOiAiYWpheEVycm9yIiwgW3ksIG8sIGogPyBtIDogbl0pLAogICAgICAgICAgICAgICAgdC5maXJlV2l0aChwLCBbeSwgeF0pLAogICAgICAgICAgICAgICAgbCAmJiAocS50cmlnZ2VyKCJhamF4Q29tcGxldGUiLCBbeSwgb10pLCAtLXIuYWN0aXZlIHx8IHIuZXZlbnQudHJpZ2dlcigiYWpheFN0b3AiKSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB5OwogICAgICAgICAgfSwKICAgICAgICAgIGdldEpTT046IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgIHJldHVybiByLmdldChhLCBiLCBjLCAianNvbiIpOwogICAgICAgICAgfSwKICAgICAgICAgIGdldFNjcmlwdDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIHIuZ2V0KGEsIHZvaWQgMCwgYiwgInNjcmlwdCIpOwogICAgICAgICAgfSwKICAgICAgICB9KSwKICAgICAgICAgIHIuZWFjaChbImdldCIsICJwb3N0Il0sIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHJbYl0gPSBmdW5jdGlvbiAoYSwgYywgZCwgZSkgewogICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICByLmlzRnVuY3Rpb24oYykgJiYgKChlID0gZSB8fCBkKSwgKGQgPSBjKSwgKGMgPSB2b2lkIDApKSwKICAgICAgICAgICAgICAgIHIuYWpheChyLmV4dGVuZCh7IHVybDogYSwgdHlwZTogYiwgZGF0YVR5cGU6IGUsIGRhdGE6IGMsIHN1Y2Nlc3M6IGQgfSwgci5pc1BsYWluT2JqZWN0KGEpICYmIGEpKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9KSwKICAgICAgICAgIChyLl9ldmFsVXJsID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgcmV0dXJuIHIuYWpheCh7CiAgICAgICAgICAgICAgdXJsOiBhLAogICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgIGRhdGFUeXBlOiAic2NyaXB0IiwKICAgICAgICAgICAgICBjYWNoZTogITAsCiAgICAgICAgICAgICAgYXN5bmM6ICExLAogICAgICAgICAgICAgIGdsb2JhbDogITEsCiAgICAgICAgICAgICAgdGhyb3dzOiAhMCwKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KSwKICAgICAgICAgIHIuZm4uZXh0ZW5kKHsKICAgICAgICAgICAgd3JhcEFsbDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICB2YXIgYjsKICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgdGhpc1swXSAmJgogICAgICAgICAgICAgICAgICAoci5pc0Z1bmN0aW9uKGEpICYmIChhID0gYS5jYWxsKHRoaXNbMF0pKSwKICAgICAgICAgICAgICAgICAgKGIgPSByKGEsIHRoaXNbMF0ub3duZXJEb2N1bWVudCkuZXEoMCkuY2xvbmUoITApKSwKICAgICAgICAgICAgICAgICAgdGhpc1swXS5wYXJlbnROb2RlICYmIGIuaW5zZXJ0QmVmb3JlKHRoaXNbMF0pLAogICAgICAgICAgICAgICAgICBiCiAgICAgICAgICAgICAgICAgICAgLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgYSA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoYS5maXJzdEVsZW1lbnRDaGlsZCkgYSA9IGEuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5hcHBlbmQodGhpcykpLAogICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHdyYXBJbm5lcjogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICByZXR1cm4gci5pc0Z1bmN0aW9uKGEpCiAgICAgICAgICAgICAgICA/IHRoaXMuZWFjaChmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgICAgIHIodGhpcykud3JhcElubmVyKGEuY2FsbCh0aGlzLCBiKSk7CiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICA6IHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSByKHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgYyA9IGIuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICAgICBjLmxlbmd0aCA/IGMud3JhcEFsbChhKSA6IGIuYXBwZW5kKGEpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgd3JhcDogZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICB2YXIgYiA9IHIuaXNGdW5jdGlvbihhKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICAgICAgICByKHRoaXMpLndyYXBBbGwoYiA/IGEuY2FsbCh0aGlzLCBjKSA6IGEpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bndyYXA6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgIHRoaXMucGFyZW50KGEpCiAgICAgICAgICAgICAgICAgIC5ub3QoImJvZHkiKQogICAgICAgICAgICAgICAgICAuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcih0aGlzKS5yZXBsYWNlV2l0aCh0aGlzLmNoaWxkTm9kZXMpOwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHRoaXMKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgfSksCiAgICAgICAgICAoci5leHByLnBzZXVkb3MuaGlkZGVuID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgcmV0dXJuICFyLmV4cHIucHNldWRvcy52aXNpYmxlKGEpOwogICAgICAgICAgfSksCiAgICAgICAgICAoci5leHByLnBzZXVkb3MudmlzaWJsZSA9IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiAhIShhLm9mZnNldFdpZHRoIHx8IGEub2Zmc2V0SGVpZ2h0IHx8IGEuZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGgpOwogICAgICAgICAgfSksCiAgICAgICAgICAoci5hamF4U2V0dGluZ3MueGhyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBuZXcgYS5YTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICB9IGNhdGNoIChiKSB7fQogICAgICAgICAgfSk7CiAgICAgICAgdmFyIE9iID0geyAwOiAyMDAsIDEyMjM6IDIwNCB9LAogICAgICAgICAgUGIgPSByLmFqYXhTZXR0aW5ncy54aHIoKTsKICAgICAgICAoby5jb3JzID0gISFQYiAmJiAid2l0aENyZWRlbnRpYWxzIiBpbiBQYiksCiAgICAgICAgICAoby5hamF4ID0gUGIgPSAhIVBiKSwKICAgICAgICAgIHIuYWpheFRyYW5zcG9ydChmdW5jdGlvbiAoYikgewogICAgICAgICAgICB2YXIgYywgZDsKICAgICAgICAgICAgaWYgKG8uY29ycyB8fCAoUGIgJiYgIWIuY3Jvc3NEb21haW4pKQogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBzZW5kOiBmdW5jdGlvbiAoZSwgZikgewogICAgICAgICAgICAgICAgICB2YXIgZywKICAgICAgICAgICAgICAgICAgICBoID0gYi54aHIoKTsKICAgICAgICAgICAgICAgICAgaWYgKChoLm9wZW4oYi50eXBlLCBiLnVybCwgYi5hc3luYywgYi51c2VybmFtZSwgYi5wYXNzd29yZCksIGIueGhyRmllbGRzKSkgZm9yIChnIGluIGIueGhyRmllbGRzKSBoW2ddID0gYi54aHJGaWVsZHNbZ107CiAgICAgICAgICAgICAgICAgIGIubWltZVR5cGUgJiYgaC5vdmVycmlkZU1pbWVUeXBlICYmIGgub3ZlcnJpZGVNaW1lVHlwZShiLm1pbWVUeXBlKSwKICAgICAgICAgICAgICAgICAgICBiLmNyb3NzRG9tYWluIHx8IGVbIlgtUmVxdWVzdGVkLVdpdGgiXSB8fCAoZVsiWC1SZXF1ZXN0ZWQtV2l0aCJdID0gIlhNTEh0dHBSZXF1ZXN0Iik7CiAgICAgICAgICAgICAgICAgIGZvciAoZyBpbiBlKSBoLnNldFJlcXVlc3RIZWFkZXIoZywgZVtnXSk7CiAgICAgICAgICAgICAgICAgIChjID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgYyAmJgogICAgICAgICAgICAgICAgICAgICAgICAoKGMgPSBkID0gaC5vbmxvYWQgPSBoLm9uZXJyb3IgPSBoLm9uYWJvcnQgPSBoLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGwpLAogICAgICAgICAgICAgICAgICAgICAgICAiYWJvcnQiID09PSBhCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBoLmFib3J0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICA6ICJlcnJvciIgPT09IGEKICAgICAgICAgICAgICAgICAgICAgICAgICA/ICJudW1iZXIiICE9IHR5cGVvZiBoLnN0YXR1cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBmKDAsICJlcnJvciIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGYoaC5zdGF0dXMsIGguc3RhdHVzVGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgICA6IGYoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9iW2guc3RhdHVzXSB8fCBoLnN0YXR1cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaC5zdGF0dXNUZXh0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGV4dCIgIT09IChoLnJlc3BvbnNlVHlwZSB8fCAidGV4dCIpIHx8ICJzdHJpbmciICE9IHR5cGVvZiBoLnJlc3BvbnNlVGV4dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8geyBiaW5hcnk6IGgucmVzcG9uc2UgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogeyB0ZXh0OiBoLnJlc3BvbnNlVGV4dCB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoLmdldEFsbFJlc3BvbnNlSGVhZGVycygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICAoaC5vbmxvYWQgPSBjKCkpLAogICAgICAgICAgICAgICAgICAgIChkID0gaC5vbmVycm9yID0gYygiZXJyb3IiKSksCiAgICAgICAgICAgICAgICAgICAgdm9pZCAwICE9PSBoLm9uYWJvcnQKICAgICAgICAgICAgICAgICAgICAgID8gKGgub25hYm9ydCA9IGQpCiAgICAgICAgICAgICAgICAgICAgICA6IChoLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICA0ID09PSBoLnJlYWR5U3RhdGUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMgJiYgZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIChjID0gYygiYWJvcnQiKSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaC5zZW5kKChiLmhhc0NvbnRlbnQgJiYgYi5kYXRhKSB8fCBudWxsKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoaSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjKSB0aHJvdyBpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgYyAmJiBjKCk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIH07CiAgICAgICAgICB9KSwKICAgICAgICAgIHIuYWpheFByZWZpbHRlcihmdW5jdGlvbiAoYSkgewogICAgICAgICAgICBhLmNyb3NzRG9tYWluICYmIChhLmNvbnRlbnRzLnNjcmlwdCA9ICExKTsKICAgICAgICAgIH0pLAogICAgICAgICAgci5hamF4U2V0dXAoewogICAgICAgICAgICBhY2NlcHRzOiB7CiAgICAgICAgICAgICAgc2NyaXB0OiAidGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9lY21hc2NyaXB0LCBhcHBsaWNhdGlvbi94LWVjbWFzY3JpcHQiLAogICAgICAgICAgICB9LAogICAgICAgICAgICBjb250ZW50czogeyBzY3JpcHQ6IC9cYig/OmphdmF8ZWNtYSlzY3JpcHRcYi8gfSwKICAgICAgICAgICAgY29udmVydGVyczogewogICAgICAgICAgICAgICJ0ZXh0IHNjcmlwdCI6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gci5nbG9iYWxFdmFsKGEpLCBhOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KSwKICAgICAgICAgIHIuYWpheFByZWZpbHRlcigic2NyaXB0IiwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgdm9pZCAwID09PSBhLmNhY2hlICYmIChhLmNhY2hlID0gITEpLCBhLmNyb3NzRG9tYWluICYmIChhLnR5cGUgPSAiR0VUIik7CiAgICAgICAgICB9KSwKICAgICAgICAgIHIuYWpheFRyYW5zcG9ydCgic2NyaXB0IiwgZnVuY3Rpb24gKGEpIHsKICAgICAgICAgICAgaWYgKGEuY3Jvc3NEb21haW4pIHsKICAgICAgICAgICAgICB2YXIgYiwgYzsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgc2VuZDogZnVuY3Rpb24gKGUsIGYpIHsKICAgICAgICAgICAgICAgICAgKGIgPSByKCI8c2NyaXB0PiIpCiAgICAgICAgICAgICAgICAgICAgLnByb3AoeyBjaGFyc2V0OiBhLnNjcmlwdENoYXJzZXQsIHNyYzogYS51cmwgfSkKICAgICAgICAgICAgICAgICAgICAub24oCiAgICAgICAgICAgICAgICAgICAgICAibG9hZCBlcnJvciIsCiAgICAgICAgICAgICAgICAgICAgICAoYyA9IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGIucmVtb3ZlKCksIChjID0gbnVsbCksIGEgJiYgZigiZXJyb3IiID09PSBhLnR5cGUgPyA0MDQgOiAyMDAsIGEudHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICkpLAogICAgICAgICAgICAgICAgICAgIGQuaGVhZC5hcHBlbmRDaGlsZChiWzBdKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhYm9ydDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICBjICYmIGMoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgdmFyIFFiID0gW10sCiAgICAgICAgICBSYiA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CiAgICAgICAgci5hamF4U2V0dXAoewogICAgICAgICAganNvbnA6ICJjYWxsYmFjayIsCiAgICAgICAgICBqc29ucENhbGxiYWNrOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBhID0gUWIucG9wKCkgfHwgci5leHBhbmRvICsgIl8iICsgcmIrKzsKICAgICAgICAgICAgcmV0dXJuICh0aGlzW2FdID0gITApLCBhOwogICAgICAgICAgfSwKICAgICAgICB9KSwKICAgICAgICAgIHIuYWpheFByZWZpbHRlcigianNvbiBqc29ucCIsIGZ1bmN0aW9uIChiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBlLAogICAgICAgICAgICAgIGYsCiAgICAgICAgICAgICAgZywKICAgICAgICAgICAgICBoID0KICAgICAgICAgICAgICAgIGIuanNvbnAgIT09ICExICYmCiAgICAgICAgICAgICAgICAoUmIudGVzdChiLnVybCkKICAgICAgICAgICAgICAgICAgPyAidXJsIgogICAgICAgICAgICAgICAgICA6ICJzdHJpbmciID09IHR5cGVvZiBiLmRhdGEgJiYKICAgICAgICAgICAgICAgICAgICAwID09PSAoYi5jb250ZW50VHlwZSB8fCAiIikuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgJiYKICAgICAgICAgICAgICAgICAgICBSYi50ZXN0KGIuZGF0YSkgJiYKICAgICAgICAgICAgICAgICAgICAiZGF0YSIpOwogICAgICAgICAgICBpZiAoaCB8fCAianNvbnAiID09PSBiLmRhdGFUeXBlc1swXSkKICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgKGUgPSBiLmpzb25wQ2FsbGJhY2sgPSByLmlzRnVuY3Rpb24oYi5qc29ucENhbGxiYWNrKSA/IGIuanNvbnBDYWxsYmFjaygpIDogYi5qc29ucENhbGxiYWNrKSwKICAgICAgICAgICAgICAgIGggPyAoYltoXSA9IGJbaF0ucmVwbGFjZShSYiwgIiQxIiArIGUpKSA6IGIuanNvbnAgIT09ICExICYmIChiLnVybCArPSAoc2IudGVzdChiLnVybCkgPyAiJiIgOiAiPyIpICsgYi5qc29ucCArICI9IiArIGUpLAogICAgICAgICAgICAgICAgKGIuY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGcgfHwgci5lcnJvcihlICsgIiB3YXMgbm90IGNhbGxlZCIpLCBnWzBdOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAoYi5kYXRhVHlwZXNbMF0gPSAianNvbiIpLAogICAgICAgICAgICAgICAgKGYgPSBhW2VdKSwKICAgICAgICAgICAgICAgIChhW2VdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICBnID0gYXJndW1lbnRzOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBkLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZvaWQgMCA9PT0gZiA/IHIoYSkucmVtb3ZlUHJvcChlKSA6IChhW2VdID0gZiksCiAgICAgICAgICAgICAgICAgICAgYltlXSAmJiAoKGIuanNvbnBDYWxsYmFjayA9IGMuanNvbnBDYWxsYmFjayksIFFiLnB1c2goZSkpLAogICAgICAgICAgICAgICAgICAgIGcgJiYgci5pc0Z1bmN0aW9uKGYpICYmIGYoZ1swXSksCiAgICAgICAgICAgICAgICAgICAgKGcgPSBmID0gdm9pZCAwKTsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgInNjcmlwdCIKICAgICAgICAgICAgICApOwogICAgICAgICAgfSksCiAgICAgICAgICAoby5jcmVhdGVIVE1MRG9jdW1lbnQgPSAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYSA9IGQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KCIiKS5ib2R5OwogICAgICAgICAgICByZXR1cm4gKGEuaW5uZXJIVE1MID0gIjxmb3JtPjwvZm9ybT48Zm9ybT48L2Zvcm0+IiksIDIgPT09IGEuY2hpbGROb2Rlcy5sZW5ndGg7CiAgICAgICAgICB9KSgpKSwKICAgICAgICAgIChyLnBhcnNlSFRNTCA9IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgIGlmICgic3RyaW5nIiAhPSB0eXBlb2YgYSkgcmV0dXJuIFtdOwogICAgICAgICAgICAiYm9vbGVhbiIgPT0gdHlwZW9mIGIgJiYgKChjID0gYiksIChiID0gITEpKTsKICAgICAgICAgICAgdmFyIGUsIGYsIGc7CiAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgYiB8fAogICAgICAgICAgICAgICAgKG8uY3JlYXRlSFRNTERvY3VtZW50CiAgICAgICAgICAgICAgICAgID8gKChiID0gZC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoIiIpKSwgKGUgPSBiLmNyZWF0ZUVsZW1lbnQoImJhc2UiKSksIChlLmhyZWYgPSBkLmxvY2F0aW9uLmhyZWYpLCBiLmhlYWQuYXBwZW5kQ2hpbGQoZSkpCiAgICAgICAgICAgICAgICAgIDogKGIgPSBkKSksCiAgICAgICAgICAgICAgKGYgPSBCLmV4ZWMoYSkpLAogICAgICAgICAgICAgIChnID0gIWMgJiYgW10pLAogICAgICAgICAgICAgIGYgPyBbYi5jcmVhdGVFbGVtZW50KGZbMV0pXSA6ICgoZiA9IG9hKFthXSwgYiwgZykpLCBnICYmIGcubGVuZ3RoICYmIHIoZykucmVtb3ZlKCksIHIubWVyZ2UoW10sIGYuY2hpbGROb2RlcykpCiAgICAgICAgICAgICk7CiAgICAgICAgICB9KSwKICAgICAgICAgIChyLmZuLmxvYWQgPSBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICB2YXIgZCwKICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgIGYsCiAgICAgICAgICAgICAgZyA9IHRoaXMsCiAgICAgICAgICAgICAgaCA9IGEuaW5kZXhPZigiICIpOwogICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgIGggPiAtMSAmJiAoKGQgPSByLnRyaW0oYS5zbGljZShoKSkpLCAoYSA9IGEuc2xpY2UoMCwgaCkpKSwKICAgICAgICAgICAgICByLmlzRnVuY3Rpb24oYikgPyAoKGMgPSBiKSwgKGIgPSB2b2lkIDApKSA6IGIgJiYgIm9iamVjdCIgPT0gdHlwZW9mIGIgJiYgKGUgPSAiUE9TVCIpLAogICAgICAgICAgICAgIGcubGVuZ3RoID4gMCAmJgogICAgICAgICAgICAgICAgcgogICAgICAgICAgICAgICAgICAuYWpheCh7IHVybDogYSwgdHlwZTogZSB8fCAiR0VUIiwgZGF0YVR5cGU6ICJodG1sIiwgZGF0YTogYiB9KQogICAgICAgICAgICAgICAgICAuZG9uZShmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgICAgICAgIChmID0gYXJndW1lbnRzKSwgZy5odG1sKGQgPyByKCI8ZGl2PiIpLmFwcGVuZChyLnBhcnNlSFRNTChhKSkuZmluZChkKSA6IGEpOwogICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAuYWx3YXlzKAogICAgICAgICAgICAgICAgICAgIGMgJiYKICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGcuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYy5hcHBseSh0aGlzLCBmIHx8IFthLnJlc3BvbnNlVGV4dCwgYiwgYV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICB0aGlzCiAgICAgICAgICAgICk7CiAgICAgICAgICB9KSwKICAgICAgICAgIHIuZWFjaChbImFqYXhTdGFydCIsICJhamF4U3RvcCIsICJhamF4Q29tcGxldGUiLCAiYWpheEVycm9yIiwgImFqYXhTdWNjZXNzIiwgImFqYXhTZW5kIl0sIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHIuZm5bYl0gPSBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLm9uKGIsIGEpOwogICAgICAgICAgICB9OwogICAgICAgICAgfSksCiAgICAgICAgICAoci5leHByLnBzZXVkb3MuYW5pbWF0ZWQgPSBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICByZXR1cm4gci5ncmVwKHIudGltZXJzLCBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgIHJldHVybiBhID09PSBiLmVsZW07CiAgICAgICAgICAgIH0pLmxlbmd0aDsKICAgICAgICAgIH0pOwogICAgICAgIGZ1bmN0aW9uIFNiKGEpIHsKICAgICAgICAgIHJldHVybiByLmlzV2luZG93KGEpID8gYSA6IDkgPT09IGEubm9kZVR5cGUgJiYgYS5kZWZhdWx0VmlldzsKICAgICAgICB9CiAgICAgICAgKHIub2Zmc2V0ID0gewogICAgICAgICAgc2V0T2Zmc2V0OiBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICB2YXIgZCwKICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgIGYsCiAgICAgICAgICAgICAgZywKICAgICAgICAgICAgICBoLAogICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgaiwKICAgICAgICAgICAgICBrID0gci5jc3MoYSwgInBvc2l0aW9uIiksCiAgICAgICAgICAgICAgbCA9IHIoYSksCiAgICAgICAgICAgICAgbSA9IHt9OwogICAgICAgICAgICAic3RhdGljIiA9PT0gayAmJiAoYS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSIpLAogICAgICAgICAgICAgIChoID0gbC5vZmZzZXQoKSksCiAgICAgICAgICAgICAgKGYgPSByLmNzcyhhLCAidG9wIikpLAogICAgICAgICAgICAgIChpID0gci5jc3MoYSwgImxlZnQiKSksCiAgICAgICAgICAgICAgKGogPSAoImFic29sdXRlIiA9PT0gayB8fCAiZml4ZWQiID09PSBrKSAmJiAoZiArIGkpLmluZGV4T2YoImF1dG8iKSA+IC0xKSwKICAgICAgICAgICAgICBqID8gKChkID0gbC5wb3NpdGlvbigpKSwgKGcgPSBkLnRvcCksIChlID0gZC5sZWZ0KSkgOiAoKGcgPSBwYXJzZUZsb2F0KGYpIHx8IDApLCAoZSA9IHBhcnNlRmxvYXQoaSkgfHwgMCkpLAogICAgICAgICAgICAgIHIuaXNGdW5jdGlvbihiKSAmJiAoYiA9IGIuY2FsbChhLCBjLCByLmV4dGVuZCh7fSwgaCkpKSwKICAgICAgICAgICAgICBudWxsICE9IGIudG9wICYmIChtLnRvcCA9IGIudG9wIC0gaC50b3AgKyBnKSwKICAgICAgICAgICAgICBudWxsICE9IGIubGVmdCAmJiAobS5sZWZ0ID0gYi5sZWZ0IC0gaC5sZWZ0ICsgZSksCiAgICAgICAgICAgICAgInVzaW5nIiBpbiBiID8gYi51c2luZy5jYWxsKGEsIG0pIDogbC5jc3MobSk7CiAgICAgICAgICB9LAogICAgICAgIH0pLAogICAgICAgICAgci5mbi5leHRlbmQoewogICAgICAgICAgICBvZmZzZXQ6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpCiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwID09PSBhCiAgICAgICAgICAgICAgICAgID8gdGhpcwogICAgICAgICAgICAgICAgICA6IHRoaXMuZWFjaChmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgICAgICAgci5vZmZzZXQuc2V0T2Zmc2V0KHRoaXMsIGEsIGIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBiLAogICAgICAgICAgICAgICAgYywKICAgICAgICAgICAgICAgIGQsCiAgICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgICAgZiA9IHRoaXNbMF07CiAgICAgICAgICAgICAgaWYgKGYpCiAgICAgICAgICAgICAgICByZXR1cm4gZi5nZXRDbGllbnRSZWN0cygpLmxlbmd0aAogICAgICAgICAgICAgICAgICA/ICgoZCA9IGYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpLAogICAgICAgICAgICAgICAgICAgIGQud2lkdGggfHwgZC5oZWlnaHQKICAgICAgICAgICAgICAgICAgICAgID8gKChlID0gZi5vd25lckRvY3VtZW50KSwKICAgICAgICAgICAgICAgICAgICAgICAgKGMgPSBTYihlKSksCiAgICAgICAgICAgICAgICAgICAgICAgIChiID0gZS5kb2N1bWVudEVsZW1lbnQpLAogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBkLnRvcCArIGMucGFnZVlPZmZzZXQgLSBiLmNsaWVudFRvcCwKICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiBkLmxlZnQgKyBjLnBhZ2VYT2Zmc2V0IC0gYi5jbGllbnRMZWZ0LAogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgOiBkKQogICAgICAgICAgICAgICAgICA6IHsgdG9wOiAwLCBsZWZ0OiAwIH07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBvc2l0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICAgICAgICAgIHZhciBhLAogICAgICAgICAgICAgICAgICBiLAogICAgICAgICAgICAgICAgICBjID0gdGhpc1swXSwKICAgICAgICAgICAgICAgICAgZCA9IHsgdG9wOiAwLCBsZWZ0OiAwIH07CiAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAiZml4ZWQiID09PSByLmNzcyhjLCAicG9zaXRpb24iKQogICAgICAgICAgICAgICAgICAgID8gKGIgPSBjLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKQogICAgICAgICAgICAgICAgICAgIDogKChhID0gdGhpcy5vZmZzZXRQYXJlbnQoKSksCiAgICAgICAgICAgICAgICAgICAgICAoYiA9IHRoaXMub2Zmc2V0KCkpLAogICAgICAgICAgICAgICAgICAgICAgci5ub2RlTmFtZShhWzBdLCAiaHRtbCIpIHx8IChkID0gYS5vZmZzZXQoKSksCiAgICAgICAgICAgICAgICAgICAgICAoZCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBkLnRvcCArIHIuY3NzKGFbMF0sICJib3JkZXJUb3BXaWR0aCIsICEwKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogZC5sZWZ0ICsgci5jc3MoYVswXSwgImJvcmRlckxlZnRXaWR0aCIsICEwKSwKICAgICAgICAgICAgICAgICAgICAgIH0pKSwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRvcDogYi50b3AgLSBkLnRvcCAtIHIuY3NzKGMsICJtYXJnaW5Ub3AiLCAhMCksCiAgICAgICAgICAgICAgICAgICAgbGVmdDogYi5sZWZ0IC0gZC5sZWZ0IC0gci5jc3MoYywgIm1hcmdpbkxlZnQiLCAhMCksCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBvZmZzZXRQYXJlbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGEgPSB0aGlzLm9mZnNldFBhcmVudDsKICAgICAgICAgICAgICAgIHdoaWxlIChhICYmICJzdGF0aWMiID09PSByLmNzcyhhLCAicG9zaXRpb24iKSkgYSA9IGEub2Zmc2V0UGFyZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIGEgfHwgcGE7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KSwKICAgICAgICAgIHIuZWFjaCh7IHNjcm9sbExlZnQ6ICJwYWdlWE9mZnNldCIsIHNjcm9sbFRvcDogInBhZ2VZT2Zmc2V0IiB9LCBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICB2YXIgYyA9ICJwYWdlWU9mZnNldCIgPT09IGI7CiAgICAgICAgICAgIHIuZm5bYV0gPSBmdW5jdGlvbiAoZCkgewogICAgICAgICAgICAgIHJldHVybiBTKAogICAgICAgICAgICAgICAgdGhpcywKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChhLCBkLCBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmID0gU2IoYSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDAgPT09IGUgPyAoZiA/IGZbYl0gOiBhW2RdKSA6IHZvaWQgKGYgPyBmLnNjcm9sbFRvKGMgPyBmLnBhZ2VYT2Zmc2V0IDogZSwgYyA/IGUgOiBmLnBhZ2VZT2Zmc2V0KSA6IChhW2RdID0gZSkpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGEsCiAgICAgICAgICAgICAgICBkLAogICAgICAgICAgICAgICAgYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9KSwKICAgICAgICAgIHIuZWFjaChbInRvcCIsICJsZWZ0Il0sIGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIHIuY3NzSG9va3NbYl0gPSBOYShvLnBpeGVsUG9zaXRpb24sIGZ1bmN0aW9uIChhLCBjKSB7CiAgICAgICAgICAgICAgaWYgKGMpIHJldHVybiAoYyA9IE1hKGEsIGIpKSwgS2EudGVzdChjKSA/IHIoYSkucG9zaXRpb24oKVtiXSArICJweCIgOiBjOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pLAogICAgICAgICAgci5lYWNoKHsgSGVpZ2h0OiAiaGVpZ2h0IiwgV2lkdGg6ICJ3aWR0aCIgfSwgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgci5lYWNoKHsgcGFkZGluZzogImlubmVyIiArIGEsIGNvbnRlbnQ6IGIsICIiOiAib3V0ZXIiICsgYSB9LCBmdW5jdGlvbiAoYywgZCkgewogICAgICAgICAgICAgIHIuZm5bZF0gPSBmdW5jdGlvbiAoZSwgZikgewogICAgICAgICAgICAgICAgdmFyIGcgPSBhcmd1bWVudHMubGVuZ3RoICYmIChjIHx8ICJib29sZWFuIiAhPSB0eXBlb2YgZSksCiAgICAgICAgICAgICAgICAgIGggPSBjIHx8IChlID09PSAhMCB8fCBmID09PSAhMCA/ICJtYXJnaW4iIDogImJvcmRlciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIFMoCiAgICAgICAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChiLCBjLCBlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGY7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHIuaXNXaW5kb3coYikKICAgICAgICAgICAgICAgICAgICAgID8gMCA9PT0gZC5pbmRleE9mKCJvdXRlciIpCiAgICAgICAgICAgICAgICAgICAgICAgID8gYlsiaW5uZXIiICsgYV0KICAgICAgICAgICAgICAgICAgICAgICAgOiBiLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsiY2xpZW50IiArIGFdCiAgICAgICAgICAgICAgICAgICAgICA6IDkgPT09IGIubm9kZVR5cGUKICAgICAgICAgICAgICAgICAgICAgID8gKChmID0gYi5kb2N1bWVudEVsZW1lbnQpLAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLm1heChiLmJvZHlbInNjcm9sbCIgKyBhXSwgZlsic2Nyb2xsIiArIGFdLCBiLmJvZHlbIm9mZnNldCIgKyBhXSwgZlsib2Zmc2V0IiArIGFdLCBmWyJjbGllbnQiICsgYV0pKQogICAgICAgICAgICAgICAgICAgICAgOiB2b2lkIDAgPT09IGUKICAgICAgICAgICAgICAgICAgICAgID8gci5jc3MoYiwgYywgaCkKICAgICAgICAgICAgICAgICAgICAgIDogci5zdHlsZShiLCBjLCBlLCBoKTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgYiwKICAgICAgICAgICAgICAgICAgZyA/IGUgOiB2b2lkIDAsCiAgICAgICAgICAgICAgICAgIGcKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KSwKICAgICAgICAgIHIuZm4uZXh0ZW5kKHsKICAgICAgICAgICAgYmluZDogZnVuY3Rpb24gKGEsIGIsIGMpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vbihhLCBudWxsLCBiLCBjKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5iaW5kOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLm9mZihhLCBudWxsLCBiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVsZWdhdGU6IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub24oYiwgYSwgYywgZCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuZGVsZWdhdGU6IGZ1bmN0aW9uIChhLCBiLCBjKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDEgPT09IGFyZ3VtZW50cy5sZW5ndGggPyB0aGlzLm9mZihhLCAiKioiKSA6IHRoaXMub2ZmKGIsIGEgfHwgIioqIiwgYyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICB9KSwKICAgICAgICAgIChyLnBhcnNlSlNPTiA9IEpTT04ucGFyc2UpLAogICAgICAgICAgImZ1bmN0aW9uIiA9PSB0eXBlb2YgZGVmaW5lICYmCiAgICAgICAgICAgIGRlZmluZS5hbWQgJiYKICAgICAgICAgICAgZGVmaW5lKCJqcXVlcnkiLCBbXSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICB9KTsKICAgICAgICB2YXIgVGIgPSBhLmpRdWVyeSwKICAgICAgICAgIFViID0gYS4kOwogICAgICAgIHJldHVybiAoCiAgICAgICAgICAoci5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEuJCA9PT0gciAmJiAoYS4kID0gVWIpLCBiICYmIGEualF1ZXJ5ID09PSByICYmIChhLmpRdWVyeSA9IFRiKSwgcjsKICAgICAgICAgIH0pLAogICAgICAgICAgYiB8fCAoYS5qUXVlcnkgPSBhLiQgPSByKSwKICAgICAgICAgIHIKICAgICAgICApOwogICAgICB9KTsKCiAgICAgIC8qCgogICAgICAgICBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCiAgICAgICAgIENvcHlyaWdodCAoYykgMjAwNy0yMDEzIEVpbmFyIExpZWxtYW5pcyBhbmQgY29udHJpYnV0b3JzLgoKICAgICAgICAgUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24KICAgICAgICAgb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMKICAgICAgICAgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwKICAgICAgICAgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwKICAgICAgICAgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwKICAgICAgICAgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywKICAgICAgICAgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgogICAgICAgICBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQogICAgICAgICBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KCiAgICAgICAgIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELAogICAgICAgICBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAgICAgICAgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKICAgICAgICAgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUwogICAgICAgICBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4KICAgICAgICAgQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4KICAgICAgICAgQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRQogICAgICAgICBTT0ZUV0FSRS4KCiAgICAgICAgIEpTIEJlYXV0aWZpZXIKICAgICAgICAgLS0tLS0tLS0tLS0tLS0tCgogICAgICAgICAqLwoKICAgICAgZnVuY3Rpb24gdHJpbShzKSB7CiAgICAgICAgcmV0dXJuIHMucmVwbGFjZSgvXlxzK3xccyskL2csICIiKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gbHRyaW0ocykgewogICAgICAgIHJldHVybiBzLnJlcGxhY2UoL15ccysvZywgIiIpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzdHlsZV9odG1sKGh0bWxfc291cmNlLCBvcHRpb25zKSB7CiAgICAgICAgLy9XcmFwcGVyIGZ1bmN0aW9uIHRvIGludm9rZSBhbGwgdGhlIG5lY2Vzc2FyeSBjb25zdHJ1Y3RvcnMgYW5kIGRlYWwgd2l0aCB0aGUgb3V0cHV0LgoKICAgICAgICB2YXIgbXVsdGlfcGFyc2VyLAogICAgICAgICAgaW5kZW50X2lubmVyX2h0bWwsCiAgICAgICAgICBpbmRlbnRfc2l6ZSwKICAgICAgICAgIGluZGVudF9jaGFyYWN0ZXIsCiAgICAgICAgICB3cmFwX2xpbmVfbGVuZ3RoLAogICAgICAgICAgYnJhY2Vfc3R5bGUsCiAgICAgICAgICB1bmZvcm1hdHRlZCwKICAgICAgICAgIHByZXNlcnZlX25ld2xpbmVzLAogICAgICAgICAgbWF4X3ByZXNlcnZlX25ld2xpbmVzOwoKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgICAgLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgdG8gMS4zLjQKICAgICAgICBpZiAoCiAgICAgICAgICAob3B0aW9ucy53cmFwX2xpbmVfbGVuZ3RoID09PSB1bmRlZmluZWQgfHwgcGFyc2VJbnQob3B0aW9ucy53cmFwX2xpbmVfbGVuZ3RoLCAxMCkgPT09IDApICYmCiAgICAgICAgICAob3B0aW9ucy5tYXhfY2hhciA9PT0gdW5kZWZpbmVkIHx8IHBhcnNlSW50KG9wdGlvbnMubWF4X2NoYXIsIDEwKSA9PT0gMCkKICAgICAgICApIHsKICAgICAgICAgIG9wdGlvbnMud3JhcF9saW5lX2xlbmd0aCA9IG9wdGlvbnMubWF4X2NoYXI7CiAgICAgICAgfQoKICAgICAgICBpbmRlbnRfaW5uZXJfaHRtbCA9IG9wdGlvbnMuaW5kZW50X2lubmVyX2h0bWwgfHwgZmFsc2U7CiAgICAgICAgaW5kZW50X3NpemUgPSBwYXJzZUludChvcHRpb25zLmluZGVudF9zaXplIHx8IDQsIDEwKTsKICAgICAgICBpbmRlbnRfY2hhcmFjdGVyID0gb3B0aW9ucy5pbmRlbnRfY2hhciB8fCAiICI7CiAgICAgICAgYnJhY2Vfc3R5bGUgPSBvcHRpb25zLmJyYWNlX3N0eWxlIHx8ICJjb2xsYXBzZSI7CiAgICAgICAgd3JhcF9saW5lX2xlbmd0aCA9IHBhcnNlSW50KG9wdGlvbnMud3JhcF9saW5lX2xlbmd0aCwgMTApID09PSAwID8gMzI3ODYgOiBwYXJzZUludChvcHRpb25zLndyYXBfbGluZV9sZW5ndGggfHwgMjUwLCAxMCk7CiAgICAgICAgdW5mb3JtYXR0ZWQgPSBvcHRpb25zLnVuZm9ybWF0dGVkIHx8IFsKICAgICAgICAgICJhIiwKICAgICAgICAgICJzcGFuIiwKICAgICAgICAgICJiZG8iLAogICAgICAgICAgImVtIiwKICAgICAgICAgICJzdHJvbmciLAogICAgICAgICAgImRmbiIsCiAgICAgICAgICAiY29kZSIsCiAgICAgICAgICAic2FtcCIsCiAgICAgICAgICAia2JkIiwKICAgICAgICAgICJ2YXIiLAogICAgICAgICAgImNpdGUiLAogICAgICAgICAgImFiYnIiLAogICAgICAgICAgImFjcm9ueW0iLAogICAgICAgICAgInEiLAogICAgICAgICAgInN1YiIsCiAgICAgICAgICAic3VwIiwKICAgICAgICAgICJ0dCIsCiAgICAgICAgICAiaSIsCiAgICAgICAgICAiYiIsCiAgICAgICAgICAiYmlnIiwKICAgICAgICAgICJzbWFsbCIsCiAgICAgICAgICAidSIsCiAgICAgICAgICAicyIsCiAgICAgICAgICAic3RyaWtlIiwKICAgICAgICAgICJmb250IiwKICAgICAgICAgICJpbnMiLAogICAgICAgICAgImRlbCIsCiAgICAgICAgICAicHJlIiwKICAgICAgICAgICJhZGRyZXNzIiwKICAgICAgICAgICJkdCIsCiAgICAgICAgICAiaDEiLAogICAgICAgICAgImgyIiwKICAgICAgICAgICJoMyIsCiAgICAgICAgICAiaDQiLAogICAgICAgICAgImg1IiwKICAgICAgICAgICJoNiIsCiAgICAgICAgXTsKICAgICAgICBwcmVzZXJ2ZV9uZXdsaW5lcyA9IG9wdGlvbnMucHJlc2VydmVfbmV3bGluZXMgfHwgdHJ1ZTsKICAgICAgICBtYXhfcHJlc2VydmVfbmV3bGluZXMgPSBwcmVzZXJ2ZV9uZXdsaW5lcyA/IHBhcnNlSW50KG9wdGlvbnMubWF4X3ByZXNlcnZlX25ld2xpbmVzIHx8IDMyNzg2LCAxMCkgOiAwOwogICAgICAgIGluZGVudF9oYW5kbGViYXJzID0gb3B0aW9ucy5pbmRlbnRfaGFuZGxlYmFycyB8fCBmYWxzZTsKCiAgICAgICAgZnVuY3Rpb24gUGFyc2VyKCkgewogICAgICAgICAgdGhpcy5wb3MgPSAwOyAvL1BhcnNlciBwb3NpdGlvbgogICAgICAgICAgdGhpcy50b2tlbiA9ICIiOwogICAgICAgICAgdGhpcy5jdXJyZW50X21vZGUgPSAiQ09OVEVOVCI7IC8vcmVmbGVjdHMgdGhlIGN1cnJlbnQgUGFyc2VyIG1vZGU6IFRBRy9DT05URU5UCiAgICAgICAgICB0aGlzLnRhZ3MgPSB7CiAgICAgICAgICAgIC8vQW4gb2JqZWN0IHRvIGhvbGQgdGFncywgdGhlaXIgcG9zaXRpb24sIGFuZCB0aGVpciBwYXJlbnQtdGFncywgaW5pdGlhdGVkIHdpdGggZGVmYXVsdCB2YWx1ZXMKICAgICAgICAgICAgcGFyZW50OiAicGFyZW50MSIsCiAgICAgICAgICAgIHBhcmVudGNvdW50OiAxLAogICAgICAgICAgICBwYXJlbnQxOiAiIiwKICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLnRhZ190eXBlID0gIiI7CiAgICAgICAgICB0aGlzLnRva2VuX3RleHQgPSB0aGlzLmxhc3RfdG9rZW4gPSB0aGlzLmxhc3RfdGV4dCA9IHRoaXMudG9rZW5fdHlwZSA9ICIiOwogICAgICAgICAgdGhpcy5uZXdsaW5lcyA9IDA7CiAgICAgICAgICB0aGlzLmluZGVudF9jb250ZW50ID0gaW5kZW50X2lubmVyX2h0bWw7CgogICAgICAgICAgdGhpcy5VdGlscyA9IHsKICAgICAgICAgICAgLy9VaWxpdGllcyBtYWRlIGF2YWlsYWJsZSB0byB0aGUgdmFyaW91cyBmdW5jdGlvbnMKICAgICAgICAgICAgd2hpdGVzcGFjZTogIlxuXHJcdCAiLnNwbGl0KCIiKSwKICAgICAgICAgICAgc2luZ2xlX3Rva2VuOiAiYnIsaW5wdXQsbGluayxtZXRhLCFkb2N0eXBlLGJhc2Vmb250LGJhc2UsYXJlYSxocix3YnIscGFyYW0saW1nLGlzaW5kZXgsP3htbCxlbWJlZCw/cGhwLD8sPz0iLnNwbGl0KCIsIiksIC8vYWxsIHRoZSBzaW5nbGUgdGFncyBmb3IgSFRNTAogICAgICAgICAgICBleHRyYV9saW5lcnM6ICJoZWFkLGJvZHksL2h0bWwiLnNwbGl0KCIsIiksIC8vZm9yIHRhZ3MgdGhhdCBuZWVkIGEgbGluZSBvZiB3aGl0ZXNwYWNlIGJlZm9yZSB0aGVtCiAgICAgICAgICAgIGluX2FycmF5OiBmdW5jdGlvbiAod2hhdCwgYXJyKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh3aGF0ID09PSBhcnJbaV0pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSwKICAgICAgICAgIH07CgogICAgICAgICAgdGhpcy50cmF2ZXJzZV93aGl0ZXNwYWNlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgaW5wdXRfY2hhciA9ICIiOwoKICAgICAgICAgICAgaW5wdXRfY2hhciA9IHRoaXMuaW5wdXQuY2hhckF0KHRoaXMucG9zKTsKICAgICAgICAgICAgaWYgKHRoaXMuVXRpbHMuaW5fYXJyYXkoaW5wdXRfY2hhciwgdGhpcy5VdGlscy53aGl0ZXNwYWNlKSkgewogICAgICAgICAgICAgIHRoaXMubmV3bGluZXMgPSAwOwogICAgICAgICAgICAgIHdoaWxlICh0aGlzLlV0aWxzLmluX2FycmF5KGlucHV0X2NoYXIsIHRoaXMuVXRpbHMud2hpdGVzcGFjZSkpIHsKICAgICAgICAgICAgICAgIGlmIChwcmVzZXJ2ZV9uZXdsaW5lcyAmJiBpbnB1dF9jaGFyID09PSAiXG4iICYmIHRoaXMubmV3bGluZXMgPD0gbWF4X3ByZXNlcnZlX25ld2xpbmVzKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMubmV3bGluZXMgKz0gMTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLnBvcysrOwogICAgICAgICAgICAgICAgaW5wdXRfY2hhciA9IHRoaXMuaW5wdXQuY2hhckF0KHRoaXMucG9zKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfTsKCiAgICAgICAgICB0aGlzLmdldF9jb250ZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvL2Z1bmN0aW9uIHRvIGNhcHR1cmUgcmVndWxhciBjb250ZW50IGJldHdlZW4gdGFncwoKICAgICAgICAgICAgdmFyIGlucHV0X2NoYXIgPSAiIiwKICAgICAgICAgICAgICBjb250ZW50ID0gW10sCiAgICAgICAgICAgICAgc3BhY2UgPSBmYWxzZTsgLy9pZiBhIHNwYWNlIGlzIG5lZWRlZAoKICAgICAgICAgICAgd2hpbGUgKHRoaXMuaW5wdXQuY2hhckF0KHRoaXMucG9zKSAhPT0gIjwiKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMucG9zID49IHRoaXMuaW5wdXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY29udGVudC5sZW5ndGggPyBjb250ZW50LmpvaW4oIiIpIDogWyIiLCAiVEtfRU9GIl07CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAodGhpcy50cmF2ZXJzZV93aGl0ZXNwYWNlKCkpIHsKICAgICAgICAgICAgICAgIGlmIChjb250ZW50Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBzcGFjZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb250aW51ZTsgLy9kb24ndCB3YW50IHRvIGluc2VydCB1bm5lY2Vzc2FyeSBzcGFjZQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKGluZGVudF9oYW5kbGViYXJzKSB7CiAgICAgICAgICAgICAgICAvLyBIYW5kbGViYXJzIHBhcnNpbmcgaXMgY29tcGxpY2F0ZWQuCiAgICAgICAgICAgICAgICAvLyB7eyNmb299fSBhbmQge3svZm9vfX0gYXJlIGZvcm1hdHRlZCB0YWdzLgogICAgICAgICAgICAgICAgLy8ge3tzb21ldGhpbmd9fSBzaG91bGQgZ2V0IHRyZWF0ZWQgYXMgY29udGVudCwgZXhjZXB0OgogICAgICAgICAgICAgICAgLy8ge3tlbHNlfX0gc3BlY2lmaWNhbGx5IGJlaGF2ZXMgbGlrZSB7eyNpZn19IGFuZCB7ey9pZn19CiAgICAgICAgICAgICAgICB2YXIgcGVlazMgPSB0aGlzLmlucHV0LnN1YnN0cih0aGlzLnBvcywgMyk7CiAgICAgICAgICAgICAgICBpZiAocGVlazMgPT09ICJ7eyMiIHx8IHBlZWszID09PSAie3svIikgewogICAgICAgICAgICAgICAgICAvLyBUaGVzZSBhcmUgdGFncyBhbmQgbm90IGNvbnRlbnQuCiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlucHV0LnN1YnN0cih0aGlzLnBvcywgMikgPT09ICJ7eyIpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0X3RhZyh0cnVlKSA9PT0gInt7ZWxzZX19IikgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpbnB1dF9jaGFyID0gdGhpcy5pbnB1dC5jaGFyQXQodGhpcy5wb3MpOwogICAgICAgICAgICAgIHRoaXMucG9zKys7CgogICAgICAgICAgICAgIGlmIChzcGFjZSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMubGluZV9jaGFyX2NvdW50ID49IHRoaXMud3JhcF9saW5lX2xlbmd0aCkgewogICAgICAgICAgICAgICAgICAvL2luc2VydCBhIGxpbmUgd2hlbiB0aGUgd3JhcF9saW5lX2xlbmd0aCBpcyByZWFjaGVkCiAgICAgICAgICAgICAgICAgIHRoaXMucHJpbnRfbmV3bGluZShmYWxzZSwgY29udGVudCk7CiAgICAgICAgICAgICAgICAgIHRoaXMucHJpbnRfaW5kZW50YXRpb24oY29udGVudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLmxpbmVfY2hhcl9jb3VudCsrOwogICAgICAgICAgICAgICAgICBjb250ZW50LnB1c2goIiAiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNwYWNlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMubGluZV9jaGFyX2NvdW50Kys7CiAgICAgICAgICAgICAgY29udGVudC5wdXNoKGlucHV0X2NoYXIpOyAvL2xldHRlciBhdC1hLXRpbWUgKG9yIHN0cmluZykgaW5zZXJ0ZWQgdG8gYW4gYXJyYXkKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGVudC5sZW5ndGggPyBjb250ZW50LmpvaW4oIiIpIDogIiI7CiAgICAgICAgICB9OwoKICAgICAgICAgIHRoaXMuZ2V0X2NvbnRlbnRzX3RvID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgLy9nZXQgdGhlIGZ1bGwgY29udGVudCBvZiBhIHNjcmlwdCBvciBzdHlsZSB0byBwYXNzIHRvIGpzX2JlYXV0aWZ5CiAgICAgICAgICAgIGlmICh0aGlzLnBvcyA9PT0gdGhpcy5pbnB1dC5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXR1cm4gWyIiLCAiVEtfRU9GIl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlucHV0X2NoYXIgPSAiIjsKICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSAiIjsKICAgICAgICAgICAgdmFyIHJlZ19tYXRjaCA9IG5ldyBSZWdFeHAoIjwvIiArIG5hbWUgKyAiXFxzKj4iLCAiaWdtIik7CiAgICAgICAgICAgIHJlZ19tYXRjaC5sYXN0SW5kZXggPSB0aGlzLnBvczsKICAgICAgICAgICAgdmFyIHJlZ19hcnJheSA9IHJlZ19tYXRjaC5leGVjKHRoaXMuaW5wdXQpOwogICAgICAgICAgICB2YXIgZW5kX3NjcmlwdCA9IHJlZ19hcnJheSA/IHJlZ19hcnJheS5pbmRleCA6IHRoaXMuaW5wdXQubGVuZ3RoOyAvL2Fic29sdXRlIGVuZCBvZiBzY3JpcHQKICAgICAgICAgICAgaWYgKHRoaXMucG9zIDwgZW5kX3NjcmlwdCkgewogICAgICAgICAgICAgIC8vZ2V0IGV2ZXJ5dGhpbmcgaW4gYmV0d2VlbiB0aGUgc2NyaXB0IHRhZ3MKICAgICAgICAgICAgICBjb250ZW50ID0gdGhpcy5pbnB1dC5zdWJzdHJpbmcodGhpcy5wb3MsIGVuZF9zY3JpcHQpOwogICAgICAgICAgICAgIHRoaXMucG9zID0gZW5kX3NjcmlwdDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGVudDsKICAgICAgICAgIH07CgogICAgICAgICAgdGhpcy5yZWNvcmRfdGFnID0gZnVuY3Rpb24gKHRhZykgewogICAgICAgICAgICAvL2Z1bmN0aW9uIHRvIHJlY29yZCBhIHRhZyBhbmQgaXRzIHBhcmVudCBpbiB0aGlzLnRhZ3MgT2JqZWN0CiAgICAgICAgICAgIGlmICh0aGlzLnRhZ3NbdGFnICsgImNvdW50Il0pIHsKICAgICAgICAgICAgICAvL2NoZWNrIGZvciB0aGUgZXhpc3RlbmNlIG9mIHRoaXMgdGFnIHR5cGUKICAgICAgICAgICAgICB0aGlzLnRhZ3NbdGFnICsgImNvdW50Il0rKzsKICAgICAgICAgICAgICB0aGlzLnRhZ3NbdGFnICsgdGhpcy50YWdzW3RhZyArICJjb3VudCJdXSA9IHRoaXMuaW5kZW50X2xldmVsOyAvL2FuZCByZWNvcmQgdGhlIHByZXNlbnQgaW5kZW50IGxldmVsCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy9vdGhlcndpc2UgaW5pdGlhbGl6ZSB0aGlzIHRhZyB0eXBlCiAgICAgICAgICAgICAgdGhpcy50YWdzW3RhZyArICJjb3VudCJdID0gMTsKICAgICAgICAgICAgICB0aGlzLnRhZ3NbdGFnICsgdGhpcy50YWdzW3RhZyArICJjb3VudCJdXSA9IHRoaXMuaW5kZW50X2xldmVsOyAvL2FuZCByZWNvcmQgdGhlIHByZXNlbnQgaW5kZW50IGxldmVsCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy50YWdzW3RhZyArIHRoaXMudGFnc1t0YWcgKyAiY291bnQiXSArICJwYXJlbnQiXSA9IHRoaXMudGFncy5wYXJlbnQ7IC8vc2V0IHRoZSBwYXJlbnQgKGkuZS4gaW4gdGhlIGNhc2Ugb2YgYSBkaXYgdGhpcy50YWdzLmRpdjFwYXJlbnQpCiAgICAgICAgICAgIHRoaXMudGFncy5wYXJlbnQgPSB0YWcgKyB0aGlzLnRhZ3NbdGFnICsgImNvdW50Il07IC8vYW5kIG1ha2UgdGhpcyB0aGUgY3VycmVudCBwYXJlbnQgKGkuZS4gaW4gdGhlIGNhc2Ugb2YgYSBkaXYgJ2RpdjEnKQogICAgICAgICAgfTsKCiAgICAgICAgICB0aGlzLnJldHJpZXZlX3RhZyA9IGZ1bmN0aW9uICh0YWcpIHsKICAgICAgICAgICAgLy9mdW5jdGlvbiB0byByZXRyaWV2ZSB0aGUgb3BlbmluZyB0YWcgdG8gdGhlIGNvcnJlc3BvbmRpbmcgY2xvc2VyCiAgICAgICAgICAgIGlmICh0aGlzLnRhZ3NbdGFnICsgImNvdW50Il0pIHsKICAgICAgICAgICAgICAvL2lmIHRoZSBvcGVuZW5lciBpcyBub3QgaW4gdGhlIE9iamVjdCB3ZSBpZ25vcmUgaXQKICAgICAgICAgICAgICB2YXIgdGVtcF9wYXJlbnQgPSB0aGlzLnRhZ3MucGFyZW50OyAvL2NoZWNrIHRvIHNlZSBpZiBpdCdzIGEgY2xvc2FibGUgdGFnLgogICAgICAgICAgICAgIHdoaWxlICh0ZW1wX3BhcmVudCkgewogICAgICAgICAgICAgICAgLy90aWxsIHdlIHJlYWNoICcnICh0aGUgaW5pdGlhbCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAodGFnICsgdGhpcy50YWdzW3RhZyArICJjb3VudCJdID09PSB0ZW1wX3BhcmVudCkgewogICAgICAgICAgICAgICAgICAvL2lmIHRoaXMgaXMgaXQgdXNlIGl0CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGVtcF9wYXJlbnQgPSB0aGlzLnRhZ3NbdGVtcF9wYXJlbnQgKyAicGFyZW50Il07IC8vb3RoZXJ3aXNlIGtlZXAgb24gY2xpbWJpbmcgdXAgdGhlIERPTSBUcmVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0ZW1wX3BhcmVudCkgewogICAgICAgICAgICAgICAgLy9pZiB3ZSBjYXVnaHQgc29tZXRoaW5nCiAgICAgICAgICAgICAgICB0aGlzLmluZGVudF9sZXZlbCA9IHRoaXMudGFnc1t0YWcgKyB0aGlzLnRhZ3NbdGFnICsgImNvdW50Il1dOyAvL3NldCB0aGUgaW5kZW50X2xldmVsIGFjY29yZGluZ2x5CiAgICAgICAgICAgICAgICB0aGlzLnRhZ3MucGFyZW50ID0gdGhpcy50YWdzW3RlbXBfcGFyZW50ICsgInBhcmVudCJdOyAvL2FuZCBzZXQgdGhlIGN1cnJlbnQgcGFyZW50CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRhZ3NbdGFnICsgdGhpcy50YWdzW3RhZyArICJjb3VudCJdICsgInBhcmVudCJdOyAvL2RlbGV0ZSB0aGUgY2xvc2VkIHRhZ3MgcGFyZW50IHJlZmVyZW5jZS4uLgogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRhZ3NbdGFnICsgdGhpcy50YWdzW3RhZyArICJjb3VudCJdXTsgLy8uLi5hbmQgdGhlIHRhZyBpdHNlbGYKICAgICAgICAgICAgICBpZiAodGhpcy50YWdzW3RhZyArICJjb3VudCJdID09PSAxKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy50YWdzW3RhZyArICJjb3VudCJdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhZ3NbdGFnICsgImNvdW50Il0tLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgdGhpcy5pbmRlbnRfdG9fdGFnID0gZnVuY3Rpb24gKHRhZykgewogICAgICAgICAgICAvLyBNYXRjaCB0aGUgaW5kZW50YXRpb24gbGV2ZWwgdG8gdGhlIGxhc3QgdXNlIG9mIHRoaXMgdGFnLCBidXQgZG9uJ3QgcmVtb3ZlIGl0LgogICAgICAgICAgICBpZiAoIXRoaXMudGFnc1t0YWcgKyAiY291bnQiXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGVtcF9wYXJlbnQgPSB0aGlzLnRhZ3MucGFyZW50OwogICAgICAgICAgICB3aGlsZSAodGVtcF9wYXJlbnQpIHsKICAgICAgICAgICAgICBpZiAodGFnICsgdGhpcy50YWdzW3RhZyArICJjb3VudCJdID09PSB0ZW1wX3BhcmVudCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRlbXBfcGFyZW50ID0gdGhpcy50YWdzW3RlbXBfcGFyZW50ICsgInBhcmVudCJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0ZW1wX3BhcmVudCkgewogICAgICAgICAgICAgIHRoaXMuaW5kZW50X2xldmVsID0gdGhpcy50YWdzW3RhZyArIHRoaXMudGFnc1t0YWcgKyAiY291bnQiXV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgdGhpcy5nZXRfdGFnID0gZnVuY3Rpb24gKHBlZWspIHsKICAgICAgICAgICAgLy9mdW5jdGlvbiB0byBnZXQgYSBmdWxsIHRhZyBhbmQgcGFyc2UgaXRzIHR5cGUKICAgICAgICAgICAgdmFyIGlucHV0X2NoYXIgPSAiIiwKICAgICAgICAgICAgICBjb250ZW50ID0gW10sCiAgICAgICAgICAgICAgY29tbWVudCA9ICIiLAogICAgICAgICAgICAgIHNwYWNlID0gZmFsc2UsCiAgICAgICAgICAgICAgdGFnX3N0YXJ0LAogICAgICAgICAgICAgIHRhZ19lbmQsCiAgICAgICAgICAgICAgdGFnX3N0YXJ0X2NoYXIsCiAgICAgICAgICAgICAgb3JpZ19wb3MgPSB0aGlzLnBvcywKICAgICAgICAgICAgICBvcmlnX2xpbmVfY2hhcl9jb3VudCA9IHRoaXMubGluZV9jaGFyX2NvdW50OwoKICAgICAgICAgICAgcGVlayA9IHBlZWsgIT09IHVuZGVmaW5lZCA/IHBlZWsgOiBmYWxzZTsKCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAodGhpcy5wb3MgPj0gdGhpcy5pbnB1dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmIChwZWVrKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMucG9zID0gb3JpZ19wb3M7CiAgICAgICAgICAgICAgICAgIHRoaXMubGluZV9jaGFyX2NvdW50ID0gb3JpZ19saW5lX2NoYXJfY291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29udGVudC5sZW5ndGggPyBjb250ZW50LmpvaW4oIiIpIDogWyIiLCAiVEtfRU9GIl07CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpbnB1dF9jaGFyID0gdGhpcy5pbnB1dC5jaGFyQXQodGhpcy5wb3MpOwogICAgICAgICAgICAgIHRoaXMucG9zKys7CgogICAgICAgICAgICAgIGlmICh0aGlzLlV0aWxzLmluX2FycmF5KGlucHV0X2NoYXIsIHRoaXMuVXRpbHMud2hpdGVzcGFjZSkpIHsKICAgICAgICAgICAgICAgIC8vZG9uJ3Qgd2FudCB0byBpbnNlcnQgdW5uZWNlc3Nhcnkgc3BhY2UKICAgICAgICAgICAgICAgIHNwYWNlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKGlucHV0X2NoYXIgPT09ICInIiB8fCBpbnB1dF9jaGFyID09PSAnIicpIHsKICAgICAgICAgICAgICAgIGlucHV0X2NoYXIgKz0gdGhpcy5nZXRfdW5mb3JtYXR0ZWQoaW5wdXRfY2hhcik7CiAgICAgICAgICAgICAgICBzcGFjZSA9IHRydWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoaW5wdXRfY2hhciA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAvL25vIHNwYWNlIGJlZm9yZSA9CiAgICAgICAgICAgICAgICBzcGFjZSA9IGZhbHNlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKGNvbnRlbnQubGVuZ3RoICYmIGNvbnRlbnRbY29udGVudC5sZW5ndGggLSAxXSAhPT0gIj0iICYmIGlucHV0X2NoYXIgIT09ICI+IiAmJiBzcGFjZSkgewogICAgICAgICAgICAgICAgLy9ubyBzcGFjZSBhZnRlciA9IG9yIGJlZm9yZSA+CiAgICAgICAgICAgICAgICBpZiAodGhpcy5saW5lX2NoYXJfY291bnQgPj0gdGhpcy53cmFwX2xpbmVfbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMucHJpbnRfbmV3bGluZShmYWxzZSwgY29udGVudCk7CiAgICAgICAgICAgICAgICAgIHRoaXMucHJpbnRfaW5kZW50YXRpb24oY29udGVudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb250ZW50LnB1c2goIiAiKTsKICAgICAgICAgICAgICAgICAgdGhpcy5saW5lX2NoYXJfY291bnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNwYWNlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoaW5kZW50X2hhbmRsZWJhcnMgJiYgdGFnX3N0YXJ0X2NoYXIgPT09ICI8IikgewogICAgICAgICAgICAgICAgLy8gV2hlbiBpbnNpZGUgYW4gYW5nbGUtYnJhY2tldCB0YWcsIHB1dCBzcGFjZXMgYXJvdW5kCiAgICAgICAgICAgICAgICAvLyBoYW5kbGViYXJzIG5vdCBpbnNpZGUgb2Ygc3RyaW5ncy4KICAgICAgICAgICAgICAgIGlmIChpbnB1dF9jaGFyICsgdGhpcy5pbnB1dC5jaGFyQXQodGhpcy5wb3MpID09PSAie3siKSB7CiAgICAgICAgICAgICAgICAgIGlucHV0X2NoYXIgKz0gdGhpcy5nZXRfdW5mb3JtYXR0ZWQoIn19Iik7CiAgICAgICAgICAgICAgICAgIGlmIChjb250ZW50Lmxlbmd0aCAmJiBjb250ZW50W2NvbnRlbnQubGVuZ3RoIC0gMV0gIT09ICIgIiAmJiBjb250ZW50W2NvbnRlbnQubGVuZ3RoIC0gMV0gIT09ICI8IikgewogICAgICAgICAgICAgICAgICAgIGlucHV0X2NoYXIgPSAiICIgKyBpbnB1dF9jaGFyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNwYWNlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChpbnB1dF9jaGFyID09PSAiPCIgJiYgIXRhZ19zdGFydF9jaGFyKSB7CiAgICAgICAgICAgICAgICB0YWdfc3RhcnQgPSB0aGlzLnBvcyAtIDE7CiAgICAgICAgICAgICAgICB0YWdfc3RhcnRfY2hhciA9ICI8IjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChpbmRlbnRfaGFuZGxlYmFycyAmJiAhdGFnX3N0YXJ0X2NoYXIpIHsKICAgICAgICAgICAgICAgIGlmIChjb250ZW50Lmxlbmd0aCA+PSAyICYmIGNvbnRlbnRbY29udGVudC5sZW5ndGggLSAxXSA9PT0gInsiICYmIGNvbnRlbnRbY29udGVudC5sZW5ndGggLSAyXSA9PSAieyIpIHsKICAgICAgICAgICAgICAgICAgaWYgKGlucHV0X2NoYXIgPT09ICIjIiB8fCBpbnB1dF9jaGFyID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgICB0YWdfc3RhcnQgPSB0aGlzLnBvcyAtIDM7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGFnX3N0YXJ0ID0gdGhpcy5wb3MgLSAyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHRhZ19zdGFydF9jaGFyID0gInsiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgdGhpcy5saW5lX2NoYXJfY291bnQrKzsKICAgICAgICAgICAgICBjb250ZW50LnB1c2goaW5wdXRfY2hhcik7IC8vaW5zZXJ0cyBjaGFyYWN0ZXIgYXQtYS10aW1lIChvciBzdHJpbmcpCgogICAgICAgICAgICAgIGlmIChjb250ZW50WzFdICYmIGNvbnRlbnRbMV0gPT09ICIhIikgewogICAgICAgICAgICAgICAgLy9pZiB3ZSdyZSBpbiBhIGNvbW1lbnQsIGRvIHNvbWV0aGluZyBzcGVjaWFsCiAgICAgICAgICAgICAgICAvLyBXZSB0cmVhdCBhbGwgY29tbWVudHMgYXMgbGl0ZXJhbHMsIGV2ZW4gbW9yZSB0aGFuIHByZWZvcm1hdHRlZCB0YWdzCiAgICAgICAgICAgICAgICAvLyB3ZSBqdXN0IGxvb2sgZm9yIHRoZSBhcHByb3ByaWF0ZSBjbG9zZSB0YWcKICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBbdGhpcy5nZXRfY29tbWVudCh0YWdfc3RhcnQpXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgaW5kZW50X2hhbmRsZWJhcnMgJiYKICAgICAgICAgICAgICAgIHRhZ19zdGFydF9jaGFyID09PSAieyIgJiYKICAgICAgICAgICAgICAgIGNvbnRlbnQubGVuZ3RoID4gMiAmJgogICAgICAgICAgICAgICAgY29udGVudFtjb250ZW50Lmxlbmd0aCAtIDJdID09PSAifSIgJiYKICAgICAgICAgICAgICAgIGNvbnRlbnRbY29udGVudC5sZW5ndGggLSAxXSA9PT0gIn0iCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKGlucHV0X2NoYXIgIT09ICI+Iik7CgogICAgICAgICAgICB2YXIgdGFnX2NvbXBsZXRlID0gY29udGVudC5qb2luKCIiKTsKICAgICAgICAgICAgdmFyIHRhZ19pbmRleDsKICAgICAgICAgICAgdmFyIHRhZ19vZmZzZXQ7CgogICAgICAgICAgICBpZiAodGFnX2NvbXBsZXRlLmluZGV4T2YoIiAiKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAvL2lmIHRoZXJlJ3Mgd2hpdGVzcGFjZSwgdGhhdHMgd2hlcmUgdGhlIHRhZyBuYW1lIGVuZHMKICAgICAgICAgICAgICB0YWdfaW5kZXggPSB0YWdfY29tcGxldGUuaW5kZXhPZigiICIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRhZ19jb21wbGV0ZVswXSA9PT0gInsiKSB7CiAgICAgICAgICAgICAgdGFnX2luZGV4ID0gdGFnX2NvbXBsZXRlLmluZGV4T2YoIn0iKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvL290aGVyd2lzZSBnbyB3aXRoIHRoZSB0YWcgZW5kaW5nCiAgICAgICAgICAgICAgdGFnX2luZGV4ID0gdGFnX2NvbXBsZXRlLmluZGV4T2YoIj4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnX2NvbXBsZXRlWzBdID09PSAiPCIgfHwgIWluZGVudF9oYW5kbGViYXJzKSB7CiAgICAgICAgICAgICAgdGFnX29mZnNldCA9IDE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGFnX29mZnNldCA9IHRhZ19jb21wbGV0ZVsyXSA9PT0gIiMiID8gMyA6IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRhZ19jaGVjayA9IHRhZ19jb21wbGV0ZS5zdWJzdHJpbmcodGFnX29mZnNldCwgdGFnX2luZGV4KS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAodGFnX2NvbXBsZXRlLmNoYXJBdCh0YWdfY29tcGxldGUubGVuZ3RoIC0gMikgPT09ICIvIiB8fCB0aGlzLlV0aWxzLmluX2FycmF5KHRhZ19jaGVjaywgdGhpcy5VdGlscy5zaW5nbGVfdG9rZW4pKSB7CiAgICAgICAgICAgICAgLy9pZiB0aGlzIHRhZyBuYW1lIGlzIGEgc2luZ2xlIHRhZyB0eXBlIChlaXRoZXIgaW4gdGhlIGxpc3Qgb3IgaGFzIGEgY2xvc2luZyAvKQogICAgICAgICAgICAgIGlmICghcGVlaykgewogICAgICAgICAgICAgICAgdGhpcy50YWdfdHlwZSA9ICJTSU5HTEUiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRlbnRfaGFuZGxlYmFycyAmJiB0YWdfY29tcGxldGVbMF0gPT09ICJ7IiAmJiB0YWdfY2hlY2sgPT09ICJlbHNlIikgewogICAgICAgICAgICAgIGlmICghcGVlaykgewogICAgICAgICAgICAgICAgdGhpcy5pbmRlbnRfdG9fdGFnKCJpZiIpOwogICAgICAgICAgICAgICAgdGhpcy50YWdfdHlwZSA9ICJIQU5ETEVCQVJTX0VMU0UiOwogICAgICAgICAgICAgICAgdGhpcy5pbmRlbnRfY29udGVudCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnRyYXZlcnNlX3doaXRlc3BhY2UoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnX2NoZWNrID09PSAic2NyaXB0IikgewogICAgICAgICAgICAgIC8vZm9yIGxhdGVyIHNjcmlwdCBoYW5kbGluZwogICAgICAgICAgICAgIGlmICghcGVlaykgewogICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRfdGFnKHRhZ19jaGVjayk7CiAgICAgICAgICAgICAgICB0aGlzLnRhZ190eXBlID0gIlNDUklQVCI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHRhZ19jaGVjayA9PT0gInN0eWxlIikgewogICAgICAgICAgICAgIC8vZm9yIGZ1dHVyZSBzdHlsZSBoYW5kbGluZyAoZm9yIG5vdyBpdCBqdXN0cyB1c2VzIGdldF9jb250ZW50KQogICAgICAgICAgICAgIGlmICghcGVlaykgewogICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRfdGFnKHRhZ19jaGVjayk7CiAgICAgICAgICAgICAgICB0aGlzLnRhZ190eXBlID0gIlNUWUxFIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc191bmZvcm1hdHRlZCh0YWdfY2hlY2ssIHVuZm9ybWF0dGVkKSkgewogICAgICAgICAgICAgIC8vIGRvIG5vdCByZWZvcm1hdCB0aGUgInVuZm9ybWF0dGVkIiB0YWdzCiAgICAgICAgICAgICAgY29tbWVudCA9IHRoaXMuZ2V0X3VuZm9ybWF0dGVkKCI8LyIgKyB0YWdfY2hlY2sgKyAiPiIsIHRhZ19jb21wbGV0ZSk7IC8vLi4uZGVsZWdhdGUgdG8gZ2V0X3VuZm9ybWF0dGVkIGZ1bmN0aW9uCiAgICAgICAgICAgICAgY29udGVudC5wdXNoKGNvbW1lbnQpOwogICAgICAgICAgICAgIC8vIFByZXNlcnZlIGNvbGxhcHNlZCB3aGl0ZXNwYWNlIGVpdGhlciBiZWZvcmUgb3IgYWZ0ZXIgdGhpcyB0YWcuCiAgICAgICAgICAgICAgaWYgKHRhZ19zdGFydCA+IDAgJiYgdGhpcy5VdGlscy5pbl9hcnJheSh0aGlzLmlucHV0LmNoYXJBdCh0YWdfc3RhcnQgLSAxKSwgdGhpcy5VdGlscy53aGl0ZXNwYWNlKSkgewogICAgICAgICAgICAgICAgY29udGVudC5zcGxpY2UoMCwgMCwgdGhpcy5pbnB1dC5jaGFyQXQodGFnX3N0YXJ0IC0gMSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0YWdfZW5kID0gdGhpcy5wb3MgLSAxOwogICAgICAgICAgICAgIGlmICh0aGlzLlV0aWxzLmluX2FycmF5KHRoaXMuaW5wdXQuY2hhckF0KHRhZ19lbmQgKyAxKSwgdGhpcy5VdGlscy53aGl0ZXNwYWNlKSkgewogICAgICAgICAgICAgICAgY29udGVudC5wdXNoKHRoaXMuaW5wdXQuY2hhckF0KHRhZ19lbmQgKyAxKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMudGFnX3R5cGUgPSAiU0lOR0xFIjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0YWdfY2hlY2suY2hhckF0KDApID09PSAiISIpIHsKICAgICAgICAgICAgICAvL3BlZWsgZm9yIDwhIGNvbW1lbnQKICAgICAgICAgICAgICAvLyBmb3IgY29tbWVudHMgY29udGVudCBpcyBhbHJlYWR5IGNvcnJlY3QuCiAgICAgICAgICAgICAgaWYgKCFwZWVrKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhZ190eXBlID0gIlNJTkdMRSI7CiAgICAgICAgICAgICAgICB0aGlzLnRyYXZlcnNlX3doaXRlc3BhY2UoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXBlZWspIHsKICAgICAgICAgICAgICBpZiAodGFnX2NoZWNrLmNoYXJBdCgwKSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAvL3RoaXMgdGFnIGlzIGEgZG91YmxlIHRhZyBzbyBjaGVjayBmb3IgdGFnLWVuZGluZwogICAgICAgICAgICAgICAgdGhpcy5yZXRyaWV2ZV90YWcodGFnX2NoZWNrLnN1YnN0cmluZygxKSk7IC8vcmVtb3ZlIGl0IGFuZCBhbGwgYW5jZXN0b3JzCiAgICAgICAgICAgICAgICB0aGlzLnRhZ190eXBlID0gIkVORCI7CiAgICAgICAgICAgICAgICB0aGlzLnRyYXZlcnNlX3doaXRlc3BhY2UoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy9vdGhlcndpc2UgaXQncyBhIHN0YXJ0LXRhZwogICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRfdGFnKHRhZ19jaGVjayk7IC8vcHVzaCBpdCBvbiB0aGUgdGFnIHN0YWNrCiAgICAgICAgICAgICAgICBpZiAodGFnX2NoZWNrLnRvTG93ZXJDYXNlKCkgIT09ICJodG1sIikgewogICAgICAgICAgICAgICAgICB0aGlzLmluZGVudF9jb250ZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMudGFnX3R5cGUgPSAiU1RBUlQiOwoKICAgICAgICAgICAgICAgIC8vIEFsbG93IHByZXNlcnZpbmcgb2YgbmV3bGluZXMgYWZ0ZXIgYSBzdGFydCB0YWcKICAgICAgICAgICAgICAgIHRoaXMudHJhdmVyc2Vfd2hpdGVzcGFjZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy5VdGlscy5pbl9hcnJheSh0YWdfY2hlY2ssIHRoaXMuVXRpbHMuZXh0cmFfbGluZXJzKSkgewogICAgICAgICAgICAgICAgLy9jaGVjayBpZiB0aGlzIGRvdWJsZSBuZWVkcyBhbiBleHRyYSBsaW5lCiAgICAgICAgICAgICAgICB0aGlzLnByaW50X25ld2xpbmUoZmFsc2UsIHRoaXMub3V0cHV0KTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLm91dHB1dC5sZW5ndGggJiYgdGhpcy5vdXRwdXRbdGhpcy5vdXRwdXQubGVuZ3RoIC0gMl0gIT09ICJcbiIpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5wcmludF9uZXdsaW5lKHRydWUsIHRoaXMub3V0cHV0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwZWVrKSB7CiAgICAgICAgICAgICAgdGhpcy5wb3MgPSBvcmlnX3BvczsKICAgICAgICAgICAgICB0aGlzLmxpbmVfY2hhcl9jb3VudCA9IG9yaWdfbGluZV9jaGFyX2NvdW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gY29udGVudC5qb2luKCIiKTsgLy9yZXR1cm5zIGZ1bGx5IGZvcm1hdHRlZCB0YWcKICAgICAgICAgIH07CgogICAgICAgICAgdGhpcy5nZXRfY29tbWVudCA9IGZ1bmN0aW9uIChzdGFydF9wb3MpIHsKICAgICAgICAgICAgLy9mdW5jdGlvbiB0byByZXR1cm4gY29tbWVudCBjb250ZW50IGluIGl0cyBlbnRpcmV0eQogICAgICAgICAgICAvLyB0aGlzIGlzIHdpbGwgaGF2ZSB2ZXJ5IHBvb3IgcGVyZiwgYnV0IHdpbGwgd29yayBmb3Igbm93LgogICAgICAgICAgICB2YXIgY29tbWVudCA9ICIiLAogICAgICAgICAgICAgIGRlbGltaXRlciA9ICI+IiwKICAgICAgICAgICAgICBtYXRjaGVkID0gZmFsc2U7CgogICAgICAgICAgICB0aGlzLnBvcyA9IHN0YXJ0X3BvczsKICAgICAgICAgICAgaW5wdXRfY2hhciA9IHRoaXMuaW5wdXQuY2hhckF0KHRoaXMucG9zKTsKICAgICAgICAgICAgdGhpcy5wb3MrKzsKCiAgICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8PSB0aGlzLmlucHV0Lmxlbmd0aCkgewogICAgICAgICAgICAgIGNvbW1lbnQgKz0gaW5wdXRfY2hhcjsKCiAgICAgICAgICAgICAgLy8gb25seSBuZWVkIHRvIGNoZWNrIGZvciB0aGUgZGVsaW1pdGVyIGlmIHRoZSBsYXN0IGNoYXJzIG1hdGNoCiAgICAgICAgICAgICAgaWYgKGNvbW1lbnRbY29tbWVudC5sZW5ndGggLSAxXSA9PT0gZGVsaW1pdGVyW2RlbGltaXRlci5sZW5ndGggLSAxXSAmJiBjb21tZW50LmluZGV4T2YoZGVsaW1pdGVyKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gb25seSBuZWVkIHRvIHNlYXJjaCBmb3IgY3VzdG9tIGRlbGltaXRlciBmb3IgdGhlIGZpcnN0IGZldyBjaGFyYWN0ZXJzCiAgICAgICAgICAgICAgaWYgKCFtYXRjaGVkICYmIGNvbW1lbnQubGVuZ3RoIDwgMTApIHsKICAgICAgICAgICAgICAgIGlmIChjb21tZW50LmluZGV4T2YoIjwhW2lmIikgPT09IDApIHsKICAgICAgICAgICAgICAgICAgLy9wZWVrIGZvciA8IVtpZiBjb25kaXRpb25hbCBjb21tZW50CiAgICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI8IVtlbmRpZl0+IjsKICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbW1lbnQuaW5kZXhPZigiPCFbY2RhdGFbIikgPT09IDApIHsKICAgICAgICAgICAgICAgICAgLy9pZiBpdCdzIGEgPFtjZGF0YVsgY29tbWVudC4uLgogICAgICAgICAgICAgICAgICBkZWxpbWl0ZXIgPSAiXV0+IjsKICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbW1lbnQuaW5kZXhPZigiPCFbIikgPT09IDApIHsKICAgICAgICAgICAgICAgICAgLy8gc29tZSBvdGhlciAhWyBjb21tZW50PyAuLi4KICAgICAgICAgICAgICAgICAgZGVsaW1pdGVyID0gIl0+IjsKICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbW1lbnQuaW5kZXhPZigiPCEtLSIpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIC8vIDwhLS0gY29tbWVudCAuLi4KICAgICAgICAgICAgICAgICAgZGVsaW1pdGVyID0gIi0tPiI7CiAgICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaW5wdXRfY2hhciA9IHRoaXMuaW5wdXQuY2hhckF0KHRoaXMucG9zKTsKICAgICAgICAgICAgICB0aGlzLnBvcysrOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gY29tbWVudDsKICAgICAgICAgIH07CgogICAgICAgICAgdGhpcy5nZXRfdW5mb3JtYXR0ZWQgPSBmdW5jdGlvbiAoZGVsaW1pdGVyLCBvcmlnX3RhZykgewogICAgICAgICAgICAvL2Z1bmN0aW9uIHRvIHJldHVybiB1bmZvcm1hdHRlZCBjb250ZW50IGluIGl0cyBlbnRpcmV0eQoKICAgICAgICAgICAgaWYgKG9yaWdfdGFnICYmIG9yaWdfdGFnLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihkZWxpbWl0ZXIpICE9PSAtMSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5wdXRfY2hhciA9ICIiOwogICAgICAgICAgICB2YXIgY29udGVudCA9ICIiOwogICAgICAgICAgICB2YXIgbWluX2luZGV4ID0gMDsKICAgICAgICAgICAgdmFyIHNwYWNlID0gdHJ1ZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICh0aGlzLnBvcyA+PSB0aGlzLmlucHV0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnQ7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpbnB1dF9jaGFyID0gdGhpcy5pbnB1dC5jaGFyQXQodGhpcy5wb3MpOwogICAgICAgICAgICAgIHRoaXMucG9zKys7CgogICAgICAgICAgICAgIGlmICh0aGlzLlV0aWxzLmluX2FycmF5KGlucHV0X2NoYXIsIHRoaXMuVXRpbHMud2hpdGVzcGFjZSkpIHsKICAgICAgICAgICAgICAgIGlmICghc3BhY2UpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5saW5lX2NoYXJfY291bnQtLTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaW5wdXRfY2hhciA9PT0gIlxuIiB8fCBpbnB1dF9jaGFyID09PSAiXHIiKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRlbnQgKz0gIlxuIjsKICAgICAgICAgICAgICAgICAgLyogIERvbid0IGNoYW5nZSB0YWIgaW5kZW50aW9uIGZvciB1bmZvcm1hdHRlZCBibG9ja3MuICBJZiB1c2luZyBjb2RlIGZvciBodG1sIGVkaXRpbmcsIHRoaXMgd2lsbCBncmVhdGx5IGFmZmVjdCA8cHJlPiB0YWdzIGlmIHRoZXkgYXJlIHNwZWNpZmllZCBpbiB0aGUgJ3VuZm9ybWF0dGVkIGFycmF5JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTA7IGk8dGhpcy5pbmRlbnRfbGV2ZWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ICs9IHRoaXMuaW5kZW50X3N0cmluZzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGFjZSA9IGZhbHNlOyAvLy4uLmFuZCBtYWtlIHN1cmUgb3RoZXIgaW5kZW50YXRpb24gaXMgZXJhc2VkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgIHRoaXMubGluZV9jaGFyX2NvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRlbnQgKz0gaW5wdXRfY2hhcjsKICAgICAgICAgICAgICB0aGlzLmxpbmVfY2hhcl9jb3VudCsrOwogICAgICAgICAgICAgIHNwYWNlID0gdHJ1ZTsKCiAgICAgICAgICAgICAgaWYgKGluZGVudF9oYW5kbGViYXJzICYmIGlucHV0X2NoYXIgPT09ICJ7IiAmJiBjb250ZW50Lmxlbmd0aCAmJiBjb250ZW50W2NvbnRlbnQubGVuZ3RoIC0gMl0gPT09ICJ7IikgewogICAgICAgICAgICAgICAgLy8gSGFuZGxlYmFycyBleHByZXNzaW9ucyBpbiBzdHJpbmdzIHNob3VsZCBhbHNvIGJlIHVuZm9ybWF0dGVkLgogICAgICAgICAgICAgICAgY29udGVudCArPSB0aGlzLmdldF91bmZvcm1hdHRlZCgifX0iKTsKICAgICAgICAgICAgICAgIC8vIFRoZXNlIGV4cHJlc3Npb25zIGFyZSBvcGFxdWUuICBJZ25vcmUgZGVsaW1pdGVycyBmb3VuZCBpbiB0aGVtLgogICAgICAgICAgICAgICAgbWluX2luZGV4ID0gY29udGVudC5sZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlIChjb250ZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZihkZWxpbWl0ZXIsIG1pbl9pbmRleCkgPT09IC0xKTsKICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnQ7CiAgICAgICAgICB9OwoKICAgICAgICAgIHRoaXMuZ2V0X3Rva2VuID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvL2luaXRpYWwgaGFuZGxlciBmb3IgdG9rZW4tcmV0cmlldmFsCiAgICAgICAgICAgIHZhciB0b2tlbjsKCiAgICAgICAgICAgIGlmICh0aGlzLmxhc3RfdG9rZW4gPT09ICJUS19UQUdfU0NSSVBUIiB8fCB0aGlzLmxhc3RfdG9rZW4gPT09ICJUS19UQUdfU1RZTEUiKSB7CiAgICAgICAgICAgICAgLy9jaGVjayBpZiB3ZSBuZWVkIHRvIGZvcm1hdCBqYXZhc2NyaXB0CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSB0aGlzLmxhc3RfdG9rZW4uc3Vic3RyKDcpOwogICAgICAgICAgICAgIHRva2VuID0gdGhpcy5nZXRfY29udGVudHNfdG8odHlwZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIFt0b2tlbiwgIlRLXyIgKyB0eXBlXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50X21vZGUgPT09ICJDT05URU5UIikgewogICAgICAgICAgICAgIHRva2VuID0gdGhpcy5nZXRfY29udGVudCgpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgdG9rZW4gIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBbdG9rZW4sICJUS19DT05URU5UIl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50X21vZGUgPT09ICJUQUciKSB7CiAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLmdldF90YWcoKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHRva2VuICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgdGFnX25hbWVfdHlwZSA9ICJUS19UQUdfIiArIHRoaXMudGFnX3R5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gW3Rva2VuLCB0YWdfbmFtZV90eXBlXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgdGhpcy5nZXRfZnVsbF9pbmRlbnQgPSBmdW5jdGlvbiAobGV2ZWwpIHsKICAgICAgICAgICAgbGV2ZWwgPSB0aGlzLmluZGVudF9sZXZlbCArIGxldmVsIHx8IDA7CiAgICAgICAgICAgIGlmIChsZXZlbCA8IDEpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBBcnJheShsZXZlbCArIDEpLmpvaW4odGhpcy5pbmRlbnRfc3RyaW5nKTsKICAgICAgICAgIH07CgogICAgICAgICAgdGhpcy5pc191bmZvcm1hdHRlZCA9IGZ1bmN0aW9uICh0YWdfY2hlY2ssIHVuZm9ybWF0dGVkKSB7CiAgICAgICAgICAgIC8vaXMgdGhpcyBhbiBIVE1MNSBibG9jay1sZXZlbCBsaW5rPwogICAgICAgICAgICBpZiAoIXRoaXMuVXRpbHMuaW5fYXJyYXkodGFnX2NoZWNrLCB1bmZvcm1hdHRlZCkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YWdfY2hlY2sudG9Mb3dlckNhc2UoKSAhPT0gImEiIHx8ICF0aGlzLlV0aWxzLmluX2FycmF5KCJhIiwgdW5mb3JtYXR0ZWQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vYXQgdGhpcyBwb2ludCB3ZSBoYXZlIGFuICB0YWc7IGlzIGl0cyBmaXJzdCBjaGlsZCBzb21ldGhpbmcgd2Ugd2FudCB0byByZW1haW4KICAgICAgICAgICAgLy91bmZvcm1hdHRlZD8KICAgICAgICAgICAgdmFyIG5leHRfdGFnID0gdGhpcy5nZXRfdGFnKHRydWUgLyogcGVlay4gKi8pOwoKICAgICAgICAgICAgLy8gdGVzdCBuZXh0X3RhZyB0byBzZWUgaWYgaXQgaXMganVzdCBodG1sIHRhZyAobm8gZXh0ZXJuYWwgY29udGVudCkKICAgICAgICAgICAgdmFyIHRhZyA9IChuZXh0X3RhZyB8fCAiIikubWF0Y2goL15ccyo8XHMqXC8/KFthLXpdKilccypbXj5dKj5ccyokLyk7CgogICAgICAgICAgICAvLyBpZiBuZXh0X3RhZyBjb21lcyBiYWNrIGJ1dCBpcyBub3QgYW4gaXNvbGF0ZWQgdGFnLCB0aGVuCiAgICAgICAgICAgIC8vIGxldCdzIHRyZWF0IHRoZSAnYScgdGFnIGFzIGhhdmluZyBjb250ZW50CiAgICAgICAgICAgIC8vIGFuZCByZXNwZWN0IHRoZSB1bmZvcm1hdHRlZCBvcHRpb24KICAgICAgICAgICAgaWYgKCF0YWcgfHwgdGhpcy5VdGlscy5pbl9hcnJheSh0YWcsIHVuZm9ybWF0dGVkKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICB0aGlzLnByaW50ZXIgPSBmdW5jdGlvbiAoanNfc291cmNlLCBpbmRlbnRfY2hhcmFjdGVyLCBpbmRlbnRfc2l6ZSwgd3JhcF9saW5lX2xlbmd0aCwgYnJhY2Vfc3R5bGUpIHsKICAgICAgICAgICAgLy9oYW5kbGVzIGlucHV0L291dHB1dCBhbmQgc29tZSBvdGhlciBwcmludGluZyBmdW5jdGlvbnMKCiAgICAgICAgICAgIHRoaXMuaW5wdXQgPSBqc19zb3VyY2UgfHwgIiI7IC8vZ2V0cyB0aGUgaW5wdXQgZm9yIHRoZSBQYXJzZXIKICAgICAgICAgICAgdGhpcy5vdXRwdXQgPSBbXTsKICAgICAgICAgICAgdGhpcy5pbmRlbnRfY2hhcmFjdGVyID0gaW5kZW50X2NoYXJhY3RlcjsKICAgICAgICAgICAgdGhpcy5pbmRlbnRfc3RyaW5nID0gIiI7CiAgICAgICAgICAgIHRoaXMuaW5kZW50X3NpemUgPSBpbmRlbnRfc2l6ZTsKICAgICAgICAgICAgdGhpcy5icmFjZV9zdHlsZSA9IGJyYWNlX3N0eWxlOwogICAgICAgICAgICB0aGlzLmluZGVudF9sZXZlbCA9IDA7CiAgICAgICAgICAgIHRoaXMud3JhcF9saW5lX2xlbmd0aCA9IHdyYXBfbGluZV9sZW5ndGg7CiAgICAgICAgICAgIHRoaXMubGluZV9jaGFyX2NvdW50ID0gMDsgLy9jb3VudCB0byBzZWUgaWYgd3JhcF9saW5lX2xlbmd0aCB3YXMgZXhjZWVkZWQKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5pbmRlbnRfc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgdGhpcy5pbmRlbnRfc3RyaW5nICs9IHRoaXMuaW5kZW50X2NoYXJhY3RlcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wcmludF9uZXdsaW5lID0gZnVuY3Rpb24gKGZvcmNlLCBhcnIpIHsKICAgICAgICAgICAgICB0aGlzLmxpbmVfY2hhcl9jb3VudCA9IDA7CiAgICAgICAgICAgICAgaWYgKCFhcnIgfHwgIWFyci5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZvcmNlIHx8IGFyclthcnIubGVuZ3RoIC0gMV0gIT09ICJcbiIpIHsKICAgICAgICAgICAgICAgIC8vd2UgbWlnaHQgd2FudCB0aGUgZXh0cmEgbGluZQogICAgICAgICAgICAgICAgYXJyLnB1c2goIlxuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5wcmludF9pbmRlbnRhdGlvbiA9IGZ1bmN0aW9uIChhcnIpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaW5kZW50X2xldmVsOyBpKyspIHsKICAgICAgICAgICAgICAgIGFyci5wdXNoKHRoaXMuaW5kZW50X3N0cmluZyk7CiAgICAgICAgICAgICAgICB0aGlzLmxpbmVfY2hhcl9jb3VudCArPSB0aGlzLmluZGVudF9zdHJpbmcubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMucHJpbnRfdG9rZW4gPSBmdW5jdGlvbiAodGV4dCkgewogICAgICAgICAgICAgIGlmICh0ZXh0IHx8IHRleHQgIT09ICIiKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vdXRwdXQubGVuZ3RoICYmIHRoaXMub3V0cHV0W3RoaXMub3V0cHV0Lmxlbmd0aCAtIDFdID09PSAiXG4iKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMucHJpbnRfaW5kZW50YXRpb24odGhpcy5vdXRwdXQpOwogICAgICAgICAgICAgICAgICB0ZXh0ID0gbHRyaW0odGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMucHJpbnRfdG9rZW5fcmF3KHRleHQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5wcmludF90b2tlbl9yYXcgPSBmdW5jdGlvbiAodGV4dCkgewogICAgICAgICAgICAgIGlmICh0ZXh0ICYmIHRleHQgIT09ICIiKSB7CiAgICAgICAgICAgICAgICBpZiAodGV4dC5sZW5ndGggPiAxICYmIHRleHRbdGV4dC5sZW5ndGggLSAxXSA9PT0gIlxuIikgewogICAgICAgICAgICAgICAgICAvLyB1bmZvcm1hdHRlZCB0YWdzIGNhbiBncmFiIG5ld2xpbmVzIGFzIHRoZWlyIGxhc3QgY2hhcmFjdGVyCiAgICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0LnB1c2godGV4dC5zbGljZSgwLCAtMSkpOwogICAgICAgICAgICAgICAgICB0aGlzLnByaW50X25ld2xpbmUoZmFsc2UsIHRoaXMub3V0cHV0KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0LnB1c2godGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBmb3IgKHZhciBuID0gMDsgbiA8IHRoaXMubmV3bGluZXM7IG4rKykgewogICAgICAgICAgICAgICAgdGhpcy5wcmludF9uZXdsaW5lKG4gPiAwLCB0aGlzLm91dHB1dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMubmV3bGluZXMgPSAwOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5pbmRlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdGhpcy5pbmRlbnRfbGV2ZWwrKzsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMudW5pbmRlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuaW5kZW50X2xldmVsID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5pbmRlbnRfbGV2ZWwtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQoKICAgICAgICAvKl9fX19fX19fX19fX19fX19fX19fXy0tLS0tLS0tLS0tLS0tLS0tLS0tX19fX19fX19fX19fX19fX19fX19fKi8KCiAgICAgICAgbXVsdGlfcGFyc2VyID0gbmV3IFBhcnNlcigpOyAvL3dyYXBwaW5nIGZ1bmN0aW9ucyBQYXJzZXIKICAgICAgICBtdWx0aV9wYXJzZXIucHJpbnRlcihodG1sX3NvdXJjZSwgaW5kZW50X2NoYXJhY3RlciwgaW5kZW50X3NpemUsIHdyYXBfbGluZV9sZW5ndGgsIGJyYWNlX3N0eWxlKTsgLy9pbml0aWFsaXplIHN0YXJ0aW5nIHZhbHVlcwoKICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgdmFyIHQgPSBtdWx0aV9wYXJzZXIuZ2V0X3Rva2VuKCk7CiAgICAgICAgICBtdWx0aV9wYXJzZXIudG9rZW5fdGV4dCA9IHRbMF07CiAgICAgICAgICBtdWx0aV9wYXJzZXIudG9rZW5fdHlwZSA9IHRbMV07CgogICAgICAgICAgaWYgKG11bHRpX3BhcnNlci50b2tlbl90eXBlID09PSAiVEtfRU9GIikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBzd2l0Y2ggKG11bHRpX3BhcnNlci50b2tlbl90eXBlKSB7CiAgICAgICAgICAgIGNhc2UgIlRLX1RBR19TVEFSVCI6CiAgICAgICAgICAgICAgbXVsdGlfcGFyc2VyLnByaW50X25ld2xpbmUoZmFsc2UsIG11bHRpX3BhcnNlci5vdXRwdXQpOwogICAgICAgICAgICAgIG11bHRpX3BhcnNlci5wcmludF90b2tlbihtdWx0aV9wYXJzZXIudG9rZW5fdGV4dCk7CiAgICAgICAgICAgICAgaWYgKG11bHRpX3BhcnNlci5pbmRlbnRfY29udGVudCkgewogICAgICAgICAgICAgICAgbXVsdGlfcGFyc2VyLmluZGVudCgpOwogICAgICAgICAgICAgICAgbXVsdGlfcGFyc2VyLmluZGVudF9jb250ZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG11bHRpX3BhcnNlci5jdXJyZW50X21vZGUgPSAiQ09OVEVOVCI7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIlRLX1RBR19TVFlMRSI6CiAgICAgICAgICAgIGNhc2UgIlRLX1RBR19TQ1JJUFQiOgogICAgICAgICAgICAgIG11bHRpX3BhcnNlci5wcmludF9uZXdsaW5lKGZhbHNlLCBtdWx0aV9wYXJzZXIub3V0cHV0KTsKICAgICAgICAgICAgICBtdWx0aV9wYXJzZXIucHJpbnRfdG9rZW4obXVsdGlfcGFyc2VyLnRva2VuX3RleHQpOwogICAgICAgICAgICAgIG11bHRpX3BhcnNlci5jdXJyZW50X21vZGUgPSAiQ09OVEVOVCI7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIlRLX1RBR19FTkQiOgogICAgICAgICAgICAgIC8vUHJpbnQgbmV3IGxpbmUgb25seSBpZiB0aGUgdGFnIGhhcyBubyBjb250ZW50IGFuZCBoYXMgY2hpbGQKICAgICAgICAgICAgICBpZiAobXVsdGlfcGFyc2VyLmxhc3RfdG9rZW4gPT09ICJUS19DT05URU5UIiAmJiBtdWx0aV9wYXJzZXIubGFzdF90ZXh0ID09PSAiIikgewogICAgICAgICAgICAgICAgdmFyIHRhZ19uYW1lID0gbXVsdGlfcGFyc2VyLnRva2VuX3RleHQubWF0Y2goL1x3Ky8pWzBdOwogICAgICAgICAgICAgICAgdmFyIHRhZ19leHRyYWN0ZWRfZnJvbV9sYXN0X291dHB1dCA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAobXVsdGlfcGFyc2VyLm91dHB1dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgdGFnX2V4dHJhY3RlZF9mcm9tX2xhc3Rfb3V0cHV0ID0gbXVsdGlfcGFyc2VyLm91dHB1dFttdWx0aV9wYXJzZXIub3V0cHV0Lmxlbmd0aCAtIDFdLm1hdGNoKC8oPzo8fHt7IylccyooXHcrKS8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRhZ19leHRyYWN0ZWRfZnJvbV9sYXN0X291dHB1dCA9PT0gbnVsbCB8fCB0YWdfZXh0cmFjdGVkX2Zyb21fbGFzdF9vdXRwdXRbMV0gIT09IHRhZ19uYW1lKSB7CiAgICAgICAgICAgICAgICAgIG11bHRpX3BhcnNlci5wcmludF9uZXdsaW5lKGZhbHNlLCBtdWx0aV9wYXJzZXIub3V0cHV0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbXVsdGlfcGFyc2VyLnByaW50X3Rva2VuKG11bHRpX3BhcnNlci50b2tlbl90ZXh0KTsKICAgICAgICAgICAgICBtdWx0aV9wYXJzZXIuY3VycmVudF9tb2RlID0gIkNPTlRFTlQiOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJUS19UQUdfU0lOR0xFIjoKICAgICAgICAgICAgICAvLyBEb24ndCBhZGQgYSBuZXdsaW5lIGJlZm9yZSBlbGVtZW50cyB0aGF0IHNob3VsZCByZW1haW4gdW5mb3JtYXR0ZWQuCiAgICAgICAgICAgICAgdmFyIHRhZ19jaGVjayA9IG11bHRpX3BhcnNlci50b2tlbl90ZXh0Lm1hdGNoKC9eXHMqPChbYS16XSspL2kpOwogICAgICAgICAgICAgIGlmICghdGFnX2NoZWNrIHx8ICFtdWx0aV9wYXJzZXIuVXRpbHMuaW5fYXJyYXkodGFnX2NoZWNrWzFdLCB1bmZvcm1hdHRlZCkpIHsKICAgICAgICAgICAgICAgIG11bHRpX3BhcnNlci5wcmludF9uZXdsaW5lKGZhbHNlLCBtdWx0aV9wYXJzZXIub3V0cHV0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbXVsdGlfcGFyc2VyLnByaW50X3Rva2VuKG11bHRpX3BhcnNlci50b2tlbl90ZXh0KTsKICAgICAgICAgICAgICBtdWx0aV9wYXJzZXIuY3VycmVudF9tb2RlID0gIkNPTlRFTlQiOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJUS19UQUdfSEFORExFQkFSU19FTFNFIjoKICAgICAgICAgICAgICBtdWx0aV9wYXJzZXIucHJpbnRfdG9rZW4obXVsdGlfcGFyc2VyLnRva2VuX3RleHQpOwogICAgICAgICAgICAgIGlmIChtdWx0aV9wYXJzZXIuaW5kZW50X2NvbnRlbnQpIHsKICAgICAgICAgICAgICAgIG11bHRpX3BhcnNlci5pbmRlbnQoKTsKICAgICAgICAgICAgICAgIG11bHRpX3BhcnNlci5pbmRlbnRfY29udGVudCA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtdWx0aV9wYXJzZXIuY3VycmVudF9tb2RlID0gIkNPTlRFTlQiOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJUS19DT05URU5UIjoKICAgICAgICAgICAgICBtdWx0aV9wYXJzZXIucHJpbnRfdG9rZW4obXVsdGlfcGFyc2VyLnRva2VuX3RleHQpOwogICAgICAgICAgICAgIG11bHRpX3BhcnNlci5jdXJyZW50X21vZGUgPSAiVEFHIjsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiVEtfU1RZTEUiOgogICAgICAgICAgICBjYXNlICJUS19TQ1JJUFQiOgogICAgICAgICAgICAgIGlmIChtdWx0aV9wYXJzZXIudG9rZW5fdGV4dCAhPT0gIiIpIHsKICAgICAgICAgICAgICAgIG11bHRpX3BhcnNlci5wcmludF9uZXdsaW5lKGZhbHNlLCBtdWx0aV9wYXJzZXIub3V0cHV0KTsKICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gbXVsdGlfcGFyc2VyLnRva2VuX3RleHQsCiAgICAgICAgICAgICAgICAgIF9iZWF1dGlmaWVyLAogICAgICAgICAgICAgICAgICBzY3JpcHRfaW5kZW50X2xldmVsID0gMTsKICAgICAgICAgICAgICAgIGlmIChtdWx0aV9wYXJzZXIudG9rZW5fdHlwZSA9PT0gIlRLX1NDUklQVCIpIHsKICAgICAgICAgICAgICAgICAgX2JlYXV0aWZpZXIgPSB0eXBlb2YganNfYmVhdXRpZnkgPT09ICJmdW5jdGlvbiIgJiYganNfYmVhdXRpZnk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG11bHRpX3BhcnNlci50b2tlbl90eXBlID09PSAiVEtfU1RZTEUiKSB7CiAgICAgICAgICAgICAgICAgIF9iZWF1dGlmaWVyID0gdHlwZW9mIGNzc19iZWF1dGlmeSA9PT0gImZ1bmN0aW9uIiAmJiBjc3NfYmVhdXRpZnk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5kZW50X3NjcmlwdHMgPT09ICJrZWVwIikgewogICAgICAgICAgICAgICAgICBzY3JpcHRfaW5kZW50X2xldmVsID0gMDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5pbmRlbnRfc2NyaXB0cyA9PT0gInNlcGFyYXRlIikgewogICAgICAgICAgICAgICAgICBzY3JpcHRfaW5kZW50X2xldmVsID0gLW11bHRpX3BhcnNlci5pbmRlbnRfbGV2ZWw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIGluZGVudGF0aW9uID0gbXVsdGlfcGFyc2VyLmdldF9mdWxsX2luZGVudChzY3JpcHRfaW5kZW50X2xldmVsKTsKICAgICAgICAgICAgICAgIGlmIChfYmVhdXRpZmllcikgewogICAgICAgICAgICAgICAgICAvLyBjYWxsIHRoZSBCZWF1dGlmaWVyIGlmIGF2YWxpYWJsZQogICAgICAgICAgICAgICAgICB0ZXh0ID0gX2JlYXV0aWZpZXIodGV4dC5yZXBsYWNlKC9eXHMqLywgaW5kZW50YXRpb24pLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIHNpbXBseSBpbmRlbnQgdGhlIHN0cmluZyBvdGhlcndpc2UKICAgICAgICAgICAgICAgICAgdmFyIHdoaXRlID0gdGV4dC5tYXRjaCgvXlxzKi8pWzBdOwogICAgICAgICAgICAgICAgICB2YXIgX2xldmVsID0gd2hpdGUubWF0Y2goL1teXG5ccl0qJC8pWzBdLnNwbGl0KG11bHRpX3BhcnNlci5pbmRlbnRfc3RyaW5nKS5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICB2YXIgcmVpbmRlbnQgPSBtdWx0aV9wYXJzZXIuZ2V0X2Z1bGxfaW5kZW50KHNjcmlwdF9pbmRlbnRfbGV2ZWwgLSBfbGV2ZWwpOwogICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dAogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9eXHMqLywgaW5kZW50YXRpb24pCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xyXG58XHJ8XG4vZywgIlxuIiArIHJlaW5kZW50KQogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9ccyskLywgIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRleHQpIHsKICAgICAgICAgICAgICAgICAgbXVsdGlfcGFyc2VyLnByaW50X3Rva2VuX3JhdyhpbmRlbnRhdGlvbiArIHRyaW0odGV4dCkpOwogICAgICAgICAgICAgICAgICBtdWx0aV9wYXJzZXIucHJpbnRfbmV3bGluZShmYWxzZSwgbXVsdGlfcGFyc2VyLm91dHB1dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG11bHRpX3BhcnNlci5jdXJyZW50X21vZGUgPSAiVEFHIjsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIG11bHRpX3BhcnNlci5sYXN0X3Rva2VuID0gbXVsdGlfcGFyc2VyLnRva2VuX3R5cGU7CiAgICAgICAgICBtdWx0aV9wYXJzZXIubGFzdF90ZXh0ID0gbXVsdGlfcGFyc2VyLnRva2VuX3RleHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtdWx0aV9wYXJzZXIub3V0cHV0LmpvaW4oIiIpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRNaXJyb3JJbmZvKGVsZW1lbnQpIHsKICAgICAgICBpZiAoZWxlbWVudC5taXJyb3JJbmZvKSB7CiAgICAgICAgICByZXR1cm4gZWxlbWVudC5taXJyb3JJbmZvOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIHZhciBzdHlsZSA9IGRpdi5zdHlsZTsKICAgICAgICB2YXIgaGlkZGVuID0gImhpZGRlbiI7CiAgICAgICAgdmFyIGZvY3VzT3V0ID0gImZvY3Vzb3V0IjsKICAgICAgICBzdHlsZS53aGl0ZVNwYWNlID0gInByZS13cmFwIjsKICAgICAgICBzdHlsZS53b3JkV3JhcCA9ICJicmVhay13b3JkIjsKICAgICAgICBzdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgICAgc3R5bGUudmlzaWJpbGl0eSA9IGhpZGRlbjsKICAgICAgICBzdHlsZS5vdmVyZmxvdyA9IGhpZGRlbjsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgZWxlbWVudC5taXJyb3JJbmZvID0geyBkaXY6IGRpdiwgc3BhbjogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpIH07CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGZvY3VzT3V0LCBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgICAgICAgZGVsZXRlIGVsZW1lbnQubWlycm9ySW5mbzsKICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZGl2KTsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihmb2N1c091dCwgY2xlYW51cCk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQubWlycm9ySW5mbzsKICAgICAgfQoKICAgICAgLyohCiAgICAgICAqCiAgICAgICAqIFpTU1JpY2hUZXh0RWRpdG9yIHYwLjUuMgogICAgICAgKiBodHRwOi8vd3d3LnplZHNhaWQuY29tCiAgICAgICAqCiAgICAgICAqIENvcHlyaWdodCAyMDE0IFplZCBTYWlkIFN0dWRpbyBMTEMKICAgICAgICoKICAgICAgICovCgogICAgICB2YXIgenNzX2VkaXRvciA9IHt9OwoKICAgICAgLy8gSWYgd2UgYXJlIHVzaW5nIGlPUyBvciBkZXNrdG9wCiAgICAgIHpzc19lZGl0b3IuaXNVc2luZ2lPUyA9IHRydWU7CgogICAgICAvLyBJZiB0aGUgdXNlciBpcyBkcmFnaW5nCiAgICAgIHpzc19lZGl0b3IuaXNEcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgLy8gVGhlIGN1cnJlbnQgc2VsZWN0aW9uCiAgICAgIHpzc19lZGl0b3IuY3VycmVudFNlbGVjdGlvbjsKCiAgICAgIC8vIFRoZSBjdXJyZW50IGVkaXRpbmcgaW1hZ2UKICAgICAgenNzX2VkaXRvci5jdXJyZW50RWRpdGluZ0ltYWdlOwoKICAgICAgLy8gVGhlIGN1cnJlbnQgZWRpdGluZyBsaW5rCiAgICAgIHpzc19lZGl0b3IuY3VycmVudEVkaXRpbmdMaW5rOwoKICAgICAgLy8gVGhlIG9iamVjdHMgdGhhdCBhcmUgZW5hYmxlZAogICAgICB6c3NfZWRpdG9yLmVuYWJsZWRJdGVtcyA9IHt9OwoKICAgICAgLy8gSGVpZ2h0IG9mIGNvbnRlbnQgd2luZG93LCB3aWxsIGJlIHNldCBieSB2aWV3Q29udHJvbGxlcgogICAgICB6c3NfZWRpdG9yLmVkaXRvckhlaWdodCA9IDI0NDsKCiAgICAgIC8vIFNldHMgdG8gdHJ1ZSB3aGVuIGV4dHJhIGZvb3RlciBnYXAgc2hvd3MgYW5kIHJlcXVpcmVzIHRvIGhpZGUKICAgICAgenNzX2VkaXRvci51cGRhdGVTY3JvbGxPZmZzZXQgPSBmYWxzZTsKCiAgICAgIC8qKgogICAgICAgKiBUaGUgaW5pdGlhbGl6ZXIgZnVuY3Rpb24gdGhhdCBtdXN0IGJlIGNhbGxlZCBvbkxvYWQKICAgICAgICovCgogICAgICBmdW5jdGlvbiBzZXR1cFRvdWNoRW5kRW5hYmxlRWRpdGluZyhlZGl0b3JJZCkgewogICAgICAgICQoIiMiICsgZWRpdG9ySWQpLm9uKCJ0b3VjaGVuZCIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoZSk7CiAgICAgICAgICB2YXIgY2xpY2tlZCA9ICQoZS50YXJnZXQpOwogICAgICAgICAgaWYgKCFjbGlja2VkLmhhc0NsYXNzKCJ6c19hY3RpdmUiKSkgewogICAgICAgICAgICAkKCJpbWciKS5yZW1vdmVDbGFzcygienNfYWN0aXZlIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHNldHVwVG91Y2hFbmRGb2N1cyhlZGl0b3JJZCkgewogICAgICAgICQod2luZG93KS5vbigidG91Y2hlbmQiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgaWYgKCF6c3NfZWRpdG9yLmlzRHJhZ2dpbmcgJiYgKGUudGFyZ2V0LmlkID09ICJ6c3NfZWRpdG9yX2Zvb3RlciIgfHwgZS50YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSAiaHRtbCIpKSB7CiAgICAgICAgICAgIHpzc19lZGl0b3IuZm9jdXNFZGl0b3IoZWRpdG9ySWQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBkaXNhYmxlTGluZUJyZWFrSWZOZWNlc3NhcnkoZWRpdG9ySWQpIHsKICAgICAgICB2YXIgZWRpdG9yID0gJCgiIyIgKyBlZGl0b3JJZCk7CiAgICAgICAgdmFyIGRpc2FibGVMaW5lQnJlYWtzID0gZWRpdG9yLmF0dHIoImRpc2FibGVMaW5lQnJlYWtzIik7CiAgICAgICAgaWYgKGRpc2FibGVMaW5lQnJlYWtzKSB7CiAgICAgICAgICBlZGl0b3Iua2V5cHJlc3MoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGUud2hpY2ggIT0gMTM7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRFZGl0aW5nTGlua09uVG91Y2goKSB7CiAgICAgICAgJCgiI3pzc19lZGl0b3JfY29udGVudCIpLmRlbGVnYXRlKCJhIiwgInRvdWNoZW5kIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICB2YXIgYW5jaG9yID0gJChldmVudC5jdXJyZW50VGFyZ2V0KTsKCiAgICAgICAgICB6c3NfZWRpdG9yLmN1cnJlbnRFZGl0aW5nTGluayA9IGFuY2hvcjsKCiAgICAgICAgICB2YXIgbGluayA9IHsKICAgICAgICAgICAgdGl0bGU6IGFuY2hvci50ZXh0KCksCiAgICAgICAgICAgIHVybDogYW5jaG9yLmF0dHIoImhyZWYiKSwKICAgICAgICAgIH07CiAgICAgICAgICB3aW5kb3cuUmVhY3ROYXRpdmVXZWJWaWV3LnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KHsgdHlwZTogIkxJTktfVE9VQ0hFRCIsIGRhdGE6IGxpbmsgfSkpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwcmV2ZW50TGlua0ZvbGxvd2luZ09uVG91Y2goKSB7CiAgICAgICAgJCgiI3pzc19lZGl0b3JfY29udGVudCIpLmRlbGVnYXRlKCJhIiwgImNsaWNrIHRvdWNoZW5kIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjbGVhckh0bWxJZlRleHRJc0VtcHR5KGVkaXRvcklkKSB7CiAgICAgICAgdmFyICRlZGl0b3IgPSAkKCIjIiArIGVkaXRvcklkKTsKCiAgICAgICAgJGVkaXRvci5vbigiaW5wdXQiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoISh0aGlzLnRleHRDb250ZW50IHx8IHRoaXMucXVlcnlTZWxlY3RvckFsbCgiaW1nLCBsaSIpLmxlbmd0aCkpIHsKICAgICAgICAgICAgdGhpcy5pbm5lckhUTUwgPSAiIjsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgenNzX2VkaXRvci5pbml0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGRpc2FibGVMaW5lQnJlYWtJZk5lY2Vzc2FyeSgienNzX2VkaXRvcl90aXRsZSIpOwogICAgICAgIGRpc2FibGVMaW5lQnJlYWtJZk5lY2Vzc2FyeSgienNzX2VkaXRvcl9jb250ZW50Iik7CgogICAgICAgIHNldHVwVG91Y2hFbmRFbmFibGVFZGl0aW5nKCJ6c3NfZWRpdG9yX3RpdGxlIik7CiAgICAgICAgc2V0dXBUb3VjaEVuZEVuYWJsZUVkaXRpbmcoInpzc19lZGl0b3JfY29udGVudCIpOwoKICAgICAgICBjbGVhckh0bWxJZlRleHRJc0VtcHR5KCJ6c3NfZWRpdG9yX3RpdGxlIik7CiAgICAgICAgY2xlYXJIdG1sSWZUZXh0SXNFbXB0eSgienNzX2VkaXRvcl9jb250ZW50Iik7CgogICAgICAgICQoZG9jdW1lbnQpLm9uKCJzZWxlY3Rpb25jaGFuZ2UiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgY29uc29sZS5sb2coInNlbGVjdGlvbmNoYW5nZSIpOwogICAgICAgICAgenNzX2VkaXRvci5jYWxjdWxhdGVFZGl0b3JIZWlnaHRXaXRoQ2FyZXRQb3NpdGlvbigpOwogICAgICAgICAgenNzX2VkaXRvci5zZXRTY3JvbGxQb3NpdGlvbigpOwogICAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKGUpOwogICAgICAgICAgbm90aWZ5SWZTZWxlY3RlZFRleHRIYXNDaGFuZ2VkKCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdoZW4gd2UgdGFwIGFueXdoZXJlIGluIHRoZSBkb2N1bWVudCB3ZSBmb2N1cyBvbiB0aGUgZWRpdG9yCiAgICAgICAgJCh3aW5kb3cpLm9uKCJ0b3VjaG1vdmUiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgenNzX2VkaXRvci5pc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgIHpzc19lZGl0b3IudXBkYXRlU2Nyb2xsT2Zmc2V0ID0gdHJ1ZTsKICAgICAgICAgIHpzc19lZGl0b3Iuc2V0U2Nyb2xsUG9zaXRpb24oKTsKICAgICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcyhlKTsKICAgICAgICB9KTsKICAgICAgICAkKHdpbmRvdykub24oInRvdWNoc3RhcnQiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgenNzX2VkaXRvci5pc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgfSk7CiAgICAgICAgJCh3aW5kb3cpLm9uKCJzY3JvbGwiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgaWYgKHpzc19lZGl0b3IucGxhdGZvcm0gPT09ICJpb3MiKSB7CiAgICAgICAgICAgIHpzc19lZGl0b3IudXBkYXRlT2Zmc2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHNldHVwVG91Y2hFbmRGb2N1cygienNzX2VkaXRvcl90aXRsZSIpOwogICAgICAgIHNldHVwVG91Y2hFbmRGb2N1cygienNzX2VkaXRvcl9jb250ZW50Iik7CgogICAgICAgIHNldEN1cnJlbnRFZGl0aW5nTGlua09uVG91Y2goKTsKICAgICAgICBwcmV2ZW50TGlua0ZvbGxvd2luZ09uVG91Y2goKTsKCiAgICAgICAgd2hlblBhc3RpbmdJbnNlcnRBc1BsYWluVGV4dCgienNzX2VkaXRvcl90aXRsZSIpOwogICAgICAgIHdoZW5QYXN0aW5nSW5zZXJ0QXNQbGFpblRleHQoInpzc19lZGl0b3JfY29udGVudCIpOwoKICAgICAgICAvL3pzc19lZGl0b3IuZm9jdXNUaXRsZSgpOwoKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHdpbmRvdy5SZWFjdE5hdGl2ZVdlYlZpZXcucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAiWlNTX0lOSVRJQUxJWkVEIiB9KSk7CiAgICAgICAgfSwgMjApOwogICAgICB9OyAvL2VuZAoKICAgICAgZnVuY3Rpb24gbm90aWZ5SWZTZWxlY3RlZFRleHRIYXNDaGFuZ2VkKCkgewogICAgICAgIHZhciBzZWxlY3RlZFRleHRDaGFuZ2VNZXNzYWdlID0gSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZGF0YTogU3RyaW5nKGdldFNlbGVjdGlvbigpKSwKICAgICAgICAgIHR5cGU6ICJTRUxFQ1RFRF9URVhUX0NIQU5HRUQiLAogICAgICAgIH0pOwoKICAgICAgICBpZiAoc2VsZWN0ZWRUZXh0Q2hhbmdlTWVzc2FnZSAhPT0genNzX2VkaXRvci5wcmV2aW91c1NlbGVjdGVkVGV4dENoYW5nZU1lc3NhZ2UpIHsKICAgICAgICAgIHdpbmRvdy5SZWFjdE5hdGl2ZVdlYlZpZXcucG9zdE1lc3NhZ2Uoc2VsZWN0ZWRUZXh0Q2hhbmdlTWVzc2FnZSk7CiAgICAgICAgICB6c3NfZWRpdG9yLnByZXZpb3VzU2VsZWN0ZWRUZXh0Q2hhbmdlTWVzc2FnZSA9IHNlbGVjdGVkVGV4dENoYW5nZU1lc3NhZ2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiB3aGVuUGFzdGluZ0luc2VydEFzUGxhaW5UZXh0KGVkaXRvcklkKSB7CiAgICAgICAgdmFyIGVkaXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVkaXRvcklkKTsKICAgICAgICBlZGl0b3IuYWRkRXZlbnRMaXN0ZW5lcigicGFzdGUiLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgdmFyIHRleHQgPSBldmVudC5jbGlwYm9hcmREYXRhLmdldERhdGEoInRleHQvcGxhaW4iKTsKICAgICAgICAgIHZhciBodG1sID0gY29udmVydFRleHRUb0h0bWxXaXRoTGluZUJyZWFrcyh0ZXh0KTsKICAgICAgICAgIHpzc19lZGl0b3IuaW5zZXJ0SFRNTChodG1sKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY29udmVydFRleHRUb0h0bWxXaXRoTGluZUJyZWFrcyh0ZXh0KSB7CiAgICAgICAgdmFyIGh0bWwgPSBlbmNvZGVIdG1sRW50aXRpZXModGV4dCk7CiAgICAgICAgcmV0dXJuIHJlcGxhY2VOZXdsaW5lc1dpdGhMaW5lQnJlYWtzKGh0bWwpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBlbmNvZGVIdG1sRW50aXRpZXModGV4dCkgewogICAgICAgIHZhciBwYXJhZ3JhcGggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwIik7CiAgICAgICAgcGFyYWdyYXBoLnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgICByZXR1cm4gcGFyYWdyYXBoLmlubmVySFRNTDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcmVwbGFjZU5ld2xpbmVzV2l0aExpbmVCcmVha3MoaHRtbCkgewogICAgICAgIHJldHVybiBodG1sLnJlcGxhY2UoL1xyP1xuL2csICI8YnI+Iik7CiAgICAgIH0KCiAgICAgIHpzc19lZGl0b3IudXBkYXRlT2Zmc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghenNzX2VkaXRvci51cGRhdGVTY3JvbGxPZmZzZXQpIHJldHVybjsKCiAgICAgICAgdmFyIG9mZnNldFkgPSB3aW5kb3cuc2Nyb2xsWTsKCiAgICAgICAgdmFyIGZvb3RlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ6c3NfZWRpdG9yX2Zvb3RlciIpOwoKICAgICAgICB2YXIgbWF4T2Zmc2V0WSA9IGZvb3Rlci5vZmZzZXRUb3AgKyBmb290ZXIub2Zmc2V0SGVpZ2h0IC0genNzX2VkaXRvci5lZGl0b3JIZWlnaHQ7CiAgICAgICAgY29uc29sZS5sb2coInVwZGF0ZU9mZnNldCBnbyBob21lIDEgIiwgbWF4T2Zmc2V0WSwgb2Zmc2V0WSk7CgogICAgICAgIGlmIChtYXhPZmZzZXRZIDwgMCkgbWF4T2Zmc2V0WSA9IDA7CgogICAgICAgIGlmIChvZmZzZXRZID4gbWF4T2Zmc2V0WSkgewogICAgICAgICAgY29uc29sZS5sb2coInVwZGF0ZU9mZnNldCBnbyBob21lIDIgIiwgbWF4T2Zmc2V0WSk7CiAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgbWF4T2Zmc2V0WSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCJ1cGRhdGVPZmZzZXQgZ28gaG9tZSAzICIsIG1heE9mZnNldFkpOwogICAgICAgIH0KCiAgICAgICAgenNzX2VkaXRvci5zZXRTY3JvbGxQb3NpdGlvbigpOwogICAgICB9OwoKICAgICAgLy8gVGhpcyB3aWxsIHNob3cgdXAgaW4gdGhlIFhDb2RlIGNvbnNvbGUgYXMgd2UgYXJlIGFibGUgdG8gcHVzaCB0aGlzIGludG8gYW4gTlNMb2cuCiAgICAgIHpzc19lZGl0b3IuZGVidWcgPSBmdW5jdGlvbiAobXNnKSB7CiAgICAgICAgd2luZG93LlJlYWN0TmF0aXZlV2ViVmlldy5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICJMT0ciLCBkYXRhOiBtc2cgfSkpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRTY3JvbGxQb3NpdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgcG9zaXRpb24gPSB3aW5kb3cucGFnZVlPZmZzZXQ7CiAgICAgICAgd2luZG93LlJlYWN0TmF0aXZlV2ViVmlldy5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICJTQ1JPTEwiLCBkYXRhOiBwb3NpdGlvbiB9KSk7CiAgICAgIH07CgogICAgICBmdW5jdGlvbiBzZXRQbGFjZWhvbGRlcihlZGl0b3JJZCwgcGxhY2Vob2xkZXIpIHsKICAgICAgICB2YXIgZWRpdG9yID0gJCgiIyIgKyBlZGl0b3JJZCk7CgogICAgICAgIC8vc2V0IHBsYWNlSG9sZGVyCiAgICAgICAgZWRpdG9yLmF0dHIoInBsYWNlaG9sZGVyIiwgcGxhY2Vob2xkZXIpOwoKICAgICAgICAvL3NldCBmb2N1cwogICAgICAgIGVkaXRvci5mb2N1c291dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9ICQodGhpcyk7CiAgICAgICAgICBpZiAoIWVsZW1lbnQuaHRtbCgpLnRyaW0oKS5sZW5ndGgpIHsKICAgICAgICAgICAgZWxlbWVudC5lbXB0eSgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBnZXRPckNyZWF0ZUlucHV0RmllbGRzTGlzdCgpIHsKICAgICAgICBpZiAoJCgiI3pzc19lZGl0b3JfaW5wdXRfZmllbGRzX2xpc3QiKVswXSkgewogICAgICAgICAgcmV0dXJuICQoIiN6c3NfZWRpdG9yX2lucHV0X2ZpZWxkc19saXN0Iik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxldCBkaXYgPSAkKCIjenNzX2VkaXRvcl9pbnB1dF9maWVsZHMiKS5hZGRDbGFzcygienNzX2VkaXRvcl9tZXRhX2ZpZWxkcyIpOwogICAgICAgICAgZGl2LmFwcGVuZCgnPHVsIGlkPSJ6c3NfZWRpdG9yX2lucHV0X2ZpZWxkc19saXN0IiBjbGFzcz0ienNzX2VkaXRvcl91bCI+Jyk7CiAgICAgICAgICByZXR1cm4gJCgiI3pzc19lZGl0b3JfaW5wdXRfZmllbGRzX2xpc3QiKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHpzc19lZGl0b3IuYWRkUmVjaXBpZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHdpbmRvdy5SZWFjdE5hdGl2ZVdlYlZpZXcucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAiQUREX1JFQ0lQSUVOVCIgfSkpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5jYW5jZWxTY2hlZHVsZWRTZW5kID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgd2luZG93LlJlYWN0TmF0aXZlV2ViVmlldy5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICJDQU5DRUxfU0NIRURVTEVfU0VORCIgfSkpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5vcGVuU2NoZWR1bGVkU2VuZE1lbnUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2luZG93LlJlYWN0TmF0aXZlV2ViVmlldy5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICJPUEVOX1NDSEVEVUxFX01FTlUiIH0pKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3IuaW5zZXJ0SW5wdXRGaWVsZCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbGV0IHsgbGFiZWwsIHZhbHVlLCBlZGl0YWJsZSwgcGxhY2Vob2xkZXIsIG9uRm9jdXMsIGF1dG9Gb2N1cywga2V5LCBzY2hlZHVsZURhdGUgfSA9IGRhdGE7CgogICAgICAgIGxldCB1bCA9IGdldE9yQ3JlYXRlSW5wdXRGaWVsZHNMaXN0KCk7CiAgICAgICAgbGV0IGhhc0l0ZW1zID0gdWwuY2hpbGRyZW4oImxpIikubGVuZ3RoID4gMDsKICAgICAgICBsZXQgZWxlbWVudElEID0gYHpzc19lZGl0b3JfaW5wdXRfZmllbGRfJHtrZXl9YDsKCiAgICAgICAgbGV0IGlucHV0RWxTdHIgPSAnPGlucHV0IGNsYXNzPSJ6c3NfZWRpdG9yX2ZpZWxkX2lucHV0IiB0eXBlPSJ0ZXh0IiAnOwogICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgIGlucHV0RWxTdHIgKz0gYGlkPSIke2VsZW1lbnRJRH0iIGA7CiAgICAgICAgfQogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgaW5wdXRFbFN0ciArPSBgdmFsdWU9IiR7dmFsdWV9IiBgOwogICAgICAgIH0KICAgICAgICBpZiAocGxhY2Vob2xkZXIpIHsKICAgICAgICAgIGlucHV0RWxTdHIgKz0gYHBsYWNlaG9sZGVyPSIke3BsYWNlaG9sZGVyfSIgYDsKICAgICAgICB9CiAgICAgICAgaWYgKGVkaXRhYmxlID09PSBmYWxzZSkgewogICAgICAgICAgaW5wdXRFbFN0ciArPSAicmVhZG9ubHkiOwogICAgICAgIH0KICAgICAgICBpbnB1dEVsU3RyICs9ICI+IjsKICAgICAgICBpZiAoa2V5ID09PSAic2NoZWR1bGVfc2VuZF9maWVsZCIpIHsKICAgICAgICAgIGlmIChzY2hlZHVsZURhdGUpIHsKICAgICAgICAgICAgbGV0IHNjaGVkdWxlTGkgPSAkKAogICAgICAgICAgICAgICc8bGkgY2xhc3M9Inpzc19lZGl0b3JfZmllbGRfbGkgc2NoZWR1bGVfd3JhcHBlciIgb25jbGljaz0ienNzX2VkaXRvci5vcGVuU2NoZWR1bGVkU2VuZE1lbnUoKSI+ICcgKwogICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9InNjaGVkdWxlX2RhdGVfd3JhcHBlciI+JyArCiAgICAgICAgICAgICAgICAnPGltZyBjbGFzcz0iY2xvY2tfaWNvbiInICsKICAgICAgICAgICAgICAgICcgc3JjPSJodHRwczovL3Jlcy5jbG91ZGluYXJ5LmNvbS9ob25leWJvb2svaW1hZ2UvdXBsb2FkL3YxNjU4OTI5NzE0L3N5c3RlbV93ZWIvc3ZnX2ljb25zL2Nsb2NrLWZvcndhcmQtMTYuc3ZnIiBhbHQ9ImNsb2NrIi8+JyArCiAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9InNjaGVkdWxlZF90ZXh0Ij4gU0NIRURVTEVEIDwvc3Bhbj4nICsKICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz0ic2NoZWR1bGVkX2RhdGUiPicgKwogICAgICAgICAgICAgICAgc2NoZWR1bGVEYXRlICsKICAgICAgICAgICAgICAgICI8L3NwYW4+IiArCiAgICAgICAgICAgICAgICAiPC9kaXY+IiArCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0idHJhc2hfd3JhcHBlciI+JyArCiAgICAgICAgICAgICAgICAnPGltZyBzcmM9Imh0dHBzOi8vcmVzLmNsb3VkaW5hcnkuY29tL2hvbmV5Ym9vay9pbWFnZS91cGxvYWQvdjE2NTk5NjYwNzIvc3lzdGVtX3dlYi9zdmdfaWNvbnMvdHJhc2gtMjQuc3ZnIiBjbGFzcz0idHJhc2hfaWNvbiIgb25jbGljaz0ienNzX2VkaXRvci5jYW5jZWxTY2hlZHVsZWRTZW5kKGV2ZW50KSIgLz4nICsKICAgICAgICAgICAgICAgICI8L2Rpdj4iICsKICAgICAgICAgICAgICAgICsiPC9saT4iCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHVsLnByZXBlbmQoc2NoZWR1bGVMaSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxldCBsaSA9ICQoCiAgICAgICAgICAgICc8bGkgY2xhc3M9Inpzc19lZGl0b3JfZmllbGRfbGkiPicgKwogICAgICAgICAgICAgICc8bGFiZWwgY2xhc3M9Inpzc19lZGl0b3JfZmllbGRfbGFiZWwiPicgKwogICAgICAgICAgICAgIGxhYmVsICsKICAgICAgICAgICAgICAiPC9sYWJlbD4iICsKICAgICAgICAgICAgICBpbnB1dEVsU3RyICsKICAgICAgICAgICAgICAoZWRpdGFibGUgPyAiIiA6ICc8YnV0dG9uIGNsYXNzPSJjc3NDaXJjbGUgcGx1c1NpZ24iIG9uY2xpY2s9Inpzc19lZGl0b3IuYWRkUmVjaXBpZW50KCkiPiYjNDM7PC9idXR0b24+JykgKwogICAgICAgICAgICAgICI8L2xpPiIKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoaGFzSXRlbXMpIHsKICAgICAgICAgICAgbGkuYWRkQ2xhc3MoInpzc19lZGl0b3JfZmllbGRfc2VwYXJhdG9yIik7CiAgICAgICAgICB9CiAgICAgICAgICB1bC5hcHBlbmQobGkpOwogICAgICAgIH0KCiAgICAgICAgd2hlblBhc3RpbmdJbnNlcnRBc1BsYWluVGV4dChlbGVtZW50SUQpOwoKICAgICAgICBpZiAob25Gb2N1cykgewogICAgICAgICAgYWRkRm9jdXNFdmVudChlbGVtZW50SUQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgd2luZG93LlJlYWN0TmF0aXZlV2ViVmlldy5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeSh7IHR5cGU6ICJJTlBVVF9GSUVMRF9GT0NVU0VEIiwgZGF0YToga2V5IH0pKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGF1dG9Gb2N1cykgewogICAgICAgICAgJCgiIyIgKyBlbGVtZW50SUQpLmZvY3VzKCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRUaXRsZVBsYWNlaG9sZGVyID0gZnVuY3Rpb24gKHBsYWNlaG9sZGVyKSB7CiAgICAgICAgc2V0UGxhY2Vob2xkZXIoInpzc19lZGl0b3JfdGl0bGUiLCBwbGFjZWhvbGRlcik7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldENvbnRlbnRQbGFjZWhvbGRlciA9IGZ1bmN0aW9uIChwbGFjZWhvbGRlcikgewogICAgICAgIHNldFBsYWNlaG9sZGVyKCJ6c3NfZWRpdG9yX2NvbnRlbnQiLCBwbGFjZWhvbGRlcik7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldEZvb3RlckhlaWdodCA9IGZ1bmN0aW9uIChmb290ZXJIZWlnaHQpIHsKICAgICAgICB2YXIgZm9vdGVyID0gJCgiI3pzc19lZGl0b3JfZm9vdGVyIik7CiAgICAgICAgZm9vdGVyLmhlaWdodChmb290ZXJIZWlnaHQgKyAicHgiKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3IuZ2V0Q2FyZXRZUG9zaXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHpzc19lZGl0b3IucGxhdGZvcm0gPT0gImlvcyIpIHsKICAgICAgICAgIHZhciBzZWwgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICAvLyBOZXh0IGxpbmUgaXMgY29tZW50ZWQgdG8gcHJldmVudCBkZXNlbGVjdGluZyBzZWxlY3Rpb24uIEl0IGxvb2tzIGxpa2Ugd29yayBidXQgaWYgdGhlcmUgYXJlIGFueSBpc3N1ZXMgd2lsbCBhcHBlYXIgdGhlbiB1Y29ubW1lbnQgaXQgYXMgd2VsbCBhcyBjb2RlIGFib3ZlLgogICAgICAgICAgaWYgKHNlbC5yYW5nZUNvdW50ID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJhbmdlID0gc2VsLmdldFJhbmdlQXQoMCk7CiAgICAgICAgICB2YXIgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsgLy8gc29tZXRoaW5nIGhhcHBlbmluZyBoZXJlIHByZXZlbnRpbmcgc2VsZWN0aW9uIG9mIGVsZW1lbnRzCiAgICAgICAgICByYW5nZS5jb2xsYXBzZShmYWxzZSk7CiAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKHNwYW4pOwogICAgICAgICAgdmFyIHRvcFBvc2l0aW9uID0gc3Bhbi5vZmZzZXRUb3A7CiAgICAgICAgICBzcGFuLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc3Bhbik7CiAgICAgICAgICByZXR1cm4gdG9wUG9zaXRpb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICAvLyBOZXh0IGxpbmUgaXMgY29tZW50ZWQgdG8gcHJldmVudCBkZXNlbGVjdGluZyBzZWxlY3Rpb24uIEl0IGxvb2tzIGxpa2Ugd29yayBidXQgaWYgdGhlcmUgYXJlIGFueSBpc3N1ZXMgd2lsbCBhcHBlYXIgdGhlbiB1Y29ubW1lbnQgaXQgYXMgd2VsbCBhcyBjb2RlIGFib3ZlLgkgCQkJCXZhciByYW5nZSA9IHNlbGVjdGlvbi5nZXRSYW5nZUF0KDApOwogICAgICAgICAgLy9zZWwuY29sbGFwc2VUb1N0YXJ0KCk7CSAJCQkJdmFyIGNvbnRhaW5lciA9IHJhbmdlLmVuZENvbnRhaW5lcjsKICAgICAgICAgIHZhciByYW5nZSA9IHNlbC5nZXRSYW5nZUF0KDApOwogICAgICAgICAgdmFyIHNlbGVjdGVkTm9kZSA9IGNvbnRhaW5lci5ub2RlVHlwZSA9PT0gMyA/IGNvbnRhaW5lci5wYXJlbnROb2RlIDogY29udGFpbmVyOwogICAgICAgICAgdmFyIHNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7IC8vIHNvbWV0aGluZyBoYXBwZW5pbmcgaGVyZSBwcmV2ZW50aW5nIHNlbGVjdGlvbiBvZiBlbGVtZW50cwkgCQkJCXZhciBwb3NpdGlvbiA9IHNlbGVjdGVkTm9kZS5zZWxlY3Rpb25FbmQ7CiAgICAgICAgICByYW5nZS5jb2xsYXBzZShmYWxzZSk7CiAgICAgICAgICB2YXIgX2EgPSBnZXRNaXJyb3JJbmZvKHNlbGVjdGVkTm9kZSk7CiAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKHNwYW4pOwogICAgICAgICAgdmFyIGRpdiA9IF9hLmRpdjsKICAgICAgICAgIHZhciB0b3BQb3NpdGlvbiA9IHNwYW4ub2Zmc2V0VG9wOwogICAgICAgICAgdmFyIHNwYW4gPSBfYS5zcGFuOwogICAgICAgICAgc3Bhbi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNwYW4pOwogICAgICAgICAgdmFyIGNvbnRlbnQgPSBzZWxlY3RlZE5vZGUudGV4dENvbnRlbnQuc3Vic3RyaW5nKDAsIHBvc2l0aW9uKTsKICAgICAgICAgIHJldHVybiB0b3BQb3NpdGlvbjsKICAgICAgICAgIGRpdi50ZXh0Q29udGVudCA9IGNvbnRlbnQ7CiAgICAgICAgICBzcGFuLnRleHRDb250ZW50ID0gc2VsZWN0ZWROb2RlLnRleHRDb250ZW50LnN1YnN0cmluZyhwb3NpdGlvbikgfHwgIi4iOwogICAgICAgICAgZGl2LmFwcGVuZENoaWxkKHNwYW4pOwoKICAgICAgICAgIHZhciByZWN0ID0gc2VsZWN0ZWROb2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgdmFyIHRvcCA9IHNwYW4ub2Zmc2V0VG9wIC0gc2VsZWN0ZWROb2RlLnNjcm9sbFRvcCArIHJlY3QudG9wOwoKICAgICAgICAgIHJldHVybiB0b3A7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5jYWxjdWxhdGVFZGl0b3JIZWlnaHRXaXRoQ2FyZXRQb3NpdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyB2YXIgY2FyZXRZUG9zaXRpb24gPSB6c3NfZWRpdG9yLmdldENhcmV0WVBvc2l0aW9uKCk7CiAgICAgICAgLy8gaWYoIWNhcmV0WVBvc2l0aW9uKXsKICAgICAgICAvLyAJY29uc29sZS5sb2coInh6eCBnb2luZyBob21lIDEgISEhISIpCiAgICAgICAgLy8gCXdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAvLwogICAgICAgIC8vIH0KICAgICAgICAvLyB2YXIgbGluZUhlaWdodCA9IDIwOwogICAgICAgIC8vIHZhciBoYWxmTGluZUhlaWdodCA9IGxpbmVIZWlnaHQvMjsKICAgICAgICAvLyB2YXIgb2Zmc2V0WSA9IHdpbmRvdy5zY3JvbGxZOwogICAgICAgIC8vIHZhciBlZGl0b3JIZWlnaHQgPSB6c3NfZWRpdG9yLmVkaXRvckhlaWdodDsKICAgICAgICAvLyB2YXIgbmV3UG9zOwogICAgICAgIC8vCiAgICAgICAgLy8gdmFyIGZ1dHVyZUVkaXRvckhlaWdodCA9IGNhcmV0WVBvc2l0aW9uICsgbGluZUhlaWdodDsKICAgICAgICAvLwogICAgICAgIC8vIGNvbnNvbGUubG9nKCJ4enggQSAiLGxpbmVIZWlnaHQsaGFsZkxpbmVIZWlnaHQsb2Zmc2V0WSxlZGl0b3JIZWlnaHQsIGZ1dHVyZUVkaXRvckhlaWdodCApCiAgICAgICAgLy8KICAgICAgICAvLyBpZiAoY2FyZXRZUG9zaXRpb24gPCBvZmZzZXRZKSB7CiAgICAgICAgLy8gCW5ld1BvcyA9IGNhcmV0WVBvc2l0aW9uOwogICAgICAgIC8vIAljb25zb2xlLmxvZygieHp4IEIgIixuZXdQb3MpCiAgICAgICAgLy8gfSBlbHNlIGlmIChmdXR1cmVFZGl0b3JIZWlnaHQgPiBlZGl0b3JIZWlnaHQgKyBvZmZzZXRZKSB7CiAgICAgICAgLy8gCW5ld1BvcyA9IGZ1dHVyZUVkaXRvckhlaWdodCAtIGVkaXRvckhlaWdodCArIGhhbGZMaW5lSGVpZ2h0OwogICAgICAgIC8vIAljb25zb2xlLmxvZygieHp4IEMgIixuZXdQb3MpCiAgICAgICAgLy8gfWVsc2V7CiAgICAgICAgLy8gCWNvbnNvbGUubG9nKCJ4enggRCBOTyBQT1MiKQogICAgICAgIC8vIH0KICAgICAgICAvLwogICAgICAgIC8vIGlmIChuZXdQb3MpIHsKICAgICAgICAvLyAJY29uc29sZS5sb2coInh6eCBnb2luZyBob21lIDIgISEhISIsIG5ld1BvcykKICAgICAgICAvLwogICAgICAgIC8vIAl3aW5kb3cuc2Nyb2xsVG8oMCwgbmV3UG9zKTsKICAgICAgICAvLyB9CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLmJhY2t1cHJhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgdmFyIHJhbmdlID0gc2VsZWN0aW9uLmdldFJhbmdlQXQoMCk7CiAgICAgICAgenNzX2VkaXRvci5jdXJyZW50U2VsZWN0aW9uID0gewogICAgICAgICAgc3RhcnRDb250YWluZXI6IHJhbmdlLnN0YXJ0Q29udGFpbmVyLAogICAgICAgICAgc3RhcnRPZmZzZXQ6IHJhbmdlLnN0YXJ0T2Zmc2V0LAogICAgICAgICAgZW5kQ29udGFpbmVyOiByYW5nZS5lbmRDb250YWluZXIsCiAgICAgICAgICBlbmRPZmZzZXQ6IHJhbmdlLmVuZE9mZnNldCwKICAgICAgICB9OwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5yZXN0b3JlcmFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTsKICAgICAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgICAgICAgdmFyIHJhbmdlID0gZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKICAgICAgICByYW5nZS5zZXRTdGFydCh6c3NfZWRpdG9yLmN1cnJlbnRTZWxlY3Rpb24uc3RhcnRDb250YWluZXIsIHpzc19lZGl0b3IuY3VycmVudFNlbGVjdGlvbi5zdGFydE9mZnNldCk7CiAgICAgICAgcmFuZ2Uuc2V0RW5kKHpzc19lZGl0b3IuY3VycmVudFNlbGVjdGlvbi5lbmRDb250YWluZXIsIHpzc19lZGl0b3IuY3VycmVudFNlbGVjdGlvbi5lbmRPZmZzZXQpOwogICAgICAgIHNlbGVjdGlvbi5hZGRSYW5nZShyYW5nZSk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLmdldFNlbGVjdGVkTm9kZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbm9kZSwgc2VsZWN0aW9uOwogICAgICAgIGlmICh3aW5kb3cuZ2V0U2VsZWN0aW9uKSB7CiAgICAgICAgICBzZWxlY3Rpb24gPSBnZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIG5vZGUgPSBzZWxlY3Rpb24uYW5jaG9yTm9kZTsKICAgICAgICB9CiAgICAgICAgaWYgKCFub2RlICYmIGRvY3VtZW50LnNlbGVjdGlvbikgewogICAgICAgICAgc2VsZWN0aW9uID0gZG9jdW1lbnQuc2VsZWN0aW9uOwogICAgICAgICAgdmFyIHJhbmdlID0gc2VsZWN0aW9uLmdldFJhbmdlQXQgPyBzZWxlY3Rpb24uZ2V0UmFuZ2VBdCgwKSA6IHNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgbm9kZSA9IHJhbmdlLmNvbW1vbkFuY2VzdG9yQ29udGFpbmVyID8gcmFuZ2UuY29tbW9uQW5jZXN0b3JDb250YWluZXIgOiByYW5nZS5wYXJlbnRFbGVtZW50ID8gcmFuZ2UucGFyZW50RWxlbWVudCgpIDogcmFuZ2UuaXRlbSgwKTsKICAgICAgICB9CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLm5vZGVOYW1lID09ICIjdGV4dCIgPyBub2RlLnBhcmVudE5vZGUgOiBub2RlOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3Iuc2V0Qm9sZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiYm9sZCIsIGZhbHNlLCBudWxsKTsKICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3Iuc2V0SXRhbGljID0gZnVuY3Rpb24gKCkgewogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJpdGFsaWMiLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldFN1YnNjcmlwdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgic3Vic2NyaXB0IiwgZmFsc2UsIG51bGwpOwogICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRTdXBlcnNjcmlwdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgic3VwZXJzY3JpcHQiLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldFN0cmlrZVRocm91Z2ggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoInN0cmlrZVRocm91Z2giLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldFVuZGVybGluZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgidW5kZXJsaW5lIiwgZmFsc2UsIG51bGwpOwogICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRCbG9ja3F1b3RlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJmb3JtYXRCbG9jayIsIGZhbHNlLCAiPGJsb2NrcXVvdGU+Iik7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnJlbW92ZUZvcm1hdGluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgicmVtb3ZlRm9ybWF0IiwgZmFsc2UsIG51bGwpOwogICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRIb3Jpem9udGFsUnVsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiaW5zZXJ0SG9yaXpvbnRhbFJ1bGUiLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldEhlYWRpbmcgPSBmdW5jdGlvbiAoaGVhZGluZykgewogICAgICAgIHZhciBjdXJyZW50X3NlbGVjdGlvbiA9ICQoenNzX2VkaXRvci5nZXRTZWxlY3RlZE5vZGUoKSk7CiAgICAgICAgdmFyIHQgPSBjdXJyZW50X3NlbGVjdGlvbi5wcm9wKCJ0YWdOYW1lIikudG9Mb3dlckNhc2UoKTsKICAgICAgICB2YXIgaXNfaGVhZGluZyA9IHQgPT0gImgxIiB8fCB0ID09ICJoMiIgfHwgdCA9PSAiaDMiIHx8IHQgPT0gImg0IiB8fCB0ID09ICJoNSIgfHwgdCA9PSAiaDYiOwogICAgICAgIGlmIChpc19oZWFkaW5nICYmIGhlYWRpbmcgPT0gdCkgewogICAgICAgICAgLy92YXIgYyA9IGN1cnJlbnRfc2VsZWN0aW9uLmh0bWwoKTsKICAgICAgICAgIC8vY3VycmVudF9zZWxlY3Rpb24ucmVwbGFjZVdpdGgoYyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJmb3JtYXRCbG9jayIsIGZhbHNlLCAiPCIgKyBoZWFkaW5nICsgIj4iKTsKICAgICAgICB9CgogICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRQYXJhZ3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGN1cnJlbnRfc2VsZWN0aW9uID0gJCh6c3NfZWRpdG9yLmdldFNlbGVjdGVkTm9kZSgpKTsKICAgICAgICB2YXIgdCA9IGN1cnJlbnRfc2VsZWN0aW9uLnByb3AoInRhZ05hbWUiKS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHZhciBpc19wYXJhZ3JhcGggPSB0ID09ICJwIjsKICAgICAgICBpZiAoaXNfcGFyYWdyYXBoKSB7CiAgICAgICAgICB2YXIgYyA9IGN1cnJlbnRfc2VsZWN0aW9uLmh0bWwoKTsKICAgICAgICAgIGN1cnJlbnRfc2VsZWN0aW9uLnJlcGxhY2VXaXRoKGMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiZm9ybWF0QmxvY2siLCBmYWxzZSwgIjxwPiIpOwogICAgICAgIH0KCiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICAvLyBOZWVkIHdheSB0byByZW1vdmUgZm9ybWF0QmxvY2sKICAgICAgY29uc29sZS5sb2coIldBUk5JTkc6IFdlIG5lZWQgYSB3YXkgdG8gcmVtb3ZlIGZvcm1hdEJsb2NrIGl0ZW1zIik7CgogICAgICB6c3NfZWRpdG9yLnVuZG8gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoInVuZG8iLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnJlZG8gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoInJlZG8iLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldE9yZGVyZWRMaXN0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJpbnNlcnRPcmRlcmVkTGlzdCIsIGZhbHNlLCBudWxsKTsKICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3Iuc2V0VW5vcmRlcmVkTGlzdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiaW5zZXJ0VW5vcmRlcmVkTGlzdCIsIGZhbHNlLCBudWxsKTsKICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3Iuc2V0SnVzdGlmeUNlbnRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgianVzdGlmeUNlbnRlciIsIGZhbHNlLCBudWxsKTsKICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3Iuc2V0SnVzdGlmeUZ1bGwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoImp1c3RpZnlGdWxsIiwgZmFsc2UsIG51bGwpOwogICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRKdXN0aWZ5TGVmdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgianVzdGlmeUxlZnQiLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldEp1c3RpZnlSaWdodCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgianVzdGlmeVJpZ2h0IiwgZmFsc2UsIG51bGwpOwogICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRJbmRlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoImluZGVudCIsIGZhbHNlLCBudWxsKTsKICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3Iuc2V0T3V0ZGVudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgib3V0ZGVudCIsIGZhbHNlLCBudWxsKTsKICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3Iuc2V0Rm9udEZhbWlseSA9IGZ1bmN0aW9uIChmb250RmFtaWx5KSB7CiAgICAgICAgenNzX2VkaXRvci5yZXN0b3JlcmFuZ2UoKTsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgic3R5bGVXaXRoQ1NTIiwgbnVsbCwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoImZvbnROYW1lIiwgZmFsc2UsIGZvbnRGYW1pbHkpOwogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJzdHlsZVdpdGhDU1MiLCBudWxsLCBmYWxzZSk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldFRleHRDb2xvciA9IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIGlmICh6c3NfZWRpdG9yLmN1cnJlbnRTZWxlY3Rpb24pIHsKICAgICAgICAgIHpzc19lZGl0b3IucmVzdG9yZXJhbmdlKCk7CiAgICAgICAgfQogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJzdHlsZVdpdGhDU1MiLCBudWxsLCB0cnVlKTsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiZm9yZUNvbG9yIiwgZmFsc2UsIGNvbG9yKTsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgic3R5bGVXaXRoQ1NTIiwgbnVsbCwgZmFsc2UpOwogICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcygpOwogICAgICAgIC8vIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJyZW1vdmVGb3JtYXQiLCBmYWxzZSwgImZvcmVDb2xvciIpOyAvLyBSZW1vdmVzIGp1c3QgZm9yZUNvbG9yCiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldEJhY2tncm91bmRDb2xvciA9IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIGlmICh6c3NfZWRpdG9yLmN1cnJlbnRTZWxlY3Rpb24pIHsKICAgICAgICAgIHpzc19lZGl0b3IucmVzdG9yZXJhbmdlKCk7CiAgICAgICAgfQogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJzdHlsZVdpdGhDU1MiLCBudWxsLCB0cnVlKTsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiaGlsaXRlQ29sb3IiLCBmYWxzZSwgY29sb3IpOwogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJzdHlsZVdpdGhDU1MiLCBudWxsLCBmYWxzZSk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICAvLyBOZWVkcyBhZGRDbGFzcyBtZXRob2QKCiAgICAgIHpzc19lZGl0b3IuaW5zZXJ0TGluayA9IGZ1bmN0aW9uICh1cmwsIHRpdGxlKSB7CiAgICAgICAgenNzX2VkaXRvci5yZXN0b3JlcmFuZ2UoKTsKICAgICAgICB2YXIgc2VsID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgc2VsLmRlbGV0ZUZyb21Eb2N1bWVudCgpOwogICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJpbnNlcnRIVE1MIiwgZmFsc2UsICc8YSBocmVmPSInICsgZW5jb2RlSHRtbEVudGl0aWVzKHVybCkgKyAnIj4nICsgZW5jb2RlSHRtbEVudGl0aWVzKHRpdGxlKSArICI8L2E+Iik7CgogICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci51cGRhdGVMaW5rID0gZnVuY3Rpb24gKHVybCwgdGl0bGUpIHsKICAgICAgICB6c3NfZWRpdG9yLnJlc3RvcmVyYW5nZSgpOwoKICAgICAgICBpZiAoenNzX2VkaXRvci5jdXJyZW50RWRpdGluZ0xpbmspIHsKICAgICAgICAgIHZhciBjID0genNzX2VkaXRvci5jdXJyZW50RWRpdGluZ0xpbms7CiAgICAgICAgICBjLmF0dHIoImhyZWYiLCB1cmwpOwogICAgICAgICAgYy50ZXh0KHRpdGxlKTsKICAgICAgICB9CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07IC8vZW5kCgogICAgICB6c3NfZWRpdG9yLnVwZGF0ZUltYWdlID0gZnVuY3Rpb24gKHVybCwgYWx0KSB7CiAgICAgICAgenNzX2VkaXRvci5yZXN0b3JlcmFuZ2UoKTsKCiAgICAgICAgaWYgKHpzc19lZGl0b3IuY3VycmVudEVkaXRpbmdJbWFnZSkgewogICAgICAgICAgdmFyIGMgPSB6c3NfZWRpdG9yLmN1cnJlbnRFZGl0aW5nSW1hZ2U7CiAgICAgICAgICBjLmF0dHIoInNyYyIsIHVybCk7CiAgICAgICAgICBjLmF0dHIoImFsdCIsIGFsdCk7CiAgICAgICAgfQogICAgICAgIHpzc19lZGl0b3IuZW5hYmxlZEVkaXRpbmdJdGVtcygpOwogICAgICB9OyAvL2VuZAoKICAgICAgenNzX2VkaXRvci51cGRhdGVJbWFnZUJhc2U2NFN0cmluZyA9IGZ1bmN0aW9uIChpbWFnZUJhc2U2NFN0cmluZywgYWx0KSB7CiAgICAgICAgenNzX2VkaXRvci5yZXN0b3JlcmFuZ2UoKTsKCiAgICAgICAgaWYgKHpzc19lZGl0b3IuY3VycmVudEVkaXRpbmdJbWFnZSkgewogICAgICAgICAgdmFyIGMgPSB6c3NfZWRpdG9yLmN1cnJlbnRFZGl0aW5nSW1hZ2U7CiAgICAgICAgICB2YXIgc3JjID0gImRhdGE6aW1hZ2UvanBlZztiYXNlNjQsIiArIGltYWdlQmFzZTY0U3RyaW5nOwogICAgICAgICAgYy5hdHRyKCJzcmMiLCBzcmMpOwogICAgICAgICAgYy5hdHRyKCJhbHQiLCBhbHQpOwogICAgICAgIH0KICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoKTsKICAgICAgfTsgLy9lbmQKCiAgICAgIHpzc19lZGl0b3IudW5saW5rID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh6c3NfZWRpdG9yLmN1cnJlbnRFZGl0aW5nTGluaykgewogICAgICAgICAgdmFyIGMgPSB6c3NfZWRpdG9yLmN1cnJlbnRFZGl0aW5nTGluazsKICAgICAgICAgIGMuY29udGVudHMoKS51bndyYXAoKTsKICAgICAgICB9CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnF1aWNrTGluayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgc2VsID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgdmFyIGxpbmtfdXJsID0gIiI7CiAgICAgICAgdmFyIHRlc3QgPSBuZXcgU3RyaW5nKHNlbCk7CiAgICAgICAgdmFyIG1haWxyZWdleHAgPSBuZXcgUmVnRXhwKCJeKC4rKShcQCkoLispJCIsICJnaSIpOwogICAgICAgIGlmICh0ZXN0LnNlYXJjaChtYWlscmVnZXhwKSA9PSAtMSkgewogICAgICAgICAgY2hlY2todHRwbGluayA9IG5ldyBSZWdFeHAoIl5odHRwXDpcL1wvIiwgImdpIik7CiAgICAgICAgICBpZiAodGVzdC5zZWFyY2goY2hlY2todHRwbGluaykgPT0gLTEpIHsKICAgICAgICAgICAgY2hlY2thbmNob3JsaW5rID0gbmV3IFJlZ0V4cCgiXlwjIiwgImdpIik7CiAgICAgICAgICAgIGlmICh0ZXN0LnNlYXJjaChjaGVja2FuY2hvcmxpbmspID09IC0xKSB7CiAgICAgICAgICAgICAgbGlua191cmwgPSAiaHR0cDovLyIgKyBzZWw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGlua191cmwgPSBzZWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtfdXJsID0gc2VsOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVja21haWxsaW5rID0gbmV3IFJlZ0V4cCgiXm1haWx0b1w6IiwgImdpIik7CiAgICAgICAgICBpZiAodGVzdC5zZWFyY2goY2hlY2ttYWlsbGluaykgPT0gLTEpIHsKICAgICAgICAgICAgbGlua191cmwgPSAibWFpbHRvOiIgKyBzZWw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rX3VybCA9IHNlbDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBodG1sX2NvZGUgPSAnPGEgaHJlZj0iJyArIGVuY29kZUh0bWxFbnRpdGllcyhsaW5rX3VybCkgKyAnIj4nICsgZW5jb2RlSHRtbEVudGl0aWVzKHNlbCkgKyAiPC9hPiI7CiAgICAgICAgenNzX2VkaXRvci5pbnNlcnRIVE1MKGh0bWxfY29kZSk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnByZXBhcmVJbnNlcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgenNzX2VkaXRvci5iYWNrdXByYW5nZSgpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5pbnNlcnRJbWFnZSA9IGZ1bmN0aW9uIChhdHRyaWJ1dGVzKSB7CiAgICAgICAgenNzX2VkaXRvci5yZXN0b3JlcmFuZ2UoKTsKICAgICAgICB2YXIgaW1hZ2VDb250YWluZXIgPSAkKCI8ZGl2PjxpbWc+PC9kaXY+Iik7CiAgICAgICAgaW1hZ2VDb250YWluZXIuZmluZCgiaW1nIikuYXR0cihhdHRyaWJ1dGVzKTsKICAgICAgICB6c3NfZWRpdG9yLmluc2VydEhUTUwoIjxicj4iICsgaW1hZ2VDb250YWluZXIuaHRtbCgpICsgIjxicj4iKTsKICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3IuaW5zZXJ0SW1hZ2VCYXNlNjRTdHJpbmcgPSBmdW5jdGlvbiAoaW1hZ2VCYXNlNjRTdHJpbmcsIGFsdCkgewogICAgICAgIHpzc19lZGl0b3IucmVzdG9yZXJhbmdlKCk7CiAgICAgICAgdmFyIGh0bWwgPSAnPGltZyBzcmM9ImRhdGE6aW1hZ2UvanBlZztiYXNlNjQsJyArIGVuY29kZUh0bWxFbnRpdGllcyhpbWFnZUJhc2U2NFN0cmluZykgKyAnIiBhbHQ9IicgKyBlbmNvZGVIdG1sRW50aXRpZXMoYWx0KSArICciIC8+JzsKICAgICAgICB6c3NfZWRpdG9yLmluc2VydEhUTUwoaHRtbCk7CiAgICAgICAgenNzX2VkaXRvci5lbmFibGVkRWRpdGluZ0l0ZW1zKCk7CiAgICAgIH07CgogICAgICBmdW5jdGlvbiBzZXRIVE1MKGVkaXRvcklkLCBodG1sKSB7CiAgICAgICAgdmFyIGVkaXRvciA9ICQoIiMiICsgZWRpdG9ySWQpOwogICAgICAgIGVkaXRvci5odG1sKGh0bWwpOwogICAgICB9CgogICAgICB6c3NfZWRpdG9yLnNldFRpdGxlSFRNTCA9IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgICAgc2V0SFRNTCgienNzX2VkaXRvcl90aXRsZSIsIGh0bWwpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci50b2dnbGVUaXRsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAkKCIjenNzX2VkaXRvcl90aXRsZSIpLnRvZ2dsZSgpOwogICAgICAgICQoIiNzZXBhcmF0b3JDb250YWluZXIiKS50b2dnbGUoKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3IuZW5hYmxlT25DaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgJCgiI3pzc19lZGl0b3JfY29udGVudCIpLm9uKCJpbnB1dCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHdpbmRvdy5SZWFjdE5hdGl2ZVdlYlZpZXcucG9zdE1lc3NhZ2UoCiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICB0eXBlOiAiQ09OVEVOVF9DSEFOR0UiLAogICAgICAgICAgICAgIGRhdGE6IHsgY29udGVudDogZ2V0SHRtbCgienNzX2VkaXRvcl9jb250ZW50IikgfSwKICAgICAgICAgICAgfSkKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLmhpZGVUaXRsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAkKCIjenNzX2VkaXRvcl90aXRsZSIpLmhpZGUoKTsKICAgICAgICAkKCIjc2VwYXJhdG9yQ29udGFpbmVyIikuaGlkZSgpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zaG93VGl0bGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgJCgiI3pzc19lZGl0b3JfdGl0bGUiKS5zaG93KCk7CiAgICAgICAgJCgiI3NlcGFyYXRvckNvbnRhaW5lciIpLnNob3coKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3Iuc2V0Q29udGVudEhUTUwgPSBmdW5jdGlvbiAoaHRtbCkgewogICAgICAgIHNldEhUTUwoInpzc19lZGl0b3JfY29udGVudCIsIGh0bWwpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5pbnNlcnRIVE1MID0gZnVuY3Rpb24gKGh0bWwpIHsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgiaW5zZXJ0SFRNTCIsIGZhbHNlLCBodG1sKTsKICAgICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMoKTsKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIGdldEh0bWwoZWRpdG9ySWQpIHsKICAgICAgICAvLyBJbWFnZXMKICAgICAgICB2YXIgaW1nID0gJCgiaW1nIik7CiAgICAgICAgaWYgKGltZy5sZW5ndGggIT0gMCkgewogICAgICAgICAgJCgiaW1nIikucmVtb3ZlQ2xhc3MoInpzX2FjdGl2ZSIpOwogICAgICAgICAgJCgiaW1nIikuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGUpIHsKICAgICAgICAgICAgdmFyIGltYWdlID0gJCh0aGlzKTsKICAgICAgICAgICAgdmFyIHpzX2NsYXNzID0gaW1hZ2UuYXR0cigiY2xhc3MiKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiB6c19jbGFzcyAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGlmICh6c19jbGFzcyA9PSAiIikgewogICAgICAgICAgICAgICAgaW1hZ2UucmVtb3ZlQXR0cigiY2xhc3MiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gQmxvY2txdW90ZQogICAgICAgIHZhciBicSA9ICQoImJsb2NrcXVvdGUiKTsKICAgICAgICBpZiAoYnEubGVuZ3RoICE9IDApIHsKICAgICAgICAgIGJxLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYiA9ICQodGhpcyk7CiAgICAgICAgICAgIGlmIChiLmNzcygiYm9yZGVyIikuaW5kZXhPZigibm9uZSIpICE9IC0xKSB7CiAgICAgICAgICAgICAgYi5jc3MoeyBib3JkZXI6ICIiIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChiLmNzcygicGFkZGluZyIpLmluZGV4T2YoIjBweCIpICE9IC0xKSB7CiAgICAgICAgICAgICAgYi5jc3MoeyBwYWRkaW5nOiAiIiB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBHZXQgdGhlIGNvbnRlbnRzCiAgICAgICAgdmFyIGggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlZGl0b3JJZCkuaW5uZXJIVE1MOwoKICAgICAgICByZXR1cm4gaDsKICAgICAgfQoKICAgICAgenNzX2VkaXRvci5nZXRUaXRsZUhUTUwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGdldEh0bWwoInpzc19lZGl0b3JfdGl0bGUiKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3IuZ2V0Q29udGVudEhUTUwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGdldEh0bWwoInpzc19lZGl0b3JfY29udGVudCIpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5nZXRJbnB1dEZpZWxkVGV4dCA9IGZ1bmN0aW9uIChmaWVsZEtleSkgewogICAgICAgIGxldCBpbnB1dCA9ICQoYCN6c3NfZWRpdG9yX2lucHV0X2ZpZWxkXyR7ZmllbGRLZXl9YClbMF07CiAgICAgICAgaWYgKGlucHV0KSB7CiAgICAgICAgICByZXR1cm4gaW5wdXQudmFsdWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRJbnB1dEZpZWxkVGV4dCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbGV0IHsga2V5LCB0ZXh0IH0gPSBkYXRhOwogICAgICAgIGxldCBpbnB1dCA9ICQoYCN6c3NfZWRpdG9yX2lucHV0X2ZpZWxkXyR7a2V5fWApWzBdOwogICAgICAgIGlmIChpbnB1dCkgewogICAgICAgICAgaW5wdXQudmFsdWUgPSB0ZXh0OwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3IuZm9jdXNJbnB1dEZpZWxkID0gZnVuY3Rpb24gKGZpZWxkS2V5KSB7CiAgICAgICAgJChgI3pzc19lZGl0b3JfaW5wdXRfZmllbGRfJHtmaWVsZEtleX1gKS5mb2N1cygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5nZXRUaXRsZVRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICQoIiN6c3NfZWRpdG9yX3RpdGxlIikudGV4dCgpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5nZXRDb250ZW50VGV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gJCgiI3pzc19lZGl0b3JfY29udGVudCIpLnRleHQoKTsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3IuaXNDb21tYW5kRW5hYmxlZCA9IGZ1bmN0aW9uIChjb21tYW5kTmFtZSkgewogICAgICAgIHJldHVybiBkb2N1bWVudC5xdWVyeUNvbW1hbmRTdGF0ZShjb21tYW5kTmFtZSk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLmVuYWJsZWRFZGl0aW5nSXRlbXMgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIGNvbnNvbGUubG9nKCJlbmFibGVkRWRpdGluZ0l0ZW1zIik7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgaWYgKHpzc19lZGl0b3IuaXNDb21tYW5kRW5hYmxlZCgiYm9sZCIpKSB7CiAgICAgICAgICBpdGVtcy5wdXNoKCJib2xkIik7CiAgICAgICAgfQogICAgICAgIGlmICh6c3NfZWRpdG9yLmlzQ29tbWFuZEVuYWJsZWQoIml0YWxpYyIpKSB7CiAgICAgICAgICBpdGVtcy5wdXNoKCJpdGFsaWMiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHpzc19lZGl0b3IuaXNDb21tYW5kRW5hYmxlZCgic3Vic2NyaXB0IikpIHsKICAgICAgICAgIGl0ZW1zLnB1c2goInN1YnNjcmlwdCIpOwogICAgICAgIH0KICAgICAgICBpZiAoenNzX2VkaXRvci5pc0NvbW1hbmRFbmFibGVkKCJzdXBlcnNjcmlwdCIpKSB7CiAgICAgICAgICBpdGVtcy5wdXNoKCJzdXBlcnNjcmlwdCIpOwogICAgICAgIH0KICAgICAgICBpZiAoenNzX2VkaXRvci5pc0NvbW1hbmRFbmFibGVkKCJzdHJpa2VUaHJvdWdoIikpIHsKICAgICAgICAgIGl0ZW1zLnB1c2goInN0cmlrZVRocm91Z2giKTsKICAgICAgICB9CiAgICAgICAgaWYgKHpzc19lZGl0b3IuaXNDb21tYW5kRW5hYmxlZCgidW5kZXJsaW5lIikpIHsKICAgICAgICAgIGl0ZW1zLnB1c2goInVuZGVybGluZSIpOwogICAgICAgIH0KICAgICAgICBpZiAoenNzX2VkaXRvci5pc0NvbW1hbmRFbmFibGVkKCJpbnNlcnRPcmRlcmVkTGlzdCIpKSB7CiAgICAgICAgICBpdGVtcy5wdXNoKCJvcmRlcmVkTGlzdCIpOwogICAgICAgIH0KICAgICAgICBpZiAoenNzX2VkaXRvci5pc0NvbW1hbmRFbmFibGVkKCJpbnNlcnRVbm9yZGVyZWRMaXN0IikpIHsKICAgICAgICAgIGl0ZW1zLnB1c2goInVub3JkZXJlZExpc3QiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHpzc19lZGl0b3IuaXNDb21tYW5kRW5hYmxlZCgianVzdGlmeUNlbnRlciIpKSB7CiAgICAgICAgICBpdGVtcy5wdXNoKCJqdXN0aWZ5Q2VudGVyIik7CiAgICAgICAgfQogICAgICAgIGlmICh6c3NfZWRpdG9yLmlzQ29tbWFuZEVuYWJsZWQoImp1c3RpZnlGdWxsIikpIHsKICAgICAgICAgIGl0ZW1zLnB1c2goImp1c3RpZnlGdWxsIik7CiAgICAgICAgfQogICAgICAgIGlmICh6c3NfZWRpdG9yLmlzQ29tbWFuZEVuYWJsZWQoImp1c3RpZnlMZWZ0IikpIHsKICAgICAgICAgIGl0ZW1zLnB1c2goImp1c3RpZnlMZWZ0Iik7CiAgICAgICAgfQogICAgICAgIGlmICh6c3NfZWRpdG9yLmlzQ29tbWFuZEVuYWJsZWQoImp1c3RpZnlSaWdodCIpKSB7CiAgICAgICAgICBpdGVtcy5wdXNoKCJqdXN0aWZ5UmlnaHQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHpzc19lZGl0b3IuaXNDb21tYW5kRW5hYmxlZCgiaW5zZXJ0SG9yaXpvbnRhbFJ1bGUiKSkgewogICAgICAgICAgaXRlbXMucHVzaCgiaG9yaXpvbnRhbFJ1bGUiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGZvcm1hdEJsb2NrID0gZG9jdW1lbnQucXVlcnlDb21tYW5kVmFsdWUoImZvcm1hdEJsb2NrIik7CiAgICAgICAgaWYgKGZvcm1hdEJsb2NrLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGl0ZW1zLnB1c2goZm9ybWF0QmxvY2spOwogICAgICAgIH0KICAgICAgICAvLyBJbWFnZXMKICAgICAgICAkKCJpbWciKS5iaW5kKCJ0b3VjaHN0YXJ0IiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICQoImltZyIpLnJlbW92ZUNsYXNzKCJ6c19hY3RpdmUiKTsKICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoInpzX2FjdGl2ZSIpOwogICAgICAgIH0pOwoKICAgICAgICAkKCIudHJhc2hfaWNvbiIpLmJpbmQoInRvdWNoc3RhcnQiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygidHJhc2hfaWNvbl9hY3RpdmUiKTsKICAgICAgICB9KTsKICAgICAgICAkKCIudHJhc2hfaWNvbiIpLmJpbmQoInRvdWNoZW5kIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3MoInRyYXNoX2ljb25fYWN0aXZlIik7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFVzZSBqUXVlcnkgdG8gZmlndXJlIG91dCB0aG9zZSB0aGF0IGFyZSBub3Qgc3VwcG9ydGVkCiAgICAgICAgaWYgKHR5cGVvZiBlICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAvLyBUaGUgdGFyZ2V0IGVsZW1lbnQKICAgICAgICAgIHZhciBzID0genNzX2VkaXRvci5nZXRTZWxlY3RlZE5vZGUoKTsKICAgICAgICAgIHZhciB0ID0gJChzKTsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGUudGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgLy8gQmFja2dyb3VuZCBDb2xvcgogICAgICAgICAgdmFyIGJnQ29sb3IgPSB0LmNzcygiYmFja2dyb3VuZENvbG9yIik7CiAgICAgICAgICBpZiAoYmdDb2xvciAmJiBiZ0NvbG9yLmxlbmd0aCAhPSAwICYmIGJnQ29sb3IgIT0gInJnYmEoMCwgMCwgMCwgMCkiICYmIGJnQ29sb3IgIT0gInJnYigwLCAwLCAwKSIgJiYgYmdDb2xvciAhPSAidHJhbnNwYXJlbnQiKSB7CiAgICAgICAgICAgIGl0ZW1zLnB1c2goImJhY2tncm91bmRDb2xvciIpOwogICAgICAgICAgfQogICAgICAgICAgLy8gVGV4dCBDb2xvcgogICAgICAgICAgdmFyIHRleHRDb2xvciA9IHQuY3NzKCJjb2xvciIpOwogICAgICAgICAgaWYgKHRleHRDb2xvciAmJiB0ZXh0Q29sb3IubGVuZ3RoICE9IDAgJiYgdGV4dENvbG9yICE9ICJyZ2JhKDAsIDAsIDAsIDApIiAmJiB0ZXh0Q29sb3IgIT0gInJnYigwLCAwLCAwKSIgJiYgdGV4dENvbG9yICE9ICJ0cmFuc3BhcmVudCIpIHsKICAgICAgICAgICAgaXRlbXMucHVzaCgidGV4dENvbG9yIik7CiAgICAgICAgICB9CgogICAgICAgICAgLy9Gb250cwogICAgICAgICAgdmFyIGZvbnQgPSB0LmNzcygiZm9udC1mYW1pbHkiKTsKICAgICAgICAgIGlmIChmb250ICYmIGZvbnQubGVuZ3RoICE9IDAgJiYgZm9udCAhPSAiQXJpYWwsIEhlbHZldGljYSwgc2Fucy1zZXJpZiIpIHsKICAgICAgICAgICAgaXRlbXMucHVzaCgiZm9udHMiKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBCbG9ja3F1b3RlCiAgICAgICAgICBpZiAobm9kZU5hbWUgPT0gImJsb2NrcXVvdGUiKSB7CiAgICAgICAgICAgIGl0ZW1zLnB1c2goImluZGVudCIpOwogICAgICAgICAgfQogICAgICAgICAgLy8gSW1hZ2UKICAgICAgICAgIGlmIChub2RlTmFtZSA9PSAiaW1nIikgewogICAgICAgICAgICB6c3NfZWRpdG9yLmN1cnJlbnRFZGl0aW5nSW1hZ2UgPSB0OwogICAgICAgICAgICBpdGVtcy5wdXNoKCJpbWFnZToiICsgdC5hdHRyKCJzcmMiKSk7CiAgICAgICAgICAgIGlmICh0LmF0dHIoImFsdCIpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBpdGVtcy5wdXNoKCJpbWFnZS1hbHQ6IiArIHQuYXR0cigiYWx0IikpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB6c3NfZWRpdG9yLmN1cnJlbnRFZGl0aW5nSW1hZ2UgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbm90aWZ5SWZTZWxlY3Rpb25IYXNDaGFuZ2VkKGl0ZW1zKTsKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIG5vdGlmeUlmU2VsZWN0aW9uSGFzQ2hhbmdlZChpdGVtcykgewogICAgICAgIHZhciBzZWxlY3Rpb25DaGFuZ2VNZXNzYWdlID0gSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZGF0YTogeyBpdGVtczogaXRlbXMgfSwKICAgICAgICAgIHR5cGU6ICJTRUxFQ1RJT05fQ0hBTkdFIiwKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHNlbGVjdGlvbkNoYW5nZU1lc3NhZ2UgIT09IHpzc19lZGl0b3IucHJldmlvdXNTZWxlY3Rpb25DaGFuZ2VNZXNzYWdlKSB7CiAgICAgICAgICB3aW5kb3cuUmVhY3ROYXRpdmVXZWJWaWV3LnBvc3RNZXNzYWdlKHNlbGVjdGlvbkNoYW5nZU1lc3NhZ2UpOwogICAgICAgICAgenNzX2VkaXRvci5wcmV2aW91c1NlbGVjdGlvbkNoYW5nZU1lc3NhZ2UgPSBzZWxlY3Rpb25DaGFuZ2VNZXNzYWdlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgenNzX2VkaXRvci5mb2N1c0NvbnRlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgJCgiI3pzc19lZGl0b3JfY29udGVudCIpLmZvY3VzKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLmZvY3VzVGl0bGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgJCgiI3pzc19lZGl0b3JfdGl0bGUiKS5mb2N1cygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5mb2N1c0VkaXRvciA9IGZ1bmN0aW9uIChlZGl0b3JJZCkgewogICAgICAgIC8vIHRoZSBmb2xsb3dpbmcgd2FzIHRha2VuIGZyb20gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xMTI1MjkyL2hvdy10by1tb3ZlLWN1cnNvci10by1lbmQtb2YtY29udGVudGVkaXRhYmxlLWVudGl0eS8zODY2NDQyIzM4NjY0NDIKICAgICAgICAvLyBhbmQgZW5zdXJlcyB3ZSBtb3ZlIHRoZSBjdXJzb3IgdG8gdGhlIGVuZCBvZiB0aGUgZWRpdG9yCiAgICAgICAgdmFyIGVkaXRvciA9ICQoIiMiICsgZWRpdG9ySWQpOwogICAgICAgIHZhciByYW5nZSA9IGRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgcmFuZ2Uuc2VsZWN0Tm9kZUNvbnRlbnRzKGVkaXRvci5nZXQoMCkpOwogICAgICAgIHJhbmdlLmNvbGxhcHNlKGZhbHNlKTsKICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luZG93LmdldFNlbGVjdGlvbigpOwogICAgICAgIHNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTsKICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2UpOwogICAgICAgIGVkaXRvci5mb2N1cygpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5ibHVyVGl0bGVFZGl0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgJCgiI3pzc19lZGl0b3JfdGl0bGUiKS5ibHVyKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLmJsdXJDb250ZW50RWRpdG9yID0gZnVuY3Rpb24gKCkgewogICAgICAgICQoIiN6c3NfZWRpdG9yX2NvbnRlbnQiKS5ibHVyKCk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLmRlbGV0ZVNjaGVkdWxlU2VuZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLnJlbW92ZUVsZW1lbnRCeUNsYXNzKCJzY2hlZHVsZV93cmFwcGVyIik7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldFNjaGVkdWxlU2VuZERhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxldCB7IHNjaGVkdWxlRGF0ZSB9ID0gZGF0YTsKICAgICAgICBsZXQgZGF0ZVNwYW4gPSAkKCIuc2NoZWR1bGVkX2RhdGUiKVswXTsKICAgICAgICBpZiAoIWRhdGVTcGFuKSB7CiAgICAgICAgICAvLyBjcmVhdGUgdGhlIHNjaGVkdWxlIGZyb20gc2NyYXRjaAogICAgICAgICAgenNzX2VkaXRvci5pbnNlcnRJbnB1dEZpZWxkKGRhdGEpOwogICAgICAgIH0KICAgICAgICBkYXRlU3Bhbi5pbm5lclRleHQgPSBzY2hlZHVsZURhdGU7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnJlbW92ZUVsZW1lbnRCeUNsYXNzID0gZnVuY3Rpb24gKGNsYXNzTmFtZSkgewogICAgICAgIGNvbnN0IGVsZW1lbnRUb0JlUmVtb3ZlZCA9ICQoYC4ke2NsYXNzTmFtZX1gKVswXTsKICAgICAgICBlbGVtZW50VG9CZVJlbW92ZWQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtZW50VG9CZVJlbW92ZWQpOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5ibHVySW5wdXRGaWVsZCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICBsZXQgaW5wdXQgPSAkKGAjenNzX2VkaXRvcl9pbnB1dF9maWVsZF8ke2tleX1gKVswXTsKICAgICAgICAgIGlmIChpbnB1dCkgewogICAgICAgICAgICBpbnB1dC5ibHVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRDdXN0b21DU1MgPSBmdW5jdGlvbiAoY3VzdG9tQ1NTKSB7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInN0eWxlIilbMV0uaW5uZXJIVE1MID0gY3VzdG9tQ1NTOwoKICAgICAgICAvL3NldCBmb2N1cwogICAgICAgIC8qZWRpdG9yLmZvY3Vzb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICB2YXIgZWxlbWVudCA9ICQodGhpcyk7CiAgICAgICAgICAgICBpZiAoIWVsZW1lbnQudGV4dCgpLnRyaW0oKS5sZW5ndGgpIHsKICAgICAgICAgICAgIGVsZW1lbnQuZW1wdHkoKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICAgIH0pOyovCiAgICAgIH07CgogICAgICBmdW5jdGlvbiBhZGRGb2N1c0V2ZW50KGVkaXRvcklkLCBjYWxsYmFja0hhbmRsZXIpIHsKICAgICAgICB2YXIgZWRpdG9yID0gJCgiIyIgKyBlZGl0b3JJZCk7CiAgICAgICAgZWRpdG9yLmZvY3VzKGNhbGxiYWNrSGFuZGxlcik7CiAgICAgIH0KCiAgICAgIHpzc19lZGl0b3Iuc2V0VGl0bGVGb2N1c0hhbmRsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgYWRkRm9jdXNFdmVudCgienNzX2VkaXRvcl90aXRsZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHdpbmRvdy5SZWFjdE5hdGl2ZVdlYlZpZXcucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAiVElUTEVfRk9DVVNFRCIgfSkpOwogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgenNzX2VkaXRvci5zZXRDb250ZW50Rm9jdXNIYW5kbGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIGFkZEZvY3VzRXZlbnQoInpzc19lZGl0b3JfY29udGVudCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHdpbmRvdy5SZWFjdE5hdGl2ZVdlYlZpZXcucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAiQ09OVEVOVF9GT0NVU0VEIiB9KSk7CiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICB6c3NfZWRpdG9yLnNldEVkaXRvckhlaWdodCA9IGZ1bmN0aW9uIChlZGl0b3JIZWlnaHQpIHsKICAgICAgICB6c3NfZWRpdG9yLmVkaXRvckhlaWdodCA9IGVkaXRvckhlaWdodDsKICAgICAgfTsKCiAgICAgIHpzc19lZGl0b3Iuc2V0UGxhdGZvcm0gPSBmdW5jdGlvbiAocGxhdGZvcm0pIHsKICAgICAgICB6c3NfZWRpdG9yLnBsYXRmb3JtID0gcGxhdGZvcm07CiAgICAgIH07CiAgICAgICQod2luZG93KS5vbigic2Nyb2xsIiwgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzY3JvbGxIZWlnaHQgPSAkKGRvY3VtZW50KS5oZWlnaHQoKTsKICAgICAgICB2YXIgc2Nyb2xsUG9zaXRpb24gPSAkKHdpbmRvdykuaGVpZ2h0KCkgKyAkKHdpbmRvdykuc2Nyb2xsVG9wKCk7CiAgICAgICAgaWYgKChzY3JvbGxIZWlnaHQgLSBzY3JvbGxQb3NpdGlvbikgLyBzY3JvbGxIZWlnaHQgPT09IDApIHsKICAgICAgICAgIHdpbmRvdy5SZWFjdE5hdGl2ZVdlYlZpZXcucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoeyB0eXBlOiAiQk9UVE9NX1JFQUNIRUQiIH0pKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNjcm9sbFBvc2l0aW9uID09PSAwKSB7CiAgICAgICAgICB3aW5kb3cuUmVhY3ROYXRpdmVXZWJWaWV3LnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KHsgdHlwZTogIlRPUF9SRUFDSEVEIiB9KSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgLy9lbmQKICAgIDwvc2NyaXB0PgoKICAgIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAgICAgIC8qIERlZmF1bHQgWlNTUmljaFRleHRFZGl0b3IgU3R5bGluZyAqLwogICAgICBAZm9udC1mYWNlIHsKICAgICAgICBmb250LWZhbWlseTogIlByb3hpbWEgTm92YSI7CiAgICAgICAgc3JjOiB1cmwoImh0dHBzOi8vZDI1cHVycmNncXRjNXcuY2xvdWRmcm9udC5uZXQvZGlzdC9mb250cy9wcm94aW1hbm92YS8zMDJENDJfNF8wLmVvdCIpOwogICAgICAgIHNyYzogdXJsKCJodHRwczovL2QyNXB1cnJjZ3F0YzV3LmNsb3VkZnJvbnQubmV0L2Rpc3QvZm9udHMvcHJveGltYW5vdmEvMzAyRDQyXzRfMC5lb3Q/I2llZml4IikgZm9ybWF0KCJlbWJlZGRlZC1vcGVudHlwZSIpLAogICAgICAgICAgdXJsKCJodHRwczovL2QyNXB1cnJjZ3F0YzV3LmNsb3VkZnJvbnQubmV0L2Rpc3QvZm9udHMvcHJveGltYW5vdmEvMzAyRDQyXzRfMC53b2ZmMiIpIGZvcm1hdCgid29mZjIiKSwKICAgICAgICAgIHVybCgiaHR0cHM6Ly9kMjVwdXJyY2dxdGM1dy5jbG91ZGZyb250Lm5ldC9kaXN0L2ZvbnRzL3Byb3hpbWFub3ZhLzMwMkQ0Ml80XzAud29mZiIpIGZvcm1hdCgid29mZiIpLAogICAgICAgICAgdXJsKCJodHRwczovL2QyNXB1cnJjZ3F0YzV3LmNsb3VkZnJvbnQubmV0L2Rpc3QvZm9udHMvcHJveGltYW5vdmEvMzAyRDQyXzRfMC50dGYiKSBmb3JtYXQoInRydWV0eXBlIiksCiAgICAgICAgICB1cmwoImh0dHBzOi8vZDI1cHVycmNncXRjNXcuY2xvdWRmcm9udC5uZXQvZGlzdC9mb250cy9wcm94aW1hbm92YS8zMDJENDJfNF8wLnN2ZyN3ZiIpIGZvcm1hdCgic3ZnIik7CiAgICAgICAgZm9udC13ZWlnaHQ6IDQwMDsKICAgICAgICBmb250LXN0eWxlOiBub3JtYWw7CiAgICAgIH0KCiAgICAgIEBmb250LWZhY2UgewogICAgICAgIGZvbnQtZmFtaWx5OiAiUHJveGltYSBOb3ZhIjsKICAgICAgICBzcmM6IHVybCgiaHR0cHM6Ly9kMjVwdXJyY2dxdGM1dy5jbG91ZGZyb250Lm5ldC9kaXN0L2ZvbnRzL3Byb3hpbWFub3ZhLzMwMkQ0Ml8yXzAuZW90Iik7CiAgICAgICAgc3JjOiB1cmwoImh0dHBzOi8vZDI1cHVycmNncXRjNXcuY2xvdWRmcm9udC5uZXQvZGlzdC9mb250cy9wcm94aW1hbm92YS8zMDJENDJfMl8wLmVvdD8jaWVmaXgiKSBmb3JtYXQoImVtYmVkZGVkLW9wZW50eXBlIiksCiAgICAgICAgICB1cmwoImh0dHBzOi8vZDI1cHVycmNncXRjNXcuY2xvdWRmcm9udC5uZXQvZGlzdC9mb250cy9wcm94aW1hbm92YS8zMDJENDJfMl8wLndvZmYyIikgZm9ybWF0KCJ3b2ZmMiIpLAogICAgICAgICAgdXJsKCJodHRwczovL2QyNXB1cnJjZ3F0YzV3LmNsb3VkZnJvbnQubmV0L2Rpc3QvZm9udHMvcHJveGltYW5vdmEvMzAyRDQyXzJfMC53b2ZmIikgZm9ybWF0KCJ3b2ZmIiksCiAgICAgICAgICB1cmwoImh0dHBzOi8vZDI1cHVycmNncXRjNXcuY2xvdWRmcm9udC5uZXQvZGlzdC9mb250cy9wcm94aW1hbm92YS8zMDJENDJfMl8wLnR0ZiIpIGZvcm1hdCgidHJ1ZXR5cGUiKSwKICAgICAgICAgIHVybCgiaHR0cHM6Ly9kMjVwdXJyY2dxdGM1dy5jbG91ZGZyb250Lm5ldC9kaXN0L2ZvbnRzL3Byb3hpbWFub3ZhLzMwMkQ0Ml8yXzAuc3ZnI3dmIikgZm9ybWF0KCJzdmciKTsKICAgICAgICBmb250LXdlaWdodDogNjAwOwogICAgICAgIGZvbnQtc3R5bGU6IG5vcm1hbDsKICAgICAgfQoKICAgICAgQGZvbnQtZmFjZSB7CiAgICAgICAgZm9udC1mYW1pbHk6ICJQcm94aW1hIE5vdmEiOwogICAgICAgIHNyYzogdXJsKCJodHRwczovL2QyNXB1cnJjZ3F0YzV3LmNsb3VkZnJvbnQubmV0L2Rpc3QvZm9udHMvcHJveGltYW5vdmEvMzAyRDQyXzVfMC5lb3QiKTsKICAgICAgICBzcmM6IHVybCgiaHR0cHM6Ly9kMjVwdXJyY2dxdGM1dy5jbG91ZGZyb250Lm5ldC9kaXN0L2ZvbnRzL3Byb3hpbWFub3ZhLzMwMkQ0Ml81XzAuZW90PyNpZWZpeCIpIGZvcm1hdCgiZW1iZWRkZWQtb3BlbnR5cGUiKSwKICAgICAgICAgIHVybCgiaHR0cHM6Ly9kMjVwdXJyY2dxdGM1dy5jbG91ZGZyb250Lm5ldC9kaXN0L2ZvbnRzL3Byb3hpbWFub3ZhLzMwMkQ0Ml81XzAud29mZjIiKSBmb3JtYXQoIndvZmYyIiksCiAgICAgICAgICB1cmwoImh0dHBzOi8vZDI1cHVycmNncXRjNXcuY2xvdWRmcm9udC5uZXQvZGlzdC9mb250cy9wcm94aW1hbm92YS8zMDJENDJfNV8wLndvZmYiKSBmb3JtYXQoIndvZmYiKSwKICAgICAgICAgIHVybCgiaHR0cHM6Ly9kMjVwdXJyY2dxdGM1dy5jbG91ZGZyb250Lm5ldC9kaXN0L2ZvbnRzL3Byb3hpbWFub3ZhLzMwMkQ0Ml81XzAudHRmIikgZm9ybWF0KCJ0cnVldHlwZSIpLAogICAgICAgICAgdXJsKCJodHRwczovL2QyNXB1cnJjZ3F0YzV3LmNsb3VkZnJvbnQubmV0L2Rpc3QvZm9udHMvcHJveGltYW5vdmEvMzAyRDQyXzVfMC5zdmcjd2YiKSBmb3JtYXQoInN2ZyIpOwogICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgZm9udC1zdHlsZTogbm9ybWFsOwogICAgICB9CiAgICAgICogewogICAgICAgIG91dGxpbmU6IDBweCBzb2xpZCB0cmFuc3BhcmVudDsKICAgICAgICAtd2Via2l0LXRhcC1oaWdobGlnaHQtY29sb3I6IHJnYmEoMCwgMCwgMCwgMCk7CiAgICAgICAgLXdlYmtpdC10b3VjaC1jYWxsb3V0OiBub25lOwogICAgICB9CgogICAgICBodG1sLAogICAgICBib2R5IHsKICAgICAgICBwYWRkaW5nOiAwOwogICAgICAgIG1hcmdpbjogMDsKICAgICAgICBmb250LWZhbWlseTogUHJveGltYSBOb3ZhOwogICAgICAgIGZvbnQtc2l6ZTogMWVtOwogICAgICAgIGNvbG9yOiAjMmQ0MTUwOwogICAgICB9CgogICAgICBib2R5IHsKICAgICAgICBwYWRkaW5nLWxlZnQ6IDBweDsKICAgICAgICBwYWRkaW5nLXJpZ2h0OiAwcHg7CiAgICAgICAgcGFkZGluZy10b3A6IDBweDsKICAgICAgICBwYWRkaW5nLWJvdHRvbTogMHB4OwogICAgICAgIG92ZXJmbG93LXk6IHNjcm9sbDsKICAgICAgICAtd2Via2l0LW92ZXJmbG93LXNjcm9sbGluZzogdG91Y2g7CiAgICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICB9CgogICAgICBpbWcuenNfYWN0aXZlIHsKICAgICAgICAvKmJvcmRlcjogMnB4IGRhc2hlZCAjMDAwOyovCiAgICAgIH0KCiAgICAgIGltZyB7CiAgICAgICAgbWF4LXdpZHRoOiA5OCU7CiAgICAgICAgbWFyZ2luLWxlZnQ6IGF1dG87CiAgICAgICAgbWFyZ2luLXJpZ2h0OiBhdXRvOwogICAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgICB9CgogICAgICBhdWRpbyB7CiAgICAgICAgcGFkZGluZzogMjBweCAwOwogICAgICB9CgogICAgICBkaXYuenNzX2VkaXRvcl9jb250ZW50IHsKICAgICAgICBmb250LWZhbWlseTogUHJveGltYSBOb3ZhOwogICAgICAgIGNvbG9yOiAjMDAwOwogICAgICAgIC8qd2lkdGg6IDEwMCU7Ki8KICAgICAgICBoZWlnaHQ6IDEwMCU7CiAgICAgICAgLXdlYmtpdC1vdmVyZmxvdy1zY3JvbGxpbmc6IHRvdWNoOwogICAgICAgIG92ZXJmbG93OiBhdXRvOwogICAgICAgIGNhcmV0LWNvbG9yOiAjMjQyNzJiOwogICAgICB9CgogICAgICAjenNzX2VkaXRvcl9jb250ZW50IHsKICAgICAgICBwYWRkaW5nLWxlZnQ6IDEwcHg7CiAgICAgICAgcGFkZGluZy1yaWdodDogMTBweDsKICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTJweDsKICAgICAgfQoKICAgICAgZGl2Lnpzc19lZGl0b3JfdGl0bGUgewogICAgICAgIGZvbnQtZmFtaWx5OiAiUHJveGltYSBOb3ZhIiwgc2Fucy1zZXJpZjsKICAgICAgICBmb250LXNpemU6IDIzcHg7CiAgICAgICAgbGluZS1oZWlnaHQ6IDMxcHg7CiAgICAgICAgY29sb3I6ICMyZDQxNTA7CiAgICAgIH0KCiAgICAgICN6c3NfZWRpdG9yX3RpdGxlIHsKICAgICAgICBwYWRkaW5nLWxlZnQ6IDEwcHg7CiAgICAgICAgcGFkZGluZy1yaWdodDogMTBweDsKICAgICAgfQoKICAgICAgLnpzc19lZGl0b3JfbWV0YV9maWVsZHMgewogICAgICAgIGRpc3BsYXk6IGJsb2NrOwogICAgICAgIC8qYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICNFRUVGRjE7Ki8KICAgICAgICBtYXJnaW4tYm90dG9tOiAyOHB4OwogICAgICB9CgogICAgICAuenNzX2VkaXRvcl91bCB7CiAgICAgICAgbGlzdC1zdHlsZTogbm9uZTsKICAgICAgICBwYWRkaW5nOiAwcHg7CiAgICAgICAgbWFyZ2luOiAwcHggMTRweCAwcHggMTRweDsKICAgICAgfQoKICAgICAgbGkuenNzX2VkaXRvcl9maWVsZF9saSB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBoZWlnaHQ6IDMwcHg7CiAgICAgICAgZmxleC1kaXJlY3Rpb246IHJvdzsKICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgIC8qZGlzcGxheTogYmxvY2s7Ki8KICAgICAgICBwYWRkaW5nOiAxNXB4IDBweCAxNXB4IDBweDsKICAgICAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQgI2VlZWZmMTsKICAgICAgfQoKICAgICAgbGkuenNzX2VkaXRvcl9maWVsZF9zZXBhcmF0b3IgewogICAgICAgIC8qYm9yZGVyLXRvcDogMXB4IHNvbGlkICNFRUVGRjE7Ki8KICAgICAgfQoKICAgICAgLnNjaGVkdWxlX3dyYXBwZXIgewogICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOwogICAgICB9CgogICAgICAudHJhc2hfaWNvbiB7CiAgICAgICAgZmlsdGVyOiBpbnZlcnQoNTUlKSBzZXBpYSg4JSkgc2F0dXJhdGUoMzkzJSkgaHVlLXJvdGF0ZSgxODBkZWcpIGJyaWdodG5lc3MoODYlKSBjb250cmFzdCg4NSUpOwogICAgICAgIHdpZHRoOiAyNHB4OwogICAgICAgIGhlaWdodDogMjRweDsKICAgICAgICBtYXJnaW4tcmlnaHQ6IDRweDsKICAgICAgICB0cmFuc2l0aW9uOiAwLjNzOwogICAgICB9CgogICAgICAudHJhc2hfaWNvbl9hY3RpdmUgewogICAgICAgIHRyYW5zaXRpb246IDAuM3M7CiAgICAgICAgZmlsdGVyOiBicmlnaHRuZXNzKDEwMCUpOwogICAgICB9CgogICAgICAuY2xvY2tfaWNvbiB7CiAgICAgICAgZmlsdGVyOiBpbnZlcnQoMjIlKSBzZXBpYSgyMSUpIHNhdHVyYXRlKDQ1MyUpIGh1ZS1yb3RhdGUoMTc2ZGVnKSBicmlnaHRuZXNzKDg4JSkgY29udHJhc3QoODUlKTsKICAgICAgICBtYXJnaW4tbGVmdDogMDsKICAgICAgICBtYXJnaW4tcmlnaHQ6IDhweDsKICAgICAgICBhbGlnbi1zZWxmOiBjZW50ZXI7CiAgICAgIH0KICAgICAgLnNjaGVkdWxlX2RhdGVfd3JhcHBlciB7CiAgICAgICAgZmxleC1kaXJlY3Rpb246IHJvdzsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGFsaWduLWl0ZW1zOiBiYXNlbGluZTsKICAgICAgfQoKICAgICAgLnNjaGVkdWxlZF90ZXh0IHsKICAgICAgICBjb2xvcjogIzI0MjcyYjsKICAgICAgICBmb250LXNpemU6IDE0cHg7CiAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgfQoKICAgICAgLnNjaGVkdWxlZF9kYXRlIHsKICAgICAgICBmb250LXdlaWdodDogNDAwOwogICAgICAgIGZvbnQtc2l6ZTogMTZweDsKICAgICAgICBsaW5lLWhlaWdodDogMjJweDsKICAgICAgICBjb2xvcjogIzI0MjcyYjsKICAgICAgICBtYXJnaW4tbGVmdDogOHB4OwogICAgICB9CgogICAgICAuY3NzQ2lyY2xlIHsKICAgICAgICAtd2Via2l0LWJvcmRlci1yYWRpdXM6IDk5OXB4OwogICAgICAgIC1tb3otYm9yZGVyLXJhZGl1czogOTk5cHg7CiAgICAgICAgYm9yZGVyLXJhZGl1czogOTk5cHg7CiAgICAgICAgYm9yZGVyOiAwOwogICAgICAgIGJlaGF2aW9yOiB1cmwoUElFLmh0Yyk7CgogICAgICAgIHdpZHRoOiAzMHB4OwogICAgICAgIGhlaWdodDogMzBweDsKICAgICAgICBwYWRkaW5nOiAwcHggMHB4IDJweDsKCiAgICAgICAgYmFja2dyb3VuZDogcmdiYSg5NCwgNDgsIDIyNywgMC4xMik7CiAgICAgICAgLypib3JkZXI6IDFweCBzb2xpZCAjMDAzNTgwOyovCiAgICAgICAgY29sb3I6IHJnYig5NCwgNDgsIDIyNyk7CiAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjogYmFja2dyb3VuZCAwLjJzIGxpbmVhcjsKICAgICAgICAtbW96LXRyYW5zaXRpb246IGJhY2tncm91bmQgMC4ycyBsaW5lYXI7CiAgICAgICAgLW1zLXRyYW5zaXRpb246IGJhY2tncm91bmQgMC4ycyBsaW5lYXI7CiAgICAgICAgLW8tdHJhbnNpdGlvbjogYmFja2dyb3VuZCAwLjJzIGxpbmVhcjsKICAgICAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kIDAuMnMgbGluZWFyOwogICAgICAgIHRyYW5zaXRpb246IGNvbG9yIDAuMnMgbGluZWFyOwoKICAgICAgICAvKmZvbnQ6IDEzcHggQXJpYWwsIHNhbnMtc2VyaWYqLwogICAgICB9CiAgICAgIC8qLmNzc0NpcmNsZTpob3ZlciB7Ki8KICAgICAgLyoJYmFja2dyb3VuZDogIzNGNjlBMCA7Ki8KICAgICAgLyoJISpjdXJzb3I6IHBvaW50ZXI7KiEqLwogICAgICAvKn0qLwogICAgICAuY3NzQ2lyY2xlOmFjdGl2ZSB7CiAgICAgICAgYmFja2dyb3VuZDogcmdiYSg5NCwgNDgsIDIyNywgMC41Mik7CiAgICAgICAgLypjdXJzb3I6IHBvaW50ZXI7Ki8KICAgICAgfQoKICAgICAgLmNzc0NpcmNsZSA6Zm9jdXMgewogICAgICAgIG91dGxpbmU6IG5vbmU7CiAgICAgIH0KCiAgICAgIC5wbHVzU2lnbiB7CiAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICAgZm9udC1zaXplOiAyMnB4OwogICAgICAgIGxpbmUtaGVpZ2h0OiAxLjFlbTsKICAgICAgfQoKICAgICAgLnpzc19lZGl0b3JfZmllbGRfbGFiZWwgewogICAgICAgIGZvbnQtZmFtaWx5OiBQcm94aW1hIE5vdmE7CiAgICAgICAgZm9udC1zaXplOiAxNnB4OwogICAgICAgIGxpbmUtaGVpZ2h0OiAxOXB4OwogICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgIGNvbG9yOiAjYThhZGI4OwogICAgICB9CgogICAgICBpbnB1dC56c3NfZWRpdG9yX2ZpZWxkX2lucHV0IHsKICAgICAgICBmbGV4OiAxOwogICAgICAgIG1hcmdpbjogMHB4IDBweCAwcHggMTBweDsKICAgICAgICBwYWRkaW5nOiAwcHg7CiAgICAgICAgYm9yZGVyOiBub25lOwogICAgICAgIGZvbnQtZmFtaWx5OiBQcm94aW1hIE5vdmE7CiAgICAgICAgZm9udC1zaXplOiAxNnB4OwogICAgICAgIGxpbmUtaGVpZ2h0OiAxOXB4OwogICAgICAgIGNvbG9yOiAjMjQyNzJiOwogICAgICAgIGNhcmV0LWNvbG9yOiAjMjQyNzJiOwogICAgICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwogICAgICB9CgogICAgICBbcGxhY2Vob2xkZXJdOmVtcHR5OmJlZm9yZSB7CiAgICAgICAgY29udGVudDogYXR0cihwbGFjZWhvbGRlcik7CiAgICAgICAgY29sb3I6ICNlMGUwZTA7CiAgICAgIH0KCiAgICAgIFtwbGFjZWhvbGRlcl06ZW1wdHk6Zm9jdXM6YmVmb3JlIHsKICAgICAgICBjb250ZW50OiBhdHRyKHBsYWNlaG9sZGVyKTsKICAgICAgICBjb2xvcjogI2UwZTBlMDsKICAgICAgfQoKICAgICAgaHIgewogICAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgICBoZWlnaHQ6IDFweDsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZTdlN2U3OwogICAgICB9CgogICAgICAjc2VwYXJhdG9yQ29udGFpbmVyIHsKICAgICAgICAtd2Via2l0LXVzZXItc2VsZWN0OiBub25lOwogICAgICAgIHBhZGRpbmctbGVmdDogMTBweDsKICAgICAgICBwYWRkaW5nLXJpZ2h0OiAxMHB4OwogICAgICB9CiAgICA8L3N0eWxlPgoKICAgIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CiAgICAgIC8qIEN1c3RvbSBDU1MgU3R5bGluZyAqLwogICAgICAvKmN1c3RvbWNzcyovCiAgICA8L3N0eWxlPgogIDwvaGVhZD4KCiAgPGJvZHk+CiAgICA8IS0tIFpTU1JpY2hUZXh0RWRpdG9yIEVkaXRhYmxlIENvbnRlbnQgLS0+CiAgICA8ZGl2IGlkPSJ6c3NfZWRpdG9yX2lucHV0X2ZpZWxkcyI+PC9kaXY+CiAgICA8ZGl2IGlkPSJ6c3NfZWRpdG9yX3RpdGxlIiBjbGFzcz0ienNzX2VkaXRvcl90aXRsZSIgY29udGVudGVkaXRhYmxlPSJ0cnVlIiBwbGFjZWhvbGRlcj0iIiBkaXNhYmxlTGluZUJyZWFrcz0idHJ1ZSI+PC9kaXY+CiAgICA8ZGl2IGlkPSJzZXBhcmF0b3JDb250YWluZXIiPjxociAvPjwvZGl2PgogICAgPGRpdgogICAgICBpZD0ienNzX2VkaXRvcl9jb250ZW50IgogICAgICBzdHlsZT0iZm9udC1mYW1pbHk6ICdQcm94aW1hIE5vdmEnOyBjb2xvcjogIzI0MjcyYiIKICAgICAgY2xhc3M9Inpzc19lZGl0b3JfY29udGVudCIKICAgICAgY29udGVudGVkaXRhYmxlPSJ0cnVlIgogICAgICBwbGFjZWhvbGRlcj0iIgogICAgPjwvZGl2PgogICAgPGRpdiBpZD0ienNzX2VkaXRvcl9mb290ZXIiPjwvZGl2PgogIDwvYm9keT4KPC9odG1sPgo=');
}
